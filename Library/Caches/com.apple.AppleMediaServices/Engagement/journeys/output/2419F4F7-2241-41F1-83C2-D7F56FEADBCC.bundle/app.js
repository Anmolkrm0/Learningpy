(()=>{function e(i){if(n[i])return n[i].exports;var r=n[i]={exports:{}};return t[i].call(r.exports,r,r.exports,e),r.exports}var t={9354:e=>{e.exports=JSON.parse('{"name":"@breejs/later","description":"Maintained fork of later. Determine later (or previous) occurrences of recurring schedules","version":"4.0.2","author":"BunKat <bill@levelstory.com>","bugs":{"url":"https://github.com/breejs/later/issues","email":"niftylettuce@gmail.com"},"contributors":["BunKat <bill@levelstory.com>","Nick Baugh <niftylettuce@gmail.com> (http://niftylettuce.com/)"],"dependencies":{},"devDependencies":{"@babel/cli":"^7.10.5","@babel/core":"^7.11.1","@babel/plugin-transform-runtime":"^7.11.0","@babel/preset-env":"^7.11.0","@commitlint/cli":"latest","@commitlint/config-conventional":"latest","babelify":"^10.0.0","benchmark":"*","browserify":"^16.5.2","codecov":"latest","cross-env":"latest","eslint":"^7.7.0","eslint-config-xo-lass":"latest","eslint-plugin-compat":"^3.8.0","eslint-plugin-node":"^11.1.0","fixpack":"latest","husky":"latest","lint-staged":"latest","mocha":"*","nyc":"latest","remark-cli":"latest","remark-preset-github":"latest","semver":"^7.3.2","should":">=13.2.3","tinyify":"^3.0.0","xo":"^0.33.0"},"engines":{"node":">= 10"},"files":["lib","dist"],"homepage":"https://github.com/breejs/later","husky":{"hooks":{"pre-commit":"lint-staged","commit-msg":"commitlint -E HUSKY_GIT_PARAMS"}},"jsdelivr":"dist/later.min.js","keywords":["agenda","async","await","bee","bee","bree","bull","bull","callback","cancel","cancelable","child","clear","cron","cronjob","crontab","date","dates","day","dayjs","delay","english","express","expression","frequencies","frequency","frequent","friendly","graceful","human","humans","interval","job","jobs","js","koa","koatiming","lad","lass","later","moment","momentjs","mongo","mongodb","mongoose","p-cancel","p-cancelable","p-retry","parse","parser","pretty","process","processors","promise","promises","queue","queues","readable","recur","recurring","redis","redis","reload","restart","run","runner","schedule","scheduler","setup","spawn","tab","task","tasker","time","timeout","timer","timers","translated","universalify","worker","workers"],"license":"MIT","main":"lib/index.js","publishConfig":{"access":"public"},"repository":{"type":"git","url":"https://github.com/breejs/later"},"scripts":{"benchmark":"benchmark/constraint/next-bench.js && benchmark/core/schedule-bench.js","browserify":"browserify src/index.js -o dist/later.js -s later -g [ babelify --configFile ./.dist.babelrc ]","build":"npm run build:clean && npm run build:lib && npm run build:dist","build:clean":"rimraf lib dist","build:dist":"npm run browserify && npm run minify","build:lib":"babel --config-file ./.lib.babelrc src --out-dir lib","coverage":"nyc report --reporter=text-lcov > coverage.lcov && codecov","lint":"yarn run lint:js && yarn run lint:md && yarn run lint:lib && yarn run lint:dist","lint:dist":"eslint --no-inline-config -c .dist.eslintrc dist","lint:js":"xo","lint:lib":"eslint -c .lib.eslintrc lib","lint:md":"remark . -qfo","minify":"cross-env NODE_ENV=production browserify src/index.js -o dist/later.min.js -s later -g [ babelify --configFile ./.dist.babelrc ] -p tinyify","nyc":"cross-env NODE_ENV=test nyc mocha test/**/*-test.js --reporter dot","pretest":"yarn run build && yarn run lint","test":"cross-env NODE_ENV=test mocha test/**/*-test.js --reporter dot","test-coverage":"cross-env NODE_ENV=test nyc yarn run test"},"unpkg":"dist/later.min.js","xo":{"prettier":true,"space":true,"extends":["xo-lass"],"rules":{"complexity":"warn","default-case":"warn","eqeqeq":"warn","guard-for-in":"warn","max-params":"warn","new-cap":"warn","no-case-declarations":"warn","no-multi-assign":"warn","no-negated-condition":"warn","no-return-assign":"warn","no-unused-vars":"warn","no-var":"warn","prefer-const":"warn","prefer-rest-params":"warn","unicorn/no-fn-reference-in-iterator":"warn","unicorn/prefer-number-properties":"warn","unicorn/prevent-abbreviations":"warn"},"overrides":[{"files":"example/**/*.js","rules":{"no-unused-vars":"warn"}},{"files":"test/**/*.js","env":["mocha"],"rules":{"new-cap":"warn","no-unused-vars":"warn","unicorn/prevent-abbreviations":"warn"}}]},"_resolved":"https://artifacts.apple.com/api/npm/npm-private/@breejs/later/-/later-4.0.2.tgz","_integrity":"sha1-OMhcyYtxfHoZb4cjgJCtrqAfjJ4=","_from":"@breejs/later@4.0.2"}')},1169:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},9010:(e,t)=>{function n(e,n){return{actionClass:t.badgingActionClass,topic:e,...n}}var i;Object.defineProperty(t,"__esModule",{value:!0}),t.createBadgingActionForTopic=t.createBadgingAction=t.BadgeClientIdentifier=t.badgingActionClass=void 0,t.badgingActionClass="BadgingAction",function(e){e[e.appStore=0]="appStore"}(i=t.BadgeClientIdentifier||(t.BadgeClientIdentifier={})),t.createBadgingAction=function(e,t){const r=function(e){return e===i.appStore?{topic:"com.apple.AppStore"}:{topic:""}}(e);return n(r.topic,t)},t.createBadgingActionForTopic=n},1542:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.createCacheDataAction=t.cacheDataActionClass=void 0,t.cacheDataActionClass="CacheDataAction",t.createCacheDataAction=function(e,n,i,r){return{actionClass:t.cacheDataActionClass,data:e,duration:r,filter:n,key:i}}},5350:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.createCarrierOfferRegistrationAction=t.carrierOfferRegistrationActionClass=void 0,t.carrierOfferRegistrationActionClass="CarrierOfferRegistrationAction",t.createCarrierOfferRegistrationAction=function(e={}){return{actionClass:t.carrierOfferRegistrationActionClass,throttleInterval:e.throttleInterval}}},8538:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.createEnqueueAction=t.enqueueActionClass=void 0,t.enqueueActionClass="EnqueueAction",t.createEnqueueAction=function(e,n){return{actionClass:t.enqueueActionClass,events:e,schedule:null==n?void 0:n.schedule}}},5855:(e,t)=>{function n(e,n){return{actionClass:t.followUpNotificationActionClass,identifier:e,data:n}}Object.defineProperty(t,"__esModule",{value:!0}),t.createFollowUpNotificationActionWithNativeContent=t.createFollowUpNotificationAction=t.followUpNotificationActionClass=void 0,t.followUpNotificationActionClass="FollowUpNotificationAction",t.createFollowUpNotificationAction=function(e,t){var i,r;const s=[];return null===(i=t.actions)||void 0===i||i.forEach((e=>{s.push({clientActionDeepLink:e.clientActionDeepLink,financeLink:e.financeURL,metrics:e.metrics,serverActionUrl:e.request,clear:e.shouldClear,title:e.title})})),n(e,{actions:s,clear:t.shouldClear,expirationDate:t.expirationDate,deviceGroup:t.deviceGroup,disableGrouping:!t.deviceGroup,footer:t.footer,hardwareOffer:t.isHardwareOffer,iconImageName:t.iconImageName,metrics:t.metrics,notification:t.shouldPostNotification,omitBadge:t.shouldOmitBadge,text:t.informativeText,title:t.title,zeroAction:t.zeroAction,priority:null!==(r=t.priority)&&void 0!==r?r:0,accountDSID:t.accountDSID})},t.createFollowUpNotificationActionWithNativeContent=n},3870:function(e,t,n){var i=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),r=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||i(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),r(n(9010),t),r(n(1542),t),r(n(5350),t),r(n(8538),t),r(n(5855),t),r(n(5908),t),r(n(168),t),r(n(5984),t),r(n(447),t),r(n(714),t)},5908:(e,t)=>{var n,i,r;Object.defineProperty(t,"__esModule",{value:!0}),t.createMessageAction=t.PlacementActionType=t.ActionStyle=t.MessageStyle=t.messageActionClass=void 0,t.messageActionClass="MessageAction",(r=t.MessageStyle||(t.MessageStyle={}))[r.default=0]="default",r[r.alert=1]="alert",r[r.sheet=2]="sheet",r[r.banner=3]="banner",r[r.bubbleTip=4]="bubbleTip",r[r.toast=5]="toast",r[r.dashboard=6]="dashboard",(i=t.ActionStyle||(t.ActionStyle={}))[i.default=0]="default",i[i.destructive=1]="destructive",i[i.cancel=2]="cancel",(n=t.PlacementActionType||(t.PlacementActionType={})).present="present",n.dismiss="dismiss",t.createMessageAction=function(e,n){return{actionClass:t.messageActionClass,serviceType:e,dialogRequest:null==n?void 0:n.dialogRequest,engagementRequest:null==n?void 0:n.engagementRequest,placements:null==n?void 0:n.placements}}},168:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.createOpenURLAction=t.deepLinkActionClass=void 0,t.deepLinkActionClass="DeepLinkAction",t.createOpenURLAction=function(e){return{actionClass:t.deepLinkActionClass,url:e}}},5984:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.createSyncAction=t.syncActionClass=void 0,t.syncActionClass="SyncAction",t.createSyncAction=function(e){return{actionClass:t.syncActionClass,context:null==e?void 0:e.context,schedule:null==e?void 0:e.schedule}}},447:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.createSystemEngagementAction=t.systemEngagementActionClass=void 0,t.systemEngagementActionClass="SystemEngagementAction",t.createSystemEngagementAction=function(e,n){return{actionClass:t.systemEngagementActionClass,request:e,account:null==n?void 0:n.account}}},714:(e,t)=>{var n,i;Object.defineProperty(t,"__esModule",{value:!0}),t.createUserNotificationAction=t.UserNotificationInterruptionLevel=t.UserNotificationClientId=t.userNotificationActionClass=void 0,t.userNotificationActionClass="UserNotificationAction",function(e){e[e.applemediaservices=0]="applemediaservices",e[e.appstore=1]="appstore",e[e.fitness=2]="fitness",e[e.ibooks=3]="ibooks",e[e.itunesstore=4]="itunesstore",e[e.music=5]="music",e[e.tv=6]="tv",e[e.news=7]="news",e[e.podcasts=8]="podcasts",e[e.wallet=9]="wallet"}(n=t.UserNotificationClientId||(t.UserNotificationClientId={})),(i=t.UserNotificationInterruptionLevel||(t.UserNotificationInterruptionLevel={}))[i.passive=0]="passive",i[i.active=1]="active",i[i.timeSensitive=2]="timeSensitive",i[i.critical=3]="critical",t.createUserNotificationAction=function(e,i){var r,s;const a=[];null===(r=i.buttons)||void 0===r||r.forEach((e=>{var t,n,i;a.push({_id:e.id,_gl:e.systemImageName,_mt:e.metrics,_rb:null===(t=e.request)||void 0===t?void 0:t.body,_rm:null===(n=e.request)||void 0===n?void 0:n.method,_ru:null===(i=e.request)||void 0===i?void 0:i.url,_tl:e.title,_url:e.url,_tp:e.defaultButton})}));const o=function(e){switch(e){case n.applemediaservices:return{bundleID:"com.apple.AppleMediaServicesUI.engagement.notifications",extensionID:"ams-notifications-extension"};case n.appstore:return{bundleID:"com.apple.AppStore",extensionID:"asd-notification-default"};case n.fitness:return{bundleID:"com.apple.Fitness",extensionID:"fitcored-engagement-category"};case n.ibooks:return{bundleID:"macos"===host.platform.toString()?"com.apple.iBooksX":"com.apple.iBooks",extensionID:"books-notification-extension"};case n.itunesstore:return{bundleID:"com.apple.MobileStore",extensionID:"mst-notification-category"};case n.music:return{bundleID:"com.apple.Music",extensionID:"music-notification-default"};case n.news:return{bundleID:"com.apple.news",extensionID:"extension-marketing"};case n.podcasts:return{bundleID:"com.apple.podcasts",extensionID:"com.apple.podcasts.announcement"};case n.tv:return{bundleID:"com.apple.tv",extensionID:"com.apple.tv-default"};case n.wallet:return{bundleID:"com.apple.Passbook",extensionID:"com.apple.passkit.engagement-notification-extension"};default:return{bundleID:"",extensionID:""}}}(e);return{actionClass:t.userNotificationActionClass,bundleID:o.bundleID,data:{_au:i.artworkURL,_ba:a,_ex:i.explicit,_id:i.id,_mt:i.metrics,_ss:i.subsections,_vu:i.videoURL,alert:{body:i.message,level:i.interruptionLevel,title:i.title,subtitle:i.subtitle},category:o.extensionID,_an:null!==(s=i.anonymous)&&void 0!==s&&s}}}},5422:(e,t)=>{var n;t.G=void 0,(n=t.G||(t.G={})).Default="default",n.A="A",n.B="B",n.C="C"},1470:(e,t,n)=>{t.Z=void 0;const i=n(2450),r=n(9541);t.Z=function(e,t,n,s){const a=e.attributes.engagementArtwork,o={};return Object.keys(a).forEach((e=>{let u;AMS.log.default("Caching artwork for: "+e),o[e]=a[e];const c=`${n}:${e}`;((0,i.isNothing)(a[e].height)||(0,i.isNothing)(a[e].width))&&(e.startsWith("breakoutTall")?(a[e].height=3636,a[e].width=1680):e.startsWith("breakoutFull")&&(a[e].height=3240,a[e].width=4320),AMS.log.default("No width and height found for "+a[e]+",using default height and width.")),u=a[e].url.substring(0,a[e].url.lastIndexOf("/")+1)+a[e].width+"x"+a[e].height+".heic",o[e].width=a[e].width,o[e].height=a[e].height,AMS.log.default(`Making url with fields: ${u}`);const l={url:u,method:r.Method.get};AMS.content.download(c,s,l,{});const d=`amsc://?app=${t}&version=${s}&cacheKey=${c}&fallbackURL=${encodeURIComponent(a[e].url)}`;AMS.log.default("Generated cached url: "+d),o[e].url=d})),e.attributes.engagementArtwork=o,e}},1476:(e,t)=>{var n,i,r;t.GL=t.W=t.AA=void 0,(r=t.AA||(t.AA={}))[r.automatic=0]="automatic",r[r.dynamic=1]="dynamic",r[r.web=2]="web",(i=t.W||(t.W={})).automatic="automatic",i.formSheet="formSheet",i.fullScreen="fullScreen",i.pageSheet="pageSheet",i.proxCard="proxCard",i.proxCardLarge="proxCardLarge",(n=t.GL||(t.GL={})).analytics="analytics",n.internal="internal",n.journeys="journeys",n.recommendations="recommendations"},1846:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},9089:function(e,t,n){var i=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),r=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||i(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),t.exportEngagementService=t.actions=void 0,r(n(1169),t),t.actions=n(3870),r(n(8890),t),r(n(9615),t),r(n(1846),t),t.exportEngagementService=function(e){exportService("EngagementService",e)}},6059:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.AccountMediaType=void 0,(n=t.AccountMediaType||(t.AccountMediaType={}))[n.appStore=100]="appStore",n[n.appStoreBeta=101]="appStoreBeta",n[n.appStoreSandbox=102]="appStoreSandbox",n[n.books=200]="books",n[n.iTunes=300]="iTunes",n[n.production=400]="production"},7776:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},7090:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},9541:(e,t)=>{var n,i;Object.defineProperty(t,"__esModule",{value:!0}),t.isContentFinishedEvent=t.Method=t.ContentState=void 0,(i=t.ContentState||(t.ContentState={}))[i.unknown=0]="unknown",i[i.downloading=1]="downloading",i[i.available=2]="available",(n=t.Method||(t.Method={})).delete="DELETE",n.get="GET",n.head="HEAD",n.options="OPTIONS",n.patch="PATCH",n.post="POST",n.put="PUT",n.trace="TRACE",n.update="UPDATE",t.isContentFinishedEvent=function(e){const t=e;return"ContentAvailable"===t.eventType&&"amsengagementd"===t.source}},7837:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},6946:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},7839:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},9169:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},9971:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},8890:function(e,t,n){var i=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),r=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||i(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),r(n(6059),t),r(n(7776),t),r(n(7090),t),r(n(9541),t),r(n(7837),t),r(n(6946),t),r(n(7839),t),r(n(9169),t),r(n(9971),t),r(n(5643),t),r(n(5069),t),r(n(6091),t),r(n(721),t),r(n(73),t),r(n(4028),t),r(n(9681),t),r(n(3049),t)},5069:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},5643:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.LocationAuthorizationStatus=void 0,(n=t.LocationAuthorizationStatus||(t.LocationAuthorizationStatus={}))[n.notDetermined=0]="notDetermined",n[n.restricted=1]="restricted",n[n.denied=2]="denied",n[n.authorized=3]="authorized",n[n.authorizedWhenInUse=4]="authorizedWhenInUse"},6091:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},721:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.MediaType=void 0,(n=t.MediaType||(t.MediaType={}))[n.app=0]="app",n[n.appBundle=1]="appBundle",n[n.inApp=2]="inApp",n[n.arcadeApp=3]="arcadeApp",n[n.appRecommendation=4]="appRecommendation",n[n.audioBook=100]="audioBook",n[n.book=101]="book",n[n.bookSeries=102]="bookSeries",n[n.album=200]="album",n[n.musicVideo=201]="musicVideo",n[n.playlist=202]="playlist",n[n.song=203]="song",n[n.station=204]="station",n[n.podcast=300]="podcast",n[n.podcastEpisode=301]="podcastEpisode"},73:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},4028:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},9681:(e,t)=>{var n,i,r;Object.defineProperty(t,"__esModule",{value:!0}),t.SubscriptionResponseStatus=t.SubscriptionResponseSource=t.SubscriptionMediaType=void 0,(r=t.SubscriptionMediaType||(t.SubscriptionMediaType={}))[r.activity=0]="activity",r[r.appStore=1]="appStore",r[r.music=2]="music",r[r.news=3]="news",r[r.tv=4]="tv",r[r.icloud=5]="icloud",r[r.podcast=6]="podcast",(i=t.SubscriptionResponseSource||(t.SubscriptionResponseSource={}))[i.unknown=0]="unknown",i[i.apple=1]="apple",i[i.carrier=2]="carrier",(n=t.SubscriptionResponseStatus||(t.SubscriptionResponseStatus={}))[n.notEntitled=0]="notEntitled",n[n.entitled=1]="entitled",n[n.requiresVerification=2]="requiresVerification",n[n.unlinked=3]="unlinked"},3049:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.AuthorizationStatus=void 0,(n=t.AuthorizationStatus||(t.AuthorizationStatus={}))[n.notDetermined=0]="notDetermined",n[n.denied=1]="denied",n[n.authorized=2]="authorized",n[n.provisional=3]="provisional",n[n.ephemeral=4]="ephemeral"},9615:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.EventComponents=void 0,(n=t.EventComponents||(t.EventComponents={}))[n.none=0]="none",n[n.app=1]="app",n[n.backlog=2]="backlog",n[n.all=3]="all"},6503:(e,t,n)=>{var i={version:n(9354).version,array:{}};i.array.sort=function(e,t){e.sort((function(e,t){return Number(e)-Number(t)})),t&&0===e[0]&&e.push(e.shift())},i.array.next=function(e,t,n){var i,r,s=0!==n[0],a=0;for(r=t.length-1;r>-1;--r){if((i=t[r])===e)return i;if(!(i>e||0===i&&s&&n[1]>e))break;a=r}return t[a]},i.array.nextInvalid=function(e,t,n){for(var i=n[0],r=n[1],s=t.length,a=0===t[s-1]&&0!==i?r:0,o=e,u=t.indexOf(e),c=o;o===(t[u]||a);)if(++o>r&&(o=i),++u===s&&(u=0),o===c)return;return o},i.array.prev=function(e,t,n){var i,r,s=t.length,a=0!==n[0],o=s-1;for(r=0;r<s;r++){if((i=t[r])===e)return i;if(!(i<e||0===i&&a&&n[1]<e))break;o=r}return t[o]},i.array.prevInvalid=function(e,t,n){for(var i=n[0],r=n[1],s=t.length,a=0===t[s-1]&&0!==i?r:0,o=e,u=t.indexOf(e),c=o;o===(t[u]||a);)if(--o<i&&(o=r),-1==--u&&(u=s-1),o===c)return;return o},i.day=i.D={name:"day",range:86400,val:function(e){return e.D||(e.D=i.date.getDate.call(e))},isValid:function(e,t){return i.D.val(e)===(t||i.D.extent(e)[1])},extent:function(e){var t,n;return e.DExtent?e.DExtent:(t=i.M.val(e),n=i.DAYS_IN_MONTH[t-1],2===t&&366===i.dy.extent(e)[1]&&(n+=1),e.DExtent=[1,n])},start:function(e){return e.DStart||(e.DStart=i.date.next(i.Y.val(e),i.M.val(e),i.D.val(e)))},end:function(e){return e.DEnd||(e.DEnd=i.date.prev(i.Y.val(e),i.M.val(e),i.D.val(e)))},next:function(e,t){var n,r;return t=t>i.D.extent(e)[1]?1:t,n=i.date.nextRollover(e,t,i.D,i.M),t=t>(r=i.D.extent(n)[1])?1:t||r,i.date.next(i.Y.val(n),i.M.val(n),t)},prev:function(e,t){var n=i.date.prevRollover(e,t,i.D,i.M),r=i.D.extent(n)[1];return i.date.prev(i.Y.val(n),i.M.val(n),t>r?r:t||r)}},i.dayOfWeekCount=i.dc={name:"day of week count",range:604800,val:function(e){return e.dc||(e.dc=Math.floor((i.D.val(e)-1)/7)+1)},isValid:function(e,t){return i.dc.val(e)===t||0===t&&i.D.val(e)>i.D.extent(e)[1]-7},extent:function(e){return e.dcExtent||(e.dcExtent=[1,Math.ceil(i.D.extent(e)[1]/7)])},start:function(e){return e.dcStart||(e.dcStart=i.date.next(i.Y.val(e),i.M.val(e),Math.max(1,7*(i.dc.val(e)-1)+1||1)))},end:function(e){return e.dcEnd||(e.dcEnd=i.date.prev(i.Y.val(e),i.M.val(e),Math.min(7*i.dc.val(e),i.D.extent(e)[1])))},next:function(e,t){var n,r;return t=t>i.dc.extent(e)[1]?1:t,n=i.date.nextRollover(e,t,i.dc,i.M),t=t>i.dc.extent(n)[1]?1:t,(r=i.date.next(i.Y.val(n),i.M.val(n),0===t?i.D.extent(n)[1]-6:1+7*(t-1))).getTime()<=e.getTime()?(n=i.M.next(e,i.M.val(e)+1),i.date.next(i.Y.val(n),i.M.val(n),0===t?i.D.extent(n)[1]-6:1+7*(t-1))):r},prev:function(e,t){var n=i.date.prevRollover(e,t,i.dc,i.M),r=i.dc.extent(n)[1];return t=t>r?r:t||r,i.dc.end(i.date.prev(i.Y.val(n),i.M.val(n),1+7*(t-1)))}},i.dayOfWeek=i.dw=i.d={name:"day of week",range:86400,val:function(e){return e.dw||(e.dw=i.date.getDay.call(e)+1)},isValid:function(e,t){return i.dw.val(e)===(t||7)},extent:function(){return[1,7]},start:function(e){return i.D.start(e)},end:function(e){return i.D.end(e)},next:function(e,t){return t=t>7?1:t||7,i.date.next(i.Y.val(e),i.M.val(e),i.D.val(e)+(t-i.dw.val(e))+(t<=i.dw.val(e)?7:0))},prev:function(e,t){return t=t>7?7:t||7,i.date.prev(i.Y.val(e),i.M.val(e),i.D.val(e)+(t-i.dw.val(e))+(t>=i.dw.val(e)?-7:0))}},i.dayOfYear=i.dy={name:"day of year",range:86400,val:function(e){return e.dy||(e.dy=Math.ceil(1+(i.D.start(e).getTime()-i.Y.start(e).getTime())/i.DAY))},isValid:function(e,t){return i.dy.val(e)===(t||i.dy.extent(e)[1])},extent:function(e){var t=i.Y.val(e);return e.dyExtent||(e.dyExtent=[1,t%4?365:366])},start:function(e){return i.D.start(e)},end:function(e){return i.D.end(e)},next:function(e,t){var n,r;return t=t>i.dy.extent(e)[1]?1:t,n=i.date.nextRollover(e,t,i.dy,i.Y),t=t>(r=i.dy.extent(n)[1])?1:t||r,i.date.next(i.Y.val(n),i.M.val(n),t)},prev:function(e,t){var n=i.date.prevRollover(e,t,i.dy,i.Y),r=i.dy.extent(n)[1];return t=t>r?r:t||r,i.date.prev(i.Y.val(n),i.M.val(n),t)}},i.hour=i.h={name:"hour",range:3600,val:function(e){return e.h||(e.h=i.date.getHour.call(e))},isValid:function(e,t){return i.h.val(e)===t},extent:function(){return[0,23]},start:function(e){return e.hStart||(e.hStart=i.date.next(i.Y.val(e),i.M.val(e),i.D.val(e),i.h.val(e)))},end:function(e){return e.hEnd||(e.hEnd=i.date.prev(i.Y.val(e),i.M.val(e),i.D.val(e),i.h.val(e)))},next:function(e,t){t=t>23?0:t;var n=i.date.next(i.Y.val(e),i.M.val(e),i.D.val(e)+(t<=i.h.val(e)?1:0),t);return!i.date.isUTC&&n.getTime()<=e.getTime()&&(n=i.date.next(i.Y.val(n),i.M.val(n),i.D.val(n),t+1)),n},prev:function(e,t){return t=t>23?23:t,i.date.prev(i.Y.val(e),i.M.val(e),i.D.val(e)+(t>=i.h.val(e)?-1:0),t)}},i.minute=i.m={name:"minute",range:60,val:function(e){return e.m||(e.m=i.date.getMin.call(e))},isValid:function(e,t){return i.m.val(e)===t},extent:function(e){return[0,59]},start:function(e){return e.mStart||(e.mStart=i.date.next(i.Y.val(e),i.M.val(e),i.D.val(e),i.h.val(e),i.m.val(e)))},end:function(e){return e.mEnd||(e.mEnd=i.date.prev(i.Y.val(e),i.M.val(e),i.D.val(e),i.h.val(e),i.m.val(e)))},next:function(e,t){var n=i.m.val(e),r=i.s.val(e),s=t>59?60-n:t<=n?60-n+t:t-n,a=new Date(e.getTime()+s*i.MIN-r*i.SEC);return!i.date.isUTC&&a.getTime()<=e.getTime()&&(a=new Date(e.getTime()+(s+120)*i.MIN-r*i.SEC)),a},prev:function(e,t){return t=t>59?59:t,i.date.prev(i.Y.val(e),i.M.val(e),i.D.val(e),i.h.val(e)+(t>=i.m.val(e)?-1:0),t)}},i.month=i.M={name:"month",range:2629740,val:function(e){return e.M||(e.M=i.date.getMonth.call(e)+1)},isValid:function(e,t){return i.M.val(e)===(t||12)},extent:function(){return[1,12]},start:function(e){return e.MStart||(e.MStart=i.date.next(i.Y.val(e),i.M.val(e)))},end:function(e){return e.MEnd||(e.MEnd=i.date.prev(i.Y.val(e),i.M.val(e)))},next:function(e,t){return t=t>12?1:t||12,i.date.next(i.Y.val(e)+(t>i.M.val(e)?0:1),t)},prev:function(e,t){return t=t>12?12:t||12,i.date.prev(i.Y.val(e)-(t>=i.M.val(e)?1:0),t)}},i.second=i.s={name:"second",range:1,val:function(e){return e.s||(e.s=i.date.getSec.call(e))},isValid:function(e,t){return i.s.val(e)===t},extent:function(){return[0,59]},start:function(e){return e},end:function(e){return e},next:function(e,t){var n=i.s.val(e),r=t>59?60-n:t<=n?60-n+t:t-n,s=new Date(e.getTime()+r*i.SEC);return!i.date.isUTC&&s.getTime()<=e.getTime()&&(s=new Date(e.getTime()+(r+7200)*i.SEC)),s},prev:function(e,t,n){return t=t>59?59:t,i.date.prev(i.Y.val(e),i.M.val(e),i.D.val(e),i.h.val(e),i.m.val(e)+(t>=i.s.val(e)?-1:0),t)}},i.time=i.t={name:"time",range:1,val:function(e){return e.t||(e.t=3600*i.h.val(e)+60*i.m.val(e)+i.s.val(e))},isValid:function(e,t){return i.t.val(e)===t},extent:function(){return[0,86399]},start:function(e){return e},end:function(e){return e},next:function(e,t){t=t>86399?0:t;var n=i.date.next(i.Y.val(e),i.M.val(e),i.D.val(e)+(t<=i.t.val(e)?1:0),0,0,t);return!i.date.isUTC&&n.getTime()<e.getTime()&&(n=i.date.next(i.Y.val(n),i.M.val(n),i.D.val(n),i.h.val(n),i.m.val(n),t+7200)),n},prev:function(e,t){return t=t>86399?86399:t,i.date.next(i.Y.val(e),i.M.val(e),i.D.val(e)+(t>=i.t.val(e)?-1:0),0,0,t)}},i.weekOfMonth=i.wm={name:"week of month",range:604800,val:function(e){return e.wm||(e.wm=(i.D.val(e)+(i.dw.val(i.M.start(e))-1)+(7-i.dw.val(e)))/7)},isValid:function(e,t){return i.wm.val(e)===(t||i.wm.extent(e)[1])},extent:function(e){return e.wmExtent||(e.wmExtent=[1,(i.D.extent(e)[1]+(i.dw.val(i.M.start(e))-1)+(7-i.dw.val(i.M.end(e))))/7])},start:function(e){return e.wmStart||(e.wmStart=i.date.next(i.Y.val(e),i.M.val(e),Math.max(i.D.val(e)-i.dw.val(e)+1,1)))},end:function(e){return e.wmEnd||(e.wmEnd=i.date.prev(i.Y.val(e),i.M.val(e),Math.min(i.D.val(e)+(7-i.dw.val(e)),i.D.extent(e)[1])))},next:function(e,t){var n,r;return t=t>i.wm.extent(e)[1]?1:t,n=i.date.nextRollover(e,t,i.wm,i.M),t=t>(r=i.wm.extent(n)[1])?1:t||r,i.date.next(i.Y.val(n),i.M.val(n),Math.max(1,7*(t-1)-(i.dw.val(n)-2)))},prev:function(e,t){var n=i.date.prevRollover(e,t,i.wm,i.M),r=i.wm.extent(n)[1];return t=t>r?r:t||r,i.wm.end(i.date.next(i.Y.val(n),i.M.val(n),Math.max(1,7*(t-1)-(i.dw.val(n)-2))))}},i.weekOfYear=i.wy={name:"week of year (ISO)",range:604800,val:function(e){var t,n;return e.wy?e.wy:(t=i.dw.next(i.wy.start(e),5),n=i.dw.next(i.Y.prev(t,i.Y.val(t)-1),5),e.wy=1+Math.ceil((t.getTime()-n.getTime())/i.WEEK))},isValid:function(e,t){return i.wy.val(e)===(t||i.wy.extent(e)[1])},extent:function(e){var t,n,r;return e.wyExtent?e.wyExtent:(t=i.dw.next(i.wy.start(e),5),n=i.dw.val(i.Y.start(t)),r=i.dw.val(i.Y.end(t)),e.wyExtent=[1,5===n||5===r?53:52])},start:function(e){return e.wyStart||(e.wyStart=i.date.next(i.Y.val(e),i.M.val(e),i.D.val(e)-(i.dw.val(e)>1?i.dw.val(e)-2:6)))},end:function(e){return e.wyEnd||(e.wyEnd=i.date.prev(i.Y.val(e),i.M.val(e),i.D.val(e)+(i.dw.val(e)>1?8-i.dw.val(e):0)))},next:function(e,t){var n,r,s,a;return t=t>i.wy.extent(e)[1]?1:t,n=i.dw.next(i.wy.start(e),5),r=i.date.nextRollover(n,t,i.wy,i.Y),1!==i.wy.val(r)&&(r=i.dw.next(r,2)),s=i.wy.extent(r)[1],a=i.wy.start(r),t=t>s?1:t||s,i.date.next(i.Y.val(a),i.M.val(a),i.D.val(a)+7*(t-1))},prev:function(e,t){var n,r,s=i.dw.next(i.wy.start(e),5),a=i.date.prevRollover(s,t,i.wy,i.Y);return 1!==i.wy.val(a)&&(a=i.dw.next(a,2)),n=i.wy.extent(a)[1],r=i.wy.end(a),t=t>n?n:t||n,i.wy.end(i.date.next(i.Y.val(r),i.M.val(r),i.D.val(r)+7*(t-1)))}},i.year=i.Y={name:"year",range:31556900,val:function(e){return e.Y||(e.Y=i.date.getYear.call(e))},isValid:function(e,t){return i.Y.val(e)===t},extent:function(){return[1970,2099]},start:function(e){return e.YStart||(e.YStart=i.date.next(i.Y.val(e)))},end:function(e){return e.YEnd||(e.YEnd=i.date.prev(i.Y.val(e)))},next:function(e,t){return t>i.Y.val(e)&&t<=i.Y.extent()[1]?i.date.next(t):i.NEVER},prev:function(e,t){return t<i.Y.val(e)&&t>=i.Y.extent()[0]?i.date.prev(t):i.NEVER}},i.fullDate=i.fd={name:"full date",range:1,val:function(e){return e.fd||(e.fd=e.getTime())},isValid:function(e,t){return i.fd.val(e)===t},extent:function(){return[0,3250368e7]},start:function(e){return e},end:function(e){return e},next:function(e,t){return i.fd.val(e)<t?new Date(t):i.NEVER},prev:function(e,t){return i.fd.val(e)>t?new Date(t):i.NEVER}},i.modifier={},i.modifier.after=i.modifier.a=function(e,t){var n=t[0];return{name:"after "+e.name,range:(e.extent(new Date)[1]-n)*e.range,val:e.val,isValid:function(e,t){return this.val(e)>=n},extent:e.extent,start:e.start,end:e.end,next:function(t,i){return i!=n&&(i=e.extent(t)[0]),e.next(t,i)},prev:function(t,i){return i=i===n?e.extent(t)[1]:n-1,e.prev(t,i)}}},i.modifier.before=i.modifier.b=function(e,t){var n=t[t.length-1];return{name:"before "+e.name,range:e.range*(n-1),val:e.val,isValid:function(e,t){return this.val(e)<n},extent:e.extent,start:e.start,end:e.end,next:function(t,i){return i=i===n?e.extent(t)[0]:n,e.next(t,i)},prev:function(t,i){return i=i===n?n-1:e.extent(t)[1],e.prev(t,i)}}},i.compile=function(e){var t,n,r,s,a,o,u,c=[],l=0;for(n in e)s=(r=n.split("_"))[0],a=r[1],o=e[n],u=a?i.modifier[a](i[s],o):i[s],c.push({constraint:u,vals:o}),l++;return c.sort((function(e,t){var n=e.constraint.range,i=t.constraint.range;return i<n?-1:i>n?1:0})),t=c[l-1].constraint,{start:function(e,n){for(var r,s,a,o,u,d,h=n,p=i.array[e],f=1e3;f--&&!r&&h;)for(r=!0,s=0;s<l;s++)if(o=(a=c[s].constraint).val(h),u=a.extent(h),d=p(o,c[s].vals,u),!a.isValid(h,d)){h=a[e](h,d),r=!1;break}return h!==i.NEVER&&(h="next"===e?t.start(h):t.end(h)),h},end:function(e,t){var n,r,s,a,o,u,d,h=i.array[e+"Invalid"],p=function(e){return"next"===e?function(e,t){return e.getTime()>t.getTime()}:function(e,t){return t.getTime()>e.getTime()}}(e);for(r=l-1;r>=0;r--)a=(s=c[r].constraint).val(t),o=s.extent(t),void 0!==(u=h(a,c[r].vals,o))&&(!(d=s[e](t,u))||n&&!p(n,d)||(n=d));return n},tick:function(e,n){return new Date("next"===e?t.end(n).getTime()+i.SEC:t.start(n).getTime()-i.SEC)},tickStart:function(e){return t.start(e)}}},i.schedule=function(e){function t(e,t,f,g,y){var w,b,A,S,T,C,E,M,k=d(e),I=t,D=1e3,P=[],_=[],$=[],x="next"===e,O=x?0:1,N=x?1:0;if(!(f=f?new Date(f):new Date)||!f.getTime())throw new Error("Invalid start date.");for(function(e,t,n,i){for(var r=0,s=t.length;r<s;r++)n[r]=t[r].start(e,i)}(e,p,P,f),function(e,t,n,r){var s,a,o;for(d(e),s=0,a=t.length;s<a;s++)o=t[s].start(e,r),n[s]=o?[o,t[s].end(e,o)]:i.NEVER}(e,m,_,f);D--&&I&&(w=h(P,k))&&(!g||!k(w,g));)if(v&&(s(e,m,_,w),b=u(e,_,w)))r(e,p,P,b);else{if(y){if(S=c(_,k),b=l(e,p,P,w,S),T=x?[new Date(Math.max(f,w)),b?new Date(g?Math.min(b,g):b):void 0]:[b?new Date(g?Math.max(g,b.getTime()+i.SEC):b.getTime()+i.SEC):void 0,new Date(Math.min(f,w.getTime()+i.SEC))],A&&T[O].getTime()===A[N].getTime()?(A[N]=T[N],I++):(A=T,$.push(A)),!b)break;r(e,p,P,b)}else $.push(x?new Date(Math.max(f,w)):o(p,P,w,g)),a(e,p,P,w);I--}for(C=0,E=$.length;C<E;C++)M=$[C],$[C]="[object Array]"===Object.prototype.toString.call(M)?[n(M[0]),n(M[1])]:n(M);return 0===$.length?i.NEVER:1===t?$[0]:$}function n(e){if(e instanceof Date&&!isNaN(e.valueOf()))return new Date(e)}function r(e,t,n,i){var r,s,a=d(e);for(r=0,s=t.length;r<s;r++)n[r]&&!a(n[r],i)&&(n[r]=t[r].start(e,i))}function s(e,t,n,r){var s,a,o,u=d(e);for(s=0,a=t.length;s<a;s++)n[s]&&!u(n[s][0],r)&&(o=t[s].start(e,r),n[s]=o?[o,t[s].end(e,o)]:i.NEVER)}function a(e,t,n,i){for(var r=0,s=t.length;r<s;r++)n[r]&&n[r].getTime()===i.getTime()&&(n[r]=t[r].start(e,t[r].tick(e,i)))}function o(e,t,n,i){var r,s,a,o;for(s=0,a=t.length;s<a;s++)if(t[s]&&t[s].getTime()===n.getTime()){if(o=e[s].tickStart(n),i&&o<i)return i;(!r||o>r)&&(r=o)}return r}function u(e,t,n){var i,r,s,a,o=d(e);for(r=0,s=t.length;r<s;r++)!(a=t[r])||o(a[0],n)||a[1]&&!o(a[1],n)||i&&!o(a[1],i)||(i=a[1]);return i}function c(e,t){var n,i,r;for(i=0,r=e.length;i<r;i++)!e[i]||n&&!t(n,e[i][0])||(n=e[i][0]);return n}function l(e,t,n,i,r){var s,a,o,u,c,l=d(e);for(a=0,o=t.length;a<o;a++)if((u=n[a])&&u.getTime()===i.getTime()){if(c=t[a].end(e,u),r&&(!c||l(c,r)))return r;s&&!l(c,s)||(s=c)}return s}function d(e){return"next"===e?function(e,t){return!t||e.getTime()>t.getTime()}:function(e,t){return!e||t.getTime()>e.getTime()}}function h(e,t){var n,i,r=e[0];for(n=1,i=e.length;n<i;n++)e[n]&&t(r,e[n])&&(r=e[n]);return r}var p,f,m,v,g,y;if(!e)throw new Error("Missing schedule definition.");if(!e.schedules)throw new Error("Definition must include at least one schedule.");for(p=[],f=e.schedules.length,m=[],v=e.exceptions?e.exceptions.length:0,g=0;g<f;g++)p.push(i.compile(e.schedules[g]));for(y=0;y<v;y++)m.push(i.compile(e.exceptions[y]));return{isValid:function(e){return t("next",1,e,e)!==i.NEVER},next:function(e,n,i){return t("next",e||1,n,i)},prev:function(e,n,i){return t("prev",e||1,n,i)},nextRange:function(e,n,i){return t("next",e||1,n,i,!0)},prevRange:function(e,n,i){return t("prev",e||1,n,i,!0)}}},i.setTimeout=function(e,t){var n,r=i.schedule(t);return e&&function t(){var i,s=Date.now(),a=r.next(2,s);a[0]?((i=a[0].getTime()-s)<1e3&&(i=a[1]?a[1].getTime()-s:1e3),n=i<2147483647?setTimeout(e,i):setTimeout(t,2147483647)):n=void 0}(),{isDone:function(){return!n},clear:function(){clearTimeout(n)}}},i.setInterval=function(e,t){var n,r;if(e)return n=i.setTimeout((function s(){r||(e(),n=i.setTimeout(s,t))}),t),r=n.isDone(),{isDone:function(){return n.isDone()},clear:function(){r=!0,n.clear()}}},i.date={},i.date.timezone=function(e){var t,n;i.date.build=e?function(e,t,n,i,r,s){return new Date(e,t,n,i,r,s)}:function(e,t,n,i,r,s){return new Date(Date.UTC(e,t,n,i,r,s))},t=e?"get":"getUTC",n=Date.prototype,i.date.getYear=n[t+"FullYear"],i.date.getMonth=n[t+"Month"],i.date.getDate=n[t+"Date"],i.date.getDay=n[t+"Day"],i.date.getHour=n[t+"Hours"],i.date.getMin=n[t+"Minutes"],i.date.getSec=n[t+"Seconds"],i.date.isUTC=!e},i.date.UTC=function(){i.date.timezone(!1)},i.date.localTime=function(){i.date.timezone(!0)},i.date.UTC(),i.SEC=1e3,i.MIN=60*i.SEC,i.HOUR=60*i.MIN,i.DAY=24*i.HOUR,i.WEEK=7*i.DAY,i.DAYS_IN_MONTH=[31,28,31,30,31,30,31,31,30,31,30,31],i.NEVER=0,i.date.next=function(e,t,n,r,s,a){return i.date.build(e,void 0!==t?t-1:0,void 0!==n?n:1,r||0,s||0,a||0)},i.date.nextRollover=function(e,t,n,r){var s=n.val(e),a=n.extent(e)[1];return(t||a)<=s||t>a?new Date(r.end(e).getTime()+i.SEC):r.start(e)},i.date.prev=function(e,t,n,r,s,a){var o=arguments.length;return t=o<2?11:t-1,n=o<3?i.D.extent(i.date.next(e,t+1))[1]:n,r=o<4?23:r,s=o<5?59:s,a=o<6?59:a,i.date.build(e,t,n,r,s,a)},i.date.prevRollover=function(e,t,n,i){return t>=n.val(e)||!t?i.start(i.prev(e,i.val(e)-1)):i.start(e)},i.parse={},i.parse.cron=function(e,t){function n(e,t,n){return isNaN(e)?o[e]||null:Math.min(Number(e)+(t||0),n||9999)}function i(e,t,n,i,r){var s=n;for(e[t]||(e[t]=[]);s<=i;)e[t].includes(s)||e[t].push(s),s+=r||1;e[t].sort((function(e,t){return e-t}))}function r(e,t,n,r){(t.d&&!t.dc||t.dc&&!t.dc.includes(r))&&(e.push(function(e){var t,n={};for(t in e)"dc"!==t&&"d"!==t&&(n[t]=e[t].slice(0));return n}(t)),t=e[e.length-1]),i(t,"d",n,n),i(t,"dc",r,r)}function s(e){return e.includes("#")||e.indexOf("L")>0}function a(e,t){return s(e)&&!s(t)?1:e-t}var o={JAN:1,FEB:2,MAR:3,APR:4,MAY:5,JUN:6,JUL:7,AUG:8,SEP:9,OCT:10,NOV:11,DEC:12,SUN:1,MON:2,TUE:3,WED:4,THU:5,FRI:6,SAT:7},u={"* * * * * *":"0/1 * * * * *","@YEARLY":"0 0 1 1 *","@ANNUALLY":"0 0 1 1 *","@MONTHLY":"0 0 1 * *","@WEEKLY":"0 0 * * 0","@DAILY":"0 0 * * *","@HOURLY":"0 * * * *"},c={s:[0,0,59],m:[1,0,59],h:[2,0,23],D:[3,1,31],M:[4,1,12],Y:[6,1970,2099],d:[5,1,7,1]},l=function(e){var t=e.toUpperCase();return u[t]||t}(e);return function(e){var t,s,u,l,d,h,p,f,m,v,g,y,w,b,A,S,T={schedules:[{}],exceptions:[]},C=e.replace(/(\s)+/g," ").split(" ");for(t in c)if((u=C[(s=c[t])[0]])&&"*"!==u&&"?"!==u)for(h=(l=u.split(",").sort(a)).length,d=0;d<h;d++)p=l[d],f=T,m=t,v=s[1],g=s[2],y=s[3],w=void 0,b=void 0,void 0,void 0,S=(A=f.schedules)[A.length-1],"L"===p&&(p=v-1),null!==(w=n(p,y,g))?i(S,m,w,w):null!==(w=n(p.replace("W",""),y,g))?function(e,t,n){var r={},s={};1===n?(i(t,"D",1,3),i(t,"d",o.MON,o.FRI),i(r,"D",2,2),i(r,"d",o.TUE,o.FRI),i(s,"D",3,3),i(s,"d",o.TUE,o.FRI)):(i(t,"D",n-1,n+1),i(t,"d",o.MON,o.FRI),i(r,"D",n-1,n-1),i(r,"d",o.MON,o.THU),i(s,"D",n+1,n+1),i(s,"d",o.TUE,o.FRI)),e.exceptions.push(r),e.exceptions.push(s)}(f,S,w):null!==(w=n(p.replace("L",""),y,g))?r(A,S,w,v-1):2===(b=p.split("#")).length?r(A,S,w=n(b[0],y,g),n(b[1])):function(e,t,r,s,a,o){var u,c=e.split("/"),l=Number(c[1]),d=c[0];"*"!==d&&"0"!==d&&(s=n((u=d.split("-"))[0],o,a),a=n(u[1],o,a)||a),i(t,r,s,a,l)}(p,S,m,v,g,y);return T}(t?l:"0 "+l)},i.parse.recur=function(){function e(e,i,d){var h,f;if(e=a?e+"_"+a:e,t||(p.push({}),t=p[0]),t[e]||(t[e]=[]),n=t[e],s){for(r=[],c=i;c<=d;c+=s)r.push(c);l={n:e,x:s,c:n.length,m:d}}for(h=(r=o?[i]:u?[d]:r).length,c=0;c<h;c+=1)f=r[c],n.includes(f)||n.push(f);r=s=a=o=u=0}var t,n,r,s,a,o,u,c,l,d=[],h=[],p=d;return{schedules:d,exceptions:h,on:function(){return r=Array.isArray(arguments[0])?arguments[0]:arguments,this},every:function(e){return s=e||1,this},after:function(e){return a="a",r=[e],this},before:function(e){return a="b",r=[e],this},first:function(){return o=1,this},last:function(){return u=1,this},time:function(){var t,n,i;for(t=0,n=r.length;t<n;t++)(i=r[t].split(":")).length<3&&i.push(0),r[t]=3600*Number(i[0])+60*Number(i[1])+Number(i[2]);return e("t"),this},second:function(){return e("s",0,59),this},minute:function(){return e("m",0,59),this},hour:function(){return e("h",0,23),this},dayOfMonth:function(){return e("D",1,u?0:31),this},dayOfWeek:function(){return e("d",1,7),this},onWeekend:function(){return r=[1,7],this.dayOfWeek()},onWeekday:function(){return r=[2,3,4,5,6],this.dayOfWeek()},dayOfWeekCount:function(){return e("dc",1,u?0:5),this},dayOfYear:function(){return e("dy",1,u?0:366),this},weekOfMonth:function(){return e("wm",1,u?0:5),this},weekOfYear:function(){return e("wy",1,u?0:53),this},month:function(){return e("M",1,12),this},year:function(){return e("Y",1970,2450),this},fullDate:function(){for(var t=0,n=r.length;t<n;t++)r[t]=r[t].getTime();return e("fd"),this},customModifier:function(e,t){var n=i.modifier[e];if(!n)throw new Error("Custom modifier "+e+" not recognized!");return a=e,r=Array.isArray(arguments[1])?arguments[1]:[arguments[1]],this},customPeriod:function(t){var n=i[t];if(!n)throw new Error("Custom time period "+t+" not recognized!");return e(t,n.extent(new Date)[0],n.extent(new Date)[1]),this},startingOn:function(e){return this.between(e,l.m)},between:function(n,i){return t[l.n]=t[l.n].splice(0,l.c),s=l.x,e(l.n,n,i),this},and:function(){return t=p[p.push({})-1],this},except:function(){return p=h,t=null,this}}},i.parse.text=function(e){function t(e,t,n,i){return{startPos:e,endPos:t,text:n,type:i}}function n(e){var n,i,r,s,a,o,u,c,l=Array.isArray(e)?e:[e],d=/\s+/;for(l.push(d),a=m;!n||n.type===d;){for(o=-1,i=v.slice(Math.max(0,a)),n=t(a,a,v.split(d)[0]),c=l.length,u=0;u<c;u++)(r=(s=l[u]).exec(i))&&0===r.index&&r[0].length>o&&(n=t(a,a+(o=r[0].length),i.slice(0,Math.max(0,o)),s));n.type===d&&(a=n.endPos)}return n}function r(e){var t=n(e);return m=t.endPos,t}function s(e){var t,n=Number(h(e)),i=l(g.through)?Number(h(e)):n,r=[];for(t=n;t<=i;t++)r.push(t);return r}function a(e){for(var t=s(e);l(g.and);)t=t.concat(s(e));return t}function o(e){var t,n,i,r;l(g.weekend)?e.on(y.sun,y.sat).dayOfWeek():l(g.weekday)?e.on(y.mon,y.tue,y.wed,y.thu,y.fri).dayOfWeek():(t=h(g.rank),e.every(t),n=c(e),l(g.start)?(t=h(g.rank),e.startingOn(t),d(n.type)):l(g.between)&&(i=h(g.rank),l(g.and)&&(r=h(g.rank),e.between(i,r))))}function u(e){l(g.first)?e.first():l(g.last)?e.last():e.on(a(g.rank)),c(e)}function c(e){var t=d([g.second,g.minute,g.hour,g.dayOfYear,g.dayOfWeek,g.dayInstance,g.day,g.month,g.year,g.weekOfMonth,g.weekOfYear]);switch(t.type){case g.second:e.second();break;case g.minute:e.minute();break;case g.hour:e.hour();break;case g.dayOfYear:e.dayOfYear();break;case g.dayOfWeek:e.dayOfWeek();break;case g.dayInstance:e.dayOfWeekCount();break;case g.day:e.dayOfMonth();break;case g.weekOfMonth:e.weekOfMonth();break;case g.weekOfYear:e.weekOfYear();break;case g.month:e.month();break;case g.year:e.year();break;default:p=m}return t}function l(e){var t=n(e).type===e;return t&&r(e),t}function d(e){var t=r(e);return t.type?t.text=function(e,t){var n,i,r,s=e;switch(t){case g.time:n=e.split(/(:|am|pm)/),i=Number.parseInt(n[0],10),r=n[2].trim(),"pm"===n[3]&&i<12?i+=12:"am"===n[3]&&12===i&&(i-=12),s=(1===(i=String(i)).length?"0":"")+i+":"+r;break;case g.rank:s=Number.parseInt(/^\d+/.exec(e)[0],10);break;case g.monthName:case g.dayName:s=y[e.slice(0,3)]}return s}(t.text,e):p=m,t}function h(e){return d(e).text}var p,f=i.parse.recur,m=0,v="",g={eof:/^$/,rank:/^((\d+)(st|nd|rd|th)?)\b/,time:/^(((0?[1-9]|1[0-2]):[0-5]\d(\s)?(am|pm))|((0?\d|1\d|2[0-3]):[0-5]\d))\b/,dayName:/^((sun|mon|tue(s)?|wed(nes)?|thu(r(s)?)?|fri|sat(ur)?)(day)?)\b/,monthName:/^(jan(uary)?|feb(ruary)?|ma((r(ch)?)?|y)|apr(il)?|ju(ly|ne)|aug(ust)?|oct(ober)?|(sept|nov|dec)(ember)?)\b/,yearIndex:/^(\d{4})\b/,every:/^every\b/,after:/^after\b/,before:/^before\b/,second:/^(s|sec(ond)?(s)?)\b/,minute:/^(m|min(ute)?(s)?)\b/,hour:/^(h|hour(s)?)\b/,day:/^(day(s)?( of the month)?)\b/,dayInstance:/^day instance\b/,dayOfWeek:/^day(s)? of the week\b/,dayOfYear:/^day(s)? of the year\b/,weekOfYear:/^week(s)?( of the year)?\b/,weekOfMonth:/^week(s)? of the month\b/,weekday:/^weekday\b/,weekend:/^weekend\b/,month:/^month(s)?\b/,year:/^year(s)?\b/,between:/^between (the)?\b/,start:/^(start(ing)? (at|on( the)?)?)\b/,at:/^(at|@)\b/,and:/^(,|and\b)/,except:/^(except\b)/,also:/(also)\b/,first:/^(first)\b/,last:/^last\b/,in:/^in\b/,of:/^of\b/,onthe:/^on the\b/,on:/^on\b/,through:/(-|^(to|through)\b)/},y={jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,oct:10,nov:11,dec:12,sun:1,mon:2,tue:3,wed:4,thu:5,fri:6,sat:7,"1st":1,fir:1,"2nd":2,sec:2,"3rd":3,thi:3,"4th":4,for:4};return function(e){var t;for(m=0,v=e,p=-1,t=f();m<v.length&&p<0;)switch(d([g.every,g.after,g.before,g.onthe,g.on,g.of,g.in,g.at,g.and,g.except,g.also]).type){case g.every:o(t);break;case g.after:void 0!==n(g.time).type?(t.after(h(g.time)),t.time()):(t.after(h(g.rank)),c(t));break;case g.before:void 0!==n(g.time).type?(t.before(h(g.time)),t.time()):(t.before(h(g.rank)),c(t));break;case g.onthe:u(t);break;case g.on:t.on(a(g.dayName)).dayOfWeek();break;case g.of:t.on(a(g.monthName)).month();break;case g.in:t.on(a(g.yearIndex)).year();break;case g.at:for(t.on(h(g.time)).time();l(g.and);)t.on(h(g.time)).time();break;case g.and:break;case g.also:t.and();break;case g.except:t.except();break;default:p=m}return{schedules:t.schedules,exceptions:t.exceptions,error:p}}(e.toLowerCase())},e.exports=i},2450:(e,t)=>{function n(e){return null==e}function i(e){return null!=e}Object.defineProperty(t,"__esModule",{value:!0}),t.flatMapOptional=t.mapOptional=t.unsafeUnwrapOptional=t.unwrapOptional=t.isSome=t.isNothing=t.unsafeUninitialized=void 0,t.unsafeUninitialized=function(){},t.isNothing=n,t.isSome=i,t.unwrapOptional=function(e){if(n(e))throw new ReferenceError;return e},t.unsafeUnwrapOptional=function(e){return e},t.mapOptional=function(e,t){return i(e)?t(e):e},t.flatMapOptional=function(e,t){return i(e)?t(e):e}},7322:function(e){var t,n,i,r,s,a,o,u,c,l,d,h,p,f,m,v,g,y,w,b,A,S,T;e.exports=(o="millisecond",u="second",c="minute",l="hour",d="day",h="week",p="month",f="quarter",m="year",v="date",g=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[^0-9]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?.?(\d+)?$/,y=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,w={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_")},b=function(e,t,n){var i=String(e);return!i||i.length>=t?e:""+Array(t+1-i.length).join(n)+e},A={s:b,z:function(e){var t=-e.utcOffset(),n=Math.abs(t),i=Math.floor(n/60),r=n%60;return(t<=0?"+":"-")+b(i,2,"0")+":"+b(r,2,"0")},m:function e(t,n){if(t.date()<n.date())return-e(n,t);var i=12*(n.year()-t.year())+(n.month()-t.month()),r=t.clone().add(i,p),s=n-r<0,a=t.clone().add(i+(s?-1:1),p);return+(-(i+(n-r)/(s?r-a:a-r))||0)},a:function(e){return e<0?Math.ceil(e)||0:Math.floor(e)},p:function(e){return{M:p,y:m,w:h,d,D:v,h:l,m:c,s:u,ms:o,Q:f}[e]||String(e||"").toLowerCase().replace(/s$/,"")},u:function(e){return void 0===e}},(T={})[S="en"]=w,t=function(e){return e instanceof s},n=function(e,t,n){var i,r;return e?("string"==typeof e?(T[e]&&(i=e),t&&(T[e]=t,i=e)):(r=e.name,T[r]=e,i=r),!n&&i&&(S=i),i||!n&&S):S},i=function(e,n){if(t(e))return e.clone();var i="object"==typeof n?n:{};return i.date=e,i.args=arguments,new s(i)},(r=A).l=n,r.i=t,r.w=function(e,t){return i(e,{locale:t.$L,utc:t.$u,x:t.$x,$offset:t.$offset})},s=function(){function e(e){this.$L=n(e.locale,null,!0),this.parse(e)}var t=e.prototype;return t.parse=function(e){this.$d=function(e){var t,n,i,s=e.date,a=e.utc;return null===s?new Date(NaN):r.u(s)?new Date:s instanceof Date?new Date(s):"string"==typeof s&&!/Z$/i.test(s)&&(t=s.match(g))?(n=t[2]-1||0,i=(t[7]||"0").substring(0,3),a?new Date(Date.UTC(t[1],n,t[3]||1,t[4]||0,t[5]||0,t[6]||0,i)):new Date(t[1],n,t[3]||1,t[4]||0,t[5]||0,t[6]||0,i)):new Date(s)}(e),this.$x=e.x||{},this.init()},t.init=function(){var e=this.$d;this.$y=e.getFullYear(),this.$M=e.getMonth(),this.$D=e.getDate(),this.$W=e.getDay(),this.$H=e.getHours(),this.$m=e.getMinutes(),this.$s=e.getSeconds(),this.$ms=e.getMilliseconds()},t.$utils=function(){return r},t.isValid=function(){return!("Invalid Date"===this.$d.toString())},t.isSame=function(e,t){var n=i(e);return this.startOf(t)<=n&&n<=this.endOf(t)},t.isAfter=function(e,t){return i(e)<this.startOf(t)},t.isBefore=function(e,t){return this.endOf(t)<i(e)},t.$g=function(e,t,n){return r.u(e)?this[t]:this.set(n,e)},t.unix=function(){return Math.floor(this.valueOf()/1e3)},t.valueOf=function(){return this.$d.getTime()},t.startOf=function(e,t){var n,i,s=this,a=!!r.u(t)||t,o=r.p(e),f=function(e,t){var n=r.w(s.$u?Date.UTC(s.$y,t,e):new Date(s.$y,t,e),s);return a?n:n.endOf(d)},g=function(e,t){return r.w(s.toDate()[e].apply(s.toDate("s"),(a?[0,0,0,0]:[23,59,59,999]).slice(t)),s)},y=this.$W,w=this.$M,b=this.$D,A="set"+(this.$u?"UTC":"");switch(o){case m:return a?f(1,0):f(31,11);case p:return a?f(1,w):f(0,w+1);case h:return i=(y<(n=this.$locale().weekStart||0)?y+7:y)-n,f(a?b-i:b+(6-i),w);case d:case v:return g(A+"Hours",0);case l:return g(A+"Minutes",1);case c:return g(A+"Seconds",2);case u:return g(A+"Milliseconds",3);default:return this.clone()}},t.endOf=function(e){return this.startOf(e,!1)},t.$set=function(e,t){var n,i,s=r.p(e),a="set"+(this.$u?"UTC":""),h=(n={},n[d]=a+"Date",n[v]=a+"Date",n[p]=a+"Month",n[m]=a+"FullYear",n[l]=a+"Hours",n[c]=a+"Minutes",n[u]=a+"Seconds",n[o]=a+"Milliseconds",n)[s],f=s===d?this.$D+(t-this.$W):t;return s===p||s===m?((i=this.clone().set(v,1)).$d[h](f),i.init(),this.$d=i.set(v,Math.min(this.$D,i.daysInMonth())).$d):h&&this.$d[h](f),this.init(),this},t.set=function(e,t){return this.clone().$set(e,t)},t.get=function(e){return this[r.p(e)]()},t.add=function(e,t){var n,s,a,o,f,v=this;return e=Number(e),a=function(t){var n=i(v);return r.w(n.date(n.date()+Math.round(t*e)),v)},(s=r.p(t))===p?this.set(p,this.$M+e):s===m?this.set(m,this.$y+e):s===d?a(1):s===h?a(7):(o=(n={},n[c]=6e4,n[l]=36e5,n[u]=1e3,n)[s]||1,f=this.$d.getTime()+e*o,r.w(f,this))},t.subtract=function(e,t){return this.add(-1*e,t)},t.format=function(e){var t,n,i,s,a,o,u,c,l,d,h,p,f=this;return this.isValid()?(t=e||"YYYY-MM-DDTHH:mm:ssZ",n=r.z(this),i=this.$locale(),s=this.$H,a=this.$m,o=this.$M,u=i.weekdays,c=i.months,l=function(e,n,i,r){return e&&(e[n]||e(f,t))||i[n].substr(0,r)},d=function(e){return r.s(s%12||12,e,"0")},h=i.meridiem||function(e,t,n){var i=e<12?"AM":"PM";return n?i.toLowerCase():i},p={YY:String(this.$y).slice(-2),YYYY:this.$y,M:o+1,MM:r.s(o+1,2,"0"),MMM:l(i.monthsShort,o,c,3),MMMM:l(c,o),D:this.$D,DD:r.s(this.$D,2,"0"),d:String(this.$W),dd:l(i.weekdaysMin,this.$W,u,2),ddd:l(i.weekdaysShort,this.$W,u,3),dddd:u[this.$W],H:String(s),HH:r.s(s,2,"0"),h:d(1),hh:d(2),a:h(s,a,!0),A:h(s,a,!1),m:String(a),mm:r.s(a,2,"0"),s:String(this.$s),ss:r.s(this.$s,2,"0"),SSS:r.s(this.$ms,3,"0"),Z:n},t.replace(y,(function(e,t){return t||p[e]||n.replace(":","")}))):"Invalid Date"},t.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},t.diff=function(e,t,n){var s,a=r.p(t),o=i(e),v=6e4*(o.utcOffset()-this.utcOffset()),g=this-o,y=r.m(this,o);return y=(s={},s[m]=y/12,s[p]=y,s[f]=y/3,s[h]=(g-v)/6048e5,s[d]=(g-v)/864e5,s[l]=g/36e5,s[c]=g/6e4,s[u]=g/1e3,s)[a]||g,n?y:r.a(y)},t.daysInMonth=function(){return this.endOf(p).$D},t.$locale=function(){return T[this.$L]},t.locale=function(e,t){if(!e)return this.$L;var i=this.clone(),r=n(e,t,!0);return r&&(i.$L=r),i},t.clone=function(){return r.w(this.$d,this)},t.toDate=function(){return new Date(this.valueOf())},t.toJSON=function(){return this.isValid()?this.toISOString():null},t.toISOString=function(){return this.$d.toISOString()},t.toString=function(){return this.$d.toUTCString()},e}(),a=s.prototype,i.prototype=a,[["$ms",o],["$s",u],["$m",c],["$H",l],["$W",d],["$M",p],["$y",m],["$D",v]].forEach((function(e){a[e[1]]=function(t){return this.$g(t,e[0],e[1])}})),i.extend=function(e,t){return e.$i||(e(t,s,i),e.$i=!0),i},i.locale=n,i.isDayjs=t,i.unix=function(e){return i(1e3*e)},i.en=T[S],i.Ls=T,i.p={},i)},267:function(e){var t,n,i,r,s,a,o,u,c;e.exports=(i=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,r=/^(-|\+)?P(?:([-+]?[0-9,.]*)Y)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)W)?(?:([-+]?[0-9,.]*)D)?(?:T(?:([-+]?[0-9,.]*)H)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)S)?)?$/,s={years:31536e6,months:2592e6,days:864e5,hours:36e5,minutes:6e4,seconds:1e3,milliseconds:1,weeks:6048e5},a=function(e){return e instanceof c},o=function(e,t,n){return new c(e,n,t.$l)},u=function(e){return n.p(e)+"s"},c=function(){function e(e,t,n){var i,a=this;return this.$d={},this.$l=n,t?o(e*s[u(t)],this):"number"==typeof e?(this.$ms=e,this.parseFromMilliseconds(),this):"object"==typeof e?(Object.keys(e).forEach((function(t){a.$d[u(t)]=e[t]})),this.calMilliseconds(),this):"string"==typeof e&&(i=e.match(r))?(this.$d.years=i[2],this.$d.months=i[3],this.$d.weeks=i[4],this.$d.days=i[5],this.$d.hours=i[6],this.$d.minutes=i[7],this.$d.seconds=i[8],this.calMilliseconds(),this):this}var c=e.prototype;return c.calMilliseconds=function(){var e=this;this.$ms=Object.keys(this.$d).reduce((function(t,n){return t+(e.$d[n]||0)*s[n]}),0)},c.parseFromMilliseconds=function(){var e=this.$ms;this.$d.years=Math.floor(e/31536e6),e%=31536e6,this.$d.months=Math.floor(e/2592e6),e%=2592e6,this.$d.days=Math.floor(e/864e5),e%=864e5,this.$d.hours=Math.floor(e/36e5),e%=36e5,this.$d.minutes=Math.floor(e/6e4),e%=6e4,this.$d.seconds=Math.floor(e/1e3),e%=1e3,this.$d.milliseconds=e},c.toISOString=function(){var e,t,n,i,r,s,a=this.$d.years?this.$d.years+"Y":"",o=this.$d.months?this.$d.months+"M":"",u=+this.$d.days||0;return this.$d.weeks&&(u+=7*this.$d.weeks),e=u?u+"D":"",t=this.$d.hours?this.$d.hours+"H":"",n=this.$d.minutes?this.$d.minutes+"M":"",i=this.$d.seconds||0,this.$d.milliseconds&&(i+=this.$d.milliseconds/1e3),r=i?i+"S":"","P"==(s="P"+a+o+e+(t||n||r?"T":"")+t+n+r)?"P0D":s},c.toJSON=function(){return this.toISOString()},c.format=function(e){var t=e||"YYYY-MM-DDTHH:mm:ss",r={Y:this.$d.years,YY:n.s(this.$d.years,2,"0"),YYYY:n.s(this.$d.years,4,"0"),M:this.$d.months,MM:n.s(this.$d.months,2,"0"),D:this.$d.days,DD:n.s(this.$d.days,2,"0"),H:this.$d.hours,HH:n.s(this.$d.hours,2,"0"),m:this.$d.minutes,mm:n.s(this.$d.minutes,2,"0"),s:this.$d.seconds,ss:n.s(this.$d.seconds,2,"0"),SSS:n.s(this.$d.milliseconds,3,"0")};return t.replace(i,(function(e,t){return t||String(r[e])}))},c.as=function(e){return this.$ms/s[u(e)]},c.get=function(e){var t=this.$ms,n=u(e);return"milliseconds"===n?t%=1e3:t="weeks"===n?Math.floor(t/s[n]):this.$d[n],t},c.add=function(e,t,n){var i;return i=t?e*s[u(t)]:a(e)?e.$ms:o(e,this).$ms,o(this.$ms+i*(n?-1:1),this)},c.subtract=function(e,t){return this.add(e,t,!0)},c.locale=function(e){var t=this.clone();return t.$l=e,t},c.clone=function(){return o(this.$ms,this)},c.humanize=function(e){return t().add(this.$ms,"ms").locale(this.$l).fromNow(!e)},c.milliseconds=function(){return this.get("milliseconds")},c.asMilliseconds=function(){return this.as("milliseconds")},c.seconds=function(){return this.get("seconds")},c.asSeconds=function(){return this.as("seconds")},c.minutes=function(){return this.get("minutes")},c.asMinutes=function(){return this.as("minutes")},c.hours=function(){return this.get("hours")},c.asHours=function(){return this.as("hours")},c.days=function(){return this.get("days")},c.asDays=function(){return this.as("days")},c.weeks=function(){return this.get("weeks")},c.asWeeks=function(){return this.as("weeks")},c.months=function(){return this.get("months")},c.asMonths=function(){return this.as("months")},c.years=function(){return this.get("years")},c.asYears=function(){return this.as("years")},e}(),function(e,i,r){t=r,n=r().$utils(),r.duration=function(e,t){var n=r.locale();return o(e,{$l:n},t)},r.isDuration=a;var s=i.prototype.add,u=i.prototype.subtract;i.prototype.add=function(e,t){return a(e)&&(e=e.asMilliseconds()),s.bind(this)(e,t)},i.prototype.subtract=function(e,t){return a(e)&&(e=e.asMilliseconds()),u.bind(this)(e,t)}})},9978:function(e){e.exports=function(e,t,n){t.prototype.isBetween=function(e,t,i,r){var s=n(e),a=n(t),o="("===(r=r||"()")[0],u=")"===r[1];return(o?this.isAfter(s,i):!this.isBefore(s,i))&&(u?this.isBefore(a,i):!this.isAfter(a,i))||(o?this.isBefore(s,i):!this.isAfter(s,i))&&(u?this.isAfter(a,i):!this.isBefore(a,i))}}},3156:(e,t,n)=>{var i=n(5368),r=n(5328);e.exports=i,e.exports.murmur3=i,e.exports.murmur2=r},5328:e=>{e.exports=function(e,t){for(var n,i=e.length,r=t^i,s=0;i>=4;)n=1540483477*(65535&(n=255&e.charCodeAt(s)|(255&e.charCodeAt(++s))<<8|(255&e.charCodeAt(++s))<<16|(255&e.charCodeAt(++s))<<24))+((1540483477*(n>>>16)&65535)<<16),r=1540483477*(65535&r)+((1540483477*(r>>>16)&65535)<<16)^(n=1540483477*(65535&(n^=n>>>24))+((1540483477*(n>>>16)&65535)<<16)),i-=4,++s;switch(i){case 3:r^=(255&e.charCodeAt(s+2))<<16;case 2:r^=(255&e.charCodeAt(s+1))<<8;case 1:r=1540483477*(65535&(r^=255&e.charCodeAt(s)))+((1540483477*(r>>>16)&65535)<<16)}return r=1540483477*(65535&(r^=r>>>13))+((1540483477*(r>>>16)&65535)<<16),(r^=r>>>15)>>>0}},5368:e=>{e.exports=function(e,t){var n,i,r,s,a,o,u,c;for(n=3&e.length,i=e.length-n,r=t,a=3432918353,o=461845907,c=0;c<i;)u=255&e.charCodeAt(c)|(255&e.charCodeAt(++c))<<8|(255&e.charCodeAt(++c))<<16|(255&e.charCodeAt(++c))<<24,++c,r=27492+(65535&(s=5*(65535&(r=(r^=u=(65535&(u=(u=(65535&u)*a+(((u>>>16)*a&65535)<<16)&4294967295)<<15|u>>>17))*o+(((u>>>16)*o&65535)<<16)&4294967295)<<13|r>>>19))+((5*(r>>>16)&65535)<<16)&4294967295))+((58964+(s>>>16)&65535)<<16);switch(u=0,n){case 3:u^=(255&e.charCodeAt(c+2))<<16;case 2:u^=(255&e.charCodeAt(c+1))<<8;case 1:r^=u=(65535&(u=(u=(65535&(u^=255&e.charCodeAt(c)))*a+(((u>>>16)*a&65535)<<16)&4294967295)<<15|u>>>17))*o+(((u>>>16)*o&65535)<<16)&4294967295}return r^=e.length,r=2246822507*(65535&(r^=r>>>16))+((2246822507*(r>>>16)&65535)<<16)&4294967295,r=3266489909*(65535&(r^=r>>>13))+((3266489909*(r>>>16)&65535)<<16)&4294967295,(r^=r>>>16)>>>0}},6620:function(e,t,n){function i(e,t){return null!=e&&null==t?1:null==e&&null!=t?-1:null==e&&null==t?0:null}function r(e){return!!c.isDate(e)||a.default(e).isValid()}function s(e){return e instanceof u.VersionNumber}var a,o,u,c,l,d,h,p,f,m,v,g,y=this&&this.__spreadArray||function(e,t){for(var n=0,i=t.length,r=e.length;n<i;n++,r++)e[r]=t[n];return e},w=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ValuesArray=t.TimeRange=t.ValueRange=t.GenericComparable=t.GenericComparator=void 0,a=w(n(8798)),o=w(n(4469)),u=n(7901),c=n(1317),a.default.extend(o.default),l=/^\s*(-?[\d]+\.[\d]+)$/,d=/^\s*(-?[\d]+)$/,h=new(Set.bind.apply(Set,y([void 0],["true","false"]))),p=function(){function e(){}return e.prototype.compare=function(e,t){var n,r;return i(e,t)||(n=new f(e),r=new f(t),n.compareTo(r))},e}(),t.GenericComparator=p,f=function(){function e(e){this.value=e}return e.prototype.compareTo=function(e){var t,n,o;return e?(t=i(this.value,e.value))?t:function(e,t){return"boolean"==typeof e&&"boolean"==typeof t||"boolean"==typeof e&&"string"==typeof t&&h.has(t.toLowerCase())||"boolean"==typeof t&&"string"==typeof e&&h.has(e.toLowerCase())}(this.value,e.value)?this.toResultNum(Boolean(this.value),Boolean(e.value)):function(e,t){return(c.isNumber(e)&&Number.isFinite(e)||c.isString(e)&&(null!==l.exec(e)||null!==d.exec(e)))&&(c.isNumber(t)&&Number.isFinite(t)||c.isString(t)&&(null!==l.exec(t)||null!==d.exec(t)))}(this.value,e.value)?this.toResultNum(Number.parseFloat(this.value.toString()),Number.parseFloat(e.value.toString())):(t=function(e,t){return s(e)&&s(t)?e.compareTo(t):s(e)&&c.isString(t)?e.compareTo(new u.VersionNumber(t)):c.isString(e)&&s(t)?-t.compareTo(new u.VersionNumber(e)):null}(this.value,e.value),null!=t?t:function(e,t){return r(e)&&r(t)}(this.value,e.value)?(n=(n=a.default(this.value)).millisecond(0),o=(o=a.default(e.value)).millisecond(0),this.toResultNum(n.valueOf(),o.valueOf())):this.defaultComparison(e)):1},e.prototype.defaultComparison=function(e){var t=null!==this.value&&void 0!==this.value?this.value.toString():null,n=null!==e.value&&void 0!==e.value?e.value.toString():null;return null==t&&null!=n?-1:null!=t&&null==n?1:null==t&&null==n?0:this.toResultNum(t,n)},e.prototype.toResultNum=function(e,t){return e>t?1:e===t?0:-1},e}(),t.GenericComparable=f,m=function(e,t){this.from=e,this.to=t,this.value=this},t.ValueRange=m,v=function(){function e(e,t){this.duration=e,this.timeUnit=t,this.value=this}return e.prototype.toMillis=function(){return a.default.duration(this.duration,this.timeUnit).asMilliseconds()},e}(),t.TimeRange=v,g=function(e){this.value=e},t.ValuesArray=g},8205:function(e,t,n){var i,r,s=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),a=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||s(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),t.VersionNumber=t.ValidTimeUnits=t.TimeUnit=t.Parser=void 0,i=n(6272),Object.defineProperty(t,"Parser",{enumerable:!0,get:function(){return i.Parser}}),r=n(7901),Object.defineProperty(t,"TimeUnit",{enumerable:!0,get:function(){return r.TimeUnit}}),Object.defineProperty(t,"ValidTimeUnits",{enumerable:!0,get:function(){return r.ValidTimeUnits}}),Object.defineProperty(t,"VersionNumber",{enumerable:!0,get:function(){return r.VersionNumber}}),a(n(918),t),a(n(1467),t),a(n(6620),t)},483:(e,t)=>{var n,i,r,s,a,o,u;Object.defineProperty(t,"__esModule",{value:!0}),t.Lex=void 0,n=/^\s*(['"])(.*?)\1/,i=/^\s*([a-zA-Z_$]\w*)/,r=/^\s*(true|false)/i,s=/^\s*(-?[\d]+\.[\d]+)/,a=/^\s*(-?[\d]+)/,o=/^\s*(.[^\s()]*)\s*/,u=function(){function e(e){this.boolVal=!1,this.source=e,this.pos=0,this.ch=e&&e.length>0?e[0]:" "}return e.prototype.getPos=function(){return this.pos},e.prototype.getTokenVal=function(){return this.tokenVal},e.prototype.getBoolVal=function(){return this.boolVal},e.prototype.getLongVal=function(){return this.longVal},e.prototype.getDoubleVal=function(){return this.doubleVal},e.prototype.getStringVal=function(){return this.stringVal},e.prototype.getIdentifierVal=function(){return this.identifierVal},e.prototype.eat=function(e){var t;return this.skipWhitespace(),t=this.pos,this.pos+e.length<=this.source.length&&this.source.substr(t,e.length).toLowerCase()===e.toLowerCase()&&(this.skipChars(e.length),!0)},e.prototype.mustEat=function(e){if(!this.eat(e))throw Error("InvalidSyntaxError: Expected "+e+" at position "+this.pos)},e.prototype.eatToken=function(){var e=this;return this.eatRegEx(o,(function(t){return e.tokenVal=t}))},e.prototype.eatIdentifier=function(){var e=this;return this.eatRegEx(i,(function(t){return e.identifierVal=t}))},e.prototype.eatString=function(){var e=this;return this.eatRegEx(n,(function(t){return e.stringVal=t}))},e.prototype.eatBool=function(){var e=this;return this.eatRegEx(r,(function(t){return e.boolVal="true"===t.toLowerCase().trim()}))},e.prototype.eatLong=function(){var e=this;return this.eatRegEx(a,(function(t){return e.longVal=Number.parseInt(t)}))},e.prototype.eatDouble=function(){var e=this;return this.eatRegEx(s,(function(t){return e.doubleVal=Number.parseFloat(t)}))},e.prototype.endOfInput=function(){var e,t=this.pos;do{e=++t<this.source.length?this.source[t]:void 0}while(void 0!==e&&this.isWhitespace(e));return void 0===e},e.prototype.eatRegEx=function(e,t){var n,i=this.source.substr(this.pos),r=e.exec(i);return null!==r&&(n=r.length<3?r[1]:r[2],this.pos+=r.index+r[0].length,this.updateCurrentCharacter(),t(n)),null!==r},e.prototype.nextChar=function(){return this.pos+1>=this.source.length?(this.ch=void 0,!1):(this.pos++,this.ch=this.source[this.pos],!0)},e.prototype.updateCurrentCharacter=function(){this.ch=this.pos<this.source.length?this.source[this.pos]:void 0},e.prototype.skipChars=function(e){this.pos+=e,this.updateCurrentCharacter()},e.prototype.skipWhitespace=function(){for(;void 0!==this.ch&&this.isWhitespace(this.ch)&&this.nextChar(););},e.prototype.isWhitespace=function(e){return" "===e||"\t"===e||"\n"===e},e}(),t.Lex=u},1467:function(e,t,n){function i(e){var t=g.get(e.symbol);if(!t)throw new Error('Cannot get comparison operator handler for "'+e.symbol+'".');return t.handler}function r(e){var t=w.get(e.symbol);if(!t)throw new Error('Cannot get lambda operator handler for "'+e.symbol+'".');return t.handler}function s(e,t){g.set(e.symbol,new v(e,t))}function a(e,t){y.set(e.symbol,new v(e,t))}function o(e,t){w.set(e.symbol,new v(e,t))}function u(e){return null!=e&&"function"==typeof e[Symbol.iterator]}var c,l,d,h,p,f,m,v,g,y,w,b,A,S,T=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.isLambdaOperator=t.getLambdaOperatorHandler=t.getLogicalOperatorHandler=t.getComparisonOperatorHandler=t.LambdaContext=t.Operators=t.Operator=t.OperandType=void 0,c=T(n(8798)),l=n(6620),d=n(1317),h=n(7901),(S=t.OperandType||(t.OperandType={}))[S.BOOLEAN=0]="BOOLEAN",S[S.INTEGER=1]="INTEGER",S[S.FLOAT=2]="FLOAT",S[S.DATE=3]="DATE",S[S.PROPERTY=4]="PROPERTY",S[S.NIL=5]="NIL",S[S.STRING=6]="STRING",S[S.BETWEEN_RANGE=7]="BETWEEN_RANGE",S[S.TIME_RANGE=8]="TIME_RANGE",S[S.IN_VALUES=9]="IN_VALUES",S[S.USER=10]="USER",S[S.OBJECT_LITERAL=11]="OBJECT_LITERAL",S[S.FUNCTION_CALL=12]="FUNCTION_CALL",S[S.NOT_IN_VALUES=13]="NOT_IN_VALUES",p=function(){function e(e,t){this._symbol=e,this._isLogical=t}return Object.defineProperty(e.prototype,"symbol",{get:function(){return this._symbol},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isLogical",{get:function(){return this._isLogical},enumerable:!1,configurable:!0}),e}(),t.Operator=p,f=function(){function e(){}return e.AND=new p("AND",!0),e.OR=new p("OR",!0),e.NOT=new p("NOT",!0),e.GT=new p(">",!1),e.GTE=new p(">=",!1),e.LT=new p("<",!1),e.LTE=new p("<=",!1),e.EQ=new p("==",!1),e.NEQ=new p("!=",!1),e.BETWEEN=new p("between",!1),e.BEFORE_LAST=new p("before last",!1),e.AFTER_LAST=new p("after last",!1),e.BEFORE_NEXT=new p("before next",!1),e.AFTER_NEXT=new p("after next",!1),e.IN_THE_PAST=new p("is in the past",!1),e.IN_THE_FUTURE=new p("is in the future",!1),e.EXACT_TIME_AGO=new p("is some time ago",!1),e.IN_THE_LAST=new p("in the last",!1),e.NOT_IN_THE_LAST=new p("not in the last",!1),e.IN_THE_NEXT=new p("in the next",!1),e.NOT_IN_THE_NEXT=new p("not in the next",!1),e.STARTS_WITH=new p("starts with",!1),e.ENDS_WITH=new p("ends with",!1),e.CONTAINS=new p("contains",!1),e.DOES_NOT_CONTAIN=new p("does not contain",!1),e.LIKE=new p("~",!1),e.IN=new p("in",!1),e.NOT_IN=new p("not in",!1),e.CONTAINS_ITEM=new p("contains_item",!1),e.NOT_CONTAINS_ITEM=new p("not contains_item",!1),e.COUNT_MATCHES=new p("count_matches",!1),e.IS_EMPTY=new p("is empty",!1),e.IS_NOT_EMPTY=new p("is not empty",!1),e.IS_DEFINED=new p("is defined",!1),e.IS_UNDEFINED=new p("is undefined",!1),e.UNKNOWN=new p("n/a",!1),e}(),t.Operators=f,m=function(e,t){this.argName=e,this.container=t},t.LambdaContext=m,v=function(e,t){this.operator=e,this.handler=t},g=new Map,y=new Map,w=new Map,b=new l.GenericComparator,t.getComparisonOperatorHandler=i,t.getLogicalOperatorHandler=function(e){var t=y.get(e.symbol);if(!t)throw new Error('Cannot get logical operator handler for "'+e.symbol+'".');return t.handler},t.getLambdaOperatorHandler=r,t.isLambdaOperator=function(e){return w.has(e.symbol)},(A=new Map).set(h.TimeUnit.Seconds,"second"),A.set(h.TimeUnit.Minutes,"minute"),A.set(h.TimeUnit.Hours,"hour"),A.set(h.TimeUnit.Days,"day"),A.set(h.TimeUnit.Weeks,"week"),A.set(h.TimeUnit.Months,"month"),a(f.AND,(function(e,t){return e.eval()&&t.eval()})),a(f.OR,(function(e,t){return e.eval()||t.eval()})),a(f.NOT,(function(e,t){return!e.eval()})),s(f.EQ,(function(e,t){return 0==b.compare(e,t)})),s(f.NEQ,(function(e,t){return 0!==b.compare(e,t)})),s(f.GT,(function(e,t){return 1==b.compare(e,t)})),s(f.GTE,(function(e,t){return b.compare(e,t)>=0})),s(f.LT,(function(e,t){return b.compare(e,t)<0})),s(f.LTE,(function(e,t){return b.compare(e,t)<=0})),s(f.BETWEEN,(function(e,t){return t instanceof l.ValueRange&&b.compare(e,t.from)>=0&&b.compare(e,t.to)<0})),s(f.BEFORE_LAST,(function(e,t){var n;return!!(c.default(e).isValid()&&t instanceof l.TimeRange)&&(n=c.default().valueOf()-t.toMillis(),b.compare(e,n)<=0)})),s(f.BEFORE_NEXT,(function(e,t){var n;return!!(c.default(e).isValid()&&t instanceof l.TimeRange)&&(n=c.default().valueOf()+t.toMillis(),b.compare(e,n)<=0)})),s(f.AFTER_LAST,(function(e,t){var n;return!!(c.default(e).isValid()&&t instanceof l.TimeRange)&&(n=c.default().valueOf()-t.toMillis(),b.compare(e,n)>=0)})),s(f.AFTER_NEXT,(function(e,t){var n;return!!(c.default(e).isValid()&&t instanceof l.TimeRange)&&(n=c.default().valueOf()+t.toMillis(),b.compare(e,n)>=0)})),s(f.IN_THE_PAST,(function(e,t){if(!c.default(e).isValid())return!1;var n=c.default().valueOf();return b.compare(e,n)<0})),s(f.IN_THE_FUTURE,(function(e,t){if(!c.default(e).isValid())return!1;var n=c.default().valueOf();return b.compare(e,n)>0})),s(f.IN_THE_NEXT,(function(e,t){var n,i;return!!(c.default(e).isValid()&&t instanceof l.TimeRange)&&(i=(n=c.default().valueOf())+t.toMillis(),b.compare(e,n)>=0&&b.compare(e,i)<=0)})),s(f.NOT_IN_THE_NEXT,(function(e,t){return!!(c.default(e).isValid()&&t instanceof l.TimeRange)&&!i(f.IN_THE_NEXT)(e,t)})),s(f.IN_THE_LAST,(function(e,t){var n,i;return!!(c.default(e).isValid()&&t instanceof l.TimeRange)&&(i=(n=c.default().valueOf())-t.toMillis(),b.compare(e,i)>=0&&b.compare(e,n)<=0)})),s(f.NOT_IN_THE_LAST,(function(e,t){return!!(c.default(e).isValid()&&t instanceof l.TimeRange)&&!i(f.IN_THE_LAST)(e,t)})),s(f.EXACT_TIME_AGO,(function(e,t){var n,i,r=c.default(e);if(!(r.isValid()&&t instanceof l.TimeRange))return!1;if(n=c.default(),!(i=A.get(t.timeUnit)))throw Error("Unsupported time unit "+t.timeUnit);return n.subtract(t.duration,i).isSame(r,i)})),s(f.IN,(function(e,t){return!!(e&&t instanceof l.ValuesArray)&&t.value.some((function(t){return 0===b.compare(t,e)}))})),s(f.NOT_IN,(function(e,t){return!i(f.IN)(e,t)})),s(f.IS_UNDEFINED,(function(e,t){return null==e})),s(f.IS_DEFINED,(function(e,t){return null!=e})),s(f.IS_EMPTY,(function(e,t){return!e||(e instanceof Set||d.isSet(e)?0===e.size:e instanceof Array||Array.isArray(e)?0===e.length:e instanceof h.VersionNumber&&""===e.versionString)})),s(f.IS_NOT_EMPTY,(function(e,t){return!i(f.IS_EMPTY)(e,t)})),s(f.STARTS_WITH,(function(e,t){return!(!d.isString(e)||!d.isString(t))&&e.startsWith(t)})),s(f.ENDS_WITH,(function(e,t){return!(!d.isString(e)||!d.isString(t))&&e.endsWith(t)})),s(f.CONTAINS,(function(e,t){return!(!d.isString(e)||!d.isString(t))&&e.indexOf(t)>=0})),s(f.DOES_NOT_CONTAIN,(function(e,t){return!(!d.isString(e)||!d.isString(t))&&-1===e.indexOf(t)})),s(f.LIKE,(function(e,t){return!(!d.isString(e)||!d.isString(t))&&e.toLowerCase()===t.toLowerCase()})),o(f.CONTAINS_ITEM,(function(e,t,n){var i,r,s,a=!1,o=e.getBoundValue(t.argName);if(!u(t.container))throw new Error("Container is not iterable.");for(i=0,r=t.container;i<r.length;i++)if(s=r[i],e.bindValue(t.argName,s),n.eval()){a=!0;break}return o&&e.bindValue(t.argName,o),a})),o(f.NOT_CONTAINS_ITEM,(function(e,t,n){return!r(f.CONTAINS_ITEM)(e,t,n)})),o(f.COUNT_MATCHES,(function(e,t,n){var i,r,s,a=0,o=e.getBoundValue(t.argName);if(!u(t.container))throw new Error("Container is not iterable.");for(i=0,r=t.container;i<r.length;i++)s=r[i],e.bindValue(t.argName,s),n.eval()&&a++;return o&&e.bindValue(t.argName,o),a}))},6272:(e,t,n)=>{var i,r,s,a,o,u;Object.defineProperty(t,"__esModule",{value:!0}),t.Parser=void 0,i=n(483),r=n(918),s=n(1467),a=n(7901),o=function(){function e(e,t,n){this.amount=e,this.timeUnit=t,this.error=n}return e.prototype.hasError=function(){var e;return(null===(e=this.error)||void 0===e?void 0:e.length)>0},e}(),u=function(){function e(e){if(this.expression=e.replace(/\s\s+/g," "),!this.expression||0==this.expression.trim().length)throw new Error("Empty expression");this.lex=new i.Lex(this.expression)}return e.prototype.parseTree=function(){var e=this.parseTreeRecursive();if(!this.lex.endOfInput())throw new Error("Unrecognized input at '"+this.expression.substr(this.lex.getPos())+"'");return e},e.prototype.parseTreeRecursive=function(){for(var e,t=this.parseTermNode();;)if(this.lex.eat(s.Operators.AND.symbol))e=this.parseTreeRecursive(),t=new r.BinaryTermNode(s.Operators.AND,t,e);else if(this.lex.eat(s.Operators.OR.symbol))e=this.parseTreeRecursive(),t=new r.BinaryTermNode(s.Operators.OR,t,e);else if(this.lex.eat(s.Operators.EQ.symbol))e=this.parseTermNode(),t=new r.BinaryTermNode(s.Operators.EQ,t,e);else if(this.lex.eat(s.Operators.NEQ.symbol))e=this.parseTermNode(),t=new r.BinaryTermNode(s.Operators.NEQ,t,e);else if(this.lex.eat(s.Operators.GTE.symbol))e=this.parseTermNode(),t=new r.BinaryTermNode(s.Operators.GTE,t,e);else if(this.lex.eat(s.Operators.GT.symbol))e=this.parseTermNode(),t=new r.BinaryTermNode(s.Operators.GT,t,e);else if(this.lex.eat(s.Operators.LTE.symbol))e=this.parseTermNode(),t=new r.BinaryTermNode(s.Operators.LTE,t,e);else if(this.lex.eat(s.Operators.LT.symbol))e=this.parseTermNode(),t=new r.BinaryTermNode(s.Operators.LT,t,e);else{if(!this.lex.eat(s.Operators.COUNT_MATCHES.symbol))break;if(!(t instanceof r.PropertyReferenceFactor||t instanceof r.FunctionCallFactor))throw new Error("An identifier is expected before the operator "+s.Operators.COUNT_MATCHES.symbol);t=new r.BinaryTermNode(s.Operators.COUNT_MATCHES,t,this.parseItemPredicate())}return t},e.prototype.parseTermNode=function(){var e,t,n,i;if(this.lex.eat("("))e=this.parseTreeRecursive(),this.lex.mustEat(")");else if(this.lex.eat("NOT ("))e=this.parseTreeRecursive(),e=new r.UnaryTermNode(s.Operators.NOT,e),this.lex.mustEat(")");else if(e=t=this.parseFactorNode(),this.lex.eat(s.Operators.BETWEEN.symbol)){if(n=this.parseFactorNode(),!this.lex.eat(s.Operators.AND.symbol))throw new Error("Expected "+s.Operators.AND.symbol+" at this point ["+this.lex.getPos()+"]");i=this.parseFactorNode(),e=new r.BinaryTermNode(s.Operators.BETWEEN,t,new r.RangeFactorNode(n,i))}else if(this.lex.eat(s.Operators.BEFORE_LAST.symbol))e=this.parseTimeRangeOperatorExpr(s.Operators.BEFORE_LAST,t);else if(this.lex.eat(s.Operators.BEFORE_NEXT.symbol))e=this.parseTimeRangeOperatorExpr(s.Operators.BEFORE_NEXT,t);else if(this.lex.eat(s.Operators.AFTER_LAST.symbol))e=this.parseTimeRangeOperatorExpr(s.Operators.AFTER_LAST,t);else if(this.lex.eat(s.Operators.AFTER_NEXT.symbol))e=this.parseTimeRangeOperatorExpr(s.Operators.AFTER_NEXT,t);else if(this.lex.eat(s.Operators.IN_THE_NEXT.symbol))e=this.parseTimeRangeOperatorExpr(s.Operators.IN_THE_NEXT,t);else if(this.lex.eat(s.Operators.IN_THE_PAST.symbol))e=new r.BinaryTermNode(s.Operators.IN_THE_PAST,t,null);else if(this.lex.eat(s.Operators.IN_THE_FUTURE.symbol))e=new r.BinaryTermNode(s.Operators.IN_THE_FUTURE,t,null);else if(this.lex.eat(s.Operators.NOT_IN_THE_NEXT.symbol))e=this.parseTimeRangeOperatorExpr(s.Operators.NOT_IN_THE_NEXT,t);else if(this.lex.eat(s.Operators.IN_THE_LAST.symbol))e=this.parseTimeRangeOperatorExpr(s.Operators.IN_THE_LAST,t);else if(this.lex.eat(s.Operators.NOT_IN_THE_LAST.symbol))e=this.parseTimeRangeOperatorExpr(s.Operators.NOT_IN_THE_LAST,t);else if(this.lex.eat(s.Operators.EXACT_TIME_AGO.symbol))e=this.parseTimeRangeOperatorExpr(s.Operators.EXACT_TIME_AGO,t);else if(this.lex.eat(s.Operators.IS_UNDEFINED.symbol))e=new r.UnaryTermNode(s.Operators.IS_UNDEFINED,t);else if(this.lex.eat(s.Operators.IS_DEFINED.symbol))e=new r.UnaryTermNode(s.Operators.IS_DEFINED,t);else if(this.lex.eat(s.Operators.IS_EMPTY.symbol))e=new r.UnaryTermNode(s.Operators.IS_EMPTY,t);else if(this.lex.eat(s.Operators.IS_NOT_EMPTY.symbol))e=new r.UnaryTermNode(s.Operators.IS_NOT_EMPTY,t);else if(this.lex.eat(s.Operators.IN.symbol))e=new r.BinaryTermNode(s.Operators.IN,t,this.parseInClauseExpr());else if(this.lex.eat(s.Operators.NOT_IN.symbol))e=new r.BinaryTermNode(s.Operators.NOT_IN,t,this.parseInClauseExpr());else if(this.lex.eat(s.Operators.CONTAINS_ITEM.symbol)){if(!(t instanceof r.PropertyReferenceFactor||t instanceof r.FunctionCallFactor))throw new Error("An identifier is expected before the operator "+s.Operators.CONTAINS_ITEM.symbol);e=new r.BinaryTermNode(s.Operators.CONTAINS_ITEM,t,this.parseItemPredicate())}else if(this.lex.eat(s.Operators.NOT_CONTAINS_ITEM.symbol)){if(!(t instanceof r.PropertyReferenceFactor||t instanceof r.FunctionCallFactor))throw new Error("An identifier is expected before the operator "+s.Operators.NOT_CONTAINS_ITEM.symbol);e=new r.BinaryTermNode(s.Operators.NOT_CONTAINS_ITEM,t,this.parseItemPredicate())}else this.lex.eat(s.Operators.STARTS_WITH.symbol)?(n=this.parseFactorNode(),e=new r.BinaryTermNode(s.Operators.STARTS_WITH,t,n)):this.lex.eat(s.Operators.ENDS_WITH.symbol)?(n=this.parseFactorNode(),e=new r.BinaryTermNode(s.Operators.ENDS_WITH,t,n)):this.lex.eat(s.Operators.CONTAINS.symbol)?(n=this.parseFactorNode(),e=new r.BinaryTermNode(s.Operators.CONTAINS,t,n)):this.lex.eat(s.Operators.DOES_NOT_CONTAIN.symbol)?(n=this.parseFactorNode(),e=new r.BinaryTermNode(s.Operators.DOES_NOT_CONTAIN,t,n)):this.lex.eat(s.Operators.LIKE.symbol)&&(n=this.parseFactorNode(),e=new r.BinaryTermNode(s.Operators.LIKE,t,n));return e},e.prototype.parseFactorNode=function(){var e,t,n,i,a=null;if(this.lex.eatBool())e=this.lex.getBoolVal(),a=new r.ValueFactorNode(s.OperandType.BOOLEAN,e);else if(this.lex.eatDouble())e=this.lex.getDoubleVal(),a=new r.ValueFactorNode(s.OperandType.FLOAT,e);else if(this.lex.eatLong())e=this.lex.getLongVal(),a=new r.ValueFactorNode(s.OperandType.INTEGER,e);else if(this.lex.eatString())e=this.lex.getStringVal(),a=new r.ValueFactorNode(s.OperandType.BOOLEAN,e);else{if(!this.lex.eatIdentifier())throw i="Unrecognised factor '"+this.getNextToken()+"'",new Error(i);t=null,this.lex.eat("(")&&(t=this.parseFunctionCall()),n=this.lex.eat("."),a=t&&!n?t:t&&n?this.parseObjectProperty(t):n?this.parseObjectProperty(null):this.parseSimpleProperty()}return a},e.prototype.parseFunctionCall=function(){var e,t=this.lex.getIdentifierVal(),n=[];if(!this.lex.eat(")")){do{e=this.parseFactorNode(),n.push(e)}while(this.lex.eat(","));this.lex.mustEat(")")}return new r.FunctionCallFactor(t,n)},e.prototype.parseSimpleProperty=function(){return new r.PropertyReferenceFactor("",this.lex.getIdentifierVal())},e.prototype.parseObjectProperty=function(e){var t,n,i,s=null!=e?e instanceof r.PropertyReferenceFactor?e.propertyName:e.functionName:this.lex.getIdentifierVal();if(!this.lex.eatIdentifier())throw i="<end of input>",this.lex.eatToken()&&(i=this.lex.getTokenVal()),new Error("Missing or invalid attribute name: '"+i+"'");return n=this.lex.getIdentifierVal(),(t=new r.PropertyReferenceFactor(s,n)).parentProperty=e,this.lex.eat(".")&&(t.nestedProperty=this.parseObjectProperty(t)),t},e.prototype.parseItemPredicate=function(){var e,t;if(this.lex.mustEat("("),!this.lex.eatIdentifier())throw new Error("Identifier expected at "+this.lex.pos);return e=this.lex.getIdentifierVal(),this.lex.mustEat("=>"),t=this.parseTreeRecursive(),this.lex.mustEat(")"),new r.ItemPredicateNode(e,t)},e.prototype.parseTimeRangeOperatorExpr=function(e,t){var n=this.parseTimeUnitExpression();if(n.hasError())throw new Error("Failed to parse time range: "+n.error);return new r.BinaryTermNode(e,t,new r.TimeRangeFactor(n.amount,n.timeUnit))},e.prototype.parseTimeUnitExpression=function(){var e,t=new o(0,a.TimeUnit.Hours,"");return this.lex.eatLong()?(t.amount=this.lex.getLongVal(),this.lex.eatToken()?(e=this.lex.getTokenVal(),a.ValidTimeUnits.has(e)?t.timeUnit=e:t.error="Unsupported time unit '"+e+"'"):t.error="Expecting a time unit specifier"):t.error="Expecting an integer quantity of time units ",t},e.prototype.parseInClauseExpr=function(){var e,t;try{e=[],this.lex.eat("(");do{t=this.parseFactorNode(),e.push(t)}while(this.lex.eat(","));return this.lex.eat(")"),new r.InFactor(e)}catch(e){throw new Error("Failed to parse IN expression")}},e.prototype.getNextToken=function(){var e="";return this.lex.eatToken()&&(e=this.lex.getTokenVal()),e},e}(),t.Parser=u},918:function(e,t,n){var i,r,s,a,o,u,c,l,d,h,p,f,m,v,g,y,w=this&&this.__extends||(y=function(e,t){return y=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},y(e,t)},function(e,t){function n(){this.constructor=e}if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");y(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0}),t.ItemPredicateNode=t.InFactor=t.FunctionCallFactor=t.PropertyReferenceFactor=t.TimeRangeFactor=t.RangeFactorNode=t.BinaryTermNode=t.UnaryTermNode=t.ValueFactorNode=t.FactorNode=t.TermNode=t.OperandNode=t.BasicVisitor=void 0,i=n(1467),r=n(6620),s=function(){function e(){}return e.prototype.visitComparisonOpTerm=function(e){var t,n,i;for(t=0,n=e.getOperands();t<n.length;t++)null==(i=n[t])||i.visit(this)},e.prototype.visitInFactor=function(e){var t,n;for(t=0,n=e._rawValues;t<n.length;t++)n[t].visit(this)},e.prototype.visitItemPredicate=function(e){e.predicate.visit(this)},e.prototype.visitLogicalOpTerm=function(e){var t,n;for(t=0,n=e.getOperands();t<n.length;t++)n[t].visit(this)},e.prototype.visitPropertyFactor=function(e){var t;null===(t=e.nestedProperty)||void 0===t||t.visit(this)},e.prototype.visitRangeFactor=function(e){},e.prototype.visitTimeRangeFactor=function(e){},e.prototype.visitValueFactor=function(e){},e.prototype.visitFunctionCallFactor=function(e){},e}(),t.BasicVisitor=s,a=function(){function e(){}return e.prototype.asFactorNode=function(){throw new Error("Can't convert EmptyOperandNode to a FactorNode")},e.prototype.asItemPredicateNode=function(){throw new Error("Can't convert EmptyOperandNode to a ItemPredicateNode")},e.prototype.getError=function(){return null},e.prototype.hasError=function(){return null!==this.getError()},e}(),t.OperandNode=a,o=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return w(t,e),t}(a),t.TermNode=o,u=function(e){function t(t){var n=e.call(this)||this;return n._operandType=t,n}return w(t,e),t}(a),t.FactorNode=u,c=function(e){function t(t,n){var i=e.call(this,t)||this;return i.value=n,i}return w(t,e),t.prototype.visit=function(e){e.visitValueFactor(this)},t.prototype.getValue=function(){return this.value},t.prototype.asFactorNode=function(){return this},t}(u),t.ValueFactorNode=c,l=function(e){function t(t,n){var i=e.call(this)||this;return i.operator=t,i.lhs=n,i}return w(t,e),t.prototype.getOperands=function(){return[this.lhs]},t.prototype.getOperator=function(){return this.operator},t.prototype.isUnary=function(){return!0},t.prototype.visit=function(e){this.operator.isLogical?e.visitLogicalOpTerm(this):e.visitComparisonOpTerm(this)},t.prototype.asFactorNode=function(){throw new Error("Can't convert a UnaryTermNode to a FactorNode")},t}(o),t.UnaryTermNode=l,d=function(e){function t(t,n,i){var r=e.call(this)||this;return r.operator=t,r.lhs=n,r.rhs=i,r}return w(t,e),t.prototype.getOperands=function(){return this.rhs?[this.lhs,this.rhs]:[this.lhs]},t.prototype.getOperator=function(){return this.operator},t.prototype.isUnary=function(){return null===this.rhs},t.prototype.visit=function(e){this.operator.isLogical?e.visitLogicalOpTerm(this):e.visitComparisonOpTerm(this)},t.prototype.asFactorNode=function(){throw new Error("Can't convert a BinaryTermNode to a FactorNode")},t}(o),t.BinaryTermNode=d,h=function(e){function t(t,n){var r=e.call(this,i.OperandType.BETWEEN_RANGE)||this;return r.from=t,r.to=n,r}return w(t,e),t.prototype.getFrom=function(){return this.from},t.prototype.getTo=function(){return this.to},t.prototype.asFactorNode=function(){return this},t.prototype.visit=function(e){e.visitRangeFactor(this)},t.prototype.getValue=function(){return new r.ValueRange(this.from.getValue(),this.to.getValue())},t}(u),t.RangeFactorNode=h,p=function(e){function t(t,n){var r=e.call(this,i.OperandType.TIME_RANGE)||this;return r.duration=t,r.timeUnit=n,r}return w(t,e),t.prototype.getValue=function(){return new r.TimeRange(this.duration,this.timeUnit)},t.prototype.visit=function(e){e.visitTimeRangeFactor(this)},t}(u),t.TimeRangeFactor=p,f=function(e){function t(t,n){var r=e.call(this,i.OperandType.PROPERTY)||this;return r.dimension=t,r.propertyName=n,r}return w(t,e),t.prototype.asFactorNode=function(){return this},t.prototype.getValue=function(){return this.dimension+"."+this.propertyName},t.prototype.visit=function(e){e.visitPropertyFactor(this)},t}(u),t.PropertyReferenceFactor=f,m=function(e){function t(t,n){var r=e.call(this,i.OperandType.FUNCTION_CALL)||this;return r.functionName=t,r.args=n,r}return w(t,e),t.prototype.getValue=function(){return null},t.prototype.visit=function(e){var t,n;for(t=0,n=this.args;t<n.length;t++)n[t].visit(e);e.visitFunctionCallFactor(this)},t}(u),t.FunctionCallFactor=m,v=function(e){function t(t){var n=e.call(this,i.OperandType.IN_VALUES)||this;return n._rawValues=t,n.values=null==t?void 0:t.map((function(e){return e.getValue()})),n}return w(t,e),t.prototype.getValue=function(){return new r.ValuesArray(this.values)},t.prototype.visit=function(e){e.visitInFactor(this)},t}(u),t.InFactor=v,g=function(e){function t(t,n){var i=e.call(this)||this;return i.argName=t,i.predicate=n,i}return w(t,e),t.prototype.asItemPredicateNode=function(){return this},t.prototype.visit=function(e){e.visitItemPredicate(this)},t}(a),t.ItemPredicateNode=g},7901:(e,t,n)=>{var i,r;Object.defineProperty(t,"__esModule",{value:!0}),t.VersionNumber=t.ValidTimeUnits=t.TimeUnit=void 0,i=n(1317),t.TimeUnit={Months:"MONTHS",Weeks:"WEEKS",Days:"DAYS",Hours:"HOURS",Minutes:"MINUTES",Seconds:"SECONDS"},t.ValidTimeUnits=new Set([t.TimeUnit.Seconds,t.TimeUnit.Minutes,t.TimeUnit.Hours,t.TimeUnit.Days,t.TimeUnit.Weeks,t.TimeUnit.Months]),r=function(){function e(e){if(null==e||0==e.trim().length)this.setEmptyVersion();else{this.versionString=e;var t=e.split(".");switch(t.length){case 3:this.majorNumber=Number(t[0]),this.minorNumber=Number(t[1]),this.patchNumber=Number(t[2]);break;case 2:this.majorNumber=Number(t[0]),this.minorNumber=Number(t[1]),this.patchNumber=void 0;break;case 1:this.majorNumber=Number(t[0]),this.minorNumber=void 0,this.patchNumber=void 0;break;default:this.setEmptyVersion()}}}return e.prototype.compareTo=function(e){var t=i.compare(this.majorNumber,e.majorNumber);return 0!=t||0!=(t=i.compare(this.minorNumber,e.minorNumber))?t:t=i.compare(this.patchNumber,e.patchNumber)},e.prototype.setEmptyVersion=function(){this.versionString="",this.majorNumber=void 0,this.minorNumber=void 0,this.patchNumber=void 0},e}(),t.VersionNumber=r},1317:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.compare=t.isSet=t.isDate=t.isNumber=t.isString=void 0,t.isString=function(e){return null!=e&&"string"==typeof e.valueOf()},t.isNumber=function(e){return"number"==typeof e||null!==e&&Number.isInteger(e)},t.isDate=function(e){return[Date].includes((e||{}).constructor)},t.isSet=function(e){return[Set].includes((e||{}).constructor)},t.compare=function(e,t){return e&&!t?1:!e&&t?-1:e||t?e>t?1:e===t?0:-1:0}},8798:function(e){var t,n,i,r,s,a,o,u,c,l,d,h,p,f,m,v,g,y,w,b,A,S,T;e.exports=(o="millisecond",u="second",c="minute",l="hour",d="day",h="week",p="month",f="quarter",m="year",v="date",g=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[^0-9]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?.?(\d+)?$/,y=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,w={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_")},b=function(e,t,n){var i=String(e);return!i||i.length>=t?e:""+Array(t+1-i.length).join(n)+e},A={s:b,z:function(e){var t=-e.utcOffset(),n=Math.abs(t),i=Math.floor(n/60),r=n%60;return(t<=0?"+":"-")+b(i,2,"0")+":"+b(r,2,"0")},m:function e(t,n){if(t.date()<n.date())return-e(n,t);var i=12*(n.year()-t.year())+(n.month()-t.month()),r=t.clone().add(i,p),s=n-r<0,a=t.clone().add(i+(s?-1:1),p);return+(-(i+(n-r)/(s?r-a:a-r))||0)},a:function(e){return e<0?Math.ceil(e)||0:Math.floor(e)},p:function(e){return{M:p,y:m,w:h,d,D:v,h:l,m:c,s:u,ms:o,Q:f}[e]||String(e||"").toLowerCase().replace(/s$/,"")},u:function(e){return void 0===e}},(T={})[S="en"]=w,t=function(e){return e instanceof s},n=function(e,t,n){var i,r;return e?("string"==typeof e?(T[e]&&(i=e),t&&(T[e]=t,i=e)):(r=e.name,T[r]=e,i=r),!n&&i&&(S=i),i||!n&&S):S},i=function(e,n){if(t(e))return e.clone();var i="object"==typeof n?n:{};return i.date=e,i.args=arguments,new s(i)},(r=A).l=n,r.i=t,r.w=function(e,t){return i(e,{locale:t.$L,utc:t.$u,x:t.$x,$offset:t.$offset})},s=function(){function e(e){this.$L=n(e.locale,null,!0),this.parse(e)}var t=e.prototype;return t.parse=function(e){this.$d=function(e){var t,n,i,s=e.date,a=e.utc;return null===s?new Date(NaN):r.u(s)?new Date:s instanceof Date?new Date(s):"string"==typeof s&&!/Z$/i.test(s)&&(t=s.match(g))?(n=t[2]-1||0,i=(t[7]||"0").substring(0,3),a?new Date(Date.UTC(t[1],n,t[3]||1,t[4]||0,t[5]||0,t[6]||0,i)):new Date(t[1],n,t[3]||1,t[4]||0,t[5]||0,t[6]||0,i)):new Date(s)}(e),this.$x=e.x||{},this.init()},t.init=function(){var e=this.$d;this.$y=e.getFullYear(),this.$M=e.getMonth(),this.$D=e.getDate(),this.$W=e.getDay(),this.$H=e.getHours(),this.$m=e.getMinutes(),this.$s=e.getSeconds(),this.$ms=e.getMilliseconds()},t.$utils=function(){return r},t.isValid=function(){return!("Invalid Date"===this.$d.toString())},t.isSame=function(e,t){var n=i(e);return this.startOf(t)<=n&&n<=this.endOf(t)},t.isAfter=function(e,t){return i(e)<this.startOf(t)},t.isBefore=function(e,t){return this.endOf(t)<i(e)},t.$g=function(e,t,n){return r.u(e)?this[t]:this.set(n,e)},t.unix=function(){return Math.floor(this.valueOf()/1e3)},t.valueOf=function(){return this.$d.getTime()},t.startOf=function(e,t){var n,i,s=this,a=!!r.u(t)||t,o=r.p(e),f=function(e,t){var n=r.w(s.$u?Date.UTC(s.$y,t,e):new Date(s.$y,t,e),s);return a?n:n.endOf(d)},g=function(e,t){return r.w(s.toDate()[e].apply(s.toDate("s"),(a?[0,0,0,0]:[23,59,59,999]).slice(t)),s)},y=this.$W,w=this.$M,b=this.$D,A="set"+(this.$u?"UTC":"");switch(o){case m:return a?f(1,0):f(31,11);case p:return a?f(1,w):f(0,w+1);case h:return i=(y<(n=this.$locale().weekStart||0)?y+7:y)-n,f(a?b-i:b+(6-i),w);case d:case v:return g(A+"Hours",0);case l:return g(A+"Minutes",1);case c:return g(A+"Seconds",2);case u:return g(A+"Milliseconds",3);default:return this.clone()}},t.endOf=function(e){return this.startOf(e,!1)},t.$set=function(e,t){var n,i,s=r.p(e),a="set"+(this.$u?"UTC":""),h=(n={},n[d]=a+"Date",n[v]=a+"Date",n[p]=a+"Month",n[m]=a+"FullYear",n[l]=a+"Hours",n[c]=a+"Minutes",n[u]=a+"Seconds",n[o]=a+"Milliseconds",n)[s],f=s===d?this.$D+(t-this.$W):t;return s===p||s===m?((i=this.clone().set(v,1)).$d[h](f),i.init(),this.$d=i.set(v,Math.min(this.$D,i.daysInMonth())).$d):h&&this.$d[h](f),this.init(),this},t.set=function(e,t){return this.clone().$set(e,t)},t.get=function(e){return this[r.p(e)]()},t.add=function(e,t){var n,s,a,o,f,v=this;return e=Number(e),a=function(t){var n=i(v);return r.w(n.date(n.date()+Math.round(t*e)),v)},(s=r.p(t))===p?this.set(p,this.$M+e):s===m?this.set(m,this.$y+e):s===d?a(1):s===h?a(7):(o=(n={},n[c]=6e4,n[l]=36e5,n[u]=1e3,n)[s]||1,f=this.$d.getTime()+e*o,r.w(f,this))},t.subtract=function(e,t){return this.add(-1*e,t)},t.format=function(e){var t,n,i,s,a,o,u,c,l,d,h,p,f=this;return this.isValid()?(t=e||"YYYY-MM-DDTHH:mm:ssZ",n=r.z(this),i=this.$locale(),s=this.$H,a=this.$m,o=this.$M,u=i.weekdays,c=i.months,l=function(e,n,i,r){return e&&(e[n]||e(f,t))||i[n].substr(0,r)},d=function(e){return r.s(s%12||12,e,"0")},h=i.meridiem||function(e,t,n){var i=e<12?"AM":"PM";return n?i.toLowerCase():i},p={YY:String(this.$y).slice(-2),YYYY:this.$y,M:o+1,MM:r.s(o+1,2,"0"),MMM:l(i.monthsShort,o,c,3),MMMM:l(c,o),D:this.$D,DD:r.s(this.$D,2,"0"),d:String(this.$W),dd:l(i.weekdaysMin,this.$W,u,2),ddd:l(i.weekdaysShort,this.$W,u,3),dddd:u[this.$W],H:String(s),HH:r.s(s,2,"0"),h:d(1),hh:d(2),a:h(s,a,!0),A:h(s,a,!1),m:String(a),mm:r.s(a,2,"0"),s:String(this.$s),ss:r.s(this.$s,2,"0"),SSS:r.s(this.$ms,3,"0"),Z:n},t.replace(y,(function(e,t){return t||p[e]||n.replace(":","")}))):"Invalid Date"},t.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},t.diff=function(e,t,n){var s,a=r.p(t),o=i(e),v=6e4*(o.utcOffset()-this.utcOffset()),g=this-o,y=r.m(this,o);return y=(s={},s[m]=y/12,s[p]=y,s[f]=y/3,s[h]=(g-v)/6048e5,s[d]=(g-v)/864e5,s[l]=g/36e5,s[c]=g/6e4,s[u]=g/1e3,s)[a]||g,n?y:r.a(y)},t.daysInMonth=function(){return this.endOf(p).$D},t.$locale=function(){return T[this.$L]},t.locale=function(e,t){if(!e)return this.$L;var i=this.clone(),r=n(e,t,!0);return r&&(i.$L=r),i},t.clone=function(){return r.w(this.$d,this)},t.toDate=function(){return new Date(this.valueOf())},t.toJSON=function(){return this.isValid()?this.toISOString():null},t.toISOString=function(){return this.$d.toISOString()},t.toString=function(){return this.$d.toUTCString()},e}(),a=s.prototype,i.prototype=a,[["$ms",o],["$s",u],["$m",c],["$H",l],["$W",d],["$M",p],["$y",m],["$D",v]].forEach((function(e){a[e[1]]=function(t){return this.$g(t,e[0],e[1])}})),i.extend=function(e,t){return e.$i||(e(t,s,i),e.$i=!0),i},i.locale=n,i.isDayjs=t,i.unix=function(e){return i(1e3*e)},i.en=T[S],i.Ls=T,i.p={},i)},4469:function(e){var t,n,i,r,s,a,o,u,c;e.exports=(i=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,r=/^(-|\+)?P(?:([-+]?[0-9,.]*)Y)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)W)?(?:([-+]?[0-9,.]*)D)?(?:T(?:([-+]?[0-9,.]*)H)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)S)?)?$/,s={years:31536e6,months:2592e6,days:864e5,hours:36e5,minutes:6e4,seconds:1e3,milliseconds:1,weeks:6048e5},a=function(e){return e instanceof c},o=function(e,t,n){return new c(e,n,t.$l)},u=function(e){return n.p(e)+"s"},c=function(){function e(e,t,n){var i,a=this;return this.$d={},this.$l=n,t?o(e*s[u(t)],this):"number"==typeof e?(this.$ms=e,this.parseFromMilliseconds(),this):"object"==typeof e?(Object.keys(e).forEach((function(t){a.$d[u(t)]=e[t]})),this.calMilliseconds(),this):"string"==typeof e&&(i=e.match(r))?(this.$d.years=i[2],this.$d.months=i[3],this.$d.weeks=i[4],this.$d.days=i[5],this.$d.hours=i[6],this.$d.minutes=i[7],this.$d.seconds=i[8],this.calMilliseconds(),this):this}var c=e.prototype;return c.calMilliseconds=function(){var e=this;this.$ms=Object.keys(this.$d).reduce((function(t,n){return t+(e.$d[n]||0)*s[n]}),0)},c.parseFromMilliseconds=function(){var e=this.$ms;this.$d.years=Math.floor(e/31536e6),e%=31536e6,this.$d.months=Math.floor(e/2592e6),e%=2592e6,this.$d.days=Math.floor(e/864e5),e%=864e5,this.$d.hours=Math.floor(e/36e5),e%=36e5,this.$d.minutes=Math.floor(e/6e4),e%=6e4,this.$d.seconds=Math.floor(e/1e3),e%=1e3,this.$d.milliseconds=e},c.toISOString=function(){var e,t,n,i,r,s,a=this.$d.years?this.$d.years+"Y":"",o=this.$d.months?this.$d.months+"M":"",u=+this.$d.days||0;return this.$d.weeks&&(u+=7*this.$d.weeks),e=u?u+"D":"",t=this.$d.hours?this.$d.hours+"H":"",n=this.$d.minutes?this.$d.minutes+"M":"",i=this.$d.seconds||0,this.$d.milliseconds&&(i+=this.$d.milliseconds/1e3),r=i?i+"S":"","P"==(s="P"+a+o+e+(t||n||r?"T":"")+t+n+r)?"P0D":s},c.toJSON=function(){return this.toISOString()},c.format=function(e){var t=e||"YYYY-MM-DDTHH:mm:ss",r={Y:this.$d.years,YY:n.s(this.$d.years,2,"0"),YYYY:n.s(this.$d.years,4,"0"),M:this.$d.months,MM:n.s(this.$d.months,2,"0"),D:this.$d.days,DD:n.s(this.$d.days,2,"0"),H:this.$d.hours,HH:n.s(this.$d.hours,2,"0"),m:this.$d.minutes,mm:n.s(this.$d.minutes,2,"0"),s:this.$d.seconds,ss:n.s(this.$d.seconds,2,"0"),SSS:n.s(this.$d.milliseconds,3,"0")};return t.replace(i,(function(e,t){return t||String(r[e])}))},c.as=function(e){return this.$ms/s[u(e)]},c.get=function(e){var t=this.$ms,n=u(e);return"milliseconds"===n?t%=1e3:t="weeks"===n?Math.floor(t/s[n]):this.$d[n],t},c.add=function(e,t,n){var i;return i=t?e*s[u(t)]:a(e)?e.$ms:o(e,this).$ms,o(this.$ms+i*(n?-1:1),this)},c.subtract=function(e,t){return this.add(e,t,!0)},c.locale=function(e){var t=this.clone();return t.$l=e,t},c.clone=function(){return o(this.$ms,this)},c.humanize=function(e){return t().add(this.$ms,"ms").locale(this.$l).fromNow(!e)},c.milliseconds=function(){return this.get("milliseconds")},c.asMilliseconds=function(){return this.as("milliseconds")},c.seconds=function(){return this.get("seconds")},c.asSeconds=function(){return this.as("seconds")},c.minutes=function(){return this.get("minutes")},c.asMinutes=function(){return this.as("minutes")},c.hours=function(){return this.get("hours")},c.asHours=function(){return this.as("hours")},c.days=function(){return this.get("days")},c.asDays=function(){return this.as("days")},c.weeks=function(){return this.get("weeks")},c.asWeeks=function(){return this.as("weeks")},c.months=function(){return this.get("months")},c.asMonths=function(){return this.as("months")},c.years=function(){return this.get("years")},c.asYears=function(){return this.as("years")},e}(),function(e,i,r){t=r,n=r().$utils(),r.duration=function(e,t){var n=r.locale();return o(e,{$l:n},t)},r.isDuration=a;var s=i.prototype.add,u=i.prototype.subtract;i.prototype.add=function(e,t){return a(e)&&(e=e.asMilliseconds()),s.bind(this)(e,t)},i.prototype.subtract=function(e,t){return a(e)&&(e=e.asMilliseconds()),u.bind(this)(e,t)}})}},n={};e.n=t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},e.d=(t,n)=>{for(var i in n)e.o(n,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:n[i]})},e.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),e.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{function t(){return"iOS"===host.platform&&host.isOSAtLeast(14,3,0)||"macOS"===host.platform&&host.isOSAtLeast(12,0,0)}function n(e){return"object"==typeof e&&null!==e}function i(e){return"string"==typeof e&&e.length>0}function r(e){return"number"==typeof e||null!==e&&Number.isInteger(e)}function s(e){return Array.isArray(e)}function a(e){return"object"!=typeof e?[]:Object.keys(e||{})}function o(e){return Math.ceil(e/60)}function u(e){var t;return`${null===(t=tn[host.platform])||void 0===t?void 0:t[e.slice(0,2)]}.${e.charCodeAt(2)-"A".charCodeAt(0)}.0`}function c(e,t,i){let r=e[t];r=n(r)?{...r,...i}:i,e[t]=r}function l(e,t){let n=new Map;for(const i of e){let e=i[t],r=n.get(e)||new Set;n.set(e,r),r.add(i)}return n}function d(e){return JSON.stringify(e,void 0,2)}function h(e,t){return e.bundleId===t.bundleId&&e.journeyId===t.journeyId&&e.versionId===t.versionId}function p(e){return e.eventType===mn}function f(e,t){return t instanceof Map?Array.from(t.entries()):t instanceof Set?Array.from(t.values()):t instanceof Error?Object.getOwnPropertyNames(t).reduce(((e,n)=>(e[n]=t[n],e)),{name:t.name}):t}function m(e){return JSON.parse(v`${e}`)}function v(e,...t){const n=[e[0]];return t.forEach(((t,i)=>{let r;r="object"==typeof t?JSON.stringify(t,f):String(t),n.push(r,e[i+1])})),n.join("")}function g(e,t){return Zt().duration(e,t.toLowerCase()).asMilliseconds()}function y(e){return null!==e.duration&&void 0!==e.duration&&null!==e.timeUnit&&void 0!==e.timeUnit}function w(e){switch(e.stepType){case"START":return new On(e);case"TERMINAL":return new Nn(e);case"CONDITION":return new xn(e);case"WAIT":return new Un(e);case"LOCAL_NOTIFICATION":return new Bn(e);case"AB_SPLIT":return new Fn(e);case"TAG":return new Wn(e);case"UNTAG":return new Vn(e);case"SET_USER_ATTRIBUTE":return new Hn(e);case"UNIFIED_MESSAGE":return new Rn(e);case"DISMISS_UNIFIED_MESSAGE":return new jn(e);case"EXPERIMENT":return new qn(e);case"ODJ_BADGE":return new Jn(e);case"ODJ_REMOVE_BADGE":return new Gn(e);default:throw new Yn(e)}}function b(e){return new ei(e,nativeApi.user(),[],{},[])}function A({bundleId:e,journeyId:t,versionId:n}){return`${e}/${t}/${n}`}function S({journeyId:e,versionId:t}){return`${e}/${t}`}function T(e){return(t,n)=>{let i=t.getBoundValue(hi),r=e.getPromiseId(t,n),s=i.getResolvedPromise(r);if(void 0!==s||i.hasPendingPromise(r))return s;{let s=e.call(t,n).then((e=>Promise.resolve([r,e])));i.addPendingPromise(r,s)}}}function C(e){let t,n=Date.now(),i=n-Zt()(n).startOf("day").valueOf();return t=e.nightTimeStart<=e.nightTimeEnd?i>=e.nightTimeStart&&i<=e.nightTimeEnd?e.nightTimeEnd-i:0:i>=e.nightTimeStart?e.nightTimeEnd+Zt().duration(1,"days").asMilliseconds()+i:i<=e.nightTimeEnd?e.nightTimeEnd-i:0,t}function E(e){var t,n;if(e.eventType===Mn&&"xp_amp_notifications"===e.topic){const i=e;if(!(null===(t=i.displayCriteria)||void 0===t?void 0:t.authorizationStatus))return;switch(e.eventType=Dn,e.newValue="authorized"===(null===(n=i.displayCriteria)||void 0===n?void 0:n.authorizationStatus),e.oldValue=!e.newValue,i.app){case"com.apple.appstored":e.bundleId="com.apple.AppStore";break;case"com.apple.itunescloudd":e.bundleId="com.apple.Music";break;case"com.apple.watchlistd":e.bundleId="com.apple.tv";break;default:e.bundleId="unknown"}}}function M(e){switch(e){case"Toast":return dt.toast;case"Alert":return dt.alert;case"Banner":return dt.banner;case"BubbleTip":return dt.bubbleTip;case"HalfSheet":return dt.halfSheet;case"FullSheet":return dt.fullSheet;case"DashboardMessage":return dt.dashboard;case"DiscoveryCard":return dt.discoveryCard;default:return dt.unknown}}function k(e,t,n){const i={eventType:"journeys:ABTestAssignment",treatmentId:t?pt.CONTROL_INDEX:pt.NON_CONTROL_INDEX,abTestId:ht.USER_JOURNEY_CONTROL_GROUP},r=e.customerJourney.groupAllocationRetentionDays;U(e,j({journeyId:e.customerJourney.journeyId,journeyVersionId:e.customerJourney.versionId,abTestId:ht.USER_JOURNEY_CONTROL_GROUP,treatmentId:i.treatmentId,bundleId:e.customerJourney.bundleId,expiresOn:Date.now()+Zt().duration(r,"days").asMilliseconds()},n))&&R(e,i,n)}function I(e,t){var n;let i=e.journeyInstance,r=null===(n=e.customerJourney.getStepById(i.step))||void 0===n?void 0:n.stepType;R(e,{eventType:"journeys:JourneyFailed",stepId:i.step,stepType:r,errorMessage:t},i)}function D(e,t){R(e,{eventType:vn,journeyStatus:t.status},t)}function P(e,t,n){R(e,{eventType:"journeys:ActionCompleted",stepId:n.id,stepType:n.stepType},t)}function _(e,t){R(e,{eventType:gn},t)}function $(e,t){var n;if(!en(t.treatments))return void nativeApi.log("Ignoring uplift event as it was re-enqueued");const i=function(e){var t;let n;const i=e.bundleId;if(i){let r=plugins.getPluginForBundle(i);r&&(n=(null!==(t=r.getUpliftEvents())&&void 0!==t?t:[]).find((t=>t.eventType===e.eventType)))}return n}(t);if(i){if(!L(t.bundleId))return void nativeApi.log("Discarding uplift event as we don't have privacy opt-in");let r={eventType:t.eventType,app:t.bundleId,eventTime:B(Date.now())};null===(n=i.attributes)||void 0===n||n.forEach((e=>r[e]=t[e]));let s=O(e,r);en(s)||(nativeApi.logDebug(v`Emitting uplift event ${r}`),F(r))}}function x(e,t){if("reenter"in t)return void nativeApi.log("Ignoring native metric event as it was re-enqueued");if(!L(t.bundleId))return void nativeApi.log("Discarding metric event as we don't have privacy opt-in");if(t.eventType===yn&&!function(e){var t,n,i,r,s,a,o;return 2===(null===(t=e.displayCriteria)||void 0===t?void 0:t.authorizationStatus)||"authorized"===(null===(n=e.displayCriteria)||void 0===n?void 0:n.authorizationStatus)||(null===(i=e.displayCriteriaParsed)||void 0===i?void 0:i.notificationsEnabled)||2===(null===(s=null===(r=e.options)||void 0===r?void 0:r.displayCriteria)||void 0===s?void 0:s.authorizationStatus)||"authorized"===(null===(o=null===(a=e.options)||void 0===a?void 0:a.displayCriteria)||void 0===o?void 0:o.authorizationStatus)}(t))return void nativeApi.log(`Discarding notification metric ${t.eventType} as the notification was not displayed`);nativeApi.log(`Enqueueing metric event ${t.eventType}`);let n=function(e){var t;let n;switch(e.eventType){case Mn:case Cn:case Tn:n={journeyId:e.journeyId,journeyVersionId:e.journeyVersionId,stepId:e.stepId,messageId:e.messageId,messageType:e.messageType,serviceType:e.serviceType,placement:e.placement,actionType:e.actionType};break;case wn:n={actionType:e.actionType,actionUrl:e.actionUrl,journeyId:e.journeyId,journeyVersionId:e.journeyVersionId,stepId:e.stepId};break;case yn:n={journeyId:e.journeyId,journeyVersionId:e.journeyVersionId,stepId:e.stepId};break;default:n={...e}}return n.topic=Ni,n.eventType=e.eventType,n.app=e.bundleId,delete n.bundleId,delete n.createdOn,n.reenter=1,n.eventTime=B(null!==(t=e.eventTime)&&void 0!==t?t:Date.now()),n.journeyStarted=e.journeyStarted?B(e.journeyStarted):void 0,n}(t);if(N(t)){const i=O(e,n);if(!(i&&0!==i.length||ji.has(t.eventType)))return}F(n)}function O(e,t){let n=new Oi,i=n.readAssignmentsByBundle(e,t.app);if(i.forEach((e=>e.upliftEvents=e.upliftEvents||{})),i=i.filter((e=>!r(e.upliftEvents[t.eventType]))),!en(i)){let r=Date.now();i.forEach((e=>{e.upliftEvents[t.eventType]=r})),n.updateAssignments(e,t.app,i),i.forEach((e=>{delete e.expiresOn,delete e.upliftEvents})),t.treatments=i}return i}function N(e){return Ui.find((t=>t.eventType===e.eventType))}function R(e,t,n){const i={...t,eventTime:B(Date.now())},r=n?{...i,app:n.bundleId,journeyId:n.journeyId,journeyVersionId:n.versionId,journeyStarted:B(n.startedOn)}:{...i,app:e.customerJourney.bundleId,journeyId:e.customerJourney.journeyId,journeyVersionId:e.customerJourney.versionId};r.eventType!=bn&&"journeys:DpStepEntered"!=r.eventType&&r.eventType!=An&&r.eventType!=gn&&r.eventType!=vn||nativeApi.logDebug(`Metric event eventType: ${r.eventType} app: ${r.app} journeyId: ${r.journeyId} versionId: ${r.journeyVersionId} stepId: ${r.stepId} stepType: ${r.stepType} transition: ${r.transition} previousStepId: ${r.previousStepId} journeyStatus: ${r.journeyStatus} eventTime: ${r.eventTime}`),F(r)}function j(e,t){return{...e,assignmentTimestamp:B(Date.now()),journeyStarted:t?B(t.startedOn):void 0}}function U(e,t){let n=new Oi;return n.canStoreAssignment(e.user.userId)?(nativeApi.logDebug(v`final test assignment ${t}`),n.storeAssignment(e.user.userId,t)):(R(e,{eventType:"journeys:MetricsLimit"}),!1)}function L(e){var t;return!en(e)&&((null===(t=plugins.getPluginForBundle(e))||void 0===t?void 0:t.analyticsOptedIn())||!1)}function B(e){return Zt()(e).hour(0).minute(0).second(0).millisecond(0).valueOf()}function F(e){Li.push(e)}function q(e){return!en(e.eventType)&&e.eventType===pn}function W(e){return(t,n)=>{let i=t.getBoundValue(di);if(!i)throw new Error("Journey scope missing");let r=e.getRequestId(i,n);return r?r in i.resolvedData?i.resolvedData[r].data:(i.pendingData.includes(r)||(e.enqueueRequest(r,n),i.addPendingData(r)),null):null}}async function V(e,t){const{userId:n}=nativeApi.user(),i=(new qi).readMessageLog(n);let r=function(e,t){if(!t.cooldownDuration||!t.cooldownTimeUnit)return{result:!0};const n=e.filter((e=>e.messageId===t.messageId&&e.action===mt.shown)).sort(((e,t)=>t.timestamp-e.timestamp)),i=null==n?void 0:n[0];if(!i)return{result:!0};const r=Zt()(i.timestamp+g(t.cooldownDuration,t.cooldownTimeUnit));return Zt()().isAfter(r)?{result:!0}:{result:!1,eventType:vt.UmsEventCooldown,reason:`Cooldown requires to wait until ${r.format()} before showing again this message`}}(i,e);if(!r.result)return r;let s=await async function(e,t,n){if(!t.displayExpression)return{result:!0,eventType:vt.UmsEventDisplayExpression};const i=plugins.getPluginForBundle(t.bundleId);if(!i)return{result:!1,eventType:vt.UmsEventDisplayExpression,reason:`Unable to determine the plugin for the current request: ${t}`};let r=new Ti(t.displayExpression),s=new bi,a=b(i);s.bindValue(ui,{...nativeApi.user(),messageContext:n}),s.bindValue(hi,a);let o=r.evaluateBoolean(s);for(;a.hasPendingPromises();)await a.resolvePromises(),o=r.evaluateBoolean(s);return o?{result:!0}:{result:o,eventType:vt.UmsEventDisplayExpression,reason:"display expression is not satisfied"}}(0,e,t);return s.result?function(e,t){if(t.appLimits){const n=H(e.filter((e=>e.action===mt.shown)),t.appLimits);if(!n.result)return{result:!1,eventType:vt.UmsEventLimit,reason:`app settings display limit is not satisfied, ${n.reason}`}}const n=H(e.filter((e=>e.messageId===t.messageId&&e.action===mt.shown)),t.stepLimits);return n.result?{result:!0}:{result:!1,eventType:vt.UmsEventLimit,reason:`step limit display is not satisfied, ${n.reason}`}}(i,e):s}function H(e,t){if(!t)return{result:!0,eventType:vt.UmsEventLimit};if("number"==typeof t.totalDisplaysLimit&&t.totalDisplaysLimit>0&&e.length>=t.totalDisplaysLimit)return{result:!1,eventType:vt.UmsEventLimit,reason:`found ${e.length} display(s) and the total limit is ${t.totalDisplaysLimit}`};if(t.intervalDisplaysLimits)for(const n of t.intervalDisplaysLimits){const t=Zt()(Date.now()).subtract(n.days-1,"day").startOf("day"),i=e.filter((e=>Zt()(e.timestamp).isAfter(t)));if(i.length>=n.count)return{result:!1,eventType:vt.UmsEventLimit,reason:`found ${i.length} display(s) in last ${n.days} days(s) and the limit is ${n.count}`}}return{result:!0,eventType:vt.UmsEventLimit}}async function J(e,t,{messageUrl:n,journeyUrl:i,publishedAt:r}){let s=new qi,a=s.readCachedMessage(t);if(a&&r&&a.published&&!Zt()(r).isAfter(Zt()(a.published)))return void nativeApi.logDebug(`Skipping downloading ${t} as it hasn't changed`);const o=function(e,t){var n;e=(e=e.replace("silverbullet-external.itunes.apple.com","apps.mzstatic.com")).replace("silverbullet-itms11.itunes.apple.com/content/","apps.apple.com/redeem/promo/");const i=null!==(n=Wi[t.toLowerCase()])&&void 0!==n?n:t.toLocaleLowerCase();let r=e.endsWith("/")?"":"/";return`${e}${r}${i}.json`}(n,e);for(let e=0;e<3;e++)try{nativeApi.log(v`Fetching in-app message ${t} for journey ${i} from ${o}`);let e=await net.fetch({url:o,method:"GET"});if(!(e.status>=400)){if(null===e.body||void 0===e.body)return Promise.reject(`Empty in-app message ${t} for journey ${i}.`);{let n=JSON.parse(e.body);if(n.__source_url=o,n.priority=n.priority||0,("iOS"===host.platform&&host.isOSAtLeast(15,5,0)||"macOS"===host.platform&&host.isOSAtLeast(12,4,0))&&n.engagementItem&&n.engagementStyle===yt.W.formSheet){nativeApi.logDebug(`Caching assets for ${n.id}`);try{n.engagementItem=(0,wt.Z)(n.engagementItem,yt.GL.journeys,n.id,n.version)}catch(e){nativeApi.logError(v`Failed to cache assets for ${n.id}: ${e}`)}}return s.writeCachedMessage(t,n),nativeApi.log(`Successfully wrote message ${t} from ${o}`),Promise.resolve()}}nativeApi.logError(`Request to fetch in-app message ${t} for journey ${i} failed. Code: ${e.status}, message: ${e.statusText}`)}catch(e){nativeApi.logError(v`Retrying in-app message ${t} for journey ${i} after error ${e} with ${o}`)}return Promise.reject(`Failed to fetch message ${t} for journey ${i} from ${o}`)}async function G(e,t,n){const i=plugins.getPluginForBundle(e.bundleId);if(!i)throw new Error(`Can't find mapped plugin for bundle ${e.bundleId}`);const r=new Ei;let s=b(i),a=new bi;return a.bindValue("messageContext",t),n.content?await async function(e,t,n,i){if(e.content&&(e.content.title=await t.evaluateTemplate(n,e.content.title,!0,i),e.content.subtitle&&(e.content.subtitle=await t.evaluateTemplate(n,e.content.subtitle,!0,i)),e.content.iconURL&&(e.content.iconURL=await t.evaluateTemplate(n,e.content.iconURL,!0,i)),e.content.defaultAction&&(e.content.defaultAction.title&&(e.content.defaultAction.title=await t.evaluateTemplate(n,e.content.defaultAction.title,!0,i)),e.content.defaultAction.deepLink=await t.evaluateTemplate(n,e.content.defaultAction.deepLink,!0,i),e.content.defaultAction.iconURL&&(e.content.defaultAction.iconURL=await t.evaluateTemplate(n,e.content.defaultAction.iconURL,!0,i))),e.content.actions))for(const r of e.content.actions)r.title&&(r.title=await t.evaluateTemplate(n,r.title,!0,i)),r.deepLink=await t.evaluateTemplate(n,r.deepLink,!0,i),r.iconURL&&(r.iconURL=await t.evaluateTemplate(n,r.iconURL,!0,i))}(n,r,s,a):n.engagementItem&&await async function(e,t,n,i){if(e.engagementItem&&(e.engagementItem.attributes.title=await t.evaluateTemplate(n,e.engagementItem.attributes.title,!0,i),e.engagementItem.attributes.subtitle&&(e.engagementItem.attributes.subtitle=await t.evaluateTemplate(n,e.engagementItem.attributes.subtitle,!0,i)),e.engagementItem.attributes.actions))for(const r of e.engagementItem.attributes.actions)r.callToActionLabel&&(r.callToActionLabel=await t.evaluateTemplate(n,r.callToActionLabel,!0,i))}(n,r,s,a),n}function Y(e){let t=new Map;for(const n of e){let e=t.get(n.message.serviceType)||new Map;e.set(n.message.placement,[...e.get(n.message.placement)||[],n]),t.set(n.message.serviceType,e)}return t}function z(e,t){var n;const i={placement:e.placement,serviceType:e.serviceType},r={...t,...i,eventType:Tn};if(e.content){e.content.metricsEvent=r;let s=e.content.actions||[];for(const e of s)e.metricsEvent={...t,...i,eventType:Cn,actionType:e.style};en(e.content.defaultAction)||(e.content.defaultAction.metricsEvent={...t,...i,eventType:Cn,actionType:null===(n=e.content.defaultAction)||void 0===n?void 0:n.style})}else e.engagementItem?e.engagementItem.meta.metrics={...t,...i,anonymous:!0,topic:Ni}:K(e)&&(e.metricsOverlay=r)}function K(e){return"DISCOVERY-CARD"===e.messageStyle}function Q(e){var t;return(null===(t=e.content)||void 0===t?void 0:t.style)===gt.MessageStyle.dashboard}function Z(e){e.content}function X(e,t,n){const i=new qi;Vi=Vi.filter((t=>t.message.id!==e.message.id));const{userId:r}=nativeApi.user();i.writeMessagesQueue(r,Vi),function(e){Ji.push(e)}(e)}function ee(e){const{message:t,journeyURL:n,type:i}=e,r=v`[Journey log][${n}][${i}]: ${t}`;"error"===i?nativeApi.logError(r):nativeApi.log(r)}function te(e,t){let n=bt.murmur3(t,195935983);return i=bt.murmur3(e,n),Math.abs((23*i+67)%1540483597%1e4);var i}async function ne(e){let t=e.customerJourney;if(!t||!t.holdoutSize||0===t.holdoutSize)return!1;let n=new Ci,i=t.groupAllocationIdentifier?t.groupAllocationIdentifier:e.user.userId;return te((await n.evalExpression(e,i)).toString(),t.holdoutSeed)<100*t.holdoutSize}function ie(e){return`j_events_log_${e}`}function re(e){let t=ae(e.eventType);t.push(e),t=t.slice(-50),function(e,t){let n=ie(e);Yi.set(n,t),zi.push(n)}(e.eventType,t)}function se(e){return ae(e)}function ae(e){let t=ie(e);const n=nativeApi.database(an);return Yi.fetch(t,(()=>{const e=Zt()().subtract(30,"day");return((null==n?void 0:n.fetch(t))||[]).filter((t=>Zt()(t.createdOn).isAfter(e)))}))||[]}function oe(e,t,i,r=!0){let s=`${e}-${t}`,a=Ki.fetch(s);if(null!=a)return a;let o={request:i};return r&&(o=JSON.stringify(o)),nativeApi.log(v`Calling plugin '${e}' with ${o}`),a=function(e,t=!0){nativeApi.logDebug(v`plugin response ${e}`);let i,r=e.result,s=e.error;if(n(s)){if(nativeApi.logDebug(`code ${s.code} domain ${s.domain}`),s.code===Ze.PrivateDataUnavailable)throw new sn("PrivateDataUnavailable",s.message);throw Error(`plugin operation failed. Code: ${s.code}, Message: ${s.message}`)}return r&&n(r)&&"json-payload"in r&&(nativeApi.logDebug(v`response payload ${r["json-payload"]}`),i=(t&&"string"==typeof r["json-payload"]?JSON.parse(r["json-payload"]):r["json-payload"]).response),i}(nativeApi.pluginFetchSync(e,{"json-payload":o}),r),Ki.set(s,a),a}function ue(e,t,n){let i={"json-payload":JSON.stringify({request:n})};nativeApi.pluginRequestAsyncEvent(e,i,t)}function ce(e,t,n){const i={};for(const[r,s]of Object.entries(t))i[r]=()=>{try{const t=e[r]();return null==t?(nativeApi.log(v`[Plugin] Evaluated property '${r}' to ${t}, returning default value`),s):(nativeApi.log(v`[Plugin] Evaluated property '${r}' to ${t}`),t)}catch(e){return e instanceof Zi||nativeApi.logError(v`Error evaluating property '${r}' for plugin ${n}, using default value`),s}};return i}async function le(e){let t=plugins.getPluginForBundle(e);if(nativeApi.log(`Got plugin for bundleId = ${e}`),!t||null==t.subscriptionMediaType||null==t.subscriptionSegment)return null;let n=nativeApi.user(),i=pe(n,t.subscriptionMediaType),s=new sr,a=await fe(t.subscriptionMediaType,e);if(!a)return nativeApi.log(`Subscription state lookup failed for type = ${t.subscriptionMediaType} and bundleId = ${e}`),null;ar.set(i,a);let o=s.fetchSubscriptionState(n.userId,e),u=null;null!=o&&o.active!=a.active?u=a.active?on:un:null==o&&a.active&&r(a.initialPurchaseTimestamp)&&Zt()(a.initialPurchaseTimestamp).isAfter(Zt()().subtract(1,"day"))&&(u=cn),null!=o&&null===u||s.storeSubscriptionState(n.userId,a);let c=null;return null!==u&&(nativeApi.logDebug(`Sub updated change: ${u} `),nativeApi.logDebug(`Generating event ${u} for ${e}`),c={eventType:u,bundleId:e,createdOn:Date.now()},o&&u===un&&(c.isTrial=o.trial)),c}async function de(e,t){if(void 0===t)return;let n=pe(nativeApi.user(),t);if(!ar.has(n)){let i=await fe(t,e);nativeApi.logDebug(v`${e} subscription state ${i}`),ar.set(n,i)}}function he(e,t){let n=pe(e,t);return ar.fetch(n)}function pe(e,t){return`${e.userId}_${t}`}async function fe(e,t){let n={bundleId:t,active:!1},i=await nativeApi.lookupSubscription(e);if(!i)return null;if(!en(i.entitlements)){const e=plugins.getPluginForBundle(t);let s;if(r(e.subscriptionAdamId)&&(s=i.entitlements[e.subscriptionAdamId]),!s){let e=Object.keys(i.entitlements)[0];s=i.entitlements[e]}s&&(n=function(e,t){var n,i,r,s,a,o,u,c,l,d;return{bundleId:e,active:1==t.status,autoRenewEnabled:t.autoRenewEnabled,expiresOn:1e3*(null!==(n=t.expiration)&&void 0!==n?n:0),entitlementSourceAdamId:null!==(i=t.entitlementSourceAdamId)&&void 0!==i?i:0,familySubscription:t.familySubscription,featureAccessTypeId:null!==(r=t.featureAccessTypeId)&&void 0!==r?r:0,freeTrialPeriodId:null!==(s=t.freeTrialPeriodId)&&void 0!==s?s:0,inAppAdamId:null!==(a=t.inAppAdamId)&&void 0!==a?a:0,inAppVersion:null!==(o=t.inAppVersion)&&void 0!==o?o:0,initialPurchaseTimestamp:1e3*(null!==(u=t.initialPurchaseTimestamp)&&void 0!==u?u:0),offerId:t.offerId,poolType:t.poolType,promoScenarioId:t.promoScenarioId,trial:t.inTrialPeriod,offerPeriod:t.inOfferPeriod,gracePeriod:t.inGracePeriod,purchaser:t.purchaser,renewDate:1e3*(null!==(c=t.renewDate)&&void 0!==c?c:0),serviceBeginsTimestamp:1e3*(null!==(l=t.serviceBeginsTimestamp)&&void 0!==l?l:0),source:t.source,status:t.status,subscriptionBundleId:null!==(d=t.subscriptionBundleId)&&void 0!==d?d:0,vendorAdHocOfferId:t.vendorAdHocOfferId,vendorId:t.vendorId}}(t,s))}return n}function me(e,t,n,i){return t.map((t=>{const r={badgeID:t,enabled:n};return i&&(r.metricsEvent=i(t)),(0,gt.createBadgingAction)(e,r)}))}function ve(e){if(e===or)return gt.BadgeClientIdentifier.appStore}function ge(e,t){e.journeyInstance.setExpectedDelay(e.journeyInstance.step,Zt()().add(t,"millisecond").valueOf()),nativeApi.scheduleEvents({identifier:`${e.journeyInstance.id}_${e.journeyInstance.step}`,battery:!0,dataClass:Kt.G.C,delaySecs:t/1e3},[{eventType:hn,bundleId:e.journeyInstance.bundleId,createdOn:Date.now(),journeyId:e.journeyInstance.id,versionId:e.journeyInstance.versionId,step:e.journeyInstance.step}])}function ye(e){return e.eventType===Ir||e.eventType===Dr||"$DebugEngagementRequest"===e.eventType}function we(e){if(Te(e))return nativeApi.logDebug(`Ignoring scheduled trigger ${e.versionId} as it has already been processed`),!1;const t=Ae(e);return!(!t||!function(e){let t=e.valueOf()-Date.now();return t>0||Zt().duration(Math.abs(t/1e3),"seconds").asHours()<24}(t)&&(nativeApi.logDebug(`Ignoring scheduled trigger ${e.versionId} as it's too old (was scheduled on: ${t.format()})`),1))}function be(e){if(e.triggerType===st.ScheduledBased&&e.status===rt.Active&&we(e)){nativeApi.logDebug(`Scheduling version ${e.versionId} at ${e.scheduledAt} ${"true"===e.scheduleAtLocalUserTime?"local time":"UTC"}`);let t=Ae(e);if(void 0===t)return void I(b(plugins.getPluginForBundle(e.bundleId)),"Failed to determine schedule time");let n=0==Math.max(0,t.valueOf()-Date.now())?Zt()().format():t.format();const i=Se(e);nativeApi.scheduleEvents({identifier:i,battery:!0,dataClass:Kt.G.Default,date:n},[{eventType:fn,createdOn:Date.now(),bundleId:e.bundleId,versionId:e.versionId}]),(new xr).writeExpectedScheduledTrigger(i,n)}}function Ae(e){if(!e.scheduledAt)return;let t=Zt()(e.scheduledAt);return"true"===e.scheduleAtLocalUserTime&&(t=t.add((new Date).getTimezoneOffset(),"minute")),t}function Se(e){return e.versionId}function Te(e){let t=new xr;const n=Se(e);return!en(t.readTrigger(n))}function Ce(e){plugins.injectUserAttributes(e),function(e){nativeApi.log("adding common attributes to user...");for(const t of plugins.getPlugins())c(e,t.namespace,{authorizedNotifications:T({getPromiseId:()=>`${t.namespace}.authorizedNotifications`,async call(){const e=nativeApi.userNotifications();if(!e)return kt.AuthorizationStatus.notDetermined;const n=await e.getAuthorizationStatus(t.appBundleId);return(null==n?void 0:n.authorizationStatus)||kt.AuthorizationStatus.notDetermined}})})}(e),e.tags=function(){return(new xi).getUserTags(e.userId)},e.device=function(){return nativeApi.device()},e.custom=function(){return(new Fi).readUserAttributes(e.userId)},e.iTunesAccount=nativeApi.iTunesAccount(),e.iCloudAccount=nativeApi.iCloudAccount(),Object.assign(e,{iTunesFamily:(new jr).readAttribute(Ur),iCloudFamily:(new jr).readAttribute(Lr)})}async function Ee(e){switch(e.eventType){case"$DebugEvaluate":return await async function(e){const t=nativeApi.database(an),n=e.expressions.map(unescape),i=[];for(const t of n){nativeApi.log(v`[Debug] Evaluating expression '${t}'`);try{const n=new Ci,r=b(null);r.currentEvent=e,r.user=Ie();const s=await n.evalExpression(r,t);nativeApi.log(v`[Debug] Evaluated expression '${t}' with event '${e}' to ${s}`),i.push({expression:t,result:v`${s}`})}catch(e){const n=v`[Debug] Failed to evaluated expression '${t}', error: ${e}`;nativeApi.logError(n),i.push({expression:t,result:n})}}nativeApi.log(v`[Debug] Evaluated expressions to ${i}`),null==t||t.set("debug_evaluate_results",i)}(e);case"$DebugWriteUserAttributes":return await async function(){const e=Ie(),t=nativeApi.database(an);let n=await Me(e);null==t||t.set("debug_user_props",n)}();case"$DebugEngagementRequest":return function(e){var t;let n=(0,gt.createMessageAction)(e.serviceType,{engagementRequest:{metricsOverlay:e.metricsOverlay,url:e.url,clientData:{style:null!==(t=e.engagementStyle)&&void 0!==t?t:"automatic"}}});nativeApi.enqueueActions(n)}(e)}}async function Me(e,t=!1){let i={};for(const r of Object.keys(e))try{let s=e[r];"function"==typeof s?s=t?null:await ke(s):n(s)&&(s=await Me(s,t)),i[r]=s}catch(e){nativeApi.logError(`Failed to evaluate attribute ${r}, error: ${e}`)}return i}async function ke(e){let t=b(new Fr);const n=new bi;return n.bindValue(hi,t),e(n),await t.resolvePromises(),e(n)}function Ie(){const e=nativeApi.user();return Ce(e),e}function De(e){return e.userId.length>0&&"anonymous"!==e.userId}function Pe(e){return Boolean(e)&&"object"==typeof e&&"object"==typeof e.userInfo}function _e(){return"undefined"!=typeof bag?bag:null}function $e(e,t){var n;let i=_e();if(!i)return;let r=i[t](e);if(!r)return;let s=AMS.database.create().result,a=null!==(n=null==s?void 0:s.fetch($t.cachedBagValues))&&void 0!==n?n:{};a[e]=r,null==s||s.set($t.cachedBagValues,a),es=a}function xe(e,t){var n;let i=_e();if(i)return i[t](e);if(!es){let e=AMS.database.create().result;es=null!==(n=null==e?void 0:e.fetch($t.cachedBagValues))&&void 0!==n?n:{}}return es[e]||null}function Oe(e,t,n=null){var i,r,s;let a=Re(e,null===(i=xe(xt.Language,Ot.String))||void 0===i?void 0:i.toLowerCase(),0);if(a||(a=Re(e,null===(r=xe(xt.LanguageTag,Ot.String))||void 0===r?void 0:r.toLowerCase(),1)),a||(a=Re(e,(null!==(s=AMS.client.locale)&&void 0!==s?s:"").replace("_","-").toLowerCase(),2)),a)return a;Ne("native",3);let o=t?AMS.localize.nativeString(t):null;return null!=o?o:n}function Ne(e,t){ns!=e&&(ns=e,AMS.log.default("Using language: "+e+" fallback: "+t))}function Re(e,t,n){var i;if(!t)return null;let r=function(e,t,n){var i,r;let s=(null!==(r=(null!==(i=n.localizations)&&void 0!==i?i:{})[t])&&void 0!==r?r:{})[e],a=s&&s.startsWith("**")&&s.endsWith("**");return s&&!a?s:null}(e,t,null!==(i=function(){if(ts)return ts;let e=AMS.props;return ts=null!=e?e:{},ts}())&&void 0!==i?i:{});return r?(Ne(t,n),r):null}function je(e,t,n){const i=e.indexOf(t);let r,s=e;if(-1!==i){const a=e.slice(0,i),o=e.slice(i+t.length,e.length);"prefix"===n?(r=a,s=o):(r=o,s=a)}return{result:r,remainder:s}}function Ue(e=!1){return e?{style:"proxCard",marketingItem:{id:"mi.d3e5f790-3c71-4764-87fb-61e136150110",type:"marketing-items",attributes:{marketingVideo:{},variantId:"219449ec-4362-495d-b85e-59cc970d9ee4",marketingArtwork:{topShelf:{width:2160,height:900,url:"https://is3-ssl.mzstatic.com/image/thumb/LBR4vM7f1oXwVG-BxbzBlg/{w}x{h}{c}.{f}"}},offers:[{kind:"link",url:"music://amsui.apple.com/dynamic/marketing?route=marketingItem&serviceType=music&placement=musicPreBuyFlow&offerHints=contextual",callToActionLabel:"Open",metrics:{offerDecisionId:"b6db504a-ac8e-47b2-866f-74948992cd9a",targetId:"SeeOtherPlans","location.0.id":"SeeOtherPlans","location.0.idType":"label","marketing.marketingItemId":"mi.d3e5f790-3c71-4764-87fb-61e136150110",placementType:"BUY_FLOW","marketing.offerDecisionId":"b6db504a-ac8e-47b2-866f-74948992cd9a",placement:"musicPreBuyFlow",decisionId:"b6db504a-ac8e-47b2-866f-74948992cd9a"}}],display:{serviceTypeData:{MUSIC:{artwork:{width:1024,height:1024,url:"https://is2-ssl.mzstatic.com/image/thumb/jEZybkUlgKe3QYfwzZj1Bg/{w}x{h}{c}.{f}"},description:"70\u2060+ million songs, all ad\u2011free",title:"Music"}},templateParameters:{hideBadge:!0},template:"service-product-card"},title:"Explore New Music",subtitle:"Discover the latest releases from all your favorite artists.",serviceType:"BUNDLE",campaignId:"marketing:aristotle---complete---none---arcade---all---savings"},relationships:{contents:{data:[]}},meta:{metrics:{offerDecisionId:"b6db504a-ac8e-47b2-866f-74948992cd9a",pageType:"Upsell",upsellType:"contextual","marketing.marketingItemId":"mi.d3e5f790-3c71-4764-87fb-61e136150110",placementType:"BUY_FLOW","marketing.offerDecisionId":"b6db504a-ac8e-47b2-866f-74948992cd9a",page:"Upsell_aobOffer",placement:"arcadePreBuyFlow",pageId:"aobOffer",decisionId:"b6db504a-ac8e-47b2-866f-74948992cd9a",upsellScenario:"savings"}}}}:{style:"proxCard",marketingItem:{id:"mi.d3e5f790-3c71-4764-87fb-61e136150110",type:"marketing-items",attributes:{marketingVideo:{},variantId:"219449ec-4362-495d-b85e-59cc970d9ee4",marketingArtwork:{topShelf:{width:2160,height:900,url:"https://is3-ssl.mzstatic.com/image/thumb/LBR4vM7f1oXwVG-BxbzBlg/{w}x{h}{c}.{f}"}},offers:[{kind:"link",url:"music://amsui.apple.com/dynamic/marketing?route=marketingItem&serviceType=music&placement=musicPreBuyFlow&offerHints=contextual",callToActionLabel:"Open",serviceTypes:["MUSIC"],metrics:{offerDecisionId:"b6db504a-ac8e-47b2-866f-74948992cd9a",targetId:"SeeOtherPlans","location.0.id":"SeeOtherPlans","location.0.idType":"label","marketing.marketingItemId":"mi.d3e5f790-3c71-4764-87fb-61e136150110",placementType:"BUY_FLOW","marketing.offerDecisionId":"b6db504a-ac8e-47b2-866f-74948992cd9a",placement:"musicPreBuyFlow",decisionId:"b6db504a-ac8e-47b2-866f-74948992cd9a"}}],display:{serviceTypeData:{MUSIC:{artwork:{width:1024,height:1024,url:"https://is2-ssl.mzstatic.com/image/thumb/jEZybkUlgKe3QYfwzZj1Bg/{w}x{h}{c}.{f}"},description:"70\u2060+ million songs, all ad\u2011free",title:"Music"}},templateParameters:{hideBadge:!0},template:"service-product-card"},title:"Explore New Music",subtitle:"Discover the latest releases from all your favorite artists.",serviceType:"BUNDLE",campaignId:"marketing:aristotle---complete---none---arcade---all---savings"},relationships:{contents:{data:[]}},meta:{metrics:{offerDecisionId:"b6db504a-ac8e-47b2-866f-74948992cd9a",pageType:"Upsell",upsellType:"contextual","marketing.marketingItemId":"mi.d3e5f790-3c71-4764-87fb-61e136150110",placementType:"BUY_FLOW","marketing.offerDecisionId":"b6db504a-ac8e-47b2-866f-74948992cd9a",page:"Upsell_aobOffer",placement:"arcadePreBuyFlow",pageId:"aobOffer",decisionId:"b6db504a-ac8e-47b2-866f-74948992cd9a",upsellScenario:"savings"}}}}}function Le(e){let t=new RegExp("^(?:([^:/?#]+):)?(?://([^/?#]*))?([^?#]*)(?:\\?([^#]*))?(?:#(.*))?"),n=e.match(t);return n?{originalUrl:e,scheme:n[1],host:n[2],path:n[3],query:n[4],fragment:n[5]}:{originalUrl:e}}function Be(e){var t;return{metadata:{"Cache-Control":"no-transform, max-age=10"},body:{data:[{id:"com.apple.ams.ac",type:"app-clips",href:"/v1/catalog/us/app-clips/com.apple.ams.ac?l=en-US",attributes:{fullAppOnly:!0,name:e.title,appShortName:e.appName,targetURL:e.targetURL,appName:e.appName,artistName:null!==(t=e.companyName)&&void 0!==t?t:"Apple",platformAttributes:{ios:{appBundleId:e.targetURLBundleId,action:e.buttonTitle,appSubtitle:e.appName,subtitle:e.subtitle,bundleId:"com.apple.ams.ac",appArtwork:{width:1024,height:1024,bgColor:"cc004b",textColor1:"ffffff",textColor2:"ffdfea",textColor3:"f4cbdb",textColor4:"f4b2ca",...e.appArtwork},verifiedAssociatedDomains:["appclips:ams-ac.apple.com","appclips:"+Le(e.targetURL).host],heroArtwork:{width:1800,height:1200,bgColor:"bb0044",textColor1:"feedf3",textColor2:"fed7e5",textColor3:"f1bed0",textColor4:"f0acc5",...e.heroArtwork},externalVersionId:-999,minimumOSVersion:"14.0",requiredCapabilities:["arm64"]}},deviceFamilies:["iphone","ipad","ipod"],appUrl:e.appURL}}]}}}function Fe(e,t,n=AMS.database.create().result){void 0===n?Ve("Failed to access DB to cache subscription"):(n.set(vs+e.type.toString(),t),We(`Cached type ${e.type}`))}async function qe(e,t=!0){We(`Performing lookup for type ${e.type}`);try{let n=await AMS.subscription.lookup(e);return We(`Got response for type ${e.type}`),t&&Fe(e,n),n}catch(e){throw Ve("Failed to perform lookup with error: "+JSON.stringify(e)),e}}function We(e){AMS.log.default("[SubscriptionManager] "+e)}function Ve(e){AMS.log.error("[SubscriptionManager] "+e)}function He(e,t){var n;let i=Le(t);return i.query=null!==(n=i.query)&&void 0!==n?n:"",i.query.length>0&&(i.query+="&"),i.query+="itscg="+e.itscg+"&itsct="+e.itsct,function(e){var t,n,i,r,s,a,o;let u=(null!==(n=null===(t=e.query)||void 0===t?void 0:t.length)&&void 0!==n?n:0)>0?"?"+e.query:"",c=(null!==(r=null===(i=e.fragment)||void 0===i?void 0:i.length)&&void 0!==r?r:0)>0?"#"+e.query:"";return(null!==(s=e.scheme)&&void 0!==s?s:"https")+"://"+(null!==(a=e.host)&&void 0!==a?a:"")+(null!==(o=e.path)&&void 0!==o?o:"")+u+c}(i)}async function Je(e){var t,n,i;let r,s=await async function(e,t=!1){We(`Handling Subscription with type ${e.type}}`);const n=function(e){let t=AMS.database.create().result;if(void 0===t)return void Ve("Failed to access DB to read subscriptions");const n=t.fetch(vs+e.type.toString());if(null===n)return void We(`Failed to get cached entitlement for type ${e.type}`);const i=n;return We(`Returning cached response for type ${e.type}`),i}(e);if(void 0!==n)return We("Returning cached result"),n;if(t)throw qe(e),new Error("No cached subscription found");return We("No cached result. Performing lookup"),qe(e)}({type:e},!0).catch((()=>(AMS.log.default("Failed to lookup subscription"),[])));if(!s||Array.isArray(s)&&0==s.length)return!1;r=Array.isArray(s)?s[0]:s;let a=null!==(n=Object.keys(null!==(t=null==r?void 0:r.entitlements)&&void 0!==t?t:{})[0])&&void 0!==n?n:"",o=null==r?void 0:r.entitlements;return!o||(null===(i=o[a])||void 0===i?void 0:i.status)==kt.SubscriptionResponseStatus.entitled}async function Ge(e){let t=function(e){var t,n,i,r,s,a,o;let u=null,c=null===(t=e.path)||void 0===t?void 0:t.split("/");if(c&&(null==c?void 0:c.length)>1){let e=null!==(n=c[1])&&void 0!==n?n:"",t="";(null==c?void 0:c.length)>2&&(t=null!==(i=c[2])&&void 0!==i?i:"");let l=null!==(r=Number(e.substring(1)))&&void 0!==r?r:-1,d=Object.values(Bt).includes(l)?l:null,h=d?gs[d]:void 0,p=t,f=/(?<version>\d*)(?<country>\w*).*/gm.exec(t),m=null!==(a=Number(null===(s=null==f?void 0:f.groups)||void 0===s?void 0:s.version))&&void 0!==a?a:1,v=null===(o=null==f?void 0:f.groups)||void 0===o?void 0:o.country;d&&m!==Number.NaN?u={serviceType:d,version:m,countryCode:v,itscg:h,itsct:p}:AMS.log.error("Missing serviceType or version. type: "+d+" version: "+m+" itscg: "+h)}return u}(e);t||AMS.log.error("Unable to determine store metadata"),AMS.log.default(`Detected store URL: ${t}`);let n=null;switch(null==t?void 0:t.serviceType){case Bt.AppStore:break;case Bt.Arcade:n=await async function(e){var t,n,i,r;let s,a,o,u;return await Je(kt.SubscriptionMediaType.appStore)?(s=null!==(t=Oe("AMSEngagement.ACC.Arcade1.Sub.Title",null,"Play Now"))&&void 0!==t?t:"",a=null!==(n=Oe("AMSEngagement.ACC.Arcade1.Sub.Description",null,"Exciting new games added every month."))&&void 0!==n?n:"",o="https://apple-shared-resources.s3.us-east-1.amazonaws.com/acc/sub/us_arcade.png",u="https://apps.apple.com/us/app/angry-birds-reloaded/id1539172625"):(s=null!==(i=Oe("AMSEngagement.ACC.Arcade1.NonSub.Title",null,"Start Playing"))&&void 0!==i?i:"",a=null!==(r=Oe("AMSEngagement.ACC.Arcade1.NonSub.Description",null,"Over 200 games. No ads. No in-app purchases."))&&void 0!==r?r:"",o="https://apple-shared-resources.s3.us-east-1.amazonaws.com/acc/non-sub/us_arcade.png",u="https://apps.apple.com/arcade"),Be({title:s,subtitle:a,buttonTitle:Lt.open,targetURL:He(e,u),targetURLBundleId:"com.apple.AppStore",appName:"App Store",appURL:"itms-apps://apps.apple.com/arcade",appArtwork:{url:"https://is3-ssl.mzstatic.com/image/thumb/Features123/v4/fd/40/74/fd407446-e0fb-a04e-9445-9dc6b8f7e90a/pr_source.png/{w}x{h}{c}.{f}"},heroArtwork:{url:o}})}(t);break;case Bt.Books:break;case Bt.Fitness:n=await async function(e){var t,n,i,r;let s,a,o,u;return await Je(kt.SubscriptionMediaType.activity)?(s=null!==(t=Oe("AMSEngagement.ACC.Fitness1.Sub.Title",null,"Move Now"))&&void 0!==t?t:"",a=null!==(n=Oe("AMSEngagement.ACC.Fitness1.Sub.Description",null,"Get inspired with new workouts every week.\t"))&&void 0!==n?n:"",o="https://apple-shared-resources.s3.us-east-1.amazonaws.com/acc/sub/us_fitness.png",u="https://fitness.apple.com"):(s=null!==(i=Oe("AMSEngagement.ACC.Fitness1.NonSub.Title",null,"Start Moving"))&&void 0!==i?i:"",a=null!==(r=Oe("AMSEngagement.ACC.Fitness1.NonSub.Description",null,"World-class workouts from the world\u2019s top trainers."))&&void 0!==r?r:"",o="https://apple-shared-resources.s3.us-east-1.amazonaws.com/acc/non-sub/us_fitness.png",u="https://fitness.apple.com"),Be({title:s,subtitle:a,buttonTitle:Lt.open,targetURL:He(e,u),targetURLBundleId:"com.apple.Fitness",appName:"Fitness",appURL:"itms-apps://?bundleIdentifier=com.apple.Fitness",appArtwork:{url:"https://is5-ssl.mzstatic.com/image/thumb/Purple114/v4/e7/a0/3e/e7a03eb9-18cc-7fcd-aa63-d8a9a8755ce7/AppIcon-1x_U007emarketing-0-10-0-85-220.png/{w}x{h}{c}.{f}"},heroArtwork:{url:o}})}(t);break;case Bt.Music:n=await async function(e){var t,n,i,r;let s,a,o,u;return await Je(kt.SubscriptionMediaType.music)?(s=null!==(t=Oe("AMSEngagement.ACC.Music1.Sub.Title",null,"Listen Now"))&&void 0!==t?t:"",a=null!==(n=Oe("AMSEngagement.ACC.Music1.Sub.Description",null,"Hear sound all around in Spatial Audio."))&&void 0!==n?n:"",o="https://apple-shared-resources.s3.us-east-1.amazonaws.com/acc/sub/us_music.png",u="https://music.apple.com/us/playlist/made-for-spatial-audio/pl.154af9931b214278a64274c410046e69"):(s=null!==(i=Oe("AMSEngagement.ACC.Music1.NonSub.Title",null,"Start Listening"))&&void 0!==i?i:"",a=null!==(r=Oe("AMSEngagement.ACC.Music1.NonSub.Description",null,"Get millions of songs, ad-free."))&&void 0!==r?r:"",o="https://apple-shared-resources.s3.us-east-1.amazonaws.com/acc/non-sub/us_music.png",u="https://music.apple.com/deeplink?app=music&p=forYou"),Be({title:s,subtitle:a,buttonTitle:Lt.open,targetURL:He(e,u),targetURLBundleId:"com.apple.Music",appName:"Music",appURL:"itms-apps://?bundleIdentifier=com.apple.Music",appArtwork:{url:"https://is3-ssl.mzstatic.com/image/thumb/Purple115/v4/96/c2/d1/96c2d1c9-4876-0461-bbe4-245bfadc6c75/AppIcon-0-0-1x_U007emarketing-0-0-0-10-0-0-sRGB-0-0-0-GLES2_U002c0-512MB-85-220-0-0.png/{w}x{h}{c}.{f}"},heroArtwork:{url:o}})}(t);break;case Bt.News:case Bt.Podcasts:break;case Bt.TV:n=await async function(e){var t,n,i,r;let s,a,o,u;return await Je(kt.SubscriptionMediaType.tv)?(s=null!==(t=Oe("AMSEngagement.ACC.TV1.Sub.Title",null,"Watch Now"))&&void 0!==t?t:"",a=null!==(n=Oe("AMSEngagement.ACC.TV1.Sub.Description",null,"Catch up on the latest Apple Originals."))&&void 0!==n?n:"",o="https://apple-shared-resources.s3.us-east-1.amazonaws.com/acc/sub/us_tv.png",u="https://tv.apple.com/us/show/ted-lasso/umc.cmc.vtoh0mn0xn7t3c643xqonfzy"):(s=null!==(i=Oe("AMSEngagement.ACC.TV1.NonSub.Title",null,"Start Watching"))&&void 0!==i?i:"",a=null!==(r=Oe("AMSEngagement.ACC.TV1.NonSub.Description",null,"Original shows and movies you won\u2019t find anywhere else."))&&void 0!==r?r:"",o="https://apple-shared-resources.s3.us-east-1.amazonaws.com/acc/non-sub/us_tv.png",u="https://tv.apple.com/channel/tvs.sbd.4000"),Be({title:s,subtitle:a,buttonTitle:Lt.open,targetURL:He(e,u),targetURLBundleId:"com.apple.tv",appName:"TV",appURL:"itms-apps://?bundleIdentifier=com.apple.tv",appArtwork:{url:"https://is3-ssl.mzstatic.com/image/thumb/Purple125/v4/b5/ef/8e/b5ef8e8d-f285-ef5c-2fad-89e2d1dd1cf8/AppIcon-0-0-1x_U007emarketing-0-0-0-7-0-0-sRGB-0-0-0-GLES2_U002c0-512MB-85-220-0-0.png/{w}x{h}{c}.{f}"},heroArtwork:{url:o}})}(t);break;case Bt.AppleOne:n=await async function(e){var t,n;return Be({title:null!==(t=Oe("AMSEngagement.ACC.AppleOne.NonSub.Title",null,"Get Apple One"))&&void 0!==t?t:"",subtitle:null!==(n=Oe("AMSEngagement.ACC.AppleOne.NonSub.Description",null,"Up to six services in one simple plan. Upgrade today."))&&void 0!==n?n:"",buttonTitle:Lt.open,targetURL:He(e,"https://one.apple.com"),targetURLBundleId:"com.apple.AMSEngagementViewService",appName:"Apple One",appURL:"ams-ui://one.apple.com",appArtwork:{url:"https://apple-shared-resources.s3.us-east-1.amazonaws.com/acc/non-sub/apple-one-icon.png"},heroArtwork:{url:"https://apple-shared-resources.s3.us-east-1.amazonaws.com/acc/non-sub/us_one.png"}})}(t)}return n}async function Ye(){var e,t=[];let n=null===(e=xe(xt.CountryCode,Ot.String))||void 0===e?void 0:e.toLowerCase();if(void 0===n)return AMS.log.error("[App Clip] Failed obtain countryCode)"),[];for(const e in Bt){const i=Number(e);if(isNaN(i))continue;const r=`https://ams-ac.apple.com/s${i}/1${n}`;AMS.log.default(`[App Clip] Attempting to cache link ${r} (countryCode: ${n}, serviceType: ${i})`);const s=Le(r);try{const i=await Ge(s);if(null===i){AMS.log.error(`[App Clip] Failed to create clip (countryCode: ${n}, serviceType: ${e})`);continue}const a=(0,Ft.createCacheDataAction)(i,{source:"AMSClipMediaTask",url:r},r,86400);AMS.log.default(`[App Clip] Caching (countryCode: ${n}, serviceType: ${e})`),t.push(a)}catch(t){AMS.log.error(`[App Clip] Failed to create clip (countryCode: ${n}, serviceType: ${e})`)}}return t}function ze(e,t){let n=!0;for(let i in t.filter){let r=e[i];if(!r){n=!1;break}let s=t.filter[i],a=s?new RegExp(s):null;if(!a){n=!1;break}if(!a.test(r)){n=!1;break}}return n}function Ke(e=ys){return{async enqueue(t){var n;let i,r=function(e,t){let n=[];for(const i of t){let t=[],r=i.eventAllowlist();0!=r.length&&(e.events.forEach((e=>{for(const n of r)if(ze(e,n)){t.push(e);break}})),t.length>0&&n.push({provider:i,client:e.client,events:t}))}return n}(t,e),s=[];for(let e=0;e<r.length;e++){let t=r[e];if(!t)continue;let a={client:null==t?void 0:t.client,events:null==t?void 0:t.events},o=await t.provider.respond(a);i=null!=i?i:o.data,s=s.concat(null!==(n=o.actions)&&void 0!==n?n:[])}return{data:i,actions:s}},async sync(t){let n=[];for(let i=0;i<e.length;i++){let r=e[i];r&&(await r.setup(t),n=n.concat(r.eventAllowlist()))}return{whitelistedEvents:n,allowedEvents:n}}}}var Qe,Ze,Xe,et,tt,nt,it,rt,st,at,ot,ut,ct,lt,dt,ht,pt,ft,mt,vt,gt,yt,wt,bt,At,St,Tt,Ct,Et,Mt,kt,It,Dt,Pt,_t,$t,xt,Ot,Nt,Rt,jt,Ut,Lt,Bt,Ft,qt,Wt,Vt,Ht,Jt,Gt,Yt,zt,Kt=e(5422),Qt=e(7322),Zt=e.n(Qt);const Xt=e=>!en(e),en=e=>Array.isArray(e)?0===e.length:e&&"object"==typeof e?0===Object.keys(e).length:!e,tn={iOS:{18:"14",19:"15",20:"16"},macOS:{20:"11",21:"12",22:"13"}};Qe=e(9681);const nn="Control";!function(e){e[e.None=0]="None",e[e.PrivateDataUnavailable=7]="PrivateDataUnavailable"}(Ze||(Ze={})),function(e){e[e.News=0]="News",e[e.AppStore=1]="AppStore",e[e.Fitness=2]="Fitness",e[e.Music=3]="Music",e[e.TV=4]="TV",e[e.iCloud=5]="iCloud"}(Xe||(Xe={}));const rn="EnqueueAction";class sn extends Error{constructor(e,t){super(t);const n=new.target.prototype;Object.setPrototypeOf(this,n)}}const an=Kt.G.Default,on="subscription:activated",un="subscription:lapsed",cn="subscription:loaded-active",ln="SubscriptionLookupFailed",dn="SubscriptionChanged",hn="DelayedEvent",pn="AsyncEvent",fn="$ScheduledTriggerEvent",mn="os:upgrade",vn="journeys:JourneyCompleted",gn="journeys:JourneyStarted",yn="journeys:NotificationDisplayed",wn="journeys:NotificationTapped",bn="journeys:StepEntered",An="journeys:StepExited",Sn="MessageRequest",Tn="journeys:InAppDisplayed",Cn="journeys:InAppAction",En="journeys:Rescheduled",Mn="click",kn="MercuryCacheUpdated",In="journeys:GranularNotificationSetting",Dn="journeys:NotificationSetting",Pn="journeys:BadgeDisplayed";class _n{getDatabase(){const e=an,t=nativeApi.database(e);if(!t)throw new Error(`Cannot get a database of data class ${e}.`);return t}}et=e(267),tt=e.n(et),Zt().extend(tt());class $n{constructor(e,t){const{id:n,transitions:i,...r}=t;this.id=n,this.stepType=e,this.transitions=i||{},Object.assign(this,r)}}class xn extends $n{constructor(e){super("CONDITION",e)}}class On extends $n{constructor(e){super("START",e)}}class Nn extends $n{constructor(e){super("TERMINAL",e)}}class Rn extends $n{constructor(e){super(e.stepType,e)}}class jn extends $n{constructor(e){super(e.stepType,e)}}class Un extends $n{constructor(e){super("WAIT",e)}}class Ln extends $n{constructor(e){super("WAIT",{id:e.id}),this.waitMode=e.waitMode,this.duration=e.duration,this.timeUnit=e.timeUnit,Object.assign(this,e)}}class Bn extends $n{constructor(e){super("LOCAL_NOTIFICATION",e)}}class Fn extends $n{constructor(e){super("AB_SPLIT",e),this.assignmentRetentionDays=90}}class qn extends $n{constructor(e){super("EXPERIMENT",e)}}class Wn extends $n{constructor(e){super("TAG",e)}}class Vn extends $n{constructor(e){super("UNTAG",e)}}class Hn extends $n{constructor(e){super("SET_USER_ATTRIBUTE",e)}}class Jn extends $n{constructor(e){super("ODJ_BADGE",e)}}class Gn extends $n{constructor(e){super("ODJ_REMOVE_BADGE",e)}}class Yn extends Error{constructor(e){super(v`Can't create step instance for ${e}.`)}}class zn{constructor(e){if(this.ttlSeconds=e,e<=0)throw Error("The cache ttl must be positive");this.cache=new Map}fetch(e,t){if(!e)return null;let n=this.cache.get(e);return n&&this.hasLapsed(n)&&(this.cache.delete(e),n=void 0),!n&&t&&(n={value:t(e),ts:Date.now()},this.cache.set(e,n)),n?n.value:null}set(e,t){this.cache.set(e,{value:t,ts:Date.now()})}has(e){let t=this.cache.get(e);return!!t&&!this.hasLapsed(t)}hasLapsed(e){return!!e&&(Date.now()-e.ts)/1e3>=this.ttlSeconds}clear(){this.cache.clear()}}!function(e){e.ApplicationSettings="appsettings",e.JourneyVersionDef="journey_def",e.JourneyVersions="journey_defs",e.JourneyVersionSteps="journey_def_steps"}(nt||(nt={}));const Kn=new zn(60);class Qn extends _n{static createKey(e,t){return`${t}_${e}`}readApplicationSettings(e){let t=Qn.createKey(e,nt.ApplicationSettings);return this.getDatabase().fetch(t)}writeApplicationSettings(e,t){let n=Qn.createKey(e,nt.ApplicationSettings);this.getDatabase().set(n,t)}readJourneyVersion(e){var t;let n=Qn.createKey(e,nt.JourneyVersionDef);const i=null!==(t=this.getDatabase().fetch(n))&&void 0!==t?t:null;return i?new Zn(i):null}deleteJourneyVersionById(e){let t=this.readJourneyVersion(e);t&&this.deleteJourneyVersion(t)}deleteJourneyVersion(e){var t;let n=Qn.createKey(e.versionId,nt.JourneyVersionDef),i=this.getDatabase();i.set(n,null);for(let n=0;n<(null!==(t=e.pages)&&void 0!==t?t:0);n++){let t=Qn.createKey(`${e.versionId}_${n}`,nt.JourneyVersionSteps);i.set(t,null)}}writeJourneyVersion(e){let t=Qn.createKey(e.versionId,nt.JourneyVersionDef);this.getDatabase().set(t,e)}readAllJourneyVersionSteps(e){let t=Qn.createKey(`${e.versionId}_%`,nt.JourneyVersionSteps);const n=this.getDatabase().fetchMatchingKeys(t);return Object.values(n).reduce(((e,t)=>({...e,...t})),{})}readJourneyVersionSteps(e,t){var n;let i=Qn.createKey(`${e.versionId}_${t}`,nt.JourneyVersionSteps),r=Kn.fetch(i);if(r)return r;let s=null!==(n=this.getDatabase().fetch(i))&&void 0!==n?n:{},a={};for(const e of Object.keys(s))a[e]=w(s[e]);return Kn.set(i,a),a}writeJourneyVersionSteps(e,t){let n=this.getDatabase();r(e.pages)||(e.pages=0),void 0===e.pageIndex&&(e.pageIndex={});let i=0;for(;i<t.length;){const r=t.slice(i,Math.min(i+10,t.length));r.forEach((t=>e.pageIndex[t.id]=e.pages));let s=Qn.createKey(`${e.versionId}_${e.pages}`,nt.JourneyVersionSteps);Kn.set(s,null);let a=r.reduce(((e,t)=>({...e,[t.id]:t})),{});n.set(s,a),e.pages+=1,i+=r.length}}readJourneyVersions(e){let t=Qn.createKey(e,nt.JourneyVersions);return(this.getDatabase().fetch(t)||[]).map((e=>new Zn(e)))}writeJourneyVersions(e,t){let n=Qn.createKey(e,nt.JourneyVersions);this.getDatabase().set(n,t)}}!function(e){e.Once="ONCE",e.Repeatable="REPEATABLE",e.MostRecent="MOST_RECENT",e.OnceEver="ONCE_EVER"}(it||(it={})),function(e){e.Active="ACTIVE",e.Published="PUBLISHED",e.Terminated="TERMINATED"}(rt||(rt={})),function(e){e.EventBased="EVENT_BASED",e.ScheduledBased="SCHEDULED_BASED"}(st||(st={}));class Zn{constructor(e){this.triggerType=st.EventBased,this.groupAllocationRetentionDays=90,this.pages=0,this.pageIndex={},this.journeyId=e.journeyId,this.versionId=e.versionId,this.bundleId=e.bundleId,this.holdoutSeed=e.holdoutSeed,this.holdoutSize=e.holdoutSize,this.groupAllocationIdentifier=e.groupAllocationIdentifier,this.triggerExpression=e.triggerExpression,this.osPlatforms=e.osPlatforms,this.scheduleAtLocalUserTime=e.scheduleAtLocalUserTime,this.allowedStorefrontIds=e.allowedStorefrontIds,this.status=e.status,this.retriggerMode=e.retriggerMode,this.pages=0,this.pageIndex={},e.groupAllocationRetentionDays&&(this.groupAllocationRetentionDays=e.groupAllocationRetentionDays);const{steps:t,...n}=e;Object.assign(this,n)}getStepById(e){return function(e,t){var n,i;if(e.steps)return e.steps[t];{const r=null!==(i=(null!==(n=e.pageIndex)&&void 0!==n?n:{})[t])&&void 0!==i?i:0;return(new Qn).readJourneyVersionSteps(e,r)[t]}}(this,e)}getFlowedStep(e,t){var n;let i=this.getStepById(e);if(i){let e=null===(n=i.transitions)||void 0===n?void 0:n[t];if(e)return this.getStepById(e)}}getTransition(e,t){let n=this.getStepById(e);if(!n)throw Error(`Can't find expected step ${e}`);let i=this.getFlowedStep(e,t);if(!i)throw Error(`Can't find destination step for edge ${t} in ${e}`);return{fromStep:n,toStep:i,edge:t}}static stringify(e){return`journey (journeyId = ${e.journeyId}, versionId = ${e.versionId})`}}!function(e){e.Active="ACTIVE",e.Cancelled="CANCELLED",e.Completed="COMPLETED",e.Failed="FAILED",e.Deleted="DELETED",e.WaitForData="WAIT_DATA"}(at||(at={}));class Xn{constructor(e){this.pendingData=[],this.resolvedData={},this.pendingEvents=[],this.id=e.id,this.userId=e.userId,this.journeyId=e.journeyId,this.versionId=e.versionId,this.bundleId=e.bundleId,this.storefrontId=e.storefrontId,this.startedOn=e.startedOn,this.status=e.status,this.step=e.step,this.stepEnteredOn=e.stepEnteredOn,this.triggerEvent=e.triggerEvent,this.pendingTransition=null,Object.assign(this,e),this.pendingEvents=[...e.pendingEvents||[]],this.pendingData=[...e.pendingData||[]]}hasPendingDataRequest(e){return new Set(this.pendingData).has(e)}hasPendingDataRequests(){return new Set(this.pendingData).size>0}hasResolvedData(){return!en(this.resolvedData||{})}removePendingData(e){s(this.pendingData)?this.pendingData=this.pendingData.filter((t=>t!==e)):this.pendingData=[]}resolvePendingData(e,t){this.resolvedData[e]={requestId:e,data:t},this.removePendingData(e)}addPendingData(e){s(this.pendingData)||(this.pendingData=[]),this.pendingData.push(e)}addPendingEvents(e){s(this.pendingEvents)||(this.pendingEvents=[]),this.pendingEvents.push(...e);let t=this.pendingEvents.length;t>20&&(this.pendingEvents=this.pendingEvents.slice(t))}isWaitingForAsyncData(){return this.status===at.WaitForData&&!en(this.pendingData)}isInProgress(){return this.status===at.Active||this.status===at.WaitForData}markJourneyAsCancelled(){this.status=at.Cancelled}markJourneyAsFailed(){this.status=at.Failed}markJourneyAsWaitingForData(e){this.status=at.WaitForData,this.pendingTransition=e}isInFinalStatus(){return!this.isInProgress()}isDelayedEventForThisJourney(e){return e.eventType===hn&&e.bundleId===this.bundleId&&e.journeyId===this.id&&e.versionId===this.versionId&&e.step===this.step}setExpectedDelay(e,t){this.expectedDelayedStep={step:e,date:t}}hasOutstandingStepDelay(e,t=30){var n;return(null===(n=this.expectedDelayedStep)||void 0===n?void 0:n.step)===e&&Zt()(this.expectedDelayedStep.date).add(t,"minute").isBefore(Zt()())}clearOutstandingStepDelay(){this.expectedDelayedStep=void 0}}class ei extends class{constructor(){this.pendingPromisesIds=[],this.pendingPromises=[],this.resolvedPromises={}}addPendingPromise(e,t){this.pendingPromises.push(t),this.pendingPromisesIds.push(e)}hasPendingPromise(e){return this.pendingPromisesIds.includes(e)}hasPendingPromises(){return!en(this.pendingPromisesIds)}getResolvedPromise(e){return this.resolvedPromises[e]}clearResolvedPromises(){this.resolvedPromises={}}async resolvePromises(){for(const e of await Promise.all(this.pendingPromises)){let[t,n]=e;this.resolvedPromises[t]=n}this.pendingPromises=[],this.pendingPromisesIds=[]}}{constructor(e,t,n,i,r,s,a,o){super(),this.plugin=e,this.user=t,this.events=n,this.applicationSettings=i,this.journeyVersions=r,this.customerJourney=s,this.journeyInstance=a,this.currentEvent=o,r?(this.activeVersions=r.filter((e=>e.status===rt.Active)),this.terminatedVersions=r.filter((e=>e.status===rt.Terminated)),this.versionsMap=new Map,r.forEach((e=>this.versionsMap.set(e.versionId,e)))):(this.activeVersions=[],this.terminatedVersions=[],this.versionsMap=new Map)}getVersionById(e){return this.versionsMap.get(e)}}!function(e){e.ONCE_EVER_TRIGGER="once_ever_trigger"}(ot||(ot={}));class ti extends _n{static createKey(e,t,n){return`${n}_${e}_${t}`}readTrigger(e,t){const n=this.getDatabase(),i=ti.createKey(e,t,ot.ONCE_EVER_TRIGGER);return n.fetch(i)}writeTrigger(e,t,n){const i=this.getDatabase(),r=ti.createKey(e,t,ot.ONCE_EVER_TRIGGER);i.set(r,n)}}class ni{constructor(){this.retriggerMode=it.Once,this.inProgress=new Set,this.completed=new Set,this.inProgressOtherVersions=new Set,this.totalInProgress=0}withRetriggerMode(e){return this.retriggerMode=e,this}withInProgress(e){return this.inProgress=e,this}withInProgressOtherVersions(e){return this.inProgressOtherVersions=e,this}withCompleted(e){return this.completed=e,this}withTotalInProgress(e){return this.totalInProgress=e,this}build(){switch(this.retriggerMode){case it.MostRecent:return new ri(this);case it.Once:return new si(this);case it.Repeatable:return new ai(this);case it.OnceEver:return new oi(this);default:throw new Error(`Unhandled retrigger mode: ${this.retriggerMode}`)}}}class ii{constructor(e){this.retriggerMode=e.retriggerMode,this.inProgress=e.inProgress,this.completed=e.completed,this.inProgressOtherVersions=e.inProgressOtherVersions,this.totalInProgress=e.totalInProgress,this.started=new Set,this.progressed=new Set}getInProgress(){return this.inProgress}getProgressed(){return this.progressed}getStarted(){return this.started}getCompleted(){return this.completed}checkUserJourneysQuota(){return this.totalInProgress+1<=100}canStartNewInstance(e){return this.checkUserJourneysQuota()}updateCompleted(e){this.inProgress.delete(e),this.completed.add(e),this.totalInProgress--}updateStarted(e){this.inProgress.add(e),this.started.add(e),this.totalInProgress++}updateProgressed(e){this.progressed.add(e)}}class ri extends ii{checkUserJourneysQuota(){return this.totalInProgress-this.inProgress.size-this.inProgressOtherVersions.size+1<=100}updateStarted(e){new Set(this.inProgress).forEach((e=>{e.isInProgress()&&(e.markJourneyAsCancelled(),this.updateCompleted(e))})),this.inProgress=new Set,this.inProgressOtherVersions.forEach((e=>{e.isInProgress()&&(e.markJourneyAsCancelled(),this.totalInProgress--)})),super.updateStarted(e)}}class si extends ii{canStartNewInstance(e){return super.canStartNewInstance(e)&&0===this.inProgress.size&&0===this.inProgressOtherVersions.size}}class ai extends ii{}class oi extends ii{constructor(){super(...arguments),this.store=new ti}canStartNewInstance(e){return!!super.canStartNewInstance(e)&&!this.store.readTrigger(nativeApi.user().userId,e.versionId)}updateStarted(e){this.store.writeTrigger(nativeApi.user().userId,e.versionId,{triggeredOn:Date.now(),expiresOn:Zt()().add(3,"month").valueOf()}),super.updateStarted(e)}}const ui="user",ci="event",li="trigger",di="journey",hi="__$context",pi="START",fi="OK",mi="ERROR",vi="TIMEOUT";class gi{instantiateJourneyForUser(e,t,n){let i=Date.now();return new Xn({stepEnteredOn:0,id:`${e.journeyId}_${e.versionId}_${i}_${1e6*Math.random()}`,userId:t.userId,bundleId:e.bundleId,storefrontId:t.storefrontId,journeyId:e.journeyId,versionId:e.versionId,startedOn:i,status:at.Active,triggerEvent:n,step:pi})}}class yi{constructor(){this.functionTable=new Map}defineFunction(e){this.functionTable.set(e.funcName,e)}removeFunction(e){this.functionTable.delete(e)}getFunctionHandler(e){var t;return null===(t=this.functionTable.get(e))||void 0===t?void 0:t.handler}getFunctions(){return this.functionTable.values()}append(e){for(const t of e.getFunctions())this.defineFunction(t)}merge(e){let t=new yi;for(const e of this.getFunctions())t.defineFunction(e);for(const n of e.getFunctions())t.defineFunction(n);return t}}const wi=new yi;wi.defineFunction({funcName:"now",handler:(e,t)=>Date.now()}),wi.defineFunction({funcName:"daysUntil",handler:(e,t)=>{const n=t[0];if("string"!=typeof n&&"number"!=typeof n&&!function(e){return e instanceof Date}(n)&&!Zt().isDayjs(n))throw new Error(`daysUntil() expects string, number, or Date argument, but got ${n}`);return Zt()(n).diff(Zt()(Date.now()),"day")}}),wi.defineFunction({funcName:"size",handler:(e,t)=>{if(0==t.length)throw new Error("size() expects an array argument");return en(t[0])?0:t[0].length}}),wi.defineFunction({funcName:"dayOfTheWeek",handler:function(){return["sun","mon","tue","wed","thu","fri","sat"][new Date(Date.now()).getDay()]}}),wi.defineFunction({funcName:"monthOfTheYear",handler:function(){return["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"][new Date(Date.now()).getMonth()]}}),wi.defineFunction({funcName:"notificationCategoryStatus",handler:T({getPromiseId:(e,t)=>t[0],async call(e,t){var n,i;const r=e.getBoundValue(ci).bundleId,s=t[0],a=await nativeApi.granularNotificationSettings(r);return{enabled:null===(n=null==a?void 0:a[s])||void 0===n?void 0:n.data,userUpdated:null===(i=null==a?void 0:a[s])||void 0===i?void 0:i.dataUpdated}}})});class bi{constructor(){this.functionsLibrary=null,this.scopeObjects=new Map,this.functionsLibrary=wi}getBindings(){return Array.from(this.scopeObjects.entries()).map((e=>({name:e[0],value:e[1]})))}getBoundValue(e){const t=this.scopeObjects.get(e);if(t)return t}bindValue(e,t){this.scopeObjects.set(e,t)}setFunctionsLibrary(e){this.functionsLibrary=e}getFunctionsLibrary(){return this.functionsLibrary}}ut=e(8205);class Ai{constructor(e,t=(()=>{})){this.scopeSupplier=e,this.expressionsStack=[],this.lambdaContexts=[],this.logFunction=t}withLog(e,t){return(...n)=>{const i=e(...n);return this.logFunction(t,i),i}}compileToFunction(e){return e.visit(this),this.popExpression()}visitLogicalOpTerm(e){for(let t of e.getOperands())t&&t.visit(this);let t=e.isUnary()?null:this.popExpression(),n=this.popExpression(),i=(0,ut.getLogicalOperatorHandler)(e.operator),r={eval:()=>e.isUnary()?i(n,n):i(n,t),name:()=>`${n.name()} ${e.operator.symbol} ${t?t.name():"<null>"}`};this.pushToExpressionStack(r)}visitComparisonOpTerm(e){let t;for(let t of e.getOperands())t&&t.visit(this);if((0,ut.isLambdaOperator)(e.operator)){let n=this.popExpression(),i=this.popExpression(),r=this.lambdaContexts.pop();t={name:()=>"lambda",eval:()=>{let t=i.eval();if(!t)return!1;if(!r)throw new Error("Can't get lambda context.");let s=new ut.LambdaContext(r,t);return(0,ut.getLambdaOperatorHandler)(e.operator)(this.scopeSupplier(),s,n)}}}else{const n=e.isUnary()?null:this.popExpression(),i=this.popExpression();t={eval:()=>{const t=i.eval(),r=e.isUnary()?t:n.eval();return(0,ut.getComparisonOperatorHandler)(e.operator)(t,r)},name:()=>`${i.name()} ${e.operator.symbol} ${n?n.name():"<null>"}`}}this.pushToExpressionStack(t)}visitValueFactor(e){this.pushToExpressionStack({name:()=>`${e.getValue()}`,eval:()=>e.getValue()},!1)}visitPropertyFactor(e){let t;e.parentProperty instanceof ut.FunctionCallFactor&&(e.parentProperty.visit(this),t=this.popExpression()),this.pushToExpressionStack({name:()=>`${e.dimension}.${e.propertyName}`,eval:()=>this.resolvePropertyRecursively(t?t.eval():null,e)})}visitItemPredicate(e){this.lambdaContexts.push(e.argName),e.predicate.visit(this)}visitRangeFactor(e){e.getFrom().visit(this);let t=this.popExpression();e.getTo().visit(this);let n=this.popExpression();this.pushToExpressionStack({name:()=>"Range",eval:()=>new ut.ValueRange(t.eval(),n.eval())},!1)}visitTimeRangeFactor(e){this.pushToExpressionStack({name:()=>"TimeRange",eval:()=>new ut.TimeRange(e.duration,e.timeUnit)},!1)}visitInFactor(e){this.pushToExpressionStack({name:()=>"In",eval:()=>new ut.ValuesArray(null==e?void 0:e.values)},!1)}visitFunctionCallFactor(e){let t=new Array(e.args.length);for(let e=0;e<t.length;e++){const n=this.popExpression();t[e]=n}t.reverse(),this.pushToExpressionStack({name:()=>`${e.functionName}`,eval:()=>{let n=t.map((e=>e.eval())),i=this.scopeSupplier().getFunctionsLibrary();if(null==i)throw new Error("Missing a functions library");let r=i.getFunctionHandler(e.functionName);if(!r)throw new Error(`Unhandled function ${e.functionName}`);return r(this.scopeSupplier(),n)}})}popExpression(){if(0===this.expressionsStack.length)throw new Error("Empty expression stack.");return this.expressionsStack.pop()}resolvePropertyRecursively(e,t){let i;if(t.dimension)if(e||t.parentProperty instanceof ut.FunctionCallFactor||(e=this.scopeSupplier().getBoundValue(t.dimension)||{}),e&&t.propertyName in e){let r=e[t.propertyName];"function"==typeof r&&(r=r(this.scopeSupplier())),i=t.nestedProperty&&n(r)?this.resolvePropertyRecursively(r,t.nestedProperty):r}else i=null;else i=this.scopeSupplier().getBoundValue(t.propertyName);return i}pushToExpressionStack(e,t=!0){this.expressionsStack.push(t?{eval:this.withLog(e.eval,e.name()),name:e.name}:e)}}const Si=new zn(86400);class Ti{constructor(e,t,n){this.expression=e,this.evaluationScope=new bi;let i=Si.fetch(e);i||(t||(t=new ut.Parser(this.expression).parseTree()),i=new Ai((()=>this.evaluationScope),n).compileToFunction(t)),this.evalFunc=i}evaluateBoolean(e){return this.evaluationScope=e,this.evalFunc.eval()}evaluateResult(e){return this.evaluationScope=e,this.evalFunc.eval()}}class Ci{async evalTriggerExpression(e,t){let n=Ci.createScope(e),i=new Ti(t),r=i.evaluateBoolean(n);for(;e.hasPendingPromises();)await e.resolvePromises(),r=i.evaluateBoolean(n);return e.clearResolvedPromises(),r}async evalExpression(e,t,n,i=(()=>{})){let r=Ci.createScope(e,n),s=new Ti(t,void 0,i),a=s.evaluateResult(r);for(;e.hasPendingPromises();)await e.resolvePromises(),a=s.evaluateResult(r);return a}static createScope(e,t){let n=t||new bi;return n.bindValue(ui,e.user),n.bindValue(ci,e.currentEvent||{}),n.bindValue(hi,e),e.journeyInstance?(n.bindValue(di,e.journeyInstance),n.bindValue(li,e.journeyInstance.triggerEvent)):n.bindValue(li,e.currentEvent||{}),n}}class Ei{constructor(){this.tokenPattern=/\${([^{}]*)}/g}async evaluateTemplate(e,t,n=!1,i){if(null==t)return t;let r=new Ci,s=(t.match(this.tokenPattern)||[]).map((async t=>{let s=Mi.parse(t).content,a=await r.evalExpression(e,s,i);if(n&&null==a)throw new Di(s);return[t,a]}));for(const[e,n]of await Promise.all(s))t=t.replace(e,n);return t}}class Mi{constructor(){this.evaluator=new Ci}static parse(e){const t=e.startsWith("${");return{hasExpressionTag:t,content:t?e.trim().slice(2,-1):e}}async interpolateTemplate(e,t,n){let r=t;if(t){if(i(t)){const{hasExpressionTag:i,content:s}=Mi.parse(t);r=i||s.includes(ui)||s.includes(ci)||s.includes(li)?await this.evaluator.evalExpression(e,s,n):t}}else r=null;return r}}class ki{constructor(){this.interpolator=new Mi}async interpolateStep(e,t){var n,i;let r=new Ln(t);const s=await this.interpolator.interpolateTemplate(e,t.duration),a=await this.interpolator.interpolateTemplate(e,t.timeUnit);return r.duration=null!=s?s:void 0,r.timeUnit=null!=a?a:void 0,t.waitUntilInstant&&(r.waitUntilInstant=null!==(n=await this.interpolator.interpolateTemplate(e,t.waitUntilInstant))&&void 0!==n?n:void 0),t.waitUntilUserTime&&(r.waitUntilUserTime=null!==(i=await this.interpolator.interpolateTemplate(e,t.waitUntilUserTime))&&void 0!==i?i:void 0),r}}class Ii{constructor(){this.templateEvaluator=new Ei}async getNotificationCopy(e,t){var n;const{storefrontId:i}=e.user;if(t.storefrontCopies){let r=null!==(n=t.storefrontCopies[i])&&void 0!==n?n:t.storefrontCopies.default,s=r.default;if(t.variationExpression){const n=await this.templateEvaluator.evaluateTemplate(e,t.variationExpression,!0),i=r[n];if(!i)throw new Pi(v`Evaluated variation expression '${t.variationExpression}' to '${n}', but didn't find matching value inside of ${r}`);s=i}return s}let r=t[`sfLoc_${i}_title`],s=t[`sfLoc_${i}_subtitle`],a=t[`sfLoc_${i}_text`],o=t[`sfLoc_${i}_url`];return t.title=null!=r?r:t.title,t.subtitle=null!=s?s:t.subtitle,t.text=null!=a?a:t.text,t.url=null!=o?o:t.url,t}async interpolateStep(e,t,n=!1){let i=new Bn(t);const r=await this.getNotificationCopy(e,i);Object.assign(i,r);const{title:s,subtitle:a,text:o,url:u}=i;if(en(s))throw new Pi("Failed to determine the title for the local notification");if(en(o))throw new Pi("Failed to determine the text for the local notification");if(en(u))throw new Pi("Failed to determine the url for the local notification");return i.title=await this.templateEvaluator.evaluateTemplate(e,s,n),a&&(i.subtitle=await this.templateEvaluator.evaluateTemplate(e,a,n)),i.text=await this.templateEvaluator.evaluateTemplate(e,o,n),i.url=await this.templateEvaluator.evaluateTemplate(e,u,n),i}}class Di extends Error{constructor(e){super(`Failed to interpolate the expression '${e}'.`),this.expression=e}}class Pi extends Error{constructor(e){super(e)}}const _i=e(6503);Zt().extend(tt());class $i{calculateDelay(e,t){let n,i=Date.now();if(t.waitMode)switch(t.waitMode){case"WAIT_UNTIL_INSTANT":if(!t.waitUntilInstant)throw new Pi("step.waitUntilInstant is not defined");if(n=Zt()(t.waitUntilInstant).valueOf()-i,t.operation){if(!t.duration)throw new Pi("step.duration is not defined");if(!t.timeUnit)throw new Pi("step.timeUnit is not defined");let e=g(t.duration,t.timeUnit);"ADD"===t.operation?n+=e:n-=e}break;case"WAIT_UNTIL_USER_TIME":n=Zt()(t.waitUntilUserTime).valueOf()-i;break;case"WAIT_CRON":{_i.date.timezone("UTC"!==t.cronTimezone);let e=_i.parse.cron(t.cronExpression);n=_i.schedule(e).next(1).valueOf()-i;break}case"WAIT_FOR":if(!t.duration)throw new Pi("step.duration is not defined");if(!t.timeUnit)throw new Pi("step.timeUnit is not defined");n=g(t.duration,t.timeUnit);break;case"WAIT_UNTIL_MORNING":n=C(e.applicationSettings);break;default:throw new Error(`Unhandled wait mode ${t.waitMode}`)}else{if(!t.duration)throw new Pi("step.duration is not defined");if(!t.timeUnit)throw new Pi("step.timeUnit is not defined");n=g(t.duration,t.timeUnit)}return Math.max(0,n)}}!function(e){e.UserTagsKey="user_tags"}(ct||(ct={}));class xi extends _n{static isTagEqual(e,t){return e.name===t.name&&e.prefix===t.prefix}getUserTags(e){let t=xi.getKeyForDsid(e);return(this.getDatabase().fetch(t)||[]).filter((e=>!xi.hasTagExpired(e)))}addTag(e,t){let n=xi.getKeyForDsid(e),i=this.getDatabase(),r=(i.fetch(n)||[]).filter((e=>!xi.isTagEqual(e,t)&&!xi.hasTagExpired(e)));r.push(t),i.set(n,r)}removeTag(e,t,n){let i=xi.getKeyForDsid(e),r=this.getDatabase(),s=(r.fetch(i)||[]).filter((e=>!xi.isTagEqual(e,{name:t,prefix:n})));r.set(i,s)}setUserTags(e,t){let n=xi.getKeyForDsid(e);this.getDatabase().set(n,t)}deleteExpiredTags(e){let t=xi.getKeyForDsid(e),n=this.getDatabase(),i=n.fetch(t)||[];i=i.filter((e=>!xi.hasTagExpired(e))),n.set(t,i)}static getKeyForDsid(e){return`${ct.UserTagsKey}_${e}`}static hasTagExpired(e){return 0!==e.expiresOn&&e.expiresOn<=Date.now()}}!function(e){e.Assignments="ab_assignments",e.NumAssignments="num_ab_assignments"}(lt||(lt={}));class Oi extends _n{static createKey(e,t){return`${t}_${e}`}canStoreAssignment(e){let t=Oi.createKey(e,lt.NumAssignments);return(this.getDatabase().fetch(t)||0)<64}readAssignments(e){let t=Oi.createKey(e,lt.Assignments),n=this.getDatabase().fetch(t)||{},i=[];for(const e of Object.values(n))i.push(...e);return i}readAssignmentsByBundle(e,t){let n=Oi.createKey(e,lt.Assignments);return(this.getDatabase().fetch(n)||{})[t]||[]}containsAssignment(e,t){return void 0!==this.findAssignment(e,t)}findAssignment(e,t){let n=e.findIndex((e=>e.stepId===t.stepId&&e.journeyId===t.journeyId&&e.journeyVersionId===t.journeyVersionId&&e.treatmentId===t.treatmentId&&e.abTestId===t.abTestId&&e.bundleId===t.bundleId));return-1!=n?n:void 0}storeAssignment(e,t){let n=Oi.createKey(e,lt.Assignments),i=this.getDatabase(),s=i.fetch(n)||{},a=s[t.bundleId]||[],o=!this.containsAssignment(a,t);if(o){if(a.push(t),s[t.bundleId]=a,!r(t.expiresOn))throw new Error("A TTL was not provide for the test assignment");i.set(n,s),this._increaseTestAssignments(e)}return o}updateAssignments(e,t,n){var i,r;let s=Oi.createKey(e,lt.Assignments),a=this.getDatabase(),o=null!==(i=a.fetch(s))&&void 0!==i?i:{},u=null!==(r=o[t])&&void 0!==r?r:[];for(const e of n){let t=this.findAssignment(u,e);void 0!==t&&u.splice(t,1,e)}o[t]=u,a.set(s,o)}deleteExpiredAssignments(e){let t=Date.now(),n=Oi.createKey(e,lt.Assignments),i=this.getDatabase(),r=i.fetch(n)||{},s=0;for(const e of a(r)){let n=r[e]||[];n=n.filter((e=>!!e.expiresOn&&e.expiresOn>t)),r[e]=n,s+=n.length}i.set(n,r),this._setNumTestAssignments(e,s)}_setNumTestAssignments(e,t){let n=Oi.createKey(e,lt.NumAssignments);this.getDatabase().set(n,t)}_increaseTestAssignments(e){let t=Oi.createKey(e,lt.NumAssignments),n=this.getDatabase(),i=n.fetch(t)||0;i+=1,n.set(t,i)}}!function(e){e[e.unknown=0]="unknown",e[e.alert=1]="alert",e[e.fullSheet=2]="fullSheet",e[e.banner=3]="banner",e[e.bubbleTip=4]="bubbleTip",e[e.toast=5]="toast",e[e.dashboard=6]="dashboard",e[e.discoveryCard=7]="discoveryCard",e[e.halfSheet=8]="halfSheet"}(dt||(dt={})),function(e){e.HOLDOUT="H",e.USER_JOURNEY_CONTROL_GROUP="C"}(ht||(ht={})),function(e){e[e.CONTROL_INDEX=0]="CONTROL_INDEX",e[e.NON_CONTROL_INDEX=1]="NON_CONTROL_INDEX"}(pt||(pt={}));const Ni="xp_amp_odj",Ri="journeys",ji=new Set([wn,yn,Tn,Cn]),Ui=[{eventType:wn},{eventType:Cn},{eventType:In,attributes:["settingId","newValue","oldValue"]},{eventType:Dn,attributes:["newValue","oldValue"]}],Li=[],Bi="users";class Fi extends _n{readLocalUserDsid(){return this.getDatabase().fetch("local_dsid")}writeLocalUserDsid(e){this.getDatabase().set("local_dsid",e)}readUsers(){let e=this.getDatabase();return new Set(e.fetch(Bi)||[])}writeUsers(e){this.getDatabase().set(Bi,e)}addUser(e){let t=new Set(this.readUsers());t.add(e),this.writeUsers([...t])}readFullUserAttributes(e){let t=this.getDatabase().fetch(Fi.keyForDsid(e))||{};return this._filterOutExpiredItems(t),Object.entries(t).map((([e,t])=>({name:e,...t})))}readUserAttributes(e){return Object.fromEntries(this.readFullUserAttributes(e).map((({name:e,value:t})=>[e,t])))}deleteUserAttributes(e,t){const n=this.getDatabase(),i=Fi.keyForDsid(e),r=n.fetch(i)||{},s=new Set(t);n.set(i,Object.fromEntries(Object.entries(r).filter((([e])=>!s.has(e)))))}writeUserAttribute(e,t,n,i){let r,s=this.readUsers(),a=Fi.keyForDsid(e),o=this.getDatabase();s.has(e)?r=o.fetch(a)||{}:(this.addUser(e),r={}),r[t]={value:n,expiresOn:i+Date.now()},r=this._filterOutExpiredItems(r),o.set(a,r)}static keyForDsid(e){return`user_${e}`}deleteExpiredAttributes(e){let t=Fi.keyForDsid(e),n=this.getDatabase(),i=n.fetch(t)||{};i=this._filterOutExpiredItems(i),n.set(t,i)}_filterOutExpiredItems(e){let t={},n=Date.now();for(const[i,r]of Object.entries(e))r.expiresOn>n&&(t[i]=r);return t}}!function(e){e.MessageKey="ums_msg_metadata",e.MessagesQueueKey="ums_queue",e.MessageLogKey="ums_message_log",e.UmsEventsLogKey="ums_events_log"}(ft||(ft={}));class qi extends _n{static getKeyForMessage(e){return`${ft.MessageKey}_${e}`}static getKeyForMessageLog(e){return`${ft.MessageLogKey}_${e}`}static getKeyForMessagesQueue(e){return`${ft.MessagesQueueKey}_${e}`}static getKeyForEventsLog(e){return`${ft.UmsEventsLogKey}_${e}`}readMessageLog(e){return this.getDatabase().fetch(qi.getKeyForMessageLog(e))||[]}writeMessageLog(e,t){this.getDatabase().set(qi.getKeyForMessageLog(e),t)}appendMessageLog(e,t){const n=[...this.readMessageLog(e),t],i=Zt()().subtract(60,"day").startOf("day"),r=n.filter((e=>Zt()(e.timestamp).isAfter(i)));this.writeMessageLog(e,r)}removeFromMessageLog(e){const t=nativeApi.user().userId,n=this.readMessageLog(t);this.writeMessageLog(t,n.filter((t=>t.messageId!==e)))}writeCachedMessage(e,t){return this.getDatabase().set(qi.getKeyForMessage(e),t)}readCachedMessage(e){return this.getDatabase().fetch(qi.getKeyForMessage(e))}readMessagesQueue(e){return this.getDatabase().fetch(qi.getKeyForMessagesQueue(e))||[]}writeMessagesQueue(e,t){this.getDatabase().set(qi.getKeyForMessagesQueue(e),t)}appendUmsEventLog(e,t){const n=qi.getKeyForEventsLog(e),i=this.getDatabase();let r=i.fetch(n)||[];r.push(t),r=r.slice(-200),i.set(n,r)}readUmsEventLog(e){const t=qi.getKeyForEventsLog(e);return this.getDatabase().fetch(t)||[]}clearUmsEventLog(e){const t=qi.getKeyForEventsLog(e);return this.getDatabase().set(t,[])}readMessages(){const e=this.getDatabase().fetchMatchingKeys(`${ft.MessageKey}_%`);return Object.values(e)}deleteMessages(){const e=this.getDatabase(),t=e.fetchMatchingKeys(`${ft.MessageKey}_%`);for(const n of Object.keys(t))e.set(n,null)}}!function(e){e.shown="shown"}(mt||(mt={})),function(e){e.UmsEventError="error",e.UmsEventExpiration="expiration",e.UmsEventPriority="priority",e.UmsEventDismissal="dismissal",e.UmsEventEnqueue="enqueue",e.UmsEventDequeue="dequeue",e.UmsEventRequested="requested",e.UmsEventPushed="pushed",e.UmsEventLimit="display limit",e.UmsEventDisplayExpression="display expression",e.UmsEventCooldown="cooldown"}(vt||(vt={})),gt=e(3870),yt=e(1476),wt=e(1470);const Wi={"zh-hans":"zh-cn","zh-hans-cn":"zh-cn","zh-hant-hk":"zh-hk","zh-hant-tw":"zh-tw"};let Vi=[],Hi=[],Ji=[],Gi=[];bt=e(3156);let Yi=new zn(3600),zi=[],Ki=new zn(60);class Qi{constructor(){this.recordedEvents=new Set}getSupportedBundles(){return[this.appBundleId,this.pluginBundleId].filter((e=>void 0!==e))}analyticsOptedIn(){return!0}getAllowedEvents(){return[]}getUpliftEvents(){return[]}initialize(){return Promise.resolve()}injectUserAttributes(e){let t={};for(const e of this.recordedEvents)t[Qi.remapEventType(e)]=()=>se(e).filter((e=>e.bundleId===this.appBundleId||e.bundleId===this.pluginBundleId));e[this.namespace]={events:t}}isAppInstalled(){return!0}isNotificationAllowed(e){return!0}customizeNotificationPayload(e,t){}onEvent(e){this.recordedEvents.has(e.eventType)&&e.bundleId===this.appBundleId&&re(e)}static remapEventType(e){return e.replace(/[:-]/g,"_")}clearCache(){Ki.clear()}}class Zi{}At=e(714);const Xi={appOpen:{},signedIntoItunes:{},previewButtonInteraction:{},sampleButtonInteraction:{},addToWTRButtonInteraction:{},carPlayAppUsed:{},appleWatchAppUsed:{},notificationSettingsOpen:{},dailyGoalReached:{},yearlyGoalReached:{},productPageViewed:{},appTransaction:{},listeningSession:{}};class er{constructor(){this.everUsedAppleWatchApp=!1,this.everUsedCarplay=!1,this.everUsedCarplayApp=!1,this.addToWTRButtonUsed=!1,this.previewButtonUsed=!1,this.sampleButtonUsed=!1,this.activeReadingState=!1,this.activeListeningState=!1,this.coachingPermissionApproved=!1,this.notificationSettingsVisited=!1,this.sampleBooks=[],this.recentBooks=[],this.storeBooks=[],this.remainingTimeToRead=0,this.currentStreakLength=0,this.readingGoal=0,this.timeReadToday=0,this.yearlyBooksFinishedGoal=0,this.readingGoalReachable=!1,this.isPairedToWatch=!1,this.readingGoalsLastUpdateDate=new Date(0)}}const tr="com.apple.iBooks",nr="com.apple.iBooksX";class ir extends Qi{constructor(){super(...arguments),this.eventTypes=[...Object.keys(Xi)],this.recordedEvents=new Set([Tn,Cn,"appTransaction","productPageViewed","appOpen","dailyGoalReached"]),this.namespace="books",this.name="BooksPlugin",this.pluginId="com.apple.iBooks.engagementExtension",this.appBundleId=tr,this.pluginBundleId=tr,this.subscriptionMediaType=void 0,this.subscriptionSegment=void 0,this.notificationClientId=At.UserNotificationClientId.ibooks}getSupportedBundles(){return[nr,tr]}getAllowedEvents(){return this.eventTypes.map((e=>({eventType:e})))}onEvent(e){e.bundleId===nr&&(e.bundleId=tr),super.onEvent(e)}injectUserAttributes(e){super.injectUserAttributes(e);const t=ce({everUsedAppleWatchApp:()=>Boolean(this.fetchProperty("everUsedAppleWatchApp")),everUsedCarplayApp:()=>Boolean(this.fetchProperty("everUsedCarplayApp")),everUsedCarplay:()=>Boolean(this.fetchProperty("everUsedCarplay")),addToWTRButtonUsed:()=>Boolean(this.fetchProperty("addToWTRButtonUsed")),previewButtonUsed:()=>Boolean(this.fetchProperty("previewButtonUsed")),sampleButtonUsed:()=>Boolean(this.fetchProperty("sampleButtonUsed")),activeReadingState:()=>Boolean(this.fetchProperty("activeReadingState")),activeListeningState:()=>Boolean(this.fetchProperty("activeListeningState")),coachingPermissionApproved:()=>Boolean(this.fetchProperty("coachingPermissionApproved")),notificationSettingsVisited:()=>Boolean(this.fetchProperty("notificationSettingsVisited")),sampleBooks:()=>this.fetchProperty("sampleBooks")[0].books,recentBooks:()=>this.fetchProperty("recentBooks")[0].books,storeBooks:()=>this.fetchProperty("storeBooks")[0].books,remainingTimeToRead:()=>o(this.fetchProperty("readingGoals")[0].remainingTimeToRead),currentStreakLength:()=>this.fetchProperty("readingGoals")[0].currentStreakLength,readingGoal:()=>o(this.fetchProperty("readingGoals")[0].readingGoal),timeReadToday:()=>o(this.fetchProperty("readingGoals")[0].timeReadToday),yearlyBooksFinishedGoal:()=>this.fetchProperty("readingGoals")[0].yearlyBooksFinishedGoal,readingGoalReachable:()=>Boolean(this.isReadingGoalReachable()),isPairedToWatch:()=>Boolean(this.fetchProperty("isPairedToWatch")),readingGoalsLastUpdateDate:()=>new Date(this.fetchProperty("readingGoals")[0].date)},new er,this.pluginId);c(e,this.namespace,t)}handlePluginResult(e){if(n(e)&&0===Object.keys(e).length)throw new Zi;return e}fetchProperty(e){const t=oe(this.pluginId,`fetchProperty/${e}`,{command:"fetchProperty",propertyName:e},!1);return this.handlePluginResult(t)}isReadingGoalReachable(){const e=oe(this.pluginId,"isReadingGoalReachable",{command:"isReadingGoalReachable"},!1);return this.handlePluginResult(e)}fetchTodaysSessions(){const e=oe(this.pluginId,"fetchTodaysSessions",{command:"fetchTodaysSessions"},!1);return this.handlePluginResult(e)}}const rr={appLaunch:{},enter:{},exit:{},page:{},pageRender:{},impressions:{},click:{},purchase:{}};!function(e){e.Subscriptions="subs"}(St||(St={}));class sr extends _n{static createKey(e,t){return`${t}_${e}`}clearSubscriptions(e){let t=this.getDatabase(),n=sr.createKey(e,St.Subscriptions);t.set(n,null)}storeSubscriptionState(e,t){let n=this.getDatabase(),i=sr.createKey(e,St.Subscriptions),r=this._readSubscriptionsKey(e),s=r[t.bundleId]||[];2==s.length&&s.pop(),s.unshift(t),r[t.bundleId]=s,n.set(i,r)}fetchSubscriptionState(e,t){let n=this._readSubscriptionsKey(e)[t]||[];return n.length>0?n[0]:null}_readSubscriptionsKey(e){let t=this.getDatabase();const n=sr.createKey(e,St.Subscriptions);return t.fetch(n)||{}}}let ar=new zn(120);const or="com.apple.AppStore",ur="com.apple.appstored";class cr extends Qi{constructor(){super(...arguments),this.namespace="appstore",this.name="AppStorePlugin",this.pluginId=ur,this.appBundleId=or,this.pluginBundleId=or,this.subscriptionMediaType=Qe.SubscriptionMediaType.appStore,this.subscriptionSegment=Xe.AppStore,this.notificationClientId=At.UserNotificationClientId.appstore,this.eventTypes=[...Object.keys(rr)],this.recordedEvents=new Set([Tn,Cn,"appLaunch","click","enter","purchase"])}getSupportedBundles(){return[or,ur]}getAllowedEvents(){return this.eventTypes.flatMap((e=>[{eventType:e,app:or},{eventType:e,app:ur}]))}onEvent(e){var t;e.bundleId===ur&&(e.bundleId=or),"purchase"===e.eventType&&(null===(t=e.buyParameters)||void 0===t?void 0:t.bid)===or&&(e.bundleId=or),super.onEvent(e)}injectUserAttributes(e){super.injectUserAttributes(e),c(e,"subscriptions",{[this.namespace]:T({getPromiseId:()=>"com.apple.AppStore.sub",call:async()=>(await de(or,Qe.SubscriptionMediaType.appStore),he(nativeApi.user(),Qe.SubscriptionMediaType.appStore))})})}}Zt().extend(tt());class lr{async onEnter(e,t){return null}async onExit(e,t){}async onEvent(e,t){return null}async prepareStepData(e,t){}}class dr extends lr{async onEnter(e,t){return e.customerJourney.getTransition(pi,fi)}async onEvent(e,t){return e.customerJourney.getTransition(pi,fi)}}class hr extends lr{async onEnter(e,t){return e.journeyInstance.status=at.Completed,null}}class pr extends lr{async onEnter(e,t){return y(t)&&ge(e,Zt().duration(t.duration,t.timeUnit.toLowerCase()).asMilliseconds()),null}async onEvent(e,t){let n,i=new Ci;return t.expression,await i.evalExpression(e,t.expression,void 0,void 0)?n="TRUE":y(t)?e.journeyInstance.isDelayedEventForThisJourney(e.currentEvent)?n=vi:e.journeyInstance.hasOutstandingStepDelay(t.id)&&(e.journeyInstance.clearOutstandingStepDelay(),n=vi):n="FALSE",n?e.customerJourney.getTransition(t.id,n):null}async prepareStepData(e,t){let n=new Ci;await n.evalExpression(e,t.expression)}}class fr extends lr{async prepareStepData(e,t){await(new ki).interpolateStep(e,t)}async onEnter(e,t){let n=await(new ki).interpolateStep(e,t);return ge(e,(new $i).calculateDelay(e,n)),null}async onEvent(e,t){return e.journeyInstance.hasOutstandingStepDelay(t.id)?(e.journeyInstance.clearOutstandingStepDelay(),e.customerJourney.getTransition(t.id,vi)):e.journeyInstance.isDelayedEventForThisJourney(e.currentEvent)?e.customerJourney.getTransition(t.id,vi):null}}class mr extends lr{async prepareStepData(e,t){await(new Ii).interpolateStep(e,t)}async onEnter(e,t){let n=0,i=null;return e.plugin.isNotificationAllowed(t)?(e.applicationSettings.nightDeliveryAllowed||(n=C(e.applicationSettings)),n>0?ge(e,n):(await this.enqueueUserNotificationAction(e,t),i=e.customerJourney.getTransition(t.id,fi))):(ee({journeyURL:A(e.journeyInstance),type:"error",payload:t,message:"Notification is not allowed"}),i=e.customerJourney.getTransition(t.id,mi)),i}async onEvent(e,t){return e.journeyInstance.isDelayedEventForThisJourney(e.currentEvent)||e.journeyInstance.hasOutstandingStepDelay(t.id)?(await this.enqueueUserNotificationAction(e,t),e.customerJourney.getTransition(t.id,fi)):null}async enqueueUserNotificationAction(e,t){var n;let r=await(new Ii).interpolateStep(e,t,!0),s={id:nativeApi.uuid(),artworkURL:i(r.artworkURL)?r.artworkURL:void 0,message:r.text,title:r.title,explicit:0!==(null!==(n=r.explicitContent)&&void 0!==n?n:0),interruptionLevel:r.interruptionLevel,anonymous:!0,metrics:{eventType:yn,journeyId:e.journeyInstance.journeyId,journeyVersionId:e.journeyInstance.versionId,journeyStarted:e.journeyInstance.startedOn,stepId:t.id,app:e.journeyInstance.bundleId},buttons:[{id:nativeApi.uuid(),defaultButton:!0,url:r.url,metrics:{eventType:wn,actionType:"tap",actionUrl:r.url,journeyId:e.journeyInstance.journeyId,journeyVersionId:e.journeyInstance.versionId,journeyStarted:e.journeyInstance.startedOn,stepId:t.id,app:e.journeyInstance.bundleId}}],videoURL:i(r.videoURL)?r.videoURL:void 0};e.plugin.customizeNotificationPayload(t,s);let a=e.plugin.notificationClientId;if(!a)throw new Error(`The notificationClientId is not defined for ${e.plugin.pluginId}`);let o=(0,gt.createUserNotificationAction)(a,s);"macOS"===host.platform&&o.bundleID===tr&&(o.bundleID=nr),r.subtitle&&(o.data.alert.title=r.subtitle,o.data.alert.subtitle=r.title),nativeApi.enqueueActions(o),P(e,e.journeyInstance,t)}}class vr extends lr{async onEnter(e,t){let n=0;if(t.expirationDuration&&i(t.timeUnit)){let e=Number(t.expirationDuration);n=Date.now()+g(e,t.timeUnit)}else en(t.expiresOn)||(n=(r=t.expiresOn,"string"==typeof r&&String(Number(r))===r?Zt()(Number(r)):Zt()(r)).valueOf());var r;let s={bundleId:e.customerJourney.bundleId,step:t.id,stepLimits:t.displayLimits,appLimits:e.applicationSettings.displayLimits,journeyVersion:e.customerJourney.versionId,expiration:n,messageId:t.messageId,displayExpression:t.displayExpression,cooldownDuration:t.cooldownDuration,cooldownTimeUnit:t.cooldownTimeUnit,metrics:{journeyId:e.journeyInstance.journeyId,journeyVersionId:e.journeyInstance.versionId,journeyStarted:e.journeyInstance.startedOn,stepId:t.id,app:e.journeyInstance.bundleId,messageId:t.messageId,messageType:M(t.messageType)}};try{return function(e){var t;const n=new qi;nativeApi.user().userId;let i=n.readCachedMessage(e.messageId);if(null==i)throw new Error(`in-app message ${e.messageId} content is missing`);if(e.expiration&&Zt()(e.expiration)<=Zt()())throw new Error(`Discarding expired message ${e.messageId} with expiration ${e.expiration}`);let r=null===(t=Y(Vi).get(i.serviceType))||void 0===t?void 0:t.get(i.placement);const s=r&&r[0],a=Boolean(s)&&(Q(i)||K(i));if(void 0!==s&&!a){let t=new ut.GenericComparator;if(s.message.id===e.messageId)return void nativeApi.log(`Message ${e.messageId} is already displayed at that placement`);if(t.compare(s.priority,i.priority)>0)throw new Error(`Discarding message request ${e.messageId} as the current message ${s.message.id} at placement ${i.placement} has equal or higher priority`);X(s,vt.UmsEventDequeue),nativeApi.log(`Replacing message request ${s.message.id} with the message ${i.id} at placement ${i.placement}`)}const o={messageInstanceId:`${i.id}_${Date.now()}`,notifiedRequest:!1,request:e,priority:i.priority,engagementStyle:i.engagementStyle,displayExpression:e.displayExpression,message:{id:e.messageId,serviceType:i.serviceType,placement:i.placement}};nativeApi.log(v`Enqueueing message ${o}`),Gi.push(o),function(e){const t=new qi;Vi.push(e);const{userId:n}=nativeApi.user();t.writeMessagesQueue(n,Vi)}(o)}(s),P(e,e.journeyInstance,t),e.customerJourney.getTransition(t.id,fi)}catch(n){return ee({journeyURL:A(e.journeyInstance),type:"error",message:v`Error while processing UMS step ${n}`}),e.customerJourney.getTransition(t.id,mi)}}}class gr extends lr{async onEnter(e,t){return function(e){if(!e)return;let t=(new qi).readCachedMessage(e);if(null==t)return void nativeApi.logError(`requested to dismiss unknown in-app message ${e}`);let n=Vi.find((n=>n.message.id===e&&n.message.placement===t.placement));n&&X(n,vt.UmsEventDismissal)}(t.messageId),e.customerJourney.getTransition(t.id,fi)}}class yr extends lr{async onEnter(e,t){let n=function(e,t){let n,i=te(t.userId,e.seed),r=[...e.testGroups];r.sort(((e,t)=>e.order-t.order));let s=100*e.controlGroup;if(i<s)n={name:nn,size:e.controlGroup,order:0};else for(const e of r)if(s+=100*e.size,i<s){n=e;break}if(!n)throw new Error("Unable to allocate user to a test group");return n}(t,e.user),i=nn===n.name?"CONTROL":n.name;return e.customerJourney.getTransition(t.id,i)}}class wr extends lr{async onEnter(e,t){const n=function(e,t){let n=te(t.userId,e.seed),i=0;for(const t of e.variants)if(i+=100*t.proportion,n<i)return t.name;throw new Error("Unable to allocate user to a test group")}(t,e.user);return function(e,t,n,i,r){const s={eventType:"journeys:SojAssignment",variantId:i,domain:Ri,stepId:t,experiment:n},a=e.customerJourney.getStepById(t).assignmentRetentionDays||e.customerJourney.groupAllocationRetentionDays;U(e,j({bundleId:e.customerJourney.bundleId,journeyId:e.customerJourney.journeyId,journeyVersionId:e.customerJourney.versionId,stepId:t,domain:Ri,experiment:n,variantId:i,expiresOn:Date.now()+Zt().duration(a,"days").asMilliseconds()},r))&&R(e,s,r)}(e,t.id,t.experimentName,n,e.journeyInstance),e.customerJourney.getTransition(t.id,n)}}class br extends lr{async onEnter(e,t){const{bundleId:n,journeyId:i,versionId:r}=e.journeyInstance,s=ve(n);return void 0===s?(ee({journeyURL:A(e.journeyInstance),type:"error",message:v`Can't get badge client identifier for bundle '${n}' in step ${t}`}),e.customerJourney.getTransition(t.id,mi)):(nativeApi.enqueueActions(...me(s,t.badges,!0,(e=>({eventType:Pn,app:n,journeyId:i,journeyVersionId:r,stepId:t.id,badgeID:e})))),e.customerJourney.getTransition(t.id,fi))}}class Ar extends lr{async onEnter(e,t){const n=ve(e.journeyInstance.bundleId);return void 0===n?(ee({journeyURL:A(e.journeyInstance),type:"error",message:v`Can't get badge client identifier for bundle '${e.journeyInstance.bundleId}' in ${t}`}),e.customerJourney.getTransition(t.id,mi)):(nativeApi.enqueueActions(...me(n,t.badges,!1)),e.customerJourney.getTransition(t.id,fi))}}class Sr extends lr{static async getTagName(e,t){if(t.tagNameExpression){const n=new Mi,i=await n.interpolateTemplate(e,t.tagNameExpression);if(!i)throw new Error("Can't evaluate step.tagNameExpression");return i}if(t.name)return t.name;throw new Error("Expected 'name' or 'tagNameExpression' to be defined.")}async onEnter(e,t){const n=new xi,i=await Sr.getTagName(e,t);return n.addTag(e.user.userId,{name:i,prefix:t.prefix,taggedOn:Date.now(),expiresOn:Date.now()+t.ttlInMillis}),e.customerJourney.getTransition(t.id,fi)}}class Tr extends lr{async onEnter(e,t){const n=new xi,i=await Sr.getTagName(e,t);return n.removeTag(e.user.userId,i,t.prefix),e.customerJourney.getTransition(t.id,fi)}}class Cr extends lr{async prepareStepData(e,t){await(new Mi).interpolateTemplate(e,t.valueExpression)}async onEnter(e,t){let n=new Mi,i=await n.interpolateTemplate(e,t.valueExpression),r=t.attribute.replace(Cr.UserCustomAttributePrefix,""),s=g(t.duration||1,t.timeUnit||"MONTHS");return(new Fi).writeUserAttribute(e.user.userId,r,i,s),e.customerJourney.getTransition(t.id,fi)}}Cr.UserCustomAttributePrefix="user.custom.";class Er{constructor(){this.stepProcessors=new Map,this.stepProcessors.set("START",new dr),this.stepProcessors.set("TERMINAL",new hr),this.stepProcessors.set("CONDITION",new pr),this.stepProcessors.set("WAIT",new fr),this.stepProcessors.set("LOCAL_NOTIFICATION",new mr),this.stepProcessors.set("AB_SPLIT",new yr),this.stepProcessors.set("TAG",new Sr),this.stepProcessors.set("UNTAG",new Tr),this.stepProcessors.set("SET_USER_ATTRIBUTE",new Cr),this.stepProcessors.set("UNIFIED_MESSAGE",new vr),this.stepProcessors.set("DISMISS_UNIFIED_MESSAGE",new gr),this.stepProcessors.set("EXPERIMENT",new wr),this.stepProcessors.set("ODJ_BADGE",new br),this.stepProcessors.set("ODJ_REMOVE_BADGE",new Ar)}async onEnter(e,t){let n=null,i=t.toStep;try{let r=this.getStepProcessorForStep(i);await r.prepareStepData(e,i),this.parkIfAsyncDataRequested(e,t)||(n=await r.onEnter(e,i)),delete e.journeyInstance.reEnterTransition,ee({journeyURL:A(e.journeyInstance),type:"enter",payload:{...i,edge:t.edge},message:v`Entering step ${i}`}),function(e,t,n){n.toStep.id!==pi&&R(e,{eventType:bn,stepId:n.toStep.id,previousStepId:n.fromStep.id,stepType:n.toStep.stepType,transition:n.edge},t)}(e,e.journeyInstance,t)}catch(n){if(n instanceof sn)e.journeyInstance.reEnterTransition=t;else if(n instanceof Di||n instanceof Pi){ee({journeyURL:A(e.journeyInstance),type:"error",payload:i,message:v`Step ${i.id} failed, transitioning to ${mi}. Error: ${n}.`});const t=e.customerJourney.getFlowedStep(i.id,mi);if(t)return{fromStep:i,toStep:t,edge:mi}}throw n}return n}async onExit(e,t){!function(e,t,n){R(e,{eventType:An,stepId:n.fromStep.id,nextStepId:n.toStep.id,stepType:n.fromStep.stepType,transition:n.edge},t)}(e,e.journeyInstance,t),e.journeyInstance.resolvedData={},e.journeyInstance.pendingData=[],e.journeyInstance.pendingTransition=null;let n=this.getStepProcessorForStep(t.fromStep);return await n.onExit(e,t.fromStep)}async onEvent(e){const t=e.customerJourney.getStepById(e.journeyInstance.step);if(!t)throw new Error;let n=this.getStepProcessorForStep(t);if(e.journeyInstance.status===at.WaitForData&&this.unparkIfAsyncDataArrived(e))return null;if(e.journeyInstance.status===at.Active&&e.journeyInstance.hasResolvedData()){if(!e.journeyInstance.pendingTransition)throw new Error("Expected a pendingTransition when resuming from a wait state");{let t=await this.onEnter(e,e.journeyInstance.pendingTransition);if(t)return t}}if(e.journeyInstance.reEnterTransition){let n=e.journeyInstance.reEnterTransition;if(delete e.journeyInstance.reEnterTransition,n&&n.toStep.id===t.id&&(n=await this.onEnter(e,n),null!==n))return n}return e.journeyInstance.status==at.Active?n.onEvent(e,t):null}getStepProcessorForStep(e){let t=this.stepProcessors.get(e.stepType);if(!t)throw new Error(`Unhandled step type ${e.stepType}`);return t}unparkIfAsyncDataArrived(e){let t=e.journeyInstance,n=e.currentEvent;if(t.status===at.WaitForData&&q(n)){let e=function(e){if(q(e))return e.requestId}(n);if(e&&t.hasPendingDataRequest(e)&&(t.resolvePendingData(e,function(e){if(q(e)){if(!en(e.error))throw Error("Failed to retrieve remote data");return JSON.parse(e.response["json-payload"]).response}}(n)||{}),en(t.pendingData)))return t.status=at.Active,!0}return!1}parkIfAsyncDataRequested(e,t){let n=e.journeyInstance;return n.status===at.Active&&n.hasPendingDataRequests()&&n.markJourneyAsWaitingForData(t),n.status===at.WaitForData}}const Mr="$DebugJourneyStart",kr="$DebugJourneyMove",Ir="$DebugWriteUserAttributes",Dr="$DebugEvaluate",Pr=[Mr,kr,Ir,Dr].map((e=>({allowsResponse:!0,filter:{eventType:e.replace("$","\\$")}})));class _r{constructor(){this.stepsProcessor=new Er}async manageEventTransitionForUserJourney(e){var t;let n=null;if(e.currentEvent.eventType===kr&&h(e.journeyInstance,e.currentEvent)){const t=e.customerJourney.getStepById(e.currentEvent.stepId);if(!t)throw new Error(`Can't get step "${e.currentEvent.stepId}".`);const i=e.customerJourney.getStepById(e.journeyInstance.step);if(!i)throw new Error(`Can't get step "${e.journeyInstance.step}".`);n=await this.enterStep(e,{fromStep:i,toStep:t,edge:fi})}else n=e.journeyInstance.step?await this.calculateTransitionFromCurrentStep(e):await this.enterStep(e,{fromStep:null,toStep:null!==(t=e.customerJourney.getStepById(pi))&&void 0!==t?t:null,edge:fi});await this.moveFlow(e,n)}async moveFlow(e,t){for(;t;)e.journeyInstance.step&&await this.exitStep(e,t),(t=await this.enterStep(e,t))||(t=await this.calculateTransitionFromCurrentStep(e))}enterStep(e,t){let n=t.toStep;return e.journeyInstance.step=n.id,e.journeyInstance.stepEnteredOn=Date.now(),this.stepsProcessor.onEnter(e,t)}exitStep(e,t){return this.stepsProcessor.onExit(e,t)}calculateTransitionFromCurrentStep(e){return this.stepsProcessor.onEvent(e)}}!function(e){e.ActiveJourneys="active_journeys",e.CompletedJourneys="completed_journeys"}(Tt||(Tt={}));class $r extends _n{static createKey(e,t){return`${t}_${e}`}writeActiveJourneys(e,t,n){let i=$r.createKey(e,Tt.ActiveJourneys),r=this.getDatabase(),s=r.fetch(i)||{};s[t]=n,this._deleteBundlesWithoutActiveJourneys(s),r.set(i,s)}_deleteBundlesWithoutActiveJourneys(e){for(const t of a(e))en(e[t])&&delete e[t]}readBundlesWithActiveJourneys(e){let t=$r.createKey(e,Tt.ActiveJourneys),n=this.getDatabase().fetch(t)||{};return this._deleteBundlesWithoutActiveJourneys(n),a(n)}readActiveJourneysForBundle(e,t){let n=$r.createKey(e,Tt.ActiveJourneys);return((this.getDatabase().fetch(n)||{})[t]||[]).map((e=>new Xn(e)))}readActiveJourneys(e){let t=$r.createKey(e,Tt.ActiveJourneys),n=this.getDatabase().fetch(t)||{},i=[];for(let e of Object.values(n))i.push(...e);return i}removeCompletedJourneys(e){let t=$r.createKey(e,Tt.CompletedJourneys);this.getDatabase().set(t,{})}appendCompletedJourneys(e,t,n){const i=this.getDatabase(),r=$r.createKey(e,Tt.CompletedJourneys),s=i.fetch(r)||{};i.set(r,{...s,[t]:[...s[t]||[],...n].slice(-16)})}readCompletedJourneys(e,t){let n=$r.createKey(e,Tt.CompletedJourneys);return((this.getDatabase().fetch(n)||{})[t]||[]).map((e=>new Xn(e)))}}Ct=e(9978),Et=e.n(Ct),function(e){e.SCHEDULED_TRIGGER="scheduled_trigger",e.EXPECTED_SCHEDULED_TRIGGER="exp_scheduled_trigger"}(Mt||(Mt={}));class xr extends _n{static createKey(e,t){return`${t}_${e}`}readTrigger(e){return this.getDatabase().fetch(xr.createKey(e,Mt.SCHEDULED_TRIGGER))}writeTrigger(e,t){this.getDatabase().set(xr.createKey(e,Mt.SCHEDULED_TRIGGER),t)}writeExpectedScheduledTrigger(e,t){this.getDatabase().set(xr.createKey(e,Mt.EXPECTED_SCHEDULED_TRIGGER),t)}readExpectedScheduledTrigger(e){return this.getDatabase().fetch(xr.createKey(e,Mt.EXPECTED_SCHEDULED_TRIGGER))}deleteExpectedScheduledTrigger(e){this.writeExpectedScheduledTrigger(e,null)}}Zt().extend(tt()),Zt().extend(Et());class Or{constructor(e=new Set,t=new Set,n=new Set,i=new Set){this.inProgressJourneys=e,this.startedJourneys=t,this.progressedJourneys=n,this.completedJourneys=i}merge(e){return new Or(new Set([...this.inProgressJourneys,...e.inProgressJourneys]),new Set([...this.startedJourneys,...e.startedJourneys]),new Set([...this.progressedJourneys,...e.progressedJourneys]),new Set([...this.completedJourneys,...e.completedJourneys]))}}class Nr{constructor(e,t,n){this.user=e,this.bundleId=t,this.events=n,n.sort(((e,t)=>(e.createdOn||0)-(t.createdOn||0)))}}class Rr{constructor(){this.rescheduledEvents=new Set,this.journeysService=new gi,this.metadataStore=new Qn,this.journeysEvaluator=new Ci,this.transitionsHandler=new _r,this.journeysStore=new $r}async processJourneys(e){this.rescheduledEvents=new Set;let t=this.metadataStore.readJourneyVersions(e.bundleId),n=this.metadataStore.readApplicationSettings(e.bundleId);if(!n)return nativeApi.log(`Skipping events from un-configured bundle ${e.bundleId}`),[];let i=plugins.getPluginForBundle(e.bundleId);if(!i)return nativeApi.log(`Skipping events without an assigned plugin for bundle ${e.bundleId}`),[];let r=new ei(i,e.user,e.events,n,t),s=this.journeysStore.readActiveJourneysForBundle(e.user.userId,e.bundleId);this.cancelTerminatedJourneys(r,s);let a=s.filter((e=>e.status===at.Cancelled)),o=s.filter((e=>e.isInProgress())),u=await this.startOrProgressActiveJourneys(r,o),c=await this.progressUserJourneys(r,o),l=Array.from([...c.inProgressJourneys,...u.inProgressJourneys]);return this.journeysStore.writeActiveJourneys(e.user.userId,e.bundleId,l),function(e,t){t.forEach((t=>D(e,t)))}(r,Array.from([...a,...c.completedJourneys,...u.completedJourneys])),Array.from(this.rescheduledEvents)}cancelTerminatedJourneys(e,t){let n=new Set(e.terminatedVersions.map((e=>e.versionId)));for(const i of t)n.has(i.versionId)&&(nativeApi.log(`Cancelling version ${i.versionId}`),i.markJourneyAsCancelled(),D(e,i))}async startOrProgressActiveJourneys(e,t){let n=l(t,"versionId"),i=new Or;for(const r of e.activeVersions)if(r.status===rt.Active){let s=n.get(r.versionId)||new Set,a=l(t,"journeyId");try{let t=await this.prepareLedgerAndProcessVersion(e,r,s,a);i=i.merge(t)}catch(e){ee({journeyURL:A(r),type:"error",payload:m(e),message:"Processing error"})}}return i}async progressUserJourneys(e,t){let n=l(t,"versionId"),i=new Set(e.activeVersions.map((e=>e.versionId))),r=new Or;for(const s of n.entries()){let n=s[0],a=s[1];if(!i.has(n))try{let i,s=e.getVersionById(n);if(s&&s.status!==rt.Terminated){let n=l(t,"journeyId");i=await this.prepareLedgerAndProcessVersion(e,s,a,n)}else nativeApi.log(`Terminating version ${n}`),a.forEach((t=>{t.markJourneyAsCancelled(),D(e,t)})),i=new Or(new Set,new Set,a,a);r=r.merge(i)}catch(e){nativeApi.logError(` failed: ${e}`)}}return r}async prepareLedgerAndProcessVersion(e,t,n,i){let r=i.get(t.journeyId)||new Set;r=new Set(Array.from(r).filter((e=>e.versionId!==t.versionId)));let s=new Set(Array.from(n).filter((e=>e.isInFinalStatus()))),a=Array.from(i.values()).map((e=>Array.from(e))).flat().filter((e=>e.isInProgress())).length,o=(new ni).withRetriggerMode(t.retriggerMode).withInProgress(n).withCompleted(s).withTotalInProgress(a);t.status===rt.Active&&o.withInProgressOtherVersions(r);let u=o.build();return e.customerJourney=t,u=await this.processVersion(e,u),u.getInProgress().forEach((e=>{let t=i.get(e.journeyId)||new Set;t.add(e),i.set(e.journeyId,t)})),new Or(u.getInProgress(),u.getStarted(),u.getProgressed(),u.getCompleted())}async processVersion(e,t){return await this.processTriggers(e,t),await this.progressJourneyInstances(e,t),t}async progressJourneyInstances(e,t){for(const n of t.getInProgress())if(e.journeyInstance=n,n.isWaitingForAsyncData()&&await this.attemptToUnBlockWithIncomingAsyncEvents(n,e,t),n.status===at.Active){let i=n.pendingEvents.length>0,r=e.events,s=!1;try{i&&(e.events=e.events.filter((e=>e.eventType!=pn)),e.events=[...n.pendingEvents,...e.events]);let a=e.events.length,o=0;for(let i=0;i<a&&n.status===at.Active;i++){const a=e.events[i];if(!this.hasTouchedJourney(a,n)){e.currentEvent=a;try{if(await this.progressJourney(e,t),n.status==at.WaitForData)break;this.markJourneyProcessedForEvent(e.currentEvent,n),o++}catch(e){if(e instanceof sn){s=!0;let e=Math.max(0,o-n.pendingEvents.length);this.markForReschedule(r.slice(e));let t=Math.min(o,n.pendingEvents.length);n.pendingEvents=n.pendingEvents.slice(t);break}throw e}}}s||(n.isWaitingForAsyncData()&&o<e.events.length?n.pendingEvents=[...e.events.slice(Math.max(0,o-1))]:n.pendingEvents=[])}finally{e.events=r}}}async processTriggers(e,t){for(let i=0;i<e.events.length;i++){const s=e.events[i];if(this.hasTouchedTrigger(s,e.customerJourney))nativeApi.logDebug(v`ignoring event ${s}`);else{e.currentEvent=s;try{if(await this.shouldTriggerCustomerJourney(e,t)){let i;const s=r(e.customerJourney.holdoutSize)&&e.customerJourney.holdoutSize>0;let a=await ne(e);if(!a){let r=(n=e.currentEvent,Object.assign({},n));delete r.$touchedTriggers,delete r.$touchedJourneys,i=this.journeysService.instantiateJourneyForUser(e.customerJourney,e.user,r),t.updateStarted(i),ee({journeyURL:A(i),type:"start",payload:r,message:"Started"}),_(e,i)}s&&(k(e,a,i),a&&ee({journeyURL:A(e.customerJourney),type:"holdout",payload:e.currentEvent}))}this.markTriggerProcessedForEvent(e.currentEvent,e.customerJourney)}catch(t){if(t instanceof sn)return void this.markForReschedule(e.events.slice(i));throw t}}}var n}async progressJourney(e,t){let n=e.journeyInstance,i=n.step,r=n.status;try{await this.transitionsHandler.manageEventTransitionForUserJourney(e)}catch(t){if(t instanceof sn)throw nativeApi.log("Private data unavailable"),t;ee({journeyURL:A(e.journeyInstance),type:"error",payload:m(t),message:v`Failed. Error: ${t}`}),n.markJourneyAsFailed(),I(e,`${t instanceof Error?t.message:v`${t}`}, osBuild: ${host.osBuild}`)}(n.step!==i||n.status!==r)&&t.updateProgressed(n),n.isInFinalStatus()&&t.updateCompleted(n)}matchesDebugJourneyStartEvent(e,t){return function(e){return e.eventType===Mr}(t)&&h(e,t)}async shouldTriggerCustomerJourney(e,t){let n=e.customerJourney;if(rt.Active!=n.status||!t.canStartNewInstance(n)||!t.checkUserJourneysQuota())return!1;if(this.matchesDebugJourneyStartEvent(n,e.currentEvent))return e.currentEvent=e.currentEvent.triggerEvent,!0;if(n.triggerType===st.EventBased)return await this.journeysEvaluator.evalTriggerExpression(e,n.triggerExpression);if(n.triggerType!==st.ScheduledBased)throw new Error(`Unrecognised trigger type: ${n.triggerType}`);return!(!(function(e){const t=(new xr).readExpectedScheduledTrigger(Se(e));return null!==t&&Zt()(t).valueOf()<Date.now()&&!Te(e)}(n)||e.currentEvent.eventType===fn&&e.currentEvent.bundleId===n.bundleId&&e.currentEvent.versionId===n.versionId)||!we(e.customerJourney)||(function(e){const t=Se(e);let n=new xr;n.writeTrigger(t,Zt()().format()),n.deleteExpectedScheduledTrigger(t)}(n),0))}async attemptToUnBlockWithIncomingAsyncEvents(e,t,n){let i=t.events.filter((e=>q(e)));for(let r=0;r<i.length;r++){const s=i[r];if(!this.hasTouchedJourney(s,e)){t.currentEvent=s;try{await this.progressJourney(t,n),this.markJourneyProcessedForEvent(t.currentEvent,e)}catch(e){if(e instanceof sn)return this.markForReschedule(i.slice(r)),void this.markForReschedule(t.events.filter((e=>!q(e))))}if(!e.isWaitingForAsyncData()||e.isInFinalStatus())break}}e.isWaitingForAsyncData()&&e.addPendingEvents(t.events.filter((e=>!q(e))))}hasTouchedJourney(e,t){let n=e.$touchedJourneys||[];return new Set(...n).has(t.id)}hasTouchedTrigger(e,t){let n=e.$touchedTriggers||[];return new Set(...n).has(t.versionId)}markJourneyProcessedForEvent(e,t){let n=e.$touchedJourneys||[];n.push(t.id),e.$touchedJourneys=n}markTriggerProcessedForEvent(e,t){if(e.eventType!=fn){let n=e.$touchedTriggers||[];n.push(t.versionId),e.$touchedTriggers=n}}markForReschedule(e){this.rescheduledEvents=new Set([...this.rescheduledEvents,...e])}}class jr extends _n{getKey(e){return`${e}_${nativeApi.user().userId}`}cacheAttribute(e,t){this.getDatabase().set(this.getKey(e),t)}readAttribute(e){return this.getDatabase().fetch(this.getKey(e))}}const Ur="itunesFamily",Lr="icloudFamily";kt=e(9089),function(e){e.PendingEvents="j_pending_events"}(It||(It={}));class Br extends _n{static createKey(e,t,n){return`${n}_${e}_${t}`}readPendingEvents(e,t){const n=Br.createKey(e,t,It.PendingEvents);return this.getDatabase().fetch(n)||[]}writePendingEvents(e,t,n){const i=Br.createKey(e,t,It.PendingEvents),r=this.getDatabase(),s=Zt()().subtract(24,"hour");n=n.filter((e=>Zt()(e.createdOn).isAfter(s))).slice(0,100),r.set(i,n)}}class Fr extends Qi{constructor(){super(...arguments),this.appBundleId="DEBUG_APP_BUNDLE_ID",this.name="DebugPlugin",this.namespace="debug_plugin",this.pluginBundleId="DEBUG_BUNDLE_ID",this.pluginId="DEBUG_PLUGIN",this.subscriptionMediaType=123456,this.subscriptionSegment=123456}}class qr{constructor(){this.journeysProcessor=new Rr}async processEvents(e){this.preJourneys(e);const t=function(e){var t,n,i,r,s;const a=[];let o=nativeApi.user();for(const u of e)if(u.eventType===kn){const e=null!==(n=null===(t=u.cacheModifications["notification-preferences"])||void 0===t?void 0:t.updated)&&void 0!==n?n:{};for(const t of Object.keys(e)){const n=e[t]||{};for(const e of Object.keys(n)){const u=null===(i=n[e])||void 0===i?void 0:i.data;null!==(s=null===(r=n[e])||void 0===r?void 0:r.dataUpdated)&&void 0!==s&&s&&void 0!==u&&a.push({eventType:In,createdOn:Date.now(),bundleId:t,userId:o.userId,storefrontId:o.storefrontId,settingId:e,newValue:u,oldValue:!u})}}}return a}(e=await this.handleDebugActions(e));if(e.push(...t),0==(e=(e=this.handleAmsOsUpgradeEvent(e)).map((e=>this.normaliseEvent(e))).filter((e=>i(e.bundleId)))).length)return;let n=nativeApi.user();!function(e,t){for(const n of t)E(n),ji.has(n.eventType)||void 0!==N(n)?x(e,n):$(e,n)}(n.userId,e);let r=await this.processSubscriptionChangeEvents(e);return e.push(...r),Ce(n),await this.processJourneys(n,e),await this.postJourneys(),Promise.resolve()}async handleDebugActions(e){for(const t of e)ye(t)&&await Ee(t);return e.filter((e=>!ye(e)))}preJourneys(e){Li.length=0,Yi.clear(),zi=[],plugins.onEvents(e),function(){let e=new qi;Vi=e.readMessagesQueue(nativeApi.user().userId),Hi=[],Ji=[],Gi=[]}(),function(e){const t=new qi,{userId:n}=nativeApi.user();!function(e){e.forEach((e=>{"page"===e.eventType&&e.messageId&&e.journeyId?e.eventType=Tn:e.eventType===Mn&&e.messageId&&e.journeyId&&e.actionType&&(e.eventType=Cn,e.actionType="dismiss"===e.actionType?gt.ActionStyle.cancel:gt.ActionStyle.default)}))}(e);const i=new Set(e.filter((e=>e.eventType===Cn)).map((e=>e.messageId))),r=Vi.filter((e=>i.has(e.message.id)));r.length>0&&nativeApi.log(v`Removing messages ${r} as they were dismissed`),r.forEach((e=>{X(e,vt.UmsEventDismissal)})),e.filter((e=>e.eventType===Sn)).forEach((e=>Hi.push(e)));const s=new Set(e.filter((e=>e.eventType===Tn)).map((e=>e.messageId))),a=Vi.filter((e=>s.has(e.message.id)));for(const e of a)t.appendMessageLog(n,{messageId:e.message.id,action:mt.shown,timestamp:Date.now()})}(e)}async postJourneys(){await async function(){let e=new qi;!function(){let e=Date.now();Vi.filter((t=>t.request.expiration&&t.request.expiration<=e)).forEach((e=>X(e,vt.UmsEventExpiration)))}();let t=[],n=function(){let e=new Set(Hi.map((e=>e.serviceType))),t=Vi.filter((t=>e.has(t.message.serviceType)));nativeApi.log(v`Pull requests ${Hi}`);let n=[],i=Y(t);for(const e of Hi){let t=i.get(e.serviceType);if(null!=t)for(const i of e.placements){let e=t.get(i.placement);if(void 0!==e)for(const t of e)n.push({enqueuedMessage:t,messageContext:i.context||{},eventType:vt.UmsEventRequested,description:"requested by the app"})}}return n}(),i=[...n,...Gi.filter((e=>e.message.id)).map((e=>({enqueuedMessage:e,messageContext:{},eventType:vt.UmsEventPushed,description:"Pushed to the app",deleted:!1})))],r=[];for(const n of i){const{enqueuedMessage:i,messageContext:s}=n;let a=e.readCachedMessage(i.message.id);if(a){if(void 0===t.find((e=>e.id===a.id)))try{const{request:e}=i,o=await V(e,s);if(!o.result){r.push({...n,description:o.reason,eventType:o.eventType});continue}const u=await G(e,s,a);z(u,e.metrics),t.push(u),r.push({...n}),Z(u)}catch(e){nativeApi.logError(`Failed to prepare message ${a.id} for display. Reason: ${e}`),r.push({...n,description:"Error while preparing for display",eventType:vt.UmsEventError})}}else X(i,vt.UmsEventDequeue,i.message.id)}const s=function(e){let t=[],n=l(e,"serviceType");for(let[e,i]of n){let n={actionClass:gt.messageActionClass,serviceType:e,placements:{}};const r=new Map;i.forEach((e=>{var t;if(K(e)){const t={action:gt.PlacementActionType.present,engagementRequest:{clientData:e.clientData,url:e.url,metricsOverlay:e.metricsOverlay}},i=[...[n.placements[e.placement]||[]].flat(),t].sort(((e,t)=>{var n,i,r,s;const a=null===(n=e.engagementRequest)||void 0===n?void 0:n.clientData,o=null===(i=t.engagementRequest)||void 0===i?void 0:i.clientData;return(null!==(r=null==o?void 0:o.carouselRankingOrder)&&void 0!==r?r:0)-(null!==(s=null==a?void 0:a.carouselRankingOrder)&&void 0!==s?s:0)}));n.placements[e.placement]=i}else if(Q(e)){r.set(e.content,e.clientData.carouselRankingOrder);const t=[...[n.placements[e.placement]||[]].flat(),{action:gt.PlacementActionType.present,content:e.content}].sort(((e,t)=>{const n=r.get(e.content);return r.get(t.content)-n}));n.placements[e.placement]=t}else{if(e.engagementItem){let i={account:null!==(t=nativeApi.iTunesAccount())&&void 0!==t?t:nativeApi.iCloudAccount(),url:"https://amsui.apple.com/dynamic/marketing#route=engagementItem",clientData:{style:e.engagementStyle,engagementItem:e.engagementItem},destinationStyle:yt.AA.dynamic};n.placements[e.placement]={action:gt.PlacementActionType.present,engagementRequest:i}}e.engagementStyle||(n.placements[e.placement]={action:gt.PlacementActionType.present,content:e.content})}})),Object.keys(n.placements).length>0&&t.push(n)}return t}(t).concat(function(e){let t=[];for(let n of e){let e={actionClass:"MessageAction",serviceType:n.message.serviceType,placements:{[n.message.placement]:{action:gt.PlacementActionType.dismiss}}};t.push(e)}return t}(Ji));nativeApi.log(`Got ums ${s.length} actions`),nativeApi.enqueueActions(...s),function(e){let t=new qi;e.forEach((e=>{if(e.eventType!==vt.UmsEventError)return;let n=t.readCachedMessage(e.enqueuedMessage.message.id);n&&t.appendUmsEventLog(nativeApi.user().userId,{timestamp:Date.now(),serviceType:n.serviceType,messageId:n.id,eventType:e.eventType,journeyVersionId:e.enqueuedMessage.request.journeyVersion,step:e.enqueuedMessage.request.step,info:e.description})}))}(r)}(),await async function(){const e=Li.filter((e=>L(e.app)));await nativeApi.metricsEnqueueBatch(e)}(),function(){let e=nativeApi.database(an);for(const t of zi){const n=Yi.fetch(t);null==e||e.set(t,n)}Yi.clear()}()}async processJourneys(e,t){let n=this.groupEventsByBundle(t);const i=new Br;for(const t of n.entries()){const n=t[0];let r=t[1];nativeApi.logDebug(v`Processing events seq ${n} -> ${r}`);const s=10,a=i.readPendingEvents(e.userId,n),o=a.slice(0,s),u=a.length>s?a.slice(s):[];r=r.filter((e=>e.eventType!==En));let c=new Nr(e,n,[...o,...r]);const l=[...u,...await this.journeysProcessor.processJourneys(c)];i.writePendingEvents(e.userId,n,l),l.length>0&&nativeApi.scheduleEvents({identifier:`journeys_classB_reschedule_${n}`,battery:!0,delaySecs:60,dataClass:Kt.G.B},[{eventType:En,bundleId:n}])}}async processSubscriptionChangeEvents(e){let t=[];for(const n of e){if(n.eventType!==dn&&n.eventType!==ln)continue;let e=await le(n.bundleId);e&&t.push(e)}return Promise.resolve(t)}groupEventsByBundle(e){let t=new Map;for(const n of e){let e=t.get(n.bundleId)||[];e.push(n),t.set(n.bundleId,e)}return t}normaliseEvent(e){var t;if(e.pluginId){const n=null===(t=plugins.mapPluginId(e.pluginId))||void 0===t?void 0:t.appBundleId;e.eventType==pn&&n&&(e.bundleId=n)}if("string"!=typeof e.eventTime&&"number"!=typeof e.eventTime||(e.createdOn=Zt()(e.eventTime).valueOf(),delete e.eventTime),en(e.createdOn)&&(e.createdOn=Date.now()),e.eventType===dn){let t=plugins.mapSubscriptionSegment(e.segment);t&&(e.bundleId=t.appBundleId)}return!p(e)||"string"!=typeof e.newVersion||e.previousVersion&&"string"!=typeof e.previousVersion||(e.newVersion=new ut.VersionNumber(e.newVersion),e.previousVersion=new ut.VersionNumber(e.previousVersion)),e}handleAmsOsUpgradeEvent(e){return e.flatMap((e=>p(e)&&!e.bundleId?plugins.getPlugins().map((t=>({...e,bundleId:t.appBundleId}))):e))}}!function(e){e[e.returnCachedDataDontLoad=0]="returnCachedDataDontLoad",e[e.returnValidCachedDataDontLoad=1]="returnValidCachedDataDontLoad",e[e.returnCachedDataElseLoadFallbackCached=2]="returnCachedDataElseLoadFallbackCached",e[e.returnCachedDataElseLoadFallbackNone=3]="returnCachedDataElseLoadFallbackNone"}(Dt||(Dt={}));class Wr{constructor(){this._actions=[],this.cachedUser=null,this.databases=new Map}getActions(){return this._actions}clearActions(){this._actions=[]}bag(){return bag}log(e){AMS.log.default(`[ODJ] ${e}`)}logError(e){AMS.log.error(`[ODJ] ${e}`)}logDebug(e){}client(){return AMS.client}userNotifications(){return AMS.userNotifications}uuid(){return random.nextUUID()}mediaApi(e){var t;let n,i=this.bag().string("countryCode"),r=null!==(t=this.bag().string("language-tag"))&&void 0!==t?t:this.getLocale(),s=this.bag().string("journeys-media-api-host");switch(host.platform){case"iOS":n="iphone";break;case"macOS":n="mac";break;case"tvOS":n="appletv";break;default:n=""}let a=en(e)?`/v1/engagement/${i}/journeys?l=${r}`:`${e}`;a=`${a}&platform=${n}`;let o={type:0,clientIdentifier:"com.apple.amp.journeys",clientVersion:"1",url:`https://${s}${a}`};return this.log(v`media api lookup ${o}`),AMS.media.lookup(o)}database(e){var t;return null!==(t=this.databases.get(e))&&void 0!==t?t:this.createDatabase(e)}createDatabase(e){let t=AMS.database.create({dataClass:e});if(t.result){const n=t.result;return this.databases.set(e,n),n}return null}metricsFlush(){return AMS.metrics.flush()}metricsEnqueueBatch(e){return e.forEach((e=>AMS.metrics.enqueue(Ni,e))),Promise.resolve()}metricsEnqueue(e){return AMS.metrics.enqueue(Ni,e),Promise.resolve()}enqueueActions(...e){this._actions.push(...e)}pluginFetchSync(e,t){return AMS.plugin.requestSync(e,t)}pluginRequestAsyncEvent(e,t,n){return AMS.plugin.requestAsyncEvent(e,n,t)}iTunesAccount(){const e=AMS.accounts.activeiTunes;if(e)return{dsid:e.dsid,storefront:e.storefront,username:e.username,firstName:e.firstName,lastName:e.lastName,fullName:e.fullName,isHSA2:e.isHSA2}}iCloudAccount(){const e=AMS.accounts.activeiCloud;if(e)return{dsid:e.dsid,storefront:e.storefront,username:e.username,firstName:e.firstName,lastName:e.lastName,fullName:e.fullName,isHSA2:e.isHSA2}}localAccount(){const e=AMS.accounts.localAccount;if(e)return{dsid:e.username,storefront:e.storefront,username:e.username,firstName:e.firstName,lastName:e.lastName,fullName:e.fullName,isHSA2:e.isHSA2}}async iCloudFamily(){if(AMS.accounts.activeiCloud)return this.getFamilyForAccount(AMS.accounts.activeiCloud)}async iTunesFamily(){if(AMS.accounts.activeiTunes)return this.getFamilyForAccount(AMS.accounts.activeiTunes)}async getFamilyForAccount(e){let t;try{let n=await AMS.family.lookup({account:e});t=s(n)?n[0]:n}catch(e){}return t}user(){var e;if(this.cachedUser)return this.cachedUser;let t;const n=this.iTunesAccount(),i=this.iCloudAccount(),r=this.localAccount();return Xt(n)?(t=n,nativeApi.log(v`[User] Using iTunes account: ${t}`)):Xt(i)?(t=i,nativeApi.log(v`[User] Using iCloud account: ${t}`)):Xt(r)?(t=r,t.dsid=this.getOrCreateRandomDsid(),nativeApi.log(v`[User] Using local account: ${t}`)):(t={dsid:this.getOrCreateRandomDsid(),storefront:"0-0"},nativeApi.log(v`[User] Using anonymous account: ${t}`)),this.cachedUser={userId:null!==(e=t.dsid)&&void 0!==e?e:"",storefrontId:t.storefront?Number(t.storefront.split("-")[0]):0,locale:this.getLocale(),deviceModel:host.deviceModel,platform:host.platform,osBuild:host.osBuild},this.cachedUser}scheduleEvents(e,t){if(!r(e.delaySecs)&&en(e.date))throw new Error("Either a delay or an absolute date must be specified in the schedule");let n=e.date;en(e.date)&&(n=Zt()().add(e.delaySecs,"second").format()),r(e.date)&&(n=Zt()(e.date).format()),this.enqueueActions({actionClass:rn,events:t,schedule:{battery:e.battery||!1,dataClass:e.dataClass||an,dateIsAdaptive:!0,delay:void 0,date:n,identifier:en(e.identifier)?this.uuid():e.identifier,grace:0,overwrite:!0}})}createRescheduledSyncAction(e,t=an,n={}){return{actionClass:"SyncAction",context:n,schedule:{battery:!0,dataClass:t,delay:e,identifier:"sync_reschedule",grace:0,overwrite:!0,dateIsAdaptive:!1}}}granularNotificationSettings(e){var t;const n=this.user(),i=this.localAccount();return(null===(t=AMS.serverDataCache)||void 0===t?void 0:t.granularNotificationSettings)&&(null==i?void 0:i.dsid)!==n.userId?AMS.serverDataCache.granularNotificationSettings(e,n.userId,{networkPolicy:Dt.returnCachedDataDontLoad}):Promise.resolve({})}device(){return{os:host.platform,osVersion:new ut.VersionNumber(void 0===AMS.device?u(host.osBuild):AMS.device.osVersion),deviceModel:host.deviceModel,osBuild:host.osBuild}}async lookupSubscription(e){try{let t=await AMS.subscription.lookup({type:e});if(s(t)){if(0===t.length||!t[0])return null;t=t[0]}return t}catch(t){return this.logError(v`Error looking up subscription for ${e}: ${t}`),null}}getLocale(){var e,t,n,r,s;let a="";return"undefined"!=typeof bag&&(a=null!==(t=null===(e=bag.string("language"))||void 0===e?void 0:e.toLowerCase())&&void 0!==t?t:a),i(a)||"undefined"==typeof bag||(a=null!==(r=null===(n=bag.string("language-tag"))||void 0===n?void 0:n.toLowerCase())&&void 0!==r?r:a),i(a)||(a=null!==(s=AMS.client.locale)&&void 0!==s?s:""),a=a.replace("_","-").toLowerCase(),a}getOrCreateRandomDsid(){const e=new Fi;let t=e.readLocalUserDsid();return t||(t=`local-${random.nextUUID()}`,e.writeLocalUserDsid(t)),t}}!function(e){e.exception="exception",e.is_production_build="is_production_build",e.unknown_method="unknown_method"}(Pt||(Pt={}));const Vr=[{allowsResponse:!0,filter:{eventType:"api"}}],Hr={actions:[]};class Jr{constructor(){this.usersDatastore=new Fi,this.assignmentsStore=new Oi,this.tagsStore=new xi}runTasks(){let e=this.usersDatastore.readUsers();for(const t of e)this.cleanupTestAssignments(t),this.cleanupTags(t),this.cleanupUserAttributes(t)}cleanupTestAssignments(e){this.assignmentsStore.deleteExpiredAssignments(e)}cleanupTags(e){this.tagsStore.deleteExpiredTags(e)}cleanupUserAttributes(e){this.usersDatastore.deleteExpiredAttributes(e)}}class Gr{constructor(){this.journeysStore=new $r,this.metadataStore=new Qn}async sync(e=!1){var t,n;const i=new Map,r=nativeApi.user();this.journeysStore.removeCompletedJourneys(r.userId);let s=[];try{for await(const e of this.fetchMetadata()){let n=e.versions||[];s.push(...n.filter((e=>e.status===rt.Terminated)).map((e=>e.versionId)));let a=n.filter((e=>e.status!==rt.Terminated));for(let n of a){if(!i.has(n.versionId)&&(nativeApi.logDebug(v`[Sync] Fetched journey ${S(n)} for bundle ${n.bundleId}`),!this.isApplicableVersion(n,r)))continue;await this.cacheInAppMessages(n);let s=null!==(t=i.get(n.versionId))&&void 0!==t?t:new Zn(n);i.set(s.versionId,s),this.metadataStore.writeJourneyVersionSteps(s,n.steps);for(const[t,n]of Object.entries(e.appSettings))this.metadataStore.writeApplicationSettings(t,n)}}s.forEach((e=>this.metadataStore.deleteJourneyVersionById(e)));const e=l([...i.values()],"bundleId");for(const t of plugins.getSupportedBundleIds()){let i=[...null!==(n=e.get(t))&&void 0!==n?n:new Set];this.maintainActiveVersions(this.metadataStore.readJourneyVersions(t),i,new Set(s)),this.metadataStore.writeJourneyVersions(t,i)}for(const e of i.values())this.metadataStore.writeJourneyVersion(e),nativeApi.logDebug(v`[Sync] Storing journey ${S(e)} for bundle ${e.bundleId}`)}catch(t){!function(e,t){var n;if(function(e){return Array.isArray(e)&&e.every(Pe)}(e)){const i=null===(n=e[0])||void 0===n?void 0:n.userInfo.AMSStatusCode;"number"==typeof i&&500!==i&&(t&&nativeApi.logError(v`[Sync] Got status code ${i}, but not rescheduling the sync, as it was already rescheduled before`),nativeApi.logError(v`[Sync] Got status code ${i}, rescheduling the sync`),nativeApi.enqueueActions(nativeApi.createRescheduledSyncAction(300,an,{isRescheduledAction:!0})))}nativeApi.logError(v`[Sync] Error while syncing metadata, falling back to the stored state. Error: ${e}`)}(t,e)}}isApplicableVersion(e,t){nativeApi.log(v`Supported plugin bundles: ${plugins.getSupportedBundleIds()}`);const n=plugins.getPluginForBundle(e.bundleId);if(!n)return nativeApi.log(v`[Sync] Skipping journey ${e.versionId} for ${e.bundleId} as no plugin supports it.`),!1;const i=n.isAppInstalled(),r=this.isAllowedForStorefrontId(e,t.storefrontId),s=e.status===rt.Active,a=this.checkOsPlatform(e);return i||nativeApi.log(`[Sync] Skipping ${A(e)} because the corresponding app is not installed.`),r||nativeApi.log(`[Sync] Skipping ${A(e)} because user.storefrontId = ${t.storefrontId} is not in journey.allowedStorefrontIds = ${e.allowedStorefrontIds}.`),s||nativeApi.log(`[Sync] Skipping ${A(e)} because journey.status = ${e.status} (should be ${rt.Active}).`),a||nativeApi.log(`[Sync] Skipping ${A(e)} because it is configured for a different device platform.`),i&&r&&s&&a}async cacheInAppMessages(e){var t;let n=new qi,i=new Map;e.steps.filter((e=>"UNIFIED_MESSAGE"===e.stepType)).filter((e=>void 0===n.readCachedMessage(e.messageId))).forEach((t=>{i.set(t.messageId,{messageUrl:t.messageUrl,journeyUrl:A(e),publishedAt:t.publishedAt})}));const r=nativeApi.user().locale;nativeApi.log(`Caching messages using the locale ${r}`);for(const e of i.keys())nativeApi.log(`[Sync] Caching message ${e} @ ${null===(t=i.get(e))||void 0===t?void 0:t.messageUrl}`);for(const[e,t]of Array.from(i.entries()))try{await J(r,e,t)}catch(n){ee({journeyURL:t.journeyUrl,type:"error",message:v`[Sync] Error while caching in-app message ${e}: ${n}`}),i.delete(e)}}async*fetchMetadata(){var e,t,n;let i;do{let r=await nativeApi.mediaApi(i);if(nativeApi.logDebug(v`[Sync] Received Media API response: ${r}`),s(r)){if(!r[0])throw new Error("Got empty metadata response!");r=r[0]}yield Promise.resolve({versions:(null===(e=r.results)||void 0===e?void 0:e.versions)||[],appSettings:null!==(n=null===(t=r.results)||void 0===t?void 0:t.appSettings)&&void 0!==n?n:{}}),i=r.next}while(i)}checkOsPlatform(e){var t;if(void 0===e.osPlatforms||en(e.osPlatforms))return!0;let n=null===(t=e.osPlatforms)||void 0===t?void 0:t[host.platform];return!en(n)&&n.every(this.checkVersionRequirement,this)}isAllowedForStorefrontId(e,t){return!e.allowedStorefrontIds||e.allowedStorefrontIds.includes(t)}checkVersionRequirement(e){if(en(e.version)||"ALL"===e.version)return!0;let t=(e.version||"").split(".").map((e=>Number(e)));for(;t.length<3;)t.push(0);const[n,i,s]=t;if(!r(n)||!r(i)||!r(s))throw new Error(v`Malformed version requirement: ${e}`);switch(e.operator){case"EQ":return host.isOSAtLeast(n,i,s)&&!host.isOSAtLeast(n,i,s+1);case"EQ_OR_NEWER_THAN":return host.isOSAtLeast(n,i,s);case"EQ_OR_OLDER_THAN":return!host.isOSAtLeast(n,i,s+1);case"NEWER_THAN":return host.isOSAtLeast(n,i,s+1);case"OLDER_THAN":return!host.isOSAtLeast(n,i,s);default:return!1}}maintainActiveVersions(e,t,n){let i=this.journeysStore.readActiveJourneys(nativeApi.user().userId).map((e=>e.versionId));for(const r of i)if(void 0===t.find((e=>e.versionId===r))&&!n.has(r)){let n=e.find((e=>e.versionId===r));n&&(n.status=rt.Published,t.push(n))}}}class Yr{getAllowedEventPatterns(){let e=[];return plugins.getPlugins().flatMap((e=>e.getAllowedEvents())).forEach((t=>e.push({allowsResponse:!0,filter:t}))),[...this.getInternalEvents(),...this.getLocalUserNotificationMetricEventsPatterns(),...this.getBadgingMetricEventsPatterns(),...this.getInAppMessagesMetricEventsPatterns(),...e,...this.getSubscriptionEvents(),...Pr,...Vr]}getSubscriptionEvents(){return[{allowsResponse:!0,filter:{eventType:dn}},{allowsResponse:!0,filter:{eventType:on}},{allowsResponse:!0,filter:{eventType:un}},{allowsResponse:!0,filter:{eventType:cn}},{allowsResponse:!0,filter:{eventType:ln}}]}getLocalUserNotificationMetricEventsPatterns(){return[{allowsResponse:!0,filter:{eventType:yn}},{allowsResponse:!0,filter:{eventType:wn}}]}getBadgingMetricEventsPatterns(){return[{allowsResponse:!0,filter:{eventType:Pn}}]}getInAppMessagesMetricEventsPatterns(){return[{allowsResponse:!0,filter:{eventType:Tn}},{allowsResponse:!0,filter:{eventType:Cn}}]}getInternalEvents(){return[{allowsResponse:!0,filter:{eventType:fn.replace("$","\\$")}},{allowsResponse:!0,filter:{eventType:"SessionStart"}},{allowsResponse:!0,filter:{eventType:kn}},{allowsResponse:!0,filter:{eventType:"test"}},{allowsResponse:!0,filter:{eventType:hn}},{allowsResponse:!0,filter:{eventType:pn}},{allowsResponse:!0,filter:{eventType:Sn}},{allowsResponse:!0,filter:{eventType:En}},{allowsResponse:!0,filter:{eventType:mn}}]}}!function(e){e.MigrationKey="data_migration"}(_t||(_t={}));class zr{static createKey(e){return`${_t.MigrationKey}_${e}`}runDataMigrations(){nativeApi.database(an)?(zr.runMigration("v1",(e=>{let t=nativeApi.user().userId;e.set(`num_ab_assignments_${t}`,0),e.set(`ab_assignments_${t}`,{}),e.set(`completed_journeys_${t}`,{})})),zr.runMigration("pagedVersions",this.pagedVersionsMigration)):nativeApi.log("Cannot access the database.")}static runMigration(e,t){let n=nativeApi.database(an),i=zr.createKey(e),r=n.fetch(i);en(r)&&(nativeApi.log(`Running migration ${e}`),t(n),n.set(i,!0))}pagedVersionsMigration(e){var t,n;const i=new Qn;let r=e.fetch("journey_metadata");if(r){for(const s of plugins.getSupportedBundleIds()){const a=null!==(t=e.fetch(`journey_defs_${s}`))&&void 0!==t?t:[];let o=a.map((e=>new Zn(e)));for(let e=0;e<a.length;e++)i.writeJourneyVersionSteps(o[e],a[e].steps);i.writeJourneyVersions(s,o);const u=null===(n=r.appSettings)||void 0===n?void 0:n[s];u&&e.set(`appsettings_${s}`,u)}e.set("journey_metadata",null)}}}const Kr="journeys_os_build",Qr={whitelistedEvents:[],allowedEvents:[],actions:[]};class Zr{constructor(e){this.actionClass="DeepLinkAction",this.url=e}}class Xr{constructor(e,t=null){this.actionClass="EnqueueAction",this.events=e,this.schedule=t}}!function(e){e.cachedBagValues="AMSLimitedCachedBagValues"}($t||($t={})),function(e){e.CountryCode="countryCode",e.Language="language",e.LanguageTag="language-tag"}(xt||(xt={})),function(e){e.String="string",e.Url="url",e.Array="array",e.Boolean="boolean",e.Dictionary="dictionary",e.Number="number"}(Ot||(Ot={}));let es=null,ts=null,ns="";!function(e){e[e.TabHeader=0]="TabHeader",e[e.Contextual=1]="Contextual",e[e.Aristotle=2]="Aristotle"}(Nt||(Nt={}));class is{accessList(){return[{filter:{eventType:"purchase"},allowsResponse:!0},{filter:{eventType:"carrier-link"},allowsResponse:!0}]}buildJourneys(){return[{id:this.constructor.name+".puchase-arcade-generic",loop:!0,steps:[{id:"S1",andMatch:[{eventType:"purchase",success:1,"buyParameters.appAdamId":"915061776",marketingPlacement:"arcadeGeneric"}],orMatch:[{"buyParameters.offerName":"~AppleArcade"},{"buyParameters.offerName":"~ocelot"}],actions:[this.arcadeDeepLinkAction()]}]},{id:this.constructor.name+".carrier-link-arcade-generic",loop:!0,steps:[{id:"S1",andMatch:[{eventType:"carrier-link",success:1,marketingPlacement:"arcadeGeneric"}],actions:[this.arcadeDeepLinkAction()]}]},{id:this.constructor.name+".purchase-non-contextual",loop:!0,steps:[{id:"S1",andMatch:[{eventType:"purchase",success:1,"buyParameters.appAdamId":"915061776",marketingServiceType:"~arcade"},{marketingPlacement:"!arcadeGroupingLockup"},{marketingPlacement:"!arcadeProductPage"}],orMatch:[{"buyParameters.offerName":"~AppleArcade"},{"buyParameters.offerName":"~ocelot"}],engagementRequest:{url:"https://amsui.apple.com/dynamic/marketing#route=welcome",clientData:{welcomeItem:this.createWelcomeItem(Nt.TabHeader)}}}]},{id:this.constructor.name+".carrier-link-non-contextual",loop:!0,steps:[{id:"S1",andMatch:[{eventType:"carrier-link",success:1,marketingServiceType:"~arcade"},{marketingPlacement:"!arcadeGeneric"},{marketingPlacement:"!arcadeGroupingLockup"},{marketingPlacement:"!arcadeProductPage"}],engagementRequest:{url:"https://amsui.apple.com/dynamic/marketing#route=welcome",clientData:{welcomeItem:this.createWelcomeItem(Nt.TabHeader)}}}]},{id:this.constructor.name+".purchase-contextual",loop:!0,steps:[{id:"S1",andMatch:[{eventType:"purchase",success:1,"buyParameters.appAdamId":"915061776"}],orMatch:[{marketingPlacement:"arcadeGroupingLockup"},{marketingPlacement:"arcadeProductPage"}],engagementRequest:{url:"https://amsui.apple.com/dynamic/marketing#route=welcome",clientData:{welcomeItem:this.createWelcomeItem(Nt.Contextual)}}}]},{id:this.constructor.name+".carrier-link-contextual",loop:!0,steps:[{id:"S1",andMatch:[{eventType:"carrier-link",success:1,marketingServiceType:"~arcade"}],orMatch:[{marketingPlacement:"arcadeGroupingLockup"},{marketingPlacement:"arcadeProductPage"}],engagementRequest:{url:"https://amsui.apple.com/dynamic/marketing#route=welcome",clientData:{welcomeItem:this.createWelcomeItem(Nt.Contextual)}}}]},{id:this.constructor.name+".3",loop:!0,steps:[{id:"S1",andMatch:[{eventType:"purchase",success:1,marketingServiceType:"~arcade",marketingPlacement:"!arcadeGeneric"}],orMatch:[{"buyParameters.appAdamId":"1529498570"},{"buyParameters.appAdamId":"383941000"}],engagementRequest:{url:"https://amsui.apple.com/dynamic/marketing#route=welcome",clientData:{welcomeItem:this.createWelcomeItem(Nt.Aristotle)}}}]}]}enabled(){const e="iOS"==host.platform,t="tvOS"==host.platform;return host.platform,e||t}arcadeDeepLinkAction(){return new Zr("itms-apps://tab/arcade")}createLinkAction(e,t){return"macOS"==host.platform?{callToAction:e,kind:"dismiss"}:{callToAction:e,kind:"link",external:!0,url:t}}createWelcomeItem(e){var t,n;let i,r,s,a,o=e==Nt.Contextual||e==Nt.Aristotle;if(o?(i={bgColor:"000000",height:3240,textColor1:"fdc97a",textColor2:"f73a03",textColor3:"caa161",textColor4:"c52e02",url:"https://is3-ssl.mzstatic.com/image/thumb/Features124/v4/57/71/7f/57717f8b-c486-4faf-7558-a4f88186855d/source/{w}x{h}{c}.{f}",width:4320},r={bgColor:"000000",height:3636,textColor1:"f7c981",textColor2:"f8a710",textColor3:"c6a067",textColor4:"c6850d",url:"https://is3-ssl.mzstatic.com/image/thumb/Features123/v4/9a/d4/48/9ad448b5-ddbb-f295-fae3-2a2e69bf5604/source/{w}x{h}{c}.{f}",width:1680}):(i={bgColor:"000000",height:3240,textColor1:"ff7900",textColor2:"f70e44",textColor3:"cb6000",textColor4:"c60b36",url:"https://is3-ssl.mzstatic.com/image/thumb/Features113/v4/72/5b/f0/725bf099-9338-4f8a-6c37-537b65e5c26a/source/{w}x{h}{c}.{f}",width:4320},r={bgColor:"000000",height:3636,textColor1:"fdfc00",textColor2:"ff0000",textColor3:"cac900",textColor4:"cb0000",url:"https://is1-ssl.mzstatic.com/image/thumb/Features113/v4/4c/82/6f/4c826f28-e367-667d-d724-365e8f0e8271/source/{w}x{h}{c}.{f}",width:1680}),"tvOS"===host.platform)a=Oe("AMSEngagement.Arcade.Welcome.Subtitle","ARCADE_SUBTITLE"),s=[{callToAction:Oe("AMSEngagement.Arcade.Welcome.CallToAction","ARCADE_CALLTOACTION"),kind:"dismiss"}];else if(o){a=e==Nt.Aristotle?Oe("AMSEngagement.Arcade.Welcome.SubtitleAristotle",null,"You just unlocked 100+ amazing games with your Apple One subscription. Visit the Arcade tab to see everything you can play."):Oe("AMSEngagement.Arcade.Welcome.Subtitle2","ARCADE_SUBTITLE");const n=null!==(t=Oe("AMSEngagement.Arcade.Welcome.Button2","ARCADE_WELCOME_BUTTON"))&&void 0!==t?t:"";s=[this.createLinkAction(n,"itms-apps://tab/arcade"),{callToAction:Oe("CommerceUI.IOS.NotNow","ARCADE_CALLTOACTION"),kind:"dismiss",style:"text"}]}else{a=Oe("AMSEngagement.Arcade.Welcome.Subtitle","ARCADE_SUBTITLE");const e=null!==(n=Oe("AMSEngagement.Arcade.Welcome.Button2","ARCADE_WELCOME_BUTTON"))&&void 0!==n?n:"";s=[this.createLinkAction(e,"itms-apps://tab/arcade")]}return{actions:s,artworks:{breakoutFullScreen:i,breakoutTall:r,topShelf:{bgColor:"ff7f46",height:2160,textColor1:"160006",textColor2:"160006",textColor3:"451913",textColor4:"451913",url:"https://is1-ssl.mzstatic.com/image/thumb/Features113/v4/cb/72/d5/cb72d518-7d56-5ce9-aa6e-8c87afa75800/source/{w}x{h}{c}.{f}",width:3840}},detail:null,display:{template:"service-product-welcome",templateParameters:{hideBadge:!1}},id:"welcome.id.123456",services:[{id:"feature1",artwork:{url:"resource://DeviceSharing",height:200,width:200},title:Oe("AMSEngagement.Arcade.Welcome.Feature1.Title","ARCADE_FEATURE1_TITLE"),description:Oe("AMSEngagement.Arcade.Welcome.Feature1.Description","ARCADE_FEATURE1_DESCRIPTION")},{id:"feature2",artwork:{url:"resource://FamilySharing",height:200,width:200},title:Oe("AMSEngagement.Arcade.Welcome.Feature2.Title","ARCADE_FEATURE2_TITLE"),description:Oe("AMSEngagement.Arcade.Welcome.Feature2.Description","ARCADE_FEATURE2_DESCRIPTION")},{id:"feature3",artwork:{url:"resource://ControllerSupport",height:200,width:200},title:Oe("AMSEngagement.Arcade.Welcome.Feature3.Title","ARCADE_FEATURE3_TITLE"),description:Oe("AMSEngagement.Arcade.Welcome.Feature3.Description","ARCADE_FEATURE3_DESCRIPTION")}],subtitle:a,title:Oe("AMSEngagement.Arcade.Welcome.Title","ARCADE_WELCOME_TITLE")}}}!function(e){e[e.Individual=0]="Individual",e[e.Family=1]="Family",e[e.Premier=2]="Premier",e[e.Premier5S=3]="Premier5S"}(Rt||(Rt={})),function(e){e[e.Arcade=0]="Arcade",e[e.iCloud=1]="iCloud",e[e.Music=2]="Music",e[e.TV=3]="TV",e[e.News=4]="News",e[e.Fitness=5]="Fitness"}(jt||(jt={}));class rs{accessList(){return[{filter:{eventType:"purchase"},allowsResponse:!0},{filter:{eventType:"carrier-link"},allowsResponse:!0}]}buildJourneys(){return[{id:this.constructor.name+".1",loop:!0,steps:[{id:"S1",andMatch:[{eventType:"purchase",success:1},{marketingServiceType:"~bundle"},{marketingPlacement:"!musicBundleTile"}],orMatch:[{"buyParameters.offerName":"~AppleOnePremier6S"},{"buyParameters.offerName":"~AristotleMax"},{"buyParameters.offerName":"~AristotlePremier"}],engagementRequest:{url:"https://amsui.apple.com/dynamic/marketing#route=welcome",clientData:{welcomeItem:this.createWelcomeItem(Rt.Premier)}}}]},{id:this.constructor.name+".1.carrier-link.upsell",loop:!0,steps:[{id:"S1",andMatch:[{eventType:"carrier-link",success:1},{marketingPlacement:"aobMarketingUpsell"},{marketingServiceType:"~bundle"}],orMatch:[{linkParams:"~offerName=com.apple.AppleOne.AppleOnePremier6S"},{linkParams:"~offerName=com.apple.aristotle.AristotleMax"},{linkParams:"~offerName=com.apple.aristotle.AristotlePremier"}],engagementRequest:{url:"https://amsui.apple.com/dynamic/marketing#route=welcome",clientData:{welcomeItem:this.createWelcomeItem(Rt.Premier)}}}]},{id:this.constructor.name+".1.carrier-link.iCloud",loop:!0,steps:[{id:"S1",andMatch:[{eventType:"carrier-link",success:1},{marketingPlacement:"iCloudPreBuyFlow"},{marketingServiceType:"~bundle"}],orMatch:[{linkParams:"~offerName=com.apple.AppleOne.AppleOnePremier6S"},{linkParams:"~offerName=com.apple.aristotle.AristotleMax"},{linkParams:"~offerName=com.apple.aristotle.AristotlePremier"}],engagementRequest:{url:"https://amsui.apple.com/dynamic/marketing#route=welcome",clientData:{welcomeItem:this.createWelcomeItem(Rt.Premier)}}}]},{id:this.constructor.name+".1.1",loop:!0,steps:[{id:"S1",andMatch:[{eventType:"purchase",success:1},{marketingServiceType:"~bundle"},{marketingPlacement:"!musicBundleTile"}],orMatch:[{"buyParameters.offerName":"~com.apple.aristotle.AppleOnePremier5S"}],engagementRequest:{url:"https://amsui.apple.com/dynamic/marketing#route=welcome",clientData:{welcomeItem:this.createWelcomeItem(Rt.Premier5S)}}}]},{id:this.constructor.name+".1.1.carrier-link.upsell",loop:!0,steps:[{id:"S1",andMatch:[{eventType:"carrier-link",success:1},{marketingPlacement:"aobMarketingUpsell"},{marketingServiceType:"~bundle"}],orMatch:[{linkParams:"~offerName=com.apple.AppleOne.AppleOnePremier5S"},{linkParams:"~offerName=com.apple.aristotle.AppleOnePremier5S"}],engagementRequest:{url:"https://amsui.apple.com/dynamic/marketing#route=welcome",clientData:{welcomeItem:this.createWelcomeItem(Rt.Premier5S)}}}]},{id:this.constructor.name+".1.1.carrier-link.iCloud",loop:!0,steps:[{id:"S1",andMatch:[{eventType:"carrier-link",success:1},{marketingPlacement:"iCloudPreBuyFlow"},{marketingServiceType:"~bundle"}],orMatch:[{linkParams:"~offerName=com.apple.AppleOne.AppleOnePremier5S"},{linkParams:"~offerName=com.apple.aristotle.AppleOnePremier5S"}],engagementRequest:{url:"https://amsui.apple.com/dynamic/marketing#route=welcome",clientData:{welcomeItem:this.createWelcomeItem(Rt.Premier5S)}}}]},{id:this.constructor.name+".2",loop:!0,steps:[{id:"S1",andMatch:[{eventType:"purchase",success:1},{marketingServiceType:"~bundle"},{marketingPlacement:"!musicBundleTile"}],orMatch:[{"buyParameters.offerName":"~AppleOneIndividual"},{"buyParameters.offerName":"~AristotleIndividual"},{"buyParameters.offerName":"~AristotleStudent"}],engagementRequest:{url:"https://amsui.apple.com/dynamic/marketing#route=welcome",clientData:{welcomeItem:this.createWelcomeItem(Rt.Individual)}}}]},{id:this.constructor.name+".2.carrier-link.upsell",loop:!0,steps:[{id:"S1",andMatch:[{eventType:"carrier-link",success:1},{marketingPlacement:"aobMarketingUpsell"},{marketingServiceType:"~bundle"}],orMatch:[{linkParams:"~offerName=com.appleone.AppleOneIndividualIAP"},{linkParams:"~offerName=com.apple.AppleOne.AppleOneIndividual"},{linkParams:"~offerName=com.apple.aristotle.AristotleIndividual"},{linkParams:"~offerName=com.apple.aristotle.AristotleStudent"}],engagementRequest:{url:"https://amsui.apple.com/dynamic/marketing#route=welcome",clientData:{welcomeItem:this.createWelcomeItem(Rt.Individual)}}}]},{id:this.constructor.name+".2.carrier-link.iCloud",loop:!0,steps:[{id:"S1",andMatch:[{eventType:"carrier-link",success:1},{marketingPlacement:"iCloudPreBuyFlow"},{marketingServiceType:"~bundle"}],orMatch:[{linkParams:"~offerName=com.appleone.AppleOneIndividualIAP"},{linkParams:"~offerName=com.apple.AppleOne.AppleOneIndividual"},{linkParams:"~offerName=com.apple.aristotle.AristotleIndividual"},{linkParams:"~offerName=com.apple.aristotle.AristotleStudent"}],engagementRequest:{url:"https://amsui.apple.com/dynamic/marketing#route=welcome",clientData:{welcomeItem:this.createWelcomeItem(Rt.Individual)}}}]},{id:this.constructor.name+".3",loop:!0,steps:[{id:"S1",andMatch:[{eventType:"purchase",success:1},{marketingServiceType:"~bundle"},{marketingPlacement:"!musicBundleTile"}],orMatch:[{"buyParameters.offerName":"~AppleOneFamily"},{"buyParameters.offerName":"~AristotleFamily"}],engagementRequest:{url:"https://amsui.apple.com/dynamic/marketing#route=welcome",clientData:{welcomeItem:this.createWelcomeItem(Rt.Family)}}}]},{id:this.constructor.name+".3.carrier-link.upsell",loop:!0,steps:[{id:"S1",andMatch:[{eventType:"carrier-link",success:1},{marketingPlacement:"aobMarketingUpsell"},{marketingServiceType:"~bundle"}],orMatch:[{linkParams:"~offerName=com.apple.AppleOne.AppleOneFamily"},{linkParams:"~offerName=com.apple.aristotle.AristotleFamily"}],engagementRequest:{url:"https://amsui.apple.com/dynamic/marketing#route=welcome",clientData:{welcomeItem:this.createWelcomeItem(Rt.Family)}}}]},{id:this.constructor.name+".3.carrier-link.iCloud",loop:!0,steps:[{id:"S1",andMatch:[{eventType:"carrier-link",success:1},{marketingPlacement:"iCloudPreBuyFlow"},{marketingServiceType:"~bundle"}],orMatch:[{linkParams:"~offerName=com.apple.AppleOne.AppleOneFamily"},{linkParams:"~offerName=com.apple.aristotle.AristotleFamily"}],engagementRequest:{url:"https://amsui.apple.com/dynamic/marketing#route=welcome",clientData:{welcomeItem:this.createWelcomeItem(Rt.Family)}}}]}]}enabled(){return!0}createWelcomeItem(e){return{actions:[{callToAction:Oe("Done",null,"Done"),kind:"dismiss"}],artworks:{breakoutFullScreen:{bgColor:"000000",height:3240,textColor1:"ff7900",textColor2:"f70e44",textColor3:"cb6000",textColor4:"c60b36",url:"https://is3-ssl.mzstatic.com/image/thumb/Features113/v4/72/5b/f0/725bf099-9338-4f8a-6c37-537b65e5c26a/source/{w}x{h}{c}.{f}",width:4320},breakoutTall:{bgColor:"000000",height:3636,textColor1:"fdfc00",textColor2:"ff0000",textColor3:"cac900",textColor4:"cb0000",url:"https://is1-ssl.mzstatic.com/image/thumb/Features113/v4/4c/82/6f/4c826f28-e367-667d-d724-365e8f0e8271/source/{w}x{h}{c}.{f}",width:1680},topShelf:{bgColor:"ff7f46",height:2160,textColor1:"160006",textColor2:"160006",textColor3:"451913",textColor4:"451913",url:"https://is1-ssl.mzstatic.com/image/thumb/Features113/v4/cb/72/d5/cb72d518-7d56-5ce9-aa6e-8c87afa75800/source/{w}x{h}{c}.{f}",width:3840}},metrics:{pageId:"aobWelcome",pageName:"Welcome to Apple One",pageType:"FullSheet",topic:"xp_amp_subscriptions_cs"},detail:null,display:{template:"bundle-list-welcome",templateParameters:{hideBadge:!1}},id:"welcome.id.123456",services:this.createItemServices(e),subtitle:Oe("AMSEngagement.Aristotle.Welcome.Subtitle",null,"Discover all your Apple One services."),title:Oe("AMSEngagement.Aristotle.Welcome.Title",null,'<s font-weight="medium">Welcome to<\\s><br/><symbol>one-logo</symbol>')}}createItemServices(e){let t,n=[];switch(e){case Rt.Individual:t="50 GB",n=[jt.Music,jt.TV,jt.Arcade,jt.iCloud];break;case Rt.Family:t="200 GB",n=[jt.Music,jt.TV,jt.Arcade,jt.iCloud];break;case Rt.Premier:t="2 TB",n=[jt.Music,jt.TV,jt.Arcade,jt.iCloud,jt.News,jt.Fitness];break;case Rt.Premier5S:t="2 TB",n=[jt.Music,jt.TV,jt.Arcade,jt.iCloud,jt.Fitness]}let i=[];return n.forEach((e=>{switch(e){case jt.Arcade:i.push({id:"arcade",artwork:{height:300,url:"https://is1-ssl.mzstatic.com/image/thumb/Features123/v4/c3/ac/a7/c3aca7e8-c076-5c48-d7cf-2229ddd9f6b8/source/{w}x{h}{c}.{f}",width:300},description:Oe("AMSEngagement.Aristotle.Welcome.Arcade.Description",null,"100+ ad-free games"),title:Oe("AMSEngagement.Aristotle.Welcome.Arcade.Title",null,"Apple Arcade")});break;case jt.Fitness:i.push({id:"fitness",artwork:{height:300,url:"https://is2-ssl.mzstatic.com/image/thumb/Purple114/v4/f5/e8/95/f5e8959f-c67f-e4ea-eb8f-87b52f13fc9e/AppIcon-1x_U007emarketing-0-10-0-85-220.png/{w}x{h}{c}.{f}",width:300},description:Oe("AMSEngagement.Aristotle.Welcome.Fitness.Description",null,"100s of studio workouts. Powered by Apple Watch (Coming Soon)"),title:Oe("AMSEngagement.Aristotle.Welcome.Fitness.Title",null,"Apple Fitness+")});break;case jt.Music:i.push({id:"music",artwork:{height:300,url:"https://is2-ssl.mzstatic.com/image/thumb/Purple124/v4/51/9b/13/519b1387-a4a3-4b8b-c324-55dd818c768c/AppIcon-1x_U007emarketing-0-10-0-85-220.png/{w}x{h}{c}.{f}",width:300},description:Oe("AMSEngagement.Aristotle.Welcome.Music.Description",null,"Over 60 million songs"),title:Oe("AMSEngagement.Aristotle.Welcome.Music.Title",null,"Apple Music")});break;case jt.News:i.push({id:"news_plus",artwork:{height:300,url:"https://is4-ssl.mzstatic.com/image/thumb/Purple123/v4/2f/de/3b/2fde3b07-fdaa-2c92-45c5-a70760a471a4/AppIcon-0-0-1x_U007emarketing-0-0-0-10-0-0-sRGB-0-0-0-GLES2_U002c0-512MB-85-220-0-0.png/{w}x{h}{c}.{f}",width:300},description:Oe("AMSEngagement.Aristotle.Welcome.News.Description",null,"Magazines and newspapers"),title:Oe("AMSEngagement.Aristotle.Welcome.News.Title",null,"Apple News+")});break;case jt.TV:i.push({id:"tv_plus",artwork:{height:300,url:"https://is5-ssl.mzstatic.com/image/thumb/Purple123/v4/bf/46/12/bf4612d4-c5e2-9a5c-667a-871d6a4dbbc3/AppIcon-0-0-1x_U007emarketing-0-0-0-7-0-0-sRGB-0-0-0-GLES2_U002c0-512MB-85-220-0-0.png/{w}x{h}{c}.{f}",width:300},description:Oe("AMSEngagement.Aristotle.Welcome.TV.Description",null,"Watch Apple TV+ in the TV app"),title:Oe("AMSEngagement.Aristotle.Welcome.TV.Title",null,"Apple TV+")});break;case jt.iCloud:let e=Oe("AMSEngagement.Aristotle.Welcome.iCloud.Description",null,"Use iCloud storage in the files app");t&&(e=e.replace("[Capacity]",t)),i.push({id:"icloud",artwork:{height:300,url:"https://is1-ssl.mzstatic.com/image/thumb/Purple71/v4/fa/45/6c/fa456cf4-cc98-acdb-17b1-82f556436db0/mzl.fluxetgb.png/{w}x{h}{c}.{f}",width:300},description:e,title:Oe("AMSEngagement.Aristotle.Welcome.iCloud.Title",null,"iCloud storage")})}})),i}}class ss{accessList(){return[{filter:{kind:"AMSMarketingItemParser"},allowsResponse:!0}]}buildJourneys(){return[]}enabled(){return!0}}class as{accessList(){return[{filter:{app:"AppStore",request:"defaultTabSelection"},allowsResponse:!0},{filter:{eventType:"loadUrl",requestUrl:".*bag\\.xml.*profile=AppleNews.*"}},{filter:{eventType:"search",term:"App development"}},{filter:{topic:"xp_amp_podcasts_main",pageUrl:".*podcasts-kids-family.*"}},{filter:{eventType:"search",term:".*Gaming.*"}}]}buildJourneys(){return[{id:"J-1.1",loop:!0,steps:[{id:"S-1",andMatch:[{eventType:"loadUrl",requestUrl:"~bag.xml"},{eventType:"loadUrl",requestUrl:"~AppleNews"}],data:{tab:"today"},cacheInfo:{duration:60,key:"tab-selection",filter:{app:"AppStore",request:"defaultTabSelection"}}}]},{id:"J-1.2",loop:!0,steps:[{id:"S-1",andMatch:[{eventType:"search",term:"App development"}],data:{tab:"apps"},cacheInfo:{duration:60,key:"tab-selection",filter:{app:"AppStore",request:"defaultTabSelection"}}}]},{id:"J-1.3",loop:!0,steps:[{id:"S-1",orMatch:[{topic:"xp_amp_podcasts_main",pageUrl:"~podcasts-kids-family"},{eventType:"search",term:"~Gaming"}],data:{tab:"games"},cacheInfo:{duration:60,key:"tab-selection",filter:{app:"AppStore",request:"defaultTabSelection"}}}]}]}enabled(){return!1}}class os{accessList(){return[{filter:{test:"1"}},{filter:{test:"2"}}]}buildJourneys(){return[{id:"TEST-1.1",loop:!0,steps:[{id:"S-1",andMatch:[{test:"1"}],actions:[new Xr([{test:"2"}],{battery:!1,dateIsAdaptive:!0,date:new Date((new Date).getTime()+6e4).toISOString().split(".")[0]+"Z",dataClass:an,identifier:"test-schedule-1",grace:0,overwrite:!1})]}]}]}enabled(){return!1}}const us=/^([a-z][a-z0-9.+-]*:)(\/\/)?([\S\s]*)/i,cs=/([^=?&]+)=?([^&]*)/g,ls=["fragment","query","pathname","host"];class ds{constructor(e){if(!e)return;let t=e;const n=us.exec(e);if(n){let e=n[1];e&&(e=e.split(":")[0]),this.protocol=e,t=n[3]}let i={remainder:t,result:void 0};for(const e of ls){if(!i.remainder)break;switch(e){case"fragment":i=je(i.remainder,"#","suffix"),this.fragment=i.result;break;case"query":i=je(i.remainder,"?","suffix"),i.result&&(this.query=ds.queryFromString(i.result));break;case"pathname":i=je(i.remainder,"/","suffix"),i.result&&(this.pathname="/"+i.result);break;case"host":if(i.remainder){const e=je(i.remainder,"@","prefix"),t=e.result,n=e.remainder;if(t){const e=t.split(":");this.username=decodeURIComponent(e[0]),this.password=decodeURIComponent(e[1])}if(n){const e=n.split(":");this.host=e[0],this.port=e[1]}}break;default:throw new Error("Unhandled case")}}}set(e,t){return t?("query"===e&&"string"==typeof t&&(t=ds.queryFromString(t)),"query"===e?this.query=t:this[e]=t,this):this}append(e,t){const n=this[e];let i;if("query"===e)"string"==typeof t&&(t=ds.queryFromString(t)),i="string"==typeof n?{existingValue:n,...t}:{...n,...t};else{let r=n;r||(r="");let s=r;if("pathname"===e){const e=r.length;e&&"/"===r[e-1]||(s+="/")}s+=t,i=s}return this.set(e,i)}param(e,t){return e?(this.query||(this.query={}),t?this.query[e]=t:delete this.query[e],this):this}removeParam(e){return e&&this.query?(delete this.query[e],this):this}path(e){return this.append("pathname",e)}pathExtension(){var e;if(void 0===this.pathname)return;const t=null===(e=this.pathname.split("/").filter((e=>e.length>0)).pop())||void 0===e?void 0:e.split(".");return!t||t.filter((e=>""!==e)).length<2?void 0:t.pop()}pathComponents(){return this.pathname?this.pathname.split("/").filter((e=>e.length>0)):[]}queryString(){if(null!=this.query)return`?${ds.toQueryString(this.query)}`}build(){return this.toString()}toString(){let e="";return this.protocol&&(e+=this.protocol+"://"),this.username&&(e+=encodeURIComponent(this.username),this.password&&(e+=":"+encodeURIComponent(this.password)),e+="@"),this.host&&(e+=this.host,this.port&&(e+=":"+this.port)),this.pathname&&(e+=this.pathname),this.query&&Object.keys(this.query).length&&(e+="?"+ds.toQueryString(this.query)),this.fragment&&(e+="#"+this.fragment),e}static queryFromString(e){const t={};let n=cs.exec(e);for(;n;){const i=decodeURIComponent(n[1]),r=decodeURIComponent(n[2]);t[i]=r,n=cs.exec(e)}return t}static toQueryString(e){let t="",n=!0;for(const i of Object.keys(e)){n||(t+="&"),n=!1,t+=encodeURIComponent(i);const r=e[i];r&&r.length&&(t+="="+encodeURIComponent(r))}return t}static from(e){return new ds(e)}static fromComponents(e,t,n,i,r){const s=new ds;return s.protocol=e,s.host=t,s.pathname=n,s.query=i,s.fragment=r,s}}class hs{accessList(){return[{filter:{eventType:"NFCScan"},allowsResponse:!0}]}buildJourneys(){return[{id:"NFCScanJourney.1",loop:!0,steps:[{id:"S-1",andMatch:[{eventType:"NFCScan"},{url:"~ams.apple.com/"}],stepResult(e){var t,n;const i=new ds(e.url),r=i.pathComponents().find((e=>e.length>0));if(null==r||"prox"!=r)return{data:{error:"unhandledURL"}};let s=!1;const a=null===(t=i.query)||void 0===t?void 0:t.banner;null!=a&&"none"==a&&(s=!0);const o={url:`https://amsui.apple.com/dynamic/marketing${null!==(n=i.queryString())&&void 0!==n?n:""}`,clientData:Ue(s)};return{actions:[(0,gt.createSystemEngagementAction)(o)],data:{}}}}]}]}enabled(){return!1}}class ps{accessList(){return[{filter:{eventType:"link"},allowsResponse:!0}]}buildJourneys(){return[{id:"AMSViewServiceJourney.1",loop:!0,steps:[{id:"S-1",andMatch:[{eventType:"link"},{url:"~ams-ue://"}],stepResult:e=>{var t;const n=e.url;let i=new ds(n);i.protocol="https";const r=null===(t=i.query)||void 0===t?void 0:t.presentation;let s={url:i.toString(),clientData:{style:r}};return{actions:[(0,gt.createSystemEngagementAction)(s)]}}}]}]}enabled(){return!1}}class fs{static fetch(){return new Promise(((e,t)=>{e(this.buildStub())}))}static buildStub(){var e,t,n;let i=[new ss,new rs,new is,new as,new hs,new ps,new os];for(e=[],t=[],n=0;n<i.length;n++){let r=i[n];if(!r.enabled())continue;let s=r.accessList();s.length>0&&e.push.apply(e,s);let a=r.buildJourneys();a.length>0&&t.push.apply(t,a)}return{whitelistedEvents:e,journeys:t}}}!function(e){e.ServerResult="ServerResult"}(Ut||(Ut={}));class ms{static localize(e){let t=AMS.localize.nativeString(e);return t&&0!=t.length?t:""}static logError(e){AMS.log.error(e)}static logDefault(e){AMS.log.default(e)}static database(){let e=AMS.database.create();if(e.result)return e.result;if(e.error)return null;throw new Error("!")}static databaseFetch(e){var t;return null===(t=this.database())||void 0===t?void 0:t.fetch(e)}static databaseStore(e,t){var n;return null===(n=this.database())||void 0===n?void 0:n.set(e,t)}static pluginRequest(e,t){return AMS.plugin.request(e,t)}static props(){if(this.cachedNativeProps)return this.cachedNativeProps;let e=AMS.props;return this.cachedNativeProps=null!=e?e:{},this.cachedNativeProps}}ms.cachedNativeProps=null,function(e){e.open="OPEN",e.play="PLAY",e.view="VIEW"}(Lt||(Lt={}));const vs="AMSSubscriptionsCache";!function(e){e[e.Music=1]="Music",e[e.TV=2]="TV",e[e.Arcade=3]="Arcade",e[e.Fitness=4]="Fitness",e[e.AppStore=5]="AppStore",e[e.Podcasts=6]="Podcasts",e[e.Books=7]="Books",e[e.News=8]="News",e[e.AppleOne=9]="AppleOne"}(Bt||(Bt={}));const gs={[Bt.AppStore]:"ACCappstore",[Bt.Arcade]:"ACCarcade",[Bt.Books]:"ACCbooks",[Bt.Fitness]:"ACCfitness",[Bt.Music]:"ACCmusic",[Bt.News]:"ACCnews",[Bt.Podcasts]:"ACCpodcasts",[Bt.TV]:"ACCtv",[Bt.AppleOne]:"ACCone"};Ft=e(1542),function(e){e.Internal="i",e.Store="s"}(qt||(qt={}));const ys=[{eventAllowlist:()=>"iOS"!==e.g.host.platform?(AMS.log.default("App clips disabled"),[]):(AMS.log.default("App clips enabled"),[{filter:{source:"AMSClipMediaTask"},allowsResponse:!0},{filter:{eventType:"SubscriptionChanged"},allowsResponse:!1}]),respond:async e=>{const t=e.events[0];if("url"in t){let e=Le(t.url),n=function(e){var t,n,i,r;let s;return null!==(n=null===(t=e.path)||void 0===t?void 0:t.length)&&void 0!==n&&n&&(s=null!==(r=null===(i=e.path)||void 0===i?void 0:i.charAt(1))&&void 0!==r?r:void 0),s&&Object.values(qt).includes(s)?s:(AMS.log.error("Invalid code type: "+s),null)}(e);AMS.log.default(`Received AppClip URL: ${t.url} type: ${n}`);let i=null;switch(n){case qt.Store:i=await Ge(e);break;case qt.Internal:i=await async function(e){return AMS.log.error("Code type denied"),null}()}return i?{data:i}:Promise.reject("Failed to locate app clip")}return"segment"in t?(AMS.log.default("Handling SubscriptionChanged event"),{actions:await Ye()}):{}},setup:async()=>{AMS.log.default("Setting up App Clip")}}];class ws{enqueue(e){return class{static async enqueue(e){var t,n,i,r;let s={};try{s=await Ke().enqueue(e)}catch(e){AMS.log.error("Limited provider failed: "+e)}let a={};try{let t=e.events;a=this.evaluate(t)}catch(e){AMS.log.error("Limited journey failed: "+e)}return{...a,data:{...null!==(t=s.data)&&void 0!==t?t:{},...null!==(n=a.data)&&void 0!==n?n:{}},actions:(null!==(i=s.actions)&&void 0!==i?i:[]).concat(null!==(r=a.actions)&&void 0!==r?r:[])}}static isString(e){return"string"==typeof e}static evaluate(e){let t={actions:[],data:{}};const n=fs.buildStub();for(let i=0;i<e.length;i++){let r=e[i],s=this.evaluateParserEvent(r);t.data={...t.data,item:s},this.evaluateJourneys(r,n,t)}return t}static evaluateJourneys(e,t,n){if(0==Object.keys(e).length)return;if(!t)return void ms.logError("ERROR: No server response");let i=t.journeys;for(let t=0;t<i.length;t++){let r=i[t];if(!r.steps||!r.steps.length){ms.logError("ERROR: No steps found on journey. Skipping journey: "+r.id);continue}if(!r.id){ms.logError("ERROR: No journey id");continue}let s,a=ms.databaseFetch(r.id);a||(a={currentStepId:void 0});let o=0;if(a.currentStepId)for(let e=0;e<r.steps.length;e++){let t=r.steps[e];if(t&&t.id==a.currentStepId){o=e,s=t;break}}if(!s&&a.currentStepId&&(ms.logDefault("Journey ("+r.id+") step not found: "+a.currentStepId),ms.databaseStore(r.id,null),a.currentStepId=void 0),a.currentStepId||(s=r.steps[0],o=0),!s||!s.id){ms.logError("ERROR: Steps missing id from journey: "+r.id);continue}a.currentStepId=s.id;let u=s.resetCreteria;if(u&&this.match(e,u)){ms.databaseStore(r.id,null);continue}let c=s.translate;if(c){let t=!1,i=c.criteria;i&&(t=this.match(e,i));let r=c.toEvent;if(t&&r&&n.actions){n.actions.push(new Xr([r]));continue}}let l=this.matchANDGroup(e,s.andMatch);if(this.matchORGroup(e,s.orMatch)&&l){ms.logDefault("Step matched: "+r.id+s.id);const t=this.stepResult(s,e);t.data&&n.data&&(ms.logError("Overwriting enqueue data in result. "+r.id),n.data=t.data),n.cacheInfo=t.cacheInfo,n.engagementRequest=t.engagementRequest,t.actions&&(n.actions=n.actions.concat(t.actions));let i=o>=r.steps.length-1;i&&ms.logDefault("Journey completed: "+r.id),r.loop&&i?(ms.logDefault("Resetting journey: "+r.id),ms.databaseStore(r.id,null)):i||(a.currentStepId=r.steps[o+1].id,ms.databaseStore(r.id,a))}}}static evaluateParserEvent(e){let t=e.kind,n=e.items;if("AMSMarketingItemParser"==t&&Array.isArray(n)&&0!=n.length)return n[0]}static match(e,t){if(null==t)return!0;const n=t;if(null!=n.matches)return n.matches(e);if(0==Object.keys(t).length)return!1;let i=!0,r=Object.keys(t);for(let n=0;n<r.length;n++){let s=r[n],a=t[s],o=this.resolve(e,s);if(void 0===a){i=!1;break}let u=!1,c=null;if(o&&(c=this.parse(o)),this.isString(a)&&a.startsWith("!")&&c!=a.substring(1,a.length)&&(u=!0),(this.isString(a)&&a.startsWith(">")&&c>a.substring(1,a.length)||this.isString(a)&&a.startsWith("<")&&c<a.substring(1,a.length)||this.isString(a)&&this.isString(c)&&a.startsWith("~")&&c.toLowerCase().includes(a.toLowerCase().substring(1,a.length))||this.isString(a)&&this.isString(c)&&a.startsWith("*")&&c.match(new RegExp(a.substring(1,a.length))).length>0||c==a)&&(u=!0),!u){i=!1;break}}return i}static matchANDGroup(e,t){if(!t||0==t.length)return!0;let n=!0;for(let i=0;i<t.length;i++){let r=t[i];if(n=this.match(e,r),!n)break}return n}static matchORGroup(e,t){if(!t||0==t.length)return!0;let n=!1;for(let i=0;i<t.length;i++){let r=t[i];if(n=this.match(e,r),n)break}return n}static parse(e){let t=e;if("string"==typeof e&&e.startsWith("%")&&e.endsWith("%")){let n=e.substring(1,e.length-1).split(":");if(n.length>=2){let e=n[0],i=n[1],r=null;ms.pluginRequest(e,i),r="undefined"==typeof AMS?plugin.requestSync(e,i):AMS.plugin.requestSync(e,i),r&&(t=r)}}return t}static resolve(e,t){let n=null,i=t.split("."),r=e;for(let e=0;e<i.length&&r&&"object"==typeof r;e++)r=r[i[e]],e==i.length-1&&(n=r);return n}static stepResult(e,t){var n,i,r,s,a;ms.logDefault("Func: "+d(e));let o=null===(n=e.stepResult)||void 0===n?void 0:n.call(e,t);return{actions:null!==(i=null==o?void 0:o.actions)&&void 0!==i?i:e.actions,cacheInfo:null!==(r=null==o?void 0:o.cacheInfo)&&void 0!==r?r:e.cacheInfo,data:null!==(s=null==o?void 0:o.data)&&void 0!==s?s:e.data,engagementRequest:null!==(a=null==o?void 0:o.engagementRequest)&&void 0!==a?a:e.engagementRequest}}}.enqueue(e)}sync(t){return class{static async sync(t){var n,i,r;$e(xt.Language,Ot.String),$e(xt.LanguageTag,Ot.String),async function(){We("Caching all subscription entitlements");const e=AMS.database.create().result;if(void 0!==e){for(const t in kt.SubscriptionMediaType){if(isNaN(Number(t)))continue;const n={type:Number(t)};try{Fe(n,await qe(n,!1),e)}catch(e){Ve(`Failed to fetch subscription with type ${t}`)}}We("Finished caching all subscriptions")}else Ve("Failed to access DB to cache subscription")}();let s={whitelistedEvents:[],allowedEvents:[]};try{s=await Ke().sync(t)}catch(e){AMS.log.error("Limited provider failed: "+e)}let a={whitelistedEvents:[],allowedEvents:[]};try{let e=await fs.fetch();ms.databaseStore(Ut.ServerResult,e),a=this.createSyncResult(e)}catch(e){throw Error("The journeys request failed with reason: "+e)}return r=[],"iOS"===e.g.host.platform&&(r=await Ye()),{allowedEvents:s.allowedEvents.concat(a.allowedEvents),whitelistedEvents:s.whitelistedEvents.concat(a.whitelistedEvents),actions:(null!==(n=s.actions)&&void 0!==n?n:[]).concat(null!==(i=a.actions)&&void 0!==i?i:[]).concat(r)}}static createSyncResult(e){return{allowedEvents:e.whitelistedEvents,whitelistedEvents:e.whitelistedEvents}}}.sync(t)}}class bs{constructor(){this.plugins=[],this.pluginsById=new Map,this.pluginsByBundle=new Map,this.pluginsBySubSegment=new Map,this.pluginsByMediaType=new Map}registerPlugin(e){const{storefrontId:t}=nativeApi.user();if(!e.storefronts||e.storefronts.includes(t)){this.plugins.push(e),this.pluginsById.set(e.pluginId,e);for(const t of e.getSupportedBundles())this.pluginsByBundle.set(t,e),this.pluginsByBundle.set(t,e);null!=e.subscriptionSegment&&this.pluginsBySubSegment.set(e.subscriptionSegment,e),null!=e.subscriptionMediaType&&this.pluginsByMediaType.set(e.subscriptionMediaType,e)}else nativeApi.log(`Plugin ${e.name} is disabled for storefront ${t}.`)}initialisePlugins(){let e=[];for(const t of this.plugins)e.push(t.initialize());return Promise.all(e).then(null)}getSupportedBundleIds(){return new Set(this.plugins.map((e=>e.appBundleId)))}getPlugins(){return[...this.plugins]}getPluginForBundle(e){return this.pluginsByBundle.get(e)}mapPluginId(e){return this.pluginsById.get(e)}mapSubscriptionSegment(e){return this.pluginsBySubSegment.get(e)}injectUserAttributes(e){this.plugins.map((t=>t.injectUserAttributes(e)))}onEvents(e){for(const t of e){let e=this.getPluginForBundle(t.bundleId);e&&e.onEvent(t)}}}const As="com.apple.fitcored",Ss="com.apple.Fitness",Ts="com.apple.seymour.SeymourEngagementPlugin";!function(e){e[e.NeedsAcknowledgement=0]="NeedsAcknowledgement",e[e.OptedIn=1]="OptedIn",e[e.OptedOut=2]="OptedOut"}(Wt||(Wt={}));class Cs extends Qi{constructor(){super(...arguments),this.namespace="fitness",this.appBundleId=Ss,this.name="FitnessPlugin",this.pluginBundleId=As,this.pluginId=Ts,this.subscriptionMediaType=Qe.SubscriptionMediaType.activity,this.subscriptionSegment=Xe.Fitness,this.notificationClientId=At.UserNotificationClientId.fitness,this.appInstalled=null,this.recordedEvents=new Set([Tn,Cn]),this.allowedEvents=[{app:Ss,eventType:"page"},{app:As,eventType:"page"},{eventType:"seymour:workout-completed"},{app:Ss,eventType:yn},{app:Ss,eventType:wn},{app:Ss,eventType:"click",targetType:"banner"},{app:As,eventType:"click",targetType:"banner"},{app:As,eventType:"enter"},{app:Ss,eventType:"enter"},{app:Ss,topic:"xp_ops_activity_wpaf",eventType:"playActivity",consentType:"improve"}]}analyticsOptedIn(){return this.getPrivacyPrefState()==Wt.OptedIn}getAllowedEvents(){return this.allowedEvents}getUpliftEvents(){return[{eventType:"enter"},{eventType:"play"}]}onEvent(e){e.bundleId==As&&(e.bundleId=Ss),"playActivity"===e.eventType&&!e.subscriptionIsSpecialAccess&&e.position>0&&null!==e.startPosition&&e.position-e.startPosition>3e4&&(e.eventType="play"),super.onEvent(e)}initialize(){return wi.defineFunction({funcName:"nextWorkoutInProgram",handler:(...e)=>this.nextWorkoutInProgram(...e)}),wi.defineFunction({funcName:"seymourWorkoutHistory",handler:(...e)=>this.getSeymourWorkoutHistory(...e)}),wi.defineFunction({funcName:"seymourWorkoutCount",handler:(...e)=>this.getSeymourWorkoutCount(...e)}),wi.defineFunction({funcName:"getSeymourWorkout",handler:W(this.getWorkoutRemoteHandler())}),wi.defineFunction({funcName:"getSeymourProgram",handler:W(this.getProgramRemoteHandler())}),wi.defineFunction({funcName:"seymourDailyWorkouts",handler:(e,t)=>{const n=t[0],i=this.callFitnessPluginSync(Ts,`querySeymourWorkoutHistory-${n}`,{command:"querySeymourWorkoutHistory",options:`state=completed,days=${n}`}),r=Date.now(),s=l(i.sessions.map((e=>({...e,daysAgo:Zt()(r).diff(e.dateSince1970,"day")}))),"daysAgo"),a=[];for(let e=n-1;e>=0;e--){const t=(s.has(e)?Array.from(s.get(e)):[]).reduce((({totalDuration:e,totalCount:t},n)=>({totalDuration:e+n.duration,totalCount:t+1})),{totalDuration:0,totalCount:0});a.push(t)}return a}}),wi.defineFunction({funcName:"seymourFavoriteModalities",handler:(e,t)=>{const n=t[0],i=this.callFitnessPluginSync(Ts,`querySeymourWorkoutHistory-${n}`,{command:"querySeymourWorkoutHistory",options:`state=completed,days=${n}`}),r=l(i.workoutReferenceMap.map((([e,t])=>({key:e,modalityIdentifier:t.modalityIdentifier}))),"modalityIdentifier"),s=new Map;for(const e of i.sessions)s.set(e.workoutIdentifier,e);const a=[...r.entries()].map((([e,t])=>[...t].reduce(((e,t)=>{const n=s.get(t.key);return n?{...e,totalDuration:e.totalDuration+n.duration,totalCount:e.totalCount+1}:e}),{modalityIdentifier:e,totalDuration:0,totalCount:0}))),o=[...a].sort(((e,t)=>t.totalCount-e.totalCount));return[...a].sort(((e,t)=>t.totalDuration-e.totalDuration)).map(((e,t)=>({...e,totalCountRank:o.indexOf(e)+1,totalDurationRank:t+1})))}}),Promise.resolve(void 0)}isAppInstalled(){if(null===this.appInstalled){let e=nativeApi.pluginFetchSync(Ts,{"native-request":{command:"queryFitnessAppInstalled"}});e.result&&n(e.result["native-response"])?this.appInstalled=Boolean(e.result["native-response"].appInstalled):this.appInstalled=!1}return nativeApi.log(`fitness is ${this.appInstalled?"":"not "}installed`),Boolean(this.appInstalled)}customizeNotificationPayload(e,t){var n;let i=null!==(n=t.subsections)&&void 0!==n?n:[];e.category?i.push(e.category):host.isOSAtLeast(14,5,0)&&i.push("com.apple.FitnessPlus.notification.newFeaturesTopic"),t.subsections=i}injectUserAttributes(e){super.injectUserAttributes(e),c(e,"subscriptions",{[this.namespace]:T({getPromiseId:()=>"com.apple.Fitness.sub",call:async()=>(await de(Ss,Qe.SubscriptionMediaType.activity),he(nativeApi.user(),Qe.SubscriptionMediaType.activity))})})}getPrivacyPrefState(){for(let e=0;e<3;e++)try{let e=this.callFitnessPluginSync(Ts,"queryOptInPrivacyPreference",{command:"queryOptInPrivacyPreference"});return(null==e?void 0:e.state)||Wt.NeedsAcknowledgement}catch(e){nativeApi.logError("Failed to fetch the privacy preference")}return Wt.NeedsAcknowledgement}nextWorkoutInProgram(e,t){let n=t[0];return this.callFitnessPluginSync(Ts,`queryNextWorkoutInProgram-${n}`,{command:"queryNextWorkoutInProgram",programIdentifier:`${n}`}).workoutIdentifier}getSeymourWorkoutHistory(e,t){let n=t[0],i=this.callFitnessPluginSync(Ts,`querySeymourWorkoutHistory-${n}`,{command:"querySeymourWorkoutHistory",options:`state=completed,days=${n}`}),r=[],s=new Map(i.workoutReferenceMap);for(const e of i.sessions){let t=s.get(e.workoutIdentifier);t&&r.push({...e,...t,sessionDuration:e.duration,startDate:e.dateSince1970})}return r}getSeymourWorkoutCount(e,t){let n=t[0];return this.callFitnessPluginSync(Ts,`querySeymourWorkoutCount-${n}`,{command:"querySeymourWorkoutCount",options:`state=completed,days=${n}`}).count}getWorkoutRemoteHandler(){return{getRequestId:(e,t)=>`fitness.workout:${t[0]}`,enqueueRequest(e,t){ue(Ts,e,{command:"fetchRemoteCatalogWorkout",workoutIdentifier:t[0]})}}}getProgramRemoteHandler(){return{getRequestId:(e,t)=>`fitness.program:${t[0]}`,enqueueRequest(e,t){ue(Ts,e,{command:"fetchRemoteCatalogProgram",programIdentifier:t[0]})}}}callFitnessPluginSync(e,t,n,i=!0){let r=oe(e,t,n,i);if(en(r))throw new sn("PrivateDataUnavailable");return r}}const Es="articleOpenedPerChannel",Ms="appLaunch",ks="channelVisited",Is="channelFollowed",Ds="tabVisited",Ps="audioDailyBriefingPlayed",_s="com.apple.news",$s="com.apple.news.engagementExtension";!function(e){e[e.Unknown=0]="Unknown",e[e.NotSubscribed=1]="NotSubscribed",e[e.Regular=2]="Regular",e[e.Personalized=3]="Personalized"}(Vt||(Vt={})),function(e){e[e.Unknown=0]="Unknown",e[e.Low=1]="Low",e[e.Medium=2]="Medium",e[e.High=3]="High"}(Ht||(Ht={})),function(e){e[e.Unknown=0]="Unknown",e[e.Eligible=1]="Eligible",e[e.NotEligible=2]="NotEligible"}(Jt||(Jt={})),function(e){e[e.Unknown=0]="Unknown",e[e.Setup=1]="Setup",e[e.NotSetup=2]="NotSetup"}(Gt||(Gt={}));class xs extends Qi{constructor(){super(...arguments),this.recordedEvents=new Set([Tn,Cn,Ms,Ds]),this.namespace="news",this.name="NewsPlugin",this.pluginId=$s,this.appBundleId=_s,this.pluginBundleId="com.apple.news",this.subscriptionMediaType=Qe.SubscriptionMediaType.news,this.subscriptionSegment=Xe.News,this.subscriptionAdamId=1449320349,this.notificationClientId=At.UserNotificationClientId.news}initialize(){return Promise.resolve()}getAllowedEvents(){return[{eventType:Ms,app:_s},{eventType:ks,app:_s},{eventType:Is,app:_s},{eventType:Es,app:_s},{eventType:Ds,app:_s},{eventType:Ps,app:_s}]}getUpliftEvents(){return[{eventType:Ds,attributes:["tabType"]},{eventType:Es},{eventType:Ms},{eventType:ks},{eventType:Ps},{eventType:Is,attributes:["channelType"]}]}isNotificationAllowed(e){let t=this.queryNewsAppEngagement().notificationCategoriesAllowlist;nativeApi.log(v`News allowed categories: ${t}`);const n=new Set(t);return null!=e.category&&n.has(e.category)}onEvent(e){this.recordedEvents.has(e.eventType)&&e.bundleId===_s&&re(e)}injectUserAttributes(e){super.injectUserAttributes(e),c(e,"subscriptions",{[this.namespace]:T({getPromiseId:()=>"com.apple.news.sub",call:async()=>(await de(_s,Qe.SubscriptionMediaType.news),he(nativeApi.user(),Qe.SubscriptionMediaType.news))})}),c(e,this.namespace,{newsletterSubscriptionStatus:()=>{var e;const t=this.queryNewsAppEngagement();return null!==(e=null==t?void 0:t.newsletterSubscriptionStatus)&&void 0!==e?e:Vt.Unknown},firstAppLaunch:()=>{const e=this.queryNewsAppEngagement();return(null==e?void 0:e.firstAppLaunchDateSince1970)?Zt()(Number(e.firstAppLaunchDateSince1970)).toDate():null},allowedNotificationsCategories:()=>{const e=this.queryNewsAppEngagement();return null==e?void 0:e.notificationCategoriesAllowlist},userSegmentsSetIds:()=>{const e=this.queryNewsAppEngagement();return null==e?void 0:e.userSegmentsSetIds},lastMagazineOpenDate:()=>{const e=this.queryNewsPlusEngagement();return(null==e?void 0:e.lastMagazineOpenDateSince1970)?Zt()(Number(e.lastMagazineOpenDateSince1970)).toDate():null},followedChannels:()=>{const e=this.queryNewsPlusEngagement();return null==e?void 0:e.followedNewsPlusChannelIdentifiers},followedNewsPlusChannels:()=>{const e=this.queryNewsPlusEngagement();return null==e?void 0:e.followedNewsPlusChannelIdentifiers},churnPropensity:()=>{const e=this.queryNewsPlusEngagement();return null==e?void 0:e.churnPropensityLevel},trialEligibilityStatus:()=>{const e=this.queryNewsPlusEngagement();return null==e?void 0:e.trialEligibilityStatus},familySharingSetupStatus:()=>{const e=this.queryNewsPlusEngagement();return null==e?void 0:e.familySharingSetupStatus},isFamilySharingEligible:()=>{const e=this.queryNewsPlusEngagement();return null==e?void 0:e.isFamilySharingEligible},isFamilySharingOrganizer:()=>{const e=this.queryNewsPlusEngagement();return null==e?void 0:e.isFamilySharingOrganizer},localNewsRegions:()=>{const e=this.queryLocalNewsEngagement();return null==e?void 0:e.localNewsRegions},followedLocalChannels:()=>{const e=this.queryLocalNewsEngagement();return null==e?void 0:e.followedLocalNewsChannelIdentifiers},lastAudioPlayedDate:()=>{const e=this.queryNewsPlusAudioEngagement();return(null==e?void 0:e.lastAudioPlayedDateSince1970)?Zt()(Number(e.lastAudioPlayedDateSince1970)).toDate():null},lastDailyBriefingPlayedDate:()=>{const e=this.queryNewsPlusAudioEngagement();return(null==e?void 0:e.lastDailyBriefingPlayedDateSince1970)?Zt()(Number(e.lastDailyBriefingPlayedDateSince1970)).toDate():null}})}queryNewsAppEngagement(){return oe($s,"queryNewsAppEngagement",{command:"queryNewsAppEngagement"},!1)}queryNewsPlusEngagement(){return oe($s,"queryNewsPlusEngagement",{command:"queryNewsPlusEngagement"},!1)}queryLocalNewsEngagement(){return oe($s,"queryLocalNewsEngagement",{command:"queryLocalNewsEngagement"},!1)}queryNewsPlusAudioEngagement(){return oe($s,"queryNewsPlusAudioEngagement",{command:"queryNewsPlusAudioEngagement"},!1)}}const Os="com.apple.mobileslideshow";class Ns extends Qi{constructor(){super(...arguments),this.namespace="photos",this.name="PhotosPlugin",this.pluginId="n/a",this.appBundleId=Os,this.pluginBundleId="n/a",this.subscriptionMediaType=void 0,this.subscriptionSegment=void 0,this.notificationClientId=At.UserNotificationClientId.appstore,this.recordedEvents=new Set([Tn,Cn])}onEvent(e){this.recordedEvents.has(e.eventType)&&e.bundleId===Os&&re(e)}}const Rs="com.apple.Home";class js extends Qi{constructor(){super(...arguments),this.namespace="home",this.name="HomePlugin",this.pluginId="n/a",this.appBundleId=Rs,this.pluginBundleId="n/a",this.subscriptionMediaType=void 0,this.subscriptionSegment=void 0,this.notificationClientId=At.UserNotificationClientId.appstore,this.recordedEvents=new Set([Tn,Cn])}}const Us="com.apple.iCloudQuotaUI",Ls="com.apple.iCloudQuotaUI.ICQEngagementExtension",Bs=1024**3,Fs="iCloudQuota:storage-level-changed";class qs extends Qi{constructor(){super(...arguments),this.namespace="icloud",this.name="iCloudPlugin",this.pluginId=Ls,this.appBundleId=Us,this.pluginBundleId="com.apple.iCloudQuotaUI",this.subscriptionMediaType=Qe.SubscriptionMediaType.icloud,this.subscriptionSegment=Xe.iCloud,this.notificationClientId=At.UserNotificationClientId.appstore}initialize(){return Promise.resolve()}getAllowedEvents(){return[{eventType:Fs},{eventType:"iCloudQuota:impression",bundleId:"com.apple.iCloudQuotaUI"}]}onEvent(e){e.bundleId===this.appBundleId&&function(e){return e.eventType===Fs}(e)&&(e.oldiCloudStoragePlan=(e.oldiCloudStoragePlan||0)/Bs,e.newiCloudStoragePlan=(e.newiCloudStoragePlan||0)/Bs,e.oldAppleOneStoragePlan=(e.oldAppleOneStoragePlan||0)/Bs,e.newAppleOneStoragePlan=(e.newAppleOneStoragePlan||0)/Bs,nativeApi.enqueueActions({actionClass:"EnqueueAction",events:[{...e,bundleId:Os},{...e,bundleId:Rs}]}))}injectUserAttributes(e){super.injectUserAttributes(e),c(e,"subscriptions",{[this.namespace]:T({getPromiseId:()=>`${Us}.sub`,call:async()=>(await de(Us,Qe.SubscriptionMediaType.icloud),he(nativeApi.user(),Qe.SubscriptionMediaType.icloud))})}),c(e,this.namespace,{storageLevel:()=>this.queryStorageLevel()}),c(e,"home",{cameraCount:()=>this.queryCameraCount().cameraCount})}queryCameraCount(){return oe(Ls,"fetchCameraCount",{command:"fetchCameraCount"},!1)}queryStorageLevel(){const e=oe(Ls,"fetchStorageLevel",{command:"fetchStorageLevel"},!1);return{icloudOriginalStorageLevel:Math.floor((e.icloudOriginalStorageLevel||0)/Bs),appleOneOriginalStorageLevel:Math.floor((e.appleOneOriginalStorageLevel||0)/Bs),icloudCurrentStorageLevel:Math.floor((e.icloudCurrentStorageLevel||0)/Bs),appleOneCurrentStorageLevel:Math.floor((e.appleOneCurrentStorageLevel||0)/Bs)}}}class Ws{constructor(){this.currentRegion="",this.deviceLanguage="",this.isApplePayActive=!1,this.isApplePaySetupAvailable=!1,this.isPrimaryAppleAccountVerified=!1,this.isDeviceRegisteredWithBroker=!1,this.hasPaymentCard=!1,this.hasApplePayTransaction=!1,this.daysSinceLastTransaction=-1,this.daysSinceOldestPaymentPassIngestDate=-1,this.defaultCreditAccountSetupFeatureState=-1,this.hasDefaultCreditAccount=!1,this.defaultCreditAccountState=-1,this.defaultCreditAccountLifetimeRewards=-1,this.defaultCreditAccountHasPhysicalCard=!1,this.defaultCreditAccountHasVirtualCard=!1,this.defaultCreditAccountHasDynamicSecurityCode=!1,this.defaultCreditAccountRequiresDebtCollectionNotices=!1,this.defaultCreditAccountBalanceStatus=-1,this.defaultCreditAccountCyclesPastDue=-1,this.defaultCreditAccountInGrace=!1,this.defaultCreditAccountInDisasterRecovery=!1,this.defaultCreditAccountHasDisputeOpen=!1,this.defaultCreditAccountDaysSinceDisputeOpened=-1,this.defaultCreditAccountAvailableCredit=-1,this.defaultCreditAccountSupportsShowNotifications=!1,this.defaultCreditAccountPassIsDefault=!1,this.defaultCreditAccountDaysSinceLastTransaction=-1,this.defaultCreditAccountHasInStoreTransaction=!1,this.defaultCreditAccountHasInAppTransaction=!1,this.defaultCreditAccountHasWebTransaction=!1,this.defaultCreditAccountHasVirtualCardTransaction=!1,this.defaultCreditAccountHasPhysicalCardTransaction=!1,this.defaultCreditAccountDaysSinceCreatedDate=-1,this.defaultCreditAccountHasActiveInstallment=!1,this.defaultCreditAccountHasUsedInstallments=!1,this.hasPaymentTransaction=!1,this.hasTransitTransaction=!1,this.defaultCreditApplicationCount=-1,this.currentDefaultCreditApplictionDaysSinceLastUpdated=-1,this.currentDefaultCreditApplicationState="",this.defaultCreditAccountIsShared=!1,this.defaultCreditAccountAccessLevel=-1,this.defaultCreditAccountIsCoOwner=!1,this.defaultCreditAccountParticipantUsersCount=-1,this.defaultCreditAccountHasUnderageParticipant=!1,this.defaultCreditAccountPhysicalAppleCardStatus="",this.daysSincePhysicalAppleCardShipmentUpdate=-1,this.anyCreditAccountStateIsClosed=!1,this.anyCreditAccountStateIsRemoved=!1,this.passStyles=[],this.unexpiredPassStyles=[],this.secureElementCardTypes=[],this.unexpiredSecureElementCardTypes=[],this.transitNetworksPresent=[],this.transitNetworksPresentAndUnexpired=[],this.hasPeerPaymentAccount=!1,this.hasPeerPaymentPassProvisioned=!1,this.peerPaymentAccountState=-1,this.peerPaymentAccountStage=-1,this.peerPaymentAccountHasTransaction=!1,this.daysSinceLastPeerPaymentTransaction=-1,this.peerPaymentAccountHasBalance=!1,this.peerPaymentAccountBalanceBase=-1,this.peerPaymentAccountDaysSinceCreatedDate=-1,this.peerPaymentAccountDaysSinceIdentifiedDate=-1,this.daysSinceParticipantPeerPaymentAccountIdentifiedDate=-1,this.peerPaymentAccountHasSentMoneyToAnyParticipant=!1,this.peerPaymentAccountRole=-1,this.peerPaymentFamilyParticipantAccounts=-1,this.familyCircleFamilyOrganizer=!1,this.familyCircleParent=!1,this.familyCircleHasFamily=!1,this.familyCircleCurrentUserAge=-1,this.familyCircleMembersUnderAge=-1,this.familyCircleMembersCount=-1,this.familyCircleDaysSinceNewestJoinedDate=-1,this.familyCircleMinimumMemberAge=-1,this.discoveryItemsWithActiveStatus=[],this.discoveryItemsWithActionedStatus=[],this.discoveryItemsWithDismissedStatus=[],this.discoveryItemsWithWaitingForTriggerStatus=[],this.discoveryItemsExpanded=[],this.discoveryItemsDismissed=[],this.discoveryCTAsTapped=[],this.discoveryCTAsCompleted=[],this.sentTransitDCINotifications=[],this.sentTransitOpenLoopUpgradeNotifications=[],this.sentTransitOpenLoopRenotifiedInMarketNotifications=[],this.cardTypesWithExpressEnabled=[],this.supportedMarketsForCurrentLocation=[],this.supportedTransitMarketsForCurrentLocation=[],this.supportedTransitNetworksForCurrentLocation=[],this.expressTransitNetworksForCurrentLocation=[],this.hasTransitPassForCurrentLocation=!1,this.hasUnexpiredTransitPassForCurrentLocation=!1,this.currentPlacemark={}}}const Vs={"wallet:passesDisplayed":{},"wallet:frontOfPassDisplayed":{},"wallet:passAdded":{},"wallet:passRemoved":{},"wallet:locationChanged":{},"wallet:accountAdded":{},"wallet:accountUpdated":{},"wallet:accountRemoved":{},"wallet:peerPaymentAccountUpdated":{},"wallet:featureApplicationAdded":{},"wallet:featureApplicationRemoved":{},"wallet:featureApplicationUpdated":{},"wallet:DCINotificationForMarketAdded":{},"wallet:openLoopUpgradeNotificationForMarketAdded":{},"wallet:renotifyNotificationForMaketAdded":{},"wallet:transactionsUpdated":{},"wallet:familyCircleChanged":{},"wallet:currentLocaleChanged":{},"wallet:applePayContextChanged":{},"wallet:expressPassInfoChanged":{},"wallet:dayChanged":{}},Hs="com.apple.passd",Js="com.apple.Passbook";class Gs extends Qi{constructor(){super(...arguments),this.namespace="wallet",this.appBundleId=Js,this.name="WalletPlugin",this.pluginBundleId=Hs,this.pluginId="com.apple.PassKit.EngagementExtension",this.appInstalled=null,this.subscriptionMediaType=void 0,this.subscriptionSegment=void 0,this.notificationClientId=gt.UserNotificationClientId.wallet,this.eventTypes=[...Object.keys(Vs)],this.recordedEvents=new Set([Tn,Cn])}getAllowedEvents(){return this.eventTypes.map((e=>({eventType:e})))}onEvent(e){e.bundleId==Hs&&(e.bundleId=Js),super.onEvent(e)}initialize(){return wi.defineFunction({funcName:"walletHasValue",handler:(e,t)=>{const n=t[0],i=t[1];return Boolean(this.fetchProperty(n,i))}}),Promise.resolve(void 0)}injectUserAttributes(e){const t=ce({currentRegion:()=>this.fetchProperty("currentRegion"),deviceLanguage:()=>this.fetchProperty("deviceLanguage"),isApplePayActive:()=>Boolean(this.fetchProperty("isApplePayActive")),isApplePaySetupAvailable:()=>Boolean(this.fetchProperty("isApplePaySetupAvailable")),isPrimaryAppleAccountVerified:()=>Boolean(this.fetchProperty("isPrimaryAppleAccountVerified")),isDeviceRegisteredWithBroker:()=>Boolean(this.fetchProperty("isDeviceRegisteredWithBroker")),hasPaymentCard:()=>Boolean(this.fetchProperty("hasPaymentCard")),hasApplePayTransaction:()=>Boolean(this.fetchProperty("hasApplePayTransaction")),daysSinceLastTransaction:()=>this.fetchProperty("daysSinceLastTransaction"),daysSinceOldestPaymentPassIngestDate:()=>this.fetchProperty("daysSinceOldestPaymentPassIngestDate"),defaultCreditAccountSetupFeatureState:()=>this.fetchProperty("defaultCreditAccountSetupFeatureState"),hasDefaultCreditAccount:()=>Boolean(this.fetchProperty("hasDefaultCreditAccount")),defaultCreditAccountState:()=>this.fetchProperty("defaultCreditAccountState"),defaultCreditAccountLifetimeRewards:()=>this.fetchProperty("defaultCreditAccountLifetimeRewards"),defaultCreditAccountHasPhysicalCard:()=>Boolean(this.fetchProperty("defaultCreditAccountHasPhysicalCard")),defaultCreditAccountHasVirtualCard:()=>Boolean(this.fetchProperty("defaultCreditAccountHasVirtualCard")),defaultCreditAccountHasDynamicSecurityCode:()=>Boolean(this.fetchProperty("defaultCreditAccountHasDynamicSecurityCode")),defaultCreditAccountRequiresDebtCollectionNotices:()=>Boolean(this.fetchProperty("defaultCreditAccountRequiresDebtCollectionNotices")),defaultCreditAccountBalanceStatus:()=>this.fetchProperty("defaultCreditAccountBalanceStatus"),defaultCreditAccountCyclesPastDue:()=>this.fetchProperty("defaultCreditAccountCyclesPastDue"),defaultCreditAccountInGrace:()=>Boolean(this.fetchProperty("defaultCreditAccountInGrace")),defaultCreditAccountInDisasterRecovery:()=>Boolean(this.fetchProperty("defaultCreditAccountInDisasterRecovery")),defaultCreditAccountHasDisputeOpen:()=>Boolean(this.fetchProperty("defaultCreditAccountHasDisputeOpen")),defaultCreditAccountDaysSinceDisputeOpened:()=>this.fetchProperty("defaultCreditAccountDaysSinceDisputeOpened"),defaultCreditAccountAvailableCredit:()=>this.fetchProperty("defaultCreditAccountAvailableCredit"),defaultCreditAccountSupportsShowNotifications:()=>Boolean(this.fetchProperty("defaultCreditAccountSupportsShowNotifications")),defaultCreditAccountPassIsDefault:()=>Boolean(this.fetchProperty("defaultCreditAccountPassIsDefault")),defaultCreditAccountDaysSinceLastTransaction:()=>Number(this.fetchProperty("defaultCreditAccountDaysSinceLastTransaction")),defaultCreditAccountHasInStoreTransaction:()=>Boolean(this.fetchProperty("defaultCreditAccountHasInStoreTransaction")),defaultCreditAccountHasInAppTransaction:()=>Boolean(this.fetchProperty("defaultCreditAccountHasInAppTransaction")),defaultCreditAccountHasWebTransaction:()=>Boolean(this.fetchProperty("defaultCreditAccountHasWebTransaction")),defaultCreditAccountHasVirtualCardTransaction:()=>Boolean(this.fetchProperty("defaultCreditAccountHasVirtualCardTransaction")),defaultCreditAccountHasPhysicalCardTransaction:()=>Boolean(this.fetchProperty("defaultCreditAccountHasPhysicalCardTransaction")),defaultCreditAccountDaysSinceCreatedDate:()=>this.fetchProperty("defaultCreditAccountDaysSinceCreatedDate"),defaultCreditAccountHasActiveInstallment:()=>Boolean(this.fetchProperty("defaultCreditAccountHasActiveInstallment")),defaultCreditAccountHasUsedInstallments:()=>Boolean(this.fetchProperty("defaultCreditAccountHasUsedInstallments")),hasPaymentTransaction:()=>Boolean(this.fetchProperty("hasPaymentTransaction")),hasTransitTransaction:()=>Boolean(this.fetchProperty("hasTransitTransaction")),defaultCreditApplicationCount:()=>this.fetchProperty("defaultCreditApplicationCount"),currentDefaultCreditApplictionDaysSinceLastUpdated:()=>this.fetchProperty("currentDefaultCreditApplictionDaysSinceLastUpdated"),currentDefaultCreditApplicationState:()=>this.fetchProperty("currentDefaultCreditApplicationState"),defaultCreditAccountIsShared:()=>Boolean(this.fetchProperty("defaultCreditAccountIsShared")),defaultCreditAccountAccessLevel:()=>this.fetchProperty("defaultCreditAccountAccessLevel"),defaultCreditAccountIsCoOwner:()=>Boolean(this.fetchProperty("defaultCreditAccountIsCoOwner")),defaultCreditAccountParticipantUsersCount:()=>this.fetchProperty("defaultCreditAccountParticipantUsersCount"),defaultCreditAccountHasUnderageParticipant:()=>Boolean(this.fetchProperty("defaultCreditAccountHasUnderageParticipant")),defaultCreditAccountPhysicalAppleCardStatus:()=>this.fetchProperty("defaultCreditAccountPhysicalAppleCardStatus"),daysSincePhysicalAppleCardShipmentUpdate:()=>this.fetchProperty("daysSincePhysicalAppleCardShipmentUpdate"),anyCreditAccountStateIsClosed:()=>Boolean(this.fetchProperty("anyCreditAccountStateIsClosed")),anyCreditAccountStateIsRemoved:()=>Boolean(this.fetchProperty("anyCreditAccountStateIsRemoved")),passStyles:()=>this.fetchProperty("passStyles"),unexpiredPassStyles:()=>this.fetchProperty("unexpiredPassStyles"),secureElementCardTypes:()=>this.fetchProperty("secureElementCardTypes"),unexpiredSecureElementCardTypes:()=>this.fetchProperty("unexpiredSecureElementCardTypes"),transitNetworksPresent:()=>this.fetchProperty("transitNetworksPresent"),transitNetworksPresentAndUnexpired:()=>this.fetchProperty("transitNetworksPresentAndUnexpired"),hasPeerPaymentAccount:()=>Boolean(this.fetchProperty("hasPeerPaymentAccount")),hasPeerPaymentPassProvisioned:()=>Boolean(this.fetchProperty("hasPeerPaymentPassProvisioned")),peerPaymentAccountState:()=>this.fetchProperty("peerPaymentAccountState"),peerPaymentAccountStage:()=>this.fetchProperty("peerPaymentAccountStage"),peerPaymentAccountHasTransaction:()=>Boolean(this.fetchProperty("peerPaymentAccountHasTransaction")),daysSinceLastPeerPaymentTransaction:()=>Number(this.fetchProperty("daysSinceLastPeerPaymentTransaction")),peerPaymentAccountHasBalance:()=>Boolean(this.fetchProperty("peerPaymentAccountHasBalance")),peerPaymentAccountBalanceBase:()=>this.fetchProperty("peerPaymentAccountBalanceBase"),peerPaymentAccountDaysSinceCreatedDate:()=>this.fetchProperty("peerPaymentAccountDaysSinceCreatedDate"),peerPaymentAccountDaysSinceIdentifiedDate:()=>this.fetchProperty("peerPaymentAccountDaysSinceIdentifiedDate"),daysSinceParticipantPeerPaymentAccountIdentifiedDate:()=>this.fetchProperty("daysSinceParticipantPeerPaymentAccountIdentifiedDate"),peerPaymentAccountHasSentMoneyToAnyParticipant:()=>Boolean(this.fetchProperty("peerPaymentAccountHasSentMoneyToAnyParticipant")),peerPaymentAccountRole:()=>this.fetchProperty("peerPaymentAccountRole"),peerPaymentFamilyParticipantAccounts:()=>this.fetchProperty("peerPaymentFamilyParticipantAccounts"),familyCircleFamilyOrganizer:()=>Boolean(this.fetchProperty("familyCircleFamilyOrganizer")),familyCircleParent:()=>Boolean(this.fetchProperty("familyCircleParent")),familyCircleHasFamily:()=>Boolean(this.fetchProperty("familyCircleHasFamily")),familyCircleCurrentUserAge:()=>this.fetchProperty("familyCircleCurrentUserAge"),familyCircleMembersUnderAge:()=>this.fetchProperty("familyCircleMembersUnderAge"),familyCircleMembersCount:()=>this.fetchProperty("familyCircleMembersCount"),familyCircleDaysSinceNewestJoinedDate:()=>this.fetchProperty("familyCircleDaysSinceNewestJoinedDate"),familyCircleMinimumMemberAge:()=>this.fetchProperty("familyCircleMinimumMemberAge"),discoveryItemsWithActiveStatus:()=>this.fetchProperty("discoveryItemsWithActiveStatus"),discoveryItemsWithActionedStatus:()=>this.fetchProperty("discoveryItemsWithActionedStatus"),discoveryItemsWithDismissedStatus:()=>this.fetchProperty("discoveryItemsWithDismissedStatus"),discoveryItemsWithWaitingForTriggerStatus:()=>this.fetchProperty("discoveryItemsWithWaitingForTriggerStatus"),discoveryItemsExpanded:()=>this.fetchProperty("discoveryItemsExpanded"),discoveryItemsDismissed:()=>this.fetchProperty("discoveryItemsDismissed"),discoveryCTAsTapped:()=>this.fetchProperty("discoveryCTAsTapped"),discoveryCTAsCompleted:()=>this.fetchProperty("discoveryCTAsCompleted"),sentTransitDCINotifications:()=>this.fetchProperty("sentTransitDCINotifications"),sentTransitOpenLoopUpgradeNotifications:()=>this.fetchProperty("sentTransitOpenLoopUpgradeNotifications"),sentTransitOpenLoopRenotifiedInMarketNotifications:()=>this.fetchProperty("sentTransitOpenLoopRenotifiedInMarketNotifications"),cardTypesWithExpressEnabled:()=>this.fetchProperty("cardTypesWithExpressEnabled"),supportedMarketsForCurrentLocation:()=>this.fetchProperty("supportedMarketsForCurrentLocation"),supportedTransitMarketsForCurrentLocation:()=>this.fetchProperty("supportedTransitMarketsForCurrentLocation"),supportedTransitNetworksForCurrentLocation:()=>this.fetchProperty("supportedTransitNetworksForCurrentLocation"),expressTransitNetworksForCurrentLocation:()=>this.fetchProperty("expressTransitNetworksForCurrentLocation"),hasTransitPassForCurrentLocation:()=>Boolean(this.fetchProperty("hasTransitPassForCurrentLocation")),hasUnexpiredTransitPassForCurrentLocation:()=>Boolean(this.fetchProperty("hasUnexpiredTransitPassForCurrentLocation")),currentPlacemark:()=>this.fetchProperty("currentPlacemark")},new Ws,this.pluginId);c(e,this.namespace,t)}handlePluginResult(e,t){if(n(e)&&void 0!==e[t])return e[t];throw new Zi}fetchProperty(e,t){const n=oe(this.pluginId,`fetchProperty/${e}`,{command:"fetchProperty",propertyName:e,parameter:t},!1);return this.handlePluginResult(n,e)}}const Ys={account:{},activeDownloadButtonsDidChange:{},applicationDidFinishLoading:{},click:{},deviceDiscoveryDidComplete:{},devicePresence:{},dialog:{},downloadDidStart:{},enter:{},exit:{},gdprStateDidChange:{},hasFavoriteTeamsDidChange:{},impressions:{},libraryContentsDidChange:{},locationStatusDidChange:{},media:{},notificationStatusDidChange:{},page:{},playbackDidEnd:{},playbackDidEndForTCC:{},search:{},TVAppEvent:{}};!function(e){e.Browse="Browse",e.Channel="Channel",e.Canvas="Canvas",e.Picker="Picker",e.Genre="Genre",e.GDPR="GDPR",e.HowToWatch="HowToWatch",e.Movie="Movie",e.Offer="Offer",e.Person="Artist",e.Room="Room",e.Recommendations="Recommendations",e.SearchIncremental="SearchIncremental",e.SearchLanding="SearchLanding",e.SearchTopResults="SearchTopResults",e.Siri="Siri",e.SportingEvent="SportingEvent",e.Teams="Teams",e.TVEpisode="TVEpisode",e.TVShow="TVShow",e.Versions="Versions",e.MovieBundle="MovieBundle",e.WatchNow="WatchNow",e.SeeAll="SeeAll"}(Yt||(Yt={})),function(e){e.Add="add",e.Buy="buy",e.Cancel="cancel",e.Close="close",e.Default="default",e.Dialog="dialog",e.GdprConsent="gdprConsent",e.Hint="hint",e.Navigate="navigate",e.Play="play",e.Remove="remove",e.Select="select",e.Subscribe="subscribe",e.SubUpgrade="upgradeSubscription",e.Versions="versions",e.Incremental="incremental",e.Share="share",e.None="none"}(zt||(zt={}));const zs="com.apple.tv";class Ks extends Qi{constructor(){super(...arguments),this.namespace="tv",this.name="TvPlugin",this.pluginId="n/a",this.appBundleId=zs,this.pluginBundleId=zs,this.subscriptionMediaType=Qe.SubscriptionMediaType.tv,this.subscriptionSegment=Xe.TV,this.notificationClientId=At.UserNotificationClientId.tv,this.eventTypes=[...Object.keys(Ys)],this.recordedEvents=new Set([Tn,Cn,"enter"])}getSupportedBundles(){return[zs]}getAllowedEvents(){return this.eventTypes.map((e=>({eventType:e,app:zs})))}onEvent(e){"TVAppEvent"===e.eventType&&(e.eventType=e.triggerType),super.onEvent(e)}}const Qs={appLaunch:{}},Zs="com.apple.podcasts";class Xs extends Qi{constructor(){super(...arguments),this.namespace="podcasts",this.name="PodcastsPlugin",this.pluginId="n/a",this.appBundleId=Zs,this.pluginBundleId="n/a",this.eventTypes=[...Object.keys(Qs)],this.subscriptionMediaType=void 0,this.subscriptionSegment=void 0,this.notificationClientId=At.UserNotificationClientId.podcasts,this.recordedEvents=new Set([Tn,Cn])}getAllowedEvents(){return this.eventTypes.map((e=>({eventType:e,app:Zs})))}}const ea=new class{constructor(e){this.buildInfo=e}async enqueue(e){let n,i;await this.initialise();try{nativeApi.log("Limited - Starting enqueue"),n=await(new ws).enqueue(e)}catch(e){nativeApi.logError(`Limited - Failed to enqueue: ${e}`)}try{nativeApi.log("Journeys - Starting enqueue"),i=await async function(e){if(!t())return nativeApi.log("Skipping enqueue as this platform is not supported"),Hr;nativeApi.log(v`Enqueue in progress ${e.events.map((e=>e.eventType))}: ${e}`);const n=nativeApi.user();if(!De(n))return nativeApi.log("Skipping enqueue as there's no active account"),Hr;n.userId&&(new Fi).addUser(n.userId);const i=e.events[0];if(function(e){return Boolean(e)&&"string"==typeof e.eventType&&"api"===e.eventType}(i)){const e=await async function(e){return{request:e,response:{ok:!1,error:"API is not supported in the production builds",code:Pt.is_production_build}}}(i);return{data:i.useLegacyResponse?(r=e,{json_string:`%!LEGACY_RESPONSE_START!%${JSON.stringify(r)}%!LEGACY_RESPONSE_END!%`}):e}}var r;let s=function(e){return(e.events||[]).filter((e=>!en(e.eventType))).map((t=>(t.bundleId=t.bundleId||t.app||("amstool"!==e.client.bundleId?e.client.bundleId:null),t)))}(e),a=new qr;try{return await a.processEvents(s),{actions:nativeApi.getActions().slice()}}catch(e){return nativeApi.log(String(e)),Promise.reject(e)}}(e)}catch(e){nativeApi.logError(v`Journeys - Failed to enqueue: ${e}`)}return nativeApi.log("Finished Enqueueing"),nativeApi.log(`journeys result ${d(i)}`),nativeApi.log(`limited result ${d(n)}`),this.combineEnqueue(i,n)}async sync(e){let n,i;await this.initialise();try{nativeApi.log("Limited - Starting limited"),n=await(new ws).sync(e)}catch(e){nativeApi.logError(`Limited - Failed to sync: ${e}`)}try{nativeApi.log("Journeys - Starting sync"),i=await async function(e){if(nativeApi.log(v`[Sync] Sync in progress, request: ${e}`),!t())return nativeApi.log(`[Sync] Disabled on this platform (${host.platform})`),Qr;const n=nativeApi.user();if(!De(n))return nativeApi.log(v`[Sync] Skipping sync as there's no active account, user: ${n}`),Qr;await nativeApi.metricsFlush(),(new Jr).runTasks(),(new zr).runDataMigrations(),await async function(){(await async function(){let e=[];ar.clear();for(const t of plugins.getPlugins()){let n=await le(t.appBundleId);null!==n&&e.push(n)}return e}()).forEach((e=>{nativeApi.logDebug(v`[Sync] Enqueueing sub change event for bundle ${e.bundleId} and change type ${e.eventType}`),nativeApi.enqueueActions({actionClass:rn,events:[e]})}))}(),await async function(){const e=await nativeApi.iCloudFamily(),t=await nativeApi.iTunesFamily(),n=new jr;n.cacheAttribute(Lr,e),n.cacheAttribute(Ur,t)}();const i=new Gr,r=Boolean(e.context&&e.context.isRescheduledAction);await i.sync(r),function(){var e;const t=new Qn;for(const n of plugins.getSupportedBundleIds())(null!==(e=t.readJourneyVersions(n))&&void 0!==e?e:[]).filter((e=>e.triggerType===st.ScheduledBased&&e.status===rt.Active)).forEach((e=>be(e)))}(),function(){const e=nativeApi.database(an);let t=null==e?void 0:e.fetch(Kr);nativeApi.logDebug(`oldOsBuild: ${t}`),t&&!t.includes(".")&&(t=u(t),nativeApi.logDebug(`remapped oldOsBuild: ${t}`));const n=nativeApi.device().osVersion,i=t?new ut.VersionNumber(t):null;if(nativeApi.logDebug(v`currentVersion: ${n}, oldVersion: ${i}`),!i||n.compareTo(i)>0)for(const e of plugins.getSupportedBundleIds())nativeApi.enqueueActions({actionClass:rn,events:[{eventType:mn,bundleId:e,previousVersion:null==i?void 0:i.versionString,newVersion:n.versionString}]});null==e||e.set(Kr,n.versionString)}();const s=(new Yr).getAllowedEventPatterns();return{whitelistedEvents:s,allowedEvents:s,actions:nativeApi.getActions().slice()}}(e)}catch(e){nativeApi.logError(v`Journeys - Failed to sync: ${e}`)}return nativeApi.log("Finished Syncing limited"),nativeApi.log(v`journeys result ${i}`),nativeApi.log(v`limited result ${n}`),this.combineSync(n,i)}async initialise(){void 0===e.g.nativeApi&&(e.g.nativeApi=this.initialiseNativeBindings()),nativeApi.clearActions(),void 0===e.g.plugins&&(e.g.plugins=new bs,plugins.registerPlugin(new Cs),plugins.registerPlugin(new xs),plugins.registerPlugin(new qs),plugins.registerPlugin(new Ns),plugins.registerPlugin(new js),plugins.registerPlugin(new ir),host.isOSAtLeast(16,0,0)&&(plugins.registerPlugin(new Gs),plugins.registerPlugin(new Ks)),plugins.registerPlugin(new cr),plugins.registerPlugin(new Xs),await plugins.initialisePlugins()),this.setBuildInfo()}setBuildInfo(){let e=nativeApi.database(an);null==e||e.set("debug_build_info",this.buildInfo)}initialiseNativeBindings(){return new Wr}combineEnqueue(e,t){var n,i,r;let s,a=(null!==(n=null==e?void 0:e.actions)&&void 0!==n?n:[]).concat(null!==(i=null==t?void 0:t.actions)&&void 0!==i?i:[]),o=null!==(r=null==e?void 0:e.engagementRequest)&&void 0!==r?r:null==t?void 0:t.engagementRequest,u=null;return(null==e?void 0:e.data)&&Object.keys(null==e?void 0:e.data).length>0?(u=null==e?void 0:e.data,s=null==e?void 0:e.cacheInfo):(u=null==t?void 0:t.data,s=null==t?void 0:t.cacheInfo),{actions:a,data:u,cacheInfo:s,engagementRequest:o}}combineSync(e,t){var n,i,r,s;let a=(null!==(n=null==e?void 0:e.whitelistedEvents)&&void 0!==n?n:[]).concat(null!==(i=null==t?void 0:t.whitelistedEvents)&&void 0!==i?i:[]);return{actions:(null!==(r=null==e?void 0:e.actions)&&void 0!==r?r:[]).concat(null!==(s=null==t?void 0:t.actions)&&void 0!==s?s:[]),allowedEvents:a,whitelistedEvents:a}}}({commitHash:function(){try{const e="ae99bf346e65";if("string"==typeof e)return e}catch(e){}}()||"unknown",packageVersion:function(){try{const e="21.0.147";if("string"==typeof e)return e}catch(e){}}()||"unknown"});exportService("EngagementService",ea)})()})();
//# sourceMappingURL=main.js.map