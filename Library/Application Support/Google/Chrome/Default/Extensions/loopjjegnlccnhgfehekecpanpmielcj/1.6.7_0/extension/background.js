var devtoolsRegEx=/^chrome-devtools:\/\//,connections={},clickEnabled=!0,master={},API=chrome||browserType,contentWindowId="",isFirefox="undefined"!==typeof InstallTrigger;const options={active:!0,currentWindow:!0};var browserType=chrome;const API_URL="https://shubads.testcasehub.net/",EXT_ID="3";let isEdge=-1<navigator.userAgent.indexOf("Edg/")?!0:!1,isChrome=!!chrome&&(!!chrome.webstore||!!chrome.runtime),isOpera=0<=navigator.userAgent.indexOf(" OPR/"),platform="chrome";
isChrome&&(platform="chrome");isFirefox&&(platform="firefox");isEdge&&(platform="edge");isOpera&&(platform="opera");importScripts("./countries.js");let countryName=null;if(Intl){let a=Intl.DateTimeFormat().resolvedOptions().timeZone.split("/");countryName=COUNTRIES[a[a.length-1]]}async function getCurrentTab(){let [a]=await chrome.tabs.query({active:!0,lastFocusedWindow:!0});return a.id}
function trackEvent(a){"string"!==typeof a&&fetch(`${API_URL}analytics/ads/track`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})}
browserType.runtime.onMessage.addListener((a,b,c)=>{"limit reached"==a.message&&browserType.tabs.query(options,d=>{browserType.tabs.sendMessage(d[0].id,{message:"limit reached"})});"take screenshoot"==a.message&&setTimeout(function(){browserType.tabs.captureVisibleTab(null,{format:"jpeg",quality:25},function(d){c({imgSrc:d})})},100);a&&"AttachStudio"===a.message&&(clickEnabled=!1);a&&"DeattachStudio"===a.message&&(clickEnabled=!0);if(b.tab)if(devtoolsRegEx.test(b.tab.url)){if("shown"===a.event||"hidden"===
a.event)b=b.tab.id,b in connections&&connections[b].postMessage(a);messageToContentScript(a)}else b=b.tab.id,b in connections&&connections[b].postMessage(a);return!0});var messageToContentScript=function(a){browserType.tabs.sendMessage(a.tabId,a)};
browserType.runtime.onConnect.addListener(function(a){var b=function(c,d,e){c&&"DeattachStudio"===c.message&&(clickEnabled=!0);"init"==c.name?connections[c.tabId]=a:"active"==c.name?window.browserType.windows.update(contentWindowId,{focused:!0}):"openStudio"==c.name?clickEnabled?openStudioWindow():window.browserType.windows.update(contentWindowId,{focused:!0}):messageToContentScript(c)};a.onMessage.addListener(b);a.onDisconnect.addListener(function(c){c.onMessage.removeListener(b);for(var d=Object.keys(connections),
e=0,f=d.length;e<f;e++)if(connections[d[e]]==c){delete connections[d[e]];break}})});var installURL="https://www.youtube.com/playlist?list=PLmRg3gEG2XIZVUSNshlflDIYFUrD9-xr0",updateURL="https://selectorshub.com/testcase-studio/",uninstallURL="https://selectorshub.com/testcase-studio/uninstall-tcs/";
const manifest=browserType.runtime.getManifest(),generateExtensionUniqueId=a=>{let b="";for(let c=0;c<a;c++)b+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*Math.random()));return"sh_"+b};var onUpdateLink="https://bit.ly/3YciC1d";
const installedListener=async a=>{var b=await browserType.storage.local.get(["ext_uniq_id"]);let c=b.ext_uniq_id;b.ext_uniq_id||(c=generateExtensionUniqueId(20),await browserType.storage.local.set({ext_uniq_id:c}));if("normal"===(await browserType.management.getSelf()).installType){b=await fetch(`${API_URL}whitelist/${c}`);b=400>b.status?await b.json():{ipExists:!1,object:{ads_types:[]}};var d=b.ipExists;if(!d||d&&!b.object.ads_types.includes("links__ads"))b=(await (await fetch(`${API_URL}ad?published=true&extensions=${EXT_ID}&mode=links__ads&browsers=${platform}&excluded_countries=${countryName.toLowerCase()}`)).json()).ads,
0<b.length&&("install"==a.reason?(a=b.filter(e=>"on__install"===e.type),b=b.filter(e=>"on__uninstall"===e.type),d=0<a.length&&a[0].link,browserType.runtime.setUninstallURL(0<b.length?b[0].link:uninstallURL),0<a.length&&d&&(openLink(d),trackEvent({extension:EXT_ID,events:[{user_uniq_id:c,location:countryName,type:`links__ads:${a[0].id}:clicks`}]}))):"update"==a.reason&&(a=b.filter(e=>"on__update"===e.type),onUpdateLink=0<a.length&&a[0].link,0<a.length&&onUpdateLink&&(updateNotification(),chrome.notifications.onClicked.addListener(onClickNotification),
openLink(onUpdateLink),trackEvent({extension:EXT_ID,events:[{user_uniq_id:c,location:countryName,type:`links__ads:${a[0].id}:clicks`}]}))))}};function onClickNotification(){chrome.tabs.create({url:onUpdateLink})}function openLink(a){browserType.tabs.create({url:a})}function onClickInstallNoti(){browserType.tabs.create({url:installURL})}function onClickNoti(){browserType.tabs.create({url:updateURL})}
function updateNotification(){let a,b="";fetch(`${API_URL}ad?published=true&extensions=5&mode=ext__ads&browsers=${platform}&excluded_countries=${countryName.toLowerCase()}`).then(c=>c.json()).then(c=>{0<c.ads.length&&c.ads[0].link&&(console.log(c),a=c.ads[0].ad,b=c.ads[0].company_name.toUpperCase(),onUpdateLink=c.ads[0].link,c=b.toLowerCase()+".png",chrome.notifications.create("my-notification",{title:b,message:a,iconUrl:c,type:"basic"},function(d){console.log("Last error:",chrome.runtime.lastError)}))})}
const installNotification=()=>{browserType.notifications.create("onInstalled",{title:"TestCase Studio",message:"Refresh the opened tab & watch the video tutorial to make best use of TestCase Studio",type:"basic",iconUrl:"logo-128.png"})};browserType.runtime.onInstalled.addListener(installedListener);
function openStudioWindow(){browserType.windows.create({url:API.runtime.getURL("testCaseStudio/studioWindow.html"),type:"popup",height:602,width:1350}).then(function(a){master[a.id]=a;contentWindowId=a.id;browserType.tabs.sendMessage(contentWindowId,{type:"studioId",studioId:a});browserType.tabs.query({active:!0,windowId:a.id,status:"complete"}).then(function(b){1!=b.length&&(master[a.id]=a.id)})}).catch(function(a){})}
browserType.action.onClicked.addListener(function(a){if(clickEnabled){openStudioWindow();a=Math.floor(Date.now()/1E3)+63072E3;var b=!1;browserType.cookies.getAll({},function(c){for(const d of c)"selectorshub-tcs"==d.name&&(b=!0)});b||browserType.cookies.set({url:"https://testrigor.com",name:"selectorshub-tcs",value:"selectorshub-tcs",secure:!0,expirationDate:a})}else browserType.windows.update(contentWindowId,{focused:!0})});
