import{b as d,d as L}from"./R4DOVXS6.js";import{b as U,ha as A,ia as N,j as C,l as W}from"./TN74TYZV.js";import{r as x}from"./JBQIPS5C.js";import{a as O}from"./CVYR3XXR.js";import{c as E,j as T,k}from"./OKNPJCGL.js";import{A as o,K as _}from"./2XMGLZMD.js";import{a as I}from"./3JX3VARJ.js";import{f as s}from"./PQ35KENF.js";var h=s(I());var R=s(W());var S=s(I()),u=s(T()),v=s(k());u.default.extend(v.default);var f="CHROME_EXTENSION_LOG_DAILY_USAGE_LIMIT_KEY",Q=async a=>{let r=async()=>{try{let e=await x(),t=a.provider||e.sidebarSettings?.common?.currentAIProvider||"UNKNOWN_PROVIDER",n={ai_provider:{USE_CHAT_GPT_PLUS:"chatgpt",OPENAI:"chatgpt_web_app",OPENAI_API:"openai_api",BARD:"bard_web_app",BING:"bing_web_app",POE:"poe",CLAUDE:"claude_web_app",MAXAI_CLAUDE:"claude"}[t]||"UNKNOWN_PROVIDER",domain:a.host,prompt_id:a.id,prompt_name:a.name,browser:await L()};N(n.prompt_id)&&(n.prompt_id=A+n.prompt_id.slice(A.length+8),n.prompt_name=`[Suggested] ${n.prompt_name}`);let y=await O(),H=await U(),M=R.default.encrypt(JSON.stringify(n),"MaxAI").toString();if(!y)return!1;let m=await(await fetch(`${_}/user/call_api`,{method:"POST",body:JSON.stringify({info_object:M}),headers:{"Content-Type":"application/json",Authorization:`Bearer ${y}`,fp:`${H}`}})).json();return m.data&&m.status==="OK"?(await p(m.data),m.data.has_reached_limit&&P(!0).then().catch(),m.data.has_reached_limit):!1}catch(e){if(e?.message==="Failed to fetch"&&(await c())?.name==="free"){let i=await l();return i.has_reached_limit=!0,await p(i),!0}return!1}};return new Promise(async e=>{try{let t=await l();if(t)if(!t.has_reached_limit)r().then().catch(),e(!1);else{let i=await P(!1);if(i?.role?.name==="pro")if(i.role.exp_time&&(0,u.default)(i.role.exp_time).diff((0,u.default)().utc())>0){d("[Pricing] Pro [cache] has reached the limit",`Pro user ${i?.email} use has reached the limit.
${JSON.stringify({role:i?.role,usage:t.usage})}`,{uuid:"7a04bc02-6155-4253-bcdb-ade3db6de492"}),e(!1);return}else await c(),t=await l(),e(t.has_reached_limit);if(new Date>new Date(t.next_reset_timestamp*1e3)){await c(),t=await l(),e(t.has_reached_limit);return}e(!0)}else{let i=await r();e(i)}}catch{e(!1)}})},p=async a=>{try{await S.default.storage.local.set({[f]:JSON.stringify(a)})}catch{}},l=async()=>{try{let a=await S.default.storage.local.get(f);if(a[f]){let r=JSON.parse(a[f]);return{has_reached_limit:r.has_reached_limit,next_reset_timestamp:r.next_reset_timestamp,usage:r.usage,limit_value:r.limit_value}}return{has_reached_limit:!1,next_reset_timestamp:0,usage:0,limit_value:0}}catch{return{has_reached_limit:!1,next_reset_timestamp:0,usage:0,limit_value:0}}};var b=s(T()),D=async()=>{let a=await h.default.storage.local.get(o);return a[o]?a[o]?.refreshToken:""},P=async a=>{try{let r=await h.default.storage.local.get(o);if(r[o]){let e=r[o]?.userData,t=!1;return e||(e=await $(),t=!0),(a||!e.role)&&(e.role=await c(),t=!0),t&&await h.default.storage.local.set({[o]:{...r[o],userData:e}}),e}return}catch{return}},c=async()=>{try{let a=await D();if(!a)return;let r=await fetch(`${_}/user/get_user_subscription_info`,{headers:{Authorization:`Bearer ${a}`}});if(r.ok){let e=await r.json();if(e.status==="OK"&&e.data&&e?.data?.roles&&E(e.data.roles)){await p({has_reached_limit:e.data.has_reached_limit,limit_value:e.data.limit_value,next_reset_timestamp:e.data.next_reset_timestamp,usage:e.data.usage});let t=e.data.roles.find(i=>i.name==="pro")||e.data.roles[0];return t||(t={name:"free",exp_time:0}),t.name==="pro"&&e.data.has_reached_limit&&d("[Pricing] Pro [subscription_info] has reached the limit",`Pro token [${a}] call api has reached the limit.
${JSON.stringify(e?.data)}`,{uuid:"7a04bc02-6155-4253-bcdb-ade3db6de492"}),t==="pro"&&(0,b.default)().utc().diff((0,b.default)(t.exp_time))>0&&d("[API] error response roles",`Pro token [${a}]
${JSON.stringify(e?.data)}`,{uuid:"6f02f533-def6-4696-b14e-1b00c2d9a4df"}),{name:t.name,exp_time:t.exp_time}}}return}catch{return}},$=async()=>{try{let a=await D();if(!a)return;let r=await fetch(`${_}/user/get_user_info`,{headers:{Authorization:`Bearer ${a}`}}),e=await c();if(r.ok){let t=await r.json();if(t.status==="OK"&&t?.data?.email)return t.data?.conversationId&&delete t.data.conversationId,t.data.role=e,t.data}return}catch{return}};var w=s(I());var g="SEARCH_WITH_AI_STORAGE_KEY",G={aiProvider:C.OPENAI,enable:!0,triggerMode:"always",webAccessPrompt:!0},B=async()=>{let a=await w.default.storage.local.get(g);return a[g]?a[g]:G},se=async a=>{let r=await B()||G;await w.default.storage.local.set({[g]:{...r,...a}})};export{Q as a,D as b,P as c,G as d,B as e,se as f};
