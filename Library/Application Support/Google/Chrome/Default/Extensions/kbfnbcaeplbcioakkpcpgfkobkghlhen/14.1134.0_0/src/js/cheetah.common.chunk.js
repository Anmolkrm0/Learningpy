(self.webpackChunk=self.webpackChunk||[]).push([[4382],{65312:(e,t,i)=>{i.r(t),i.d(t,{CheetahFeatureImpl:()=>Bt,isAssistantOpened:()=>kt});var s=i(17771),a=i(17889),n=i(62965),r=i(6294),o=i(85892),l=i(57050),d=i(27378),h=i(54696),c=i(55649),u=i(98805),p=i(14601),g=i(32952),m=i(60797),v=i(66310),_=i(24209),b=i(85985),S=i(23063),f=i(40151),w=i(98403),y=i(2844),A=i(77176),I=i(2834),R=i(76974),C=i(28043),x=i(93508),E=i(16118),U=i(13444),k=i(78674),B=i(17343),P=i(80544),M=i(79692),O=i(67434),T=i(19751),G=i(44586),z=i(97425),N=i(5114),H=i(8125),F=i(83078),D=i(95195),W=i(22232),q=i(12187),j=i(38983),V=i(34217),L=i(51325);const $=({width:e,height:t,top:i,left:s,visibility:a})=>d.createElement("div",{"data-grammarly-part":"cheetah-highlight-rect",...(0,q.Sh)(L.highlightRect,"hidden"===a?L.hidden:null,"attention"===a?L.attention:null),style:{width:e,height:t,top:i,left:s}});var Z=i(6726),Q=i(16805);const Y=d.forwardRef((function({forceTooltipMessage:e,onClick:t,onMouseEnter:i,onMouseLeave:s},a){return d.createElement(Z.u,{message:"Open GrammarlyGO",forcedMessage:e},d.createElement("button",{onClick:t,"data-grammarly-part":"cheetah-ideate-button",className:Q.ideateButton,ref:a,onMouseEnter:i,onMouseLeave:s},d.createElement("div",{className:Q.ideateButtonIcon})))}));var K=i(864),J=i(88571),X=i(4147),ee=i(89894),te=i(33678),ie=i(15073),se=i(42103),ae=i(51369),ne=i(85665);const re=ee.ux.style({fontStyle:"normal",fontWeight:"normal",fontFamily:"Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', sans-serif, Arial",$nest:{"button, input, textarea":{fontFamily:"inherit"}}}),oe=({isMac:e,children:t})=>{var i;const s=null===(i=d.useContext(ne.nS.Context))||void 0===i?void 0:i.host,a=d.useMemo((()=>new K.C(e)),[e]);return d.createElement(X.o,null,d.createElement(te.a.Context.Provider,{value:a},d.createElement(J.Q,{remSize:R.of(16),setter:e=>ie.u.setRootCssVar(s||document.documentElement,e)},d.createElement(se.G.DefaultProvider,null,d.createElement("div",{className:re},t,d.createElement(ae.X,null))))))};var le=i(74204),de=i(50783);const he=({referenceElement:e,placement:t,offset:i,disabled:s,onClick:a})=>{const[n,r]=d.useState(null),{styles:o,attributes:l}=(0,le.D)(e,n,{placement:t,modifiers:i?[{name:"offset",options:{offset:i}}]:[]});return d.createElement("button",{ref:r,style:o.popper,...l.popper,onClick:a,onMouseDown:e=>{e.stopPropagation(),e.preventDefault()},"data-grammarly-part":"cheetah-reply-button",className:de.replyButton,"data-disabled":s},d.createElement("div",{className:de.icon}),d.createElement("span",null,"Reply quickly"))};var ce=i(87491);const ue=({referenceElement:e,placement:t,offset:i,disabled:s,onMagicRewriteClick:a,onOpenRewriteClick:n})=>{const[r,o]=d.useState(null),{styles:l,attributes:h}=(0,le.D)(e,r,{placement:t,modifiers:i?[{name:"offset",options:{offset:i}}]:[]});return a||n?d.createElement("div",{ref:o,style:l.popper,...h.popper,onMouseDown:e=>{e.stopPropagation(),e.preventDefault()},"data-grammarly-part":"cheetah-entry-button",className:ce.entryButton,"data-disabled":s},a?d.createElement(Z.u,{message:"Improve it"},d.createElement("button",{onClick:a,onMouseDown:e=>{e.stopPropagation(),e.preventDefault()},className:ce.entryButtonItem,"data-disabled":s},d.createElement("i",{className:ce.rewriteIcon}))):null,n?d.createElement(Z.u,{message:"Open GrammarlyGO"},d.createElement("button",{onClick:n,onMouseDown:e=>{e.stopPropagation(),e.preventDefault()},className:ce.entryButtonItem,"data-disabled":s},d.createElement("i",{className:ce.openIcon}))):null):null};var pe=i(90845),ge=i(49708),me=i(5739),ve=i(48033);const _e=()=>d.createElement("svg",{className:ve.icon,viewBox:"0 0 16 16",fillRule:"evenodd",clipRule:"evenodd",strokeLinecap:"round"},d.createElement("path",{d:"M8,16C12.418,16 16,12.418 16,8C16,3.582 12.418,0 8,0C3.582,0 0,3.582 0,8C0,12.418 3.582,16 8,16Z",fill:"#0A9A78"}),d.createElement("path",{d:"M4,8L12,8M8,4L8,12",fill:"none",fillRule:"nonzero",stroke:"white",strokeWidth:"1.5px"})),be=({overflow:e,...t})=>e?d.createElement(fe,{...t}):d.createElement(Se,{...t}),Se=({left:e,top:t,height:i})=>d.createElement(d.Fragment,null,d.createElement("div",{"data-grammarly-part":"cheetah-quasi-caret",className:ve.quasiCaret,style:{left:e,top:t+i,height:i+8}},d.createElement(_e,null))),fe=({left:e,top:t,height:i})=>{const{ref:a,onMount:n}=pe.P.useElWatcher(),r=d.useMemo((()=>j.h.create(N.none)),[]),{rect:o,onMount:h}=pe.P.useRectWatcher(),c=d.useCallback((e=>{e.style.pointerEvents="all",r.set((0,l.zG)(s.Y(N.option)({rect:N.some(e.getBoundingClientRect()),goodParent:(0,l.zG)(e.getBoundingClientRect(),(e=>({x:e.x+e.width/2,y:e.y+e.height/2})),(({x:e,y:t})=>{var i,s;return N.fromNullable(null===(s=null===(i=document.elementFromPoint(e,t))||void 0===i?void 0:i.shadowRoot)||void 0===s?void 0:s.elementFromPoint(e,t))}),N.filter((t=>t===e||e.contains(t||null))))}),N.fold((()=>N.none),(({rect:e})=>N.some({x:e.x,y:e.y}))))),e.style.pointerEvents="none"}),[]),u=d.useMemo((()=>ge.R(document,"scroll",{capture:!0}).pipe(x.O(null))),[]);return pe.P.useSubscriptionTo(y.aj([a.pipe(m.oA),u,o]).pipe(I.b((([e])=>c(e))))),d.createElement(d.Fragment,null,d.createElement("div",{"data-grammarly-part":"cheetah-quasi-caret",className:ve.quasiCaret,style:{left:e,top:t+i,height:i+8},ref:e=>{n(e),h(e)}},d.createElement(me.F.div,{style:r.pipe(A.U((e=>(0,l.zG)(e,N.fold((()=>({opacity:1})),(()=>({opacity:0})))))))},d.createElement(_e,null))),d.createElement(me.F.Fragment,null,r.pipe(A.U((e=>(0,l.zG)(e,N.fold(l.gn,(e=>d.createElement("div",{"data-grammarly-part":"cheetah-quasi-caret-fixed-bro",className:ve.quasiCaret,style:{transform:"none",position:"fixed",left:e.x,top:e.y,height:i+8}},d.createElement(_e,null))))))))))};var we=i(10389),ye=i(64015),Ae=i(3709),Ie=i(91984),Re=i(819),Ce=i(21189),xe=i(8122),Ee=i(69693),Ue=i(35298),ke=i(31409),Be=i(87311),Pe=i(65924),Me=i(18027),Oe=i(39670),Te=i(69438),Ge=i(72715),ze=i(2847),Ne=i(46733),He=i(84403),Fe=i(42724),De=i(92627),We=i(99877),qe=i(33104),je=i(83959),Ve=i(51129),Le=i(7534);var $e=i(44358),Ze=i(81873),Qe=i(81531),Ye=i(65504),Ke=i(9205),Je=i(9629),Xe=i(88355),et=i(4068),tt=i(30857),it=i(31528);function st(e){return"pushAssistantFeed"===e.type}function at(e){var t,i;const s=e.mode===Ee.w.pushRewrite?null:e,a=((null===(t=null==s?void 0:s.source)||void 0===t?void 0:t.type)===it.WT.sdui?s.source.action.actions:[]).find((0,H.W9)(st,(e=>"default-feed"===e.feedId)));return{feedId:"default-feed",cardId:null!==(i=null==a?void 0:a.cardId)&&void 0!==i?i:null}}function nt(e){var t,i,s,a,n,r,o,d,h,c,u,p,g,m,v,_,b;const S=e=>{var t;return null!==(t=null==e?void 0:e.reduce(((e,t)=>{var i;return t.email&&!e.has(t.email)&&e.set(t.email,{name:null!==(i=t.name)&&void 0!==i?i:"",email:t.email}),e}),new Map))&&void 0!==t?t:new Map},f=S(null===(s=null===(i=null===(t=e.parents)||void 0===t?void 0:t[0])||void 0===i?void 0:i.audience)||void 0===s?void 0:s.indirectRecipients),w=S(null===(r=null===(n=null===(a=e.parents)||void 0===a?void 0:a[0])||void 0===n?void 0:n.audience)||void 0===r?void 0:r.undisclosedRecipients),y=S(null===(c=null===(h=null===(d=null===(o=e.parents)||void 0===o?void 0:o[0])||void 0===d?void 0:d.audience)||void 0===h?void 0:h.recipients)||void 0===c?void 0:c.filter((({email:e})=>(0,tt.HD)(e)&&!f.has(e)&&!w.has(e)))),A=S(null===(u=e.audience)||void 0===u?void 0:u.indirectRecipients),I=S(null===(p=e.audience)||void 0===p?void 0:p.undisclosedRecipients),R=S(null===(m=null===(g=e.audience)||void 0===g?void 0:g.recipients)||void 0===m?void 0:m.filter((({email:e})=>(0,tt.HD)(e)&&!A.has(e)&&!I.has(e))));return{previousMessageInfo:(0,l.zG)(ye.YM(null!==(v=e.parents)&&void 0!==v?v:[]),N.fold((()=>et.H.PreviousMessageInfo.empty),(e=>{var t;return{author:(0,l.zG)(ye.YM(null!==(t=e.authors)&&void 0!==t?t:[]),N.fold((()=>et.H.Person.empty),(e=>{var t,i;return{name:null!==(t=e.name)&&void 0!==t?t:"",email:null!==(i=e.email)&&void 0!==i?i:""}}))),directRecipients:Array.from(y.values()),text:e.delta?(0,Xe.l)(e.delta,""):""}}))),title:null!==(_=e.title)&&void 0!==_?_:"",author:(0,l.zG)(ye.YM(null!==(b=e.authors)&&void 0!==b?b:[]),N.fold((()=>et.H.Person.empty),(e=>{var t,i;return{name:null!==(t=e.name)&&void 0!==t?t:"",email:null!==(i=e.email)&&void 0!==i?i:""}}))),directRecipients:Array.from(R.values()),indirectRecipients:Array.from(A.values()),undisclosedRecipients:Array.from(I.values())}}var rt=i(41127),ot=i(8709),lt=i(20236),dt=i(67534);function ht(e,t,i,s){const{left:a,right:n}=(0,l.zG)(e,ye.UI((({alertId:e,alternativeIndex:i})=>function(e,t,i){return(0,l.zG)(D.fromOption((()=>`Alert ${e} not found`))(i(e)),D.filterOrElse(lt.S.isCapiAlert,(t=>`Unsupported alert ${e} with type ${t._tag}`)),D.chain((i=>h.$.isWithTransformJson(i)?(0,l.zG)(i.transformJSON.alternatives,N.chain((e=>{var i;return N.fromNullable(null===(i=e.alternatives[t])||void 0===i?void 0:i.delta)})),D.fromOption((()=>`Alternative ${t} not found for WithTransformJson alert ${e}`))):h.$.isWithSubAlerts(i)?(0,l.zG)(i.subalerts.alternatives,N.chain((e=>{var i;return N.fromNullable(null===(i=e.alternatives[t])||void 0===i?void 0:i.delta)})),D.fromOption((()=>`Alternative ${t} or context not found for WithSubAlerts alert ${e}`))):h.$.isWithPosition(i)?D.right((new ot.i).retain(i.transformRange.start).delete(i.transformRange.end-i.transformRange.start).insert(i.transformText)):D.left(`Unsupported alert ${e}`))),D.map((i=>({delta:i,alertId:e,alternativeIndex:t}))))}(e,i,t))),ye.oh),r=n.reduce(((e,t)=>e.compose(t.delta)),new ot.i),o=(0,dt.g)(r),d=(0,dt.B)(r);return i.performBatchReplacements(o).then((()=>D.right(void 0))).catch((t=>D.left(`Replacement error for [${e.map((e=>`alertId: ${e.alertId} altIdx: ${e.alternativeIndex}`)).join(", ")}]: `+String(t)))).then((e=>(0,l.zG)(s(),N.filter((()=>d.length>0)),N.fold((()=>Promise.resolve(D.right(void 0))),(e=>Promise.all(d.map((({range:t,formatting:i})=>e.apply(t,i).then((()=>D.right(void 0))).catch((e=>D.left(String(e))))))).then((0,l.ls)(ye.oh,(({left:e})=>e.length>0?D.left(`Formatting errors [${e.join(", ")}]`):D.right(void 0))))))).then((t=>{const i=a.concat(D.isLeft(e)?[e.left]:[]).concat(D.isLeft(t)?[t.left]:[]);return i.length>0?D.left(new Error(`AlertApply - ${i.join(" - ")}`)):D.right(void 0)}))))}var ct=i(80358),ut=i(36919),pt=i(19125);var gt=i(71078),mt=i(18625);var vt=i(91447);var _t=i(48015);function bt(e){return i.e(8661).then(i.bind(i,19853)).then((({createRevisionEngine:t})=>{const i=j.h.create(null),s=e.alertStateService.getActiveAlertByClick().pipe(A.U((e=>{var t;return null!==(t=null==e?void 0:e.alertId)&&void 0!==t?t:null}))).subscribe(w.wW(i)),a=c.Y.create("cheetah.revision"),{revisionEngine:n,dispose:r}=t({capiService:e.capiService,sduiService:{sduiItemCollectionChanges:(d=e.sduiBufferService,_.T(d.pipe(E.G(),A.U((([e,t])=>N.isSome(e)?N.some((0,pt.ex)()):N.none)),m.oA),d.pipe(v.w(N.fold((()=>f.E),(e=>e.capiEvents.pipe(b.h((0,H.Kg)(ct.h.is("sdui_add"),ct.h.is("sdui_update"),ct.h.is("sdui_remove"))),A.U((e=>{switch(e.kind){case"sdui_add":return(0,pt.K5)(e.sduiRootId,e.sdui);case"sdui_update":return(0,pt.FE)(e.sduiRootId,e.sdui);case"sdui_remove":return(0,pt.Ul)(e.sduiRootId);default:return(0,l.Rz)(e)}})))))))).pipe((e=>e.pipe(ut.f(e.pipe(k.b(0))))),b.h((e=>e.length>0)))).pipe(I.b((e=>a.trace("sduiService.sduiItemCollectionChanges",e)))),initialFeed:e.initialFeed},alertService:{alertCollectionChanges:(o=e.alertProcessor.alerts,mt.P((()=>o.changes.pipe(A.U((e=>{const t=new Set(e.addedAlerts.filter(lt.S.isCapiAlert).map((e=>e.id))),i=new Set(e.removedAlerts.filter((e=>lt.S.isCapiAlert(e.alert))).map((e=>e.id)));return[...e.addedAlerts.filter(lt.S.isCapiAlert).filter((e=>!i.has(e.id))).map((e=>(0,gt.Tm)(e.id))),...e.removedAlerts.filter((e=>lt.S.isCapiAlert(e.alert))).filter((e=>!t.has(e.id))).map((e=>(0,gt.qQ)(e.id,"textChange"===e.reason._tag?"textChange":"other")))]})),x.O(Array.from(o.getAll()).filter(lt.S.isCapiAlert).map((e=>(0,gt.Tm)(e.id)))),(e=>e.pipe(ut.f(e.pipe(k.b(0))))),A.U((e=>e.flatMap(l.yR))),b.h((e=>e.length>0)))))).pipe(I.b((e=>a.trace("alertService.alertCollectionChange",e)))),selectedAlertId:i,applyAlerts:t=>{const i=ht(t,(t=>N.fromNullable(e.alertProcessor.alerts.getAlertById(t))),e.replacementService,e.getFormattingService).then(D.fold((e=>{throw a.warn("Error applying alerts",{applyAlertsInfo:t,error:e}),e}),(()=>{})));return e.requestAwaitService.addRequest(i),i},removeAlerts:t=>(0,_t.DV)((()=>Promise.resolve(t.forEach((({alertId:t,removalReason:i})=>{e.alertProcessor.removeAlert(t,{_tag:"alertApplied"===i?rt.i.alertAccepted:rt.i.ignore})})))),(e=>(a.warn("Error removing alerts",{removedAlertsInfo:t,error:e}),Promise.reject(e)))),setAlertsVisibility:t=>(e.highlightsUpdater.setAlertsVisibility(t),Promise.resolve(void 0)),updateAlertsVisibility:t=>(e.highlightsUpdater.updateAlertsVisibility(t),Promise.resolve(void 0))},monitoringService:{notify:t=>function(e,t,i,s){(0,vt.Sf)(t)?e.cheetah.error(t,i,s):(0,vt.lS)(t)?e.cheetah.warning(t,i,s):(0,vt.ti)(t)?e.cheetah.info(t,i,s):(0,W.L0)(t)}(e.telemetry,t,e.domain,e.getSessionUuid())},logger:a});var o,d;return{revisionEngine:n,dispose:()=>{e.highlightsUpdater.clearAll(),s.unsubscribe(),r()}}}))}var St=i(48044),ft=i(13853),wt=i(7604),yt=i(73975),At=i(95300),It=i(32409);class Rt{constructor(e){this._params=e,this._subs=new p.w,this._visibleAlertsSubject=new At.X(new Map),this._emphasizedAlertsSubject=new At.X(new Map),this._visibleAlerts=this._visibleAlertsSubject.pipe(T.skipBy(St.Eh(yt.yv,ft.Eh(yt.yv)))),this._emphasizedAlerts=this._emphasizedAlertsSubject.pipe(T.skipBy(St.Eh(yt.yv,ft.Eh(yt.yv)))),this._subs.add(this._visibleAlerts.subscribe((e=>{var t;return null===(t=this._params.logger)||void 0===t?void 0:t.debug("visible highlights",e)}))),this._subs.add(this._emphasizedAlerts.subscribe((e=>{var t;return null===(t=this._params.logger)||void 0===t?void 0:t.debug("emphasized highlights",e)})))}setAlertsVisibility(e){this.clearAll();const t=new Map(this._visibleAlertsSubject.value),i=new Map(this._emphasizedAlertsSubject.value);e.filter((e=>"hidden"!==e.visibility)).forEach((({alertId:e,visibility:s})=>{const a=this._params.getAlertById(e);if(a){const n=a.highlightRanges.map((t=>({range:t,highlightId:Ct(e,t)})));n.forEach((({range:e,highlightId:t})=>{this._params.highlightCollection.addHighlight(t,e,It.M.getHighlightMeta(a,t,e,!1))})),t.set(e,new Set(n.map((e=>e.highlightId)))),"emphasized"===s&&i.set(e,new Set(n.map((e=>e.highlightId))))}})),this._visibleAlertsSubject.next(t),this._emphasizedAlertsSubject.next(i)}updateAlertsVisibility(e){const t=new Map(this._visibleAlertsSubject.value),i=new Map(this._emphasizedAlertsSubject.value);e.forEach((({alertId:e,visibility:s})=>{var a;const n=this._params.getAlertById(e);if(n&&"hidden"!==s){const a=n.highlightRanges.map((t=>({range:t,highlightId:Ct(e,t)})));a.forEach((({range:e,highlightId:t})=>{this._params.highlightCollection.updateHighlight(t,e,It.M.getHighlightMeta(n,t,e,!1))})),t.set(e,new Set(a.map((e=>e.highlightId)))),"emphasized"===s?i.set(e,new Set(a.map((e=>e.highlightId)))):i.delete(e)}else{const s=Array.from(null!==(a=this._visibleAlertsSubject.value.get(e))&&void 0!==a?a:new Set);s.length>0&&this._params.highlightCollection.removeHighlights(s),t.delete(e),i.delete(e)}})),this._visibleAlertsSubject.next(t),this._emphasizedAlertsSubject.next(i)}clearAll(){const e=new Set(Array.from(this._visibleAlertsSubject.value.values()).concat(Array.from(this._emphasizedAlertsSubject.value.values())).flatMap((e=>Array.from(e))));e.size>0&&this._params.highlightCollection.removeHighlights(Array.from(e)),this._visibleAlertsSubject.next(new Map),this._emphasizedAlertsSubject.next(new Map)}getHighlightVisualState(e){const t=this._params.alertStateService.getHighlightedAlert().pipe(A.U((t=>{var i;return!0===(null===(i=null==t?void 0:t.highlightIds)||void 0===i?void 0:i.includes(e))})),x.O(!1),C.x()),i=this._params.alertStateService.getActiveAlertByClick().pipe(A.U((t=>{var i;return!0===(null===(i=null==t?void 0:t.highlightIds)||void 0===i?void 0:i.includes(e))})),x.O(!1),C.x()),s=this._emphasizedAlerts.pipe(A.U((t=>Array.from(t.values()).some((t=>t.has(e))))),C.x());return y.aj([t,i,s]).pipe(A.U((([e,t,i])=>({hovered:e,selectedByClick:t,emphasized:i}))),x.O({hovered:!1,selectedByClick:!1,emphasized:!1}),E.G(),A.U((([e,t])=>t.hovered||t.selectedByClick?wt.pc.hovered:t.emphasized?e.hovered||e.selectedByClick?wt.pc.hovered:wt.pc.hoveredNeedsAttention:wt.pc.none)),x.O(wt.pc.none),C.x(),I.b((t=>{var i;return null===(i=this._params.logger)||void 0===i?void 0:i.debug(`[${e}] visual state:`,t)})))}dispose(){this.clearAll(),this._subs.unsubscribe()}}function Ct(e,t){return`${e}|${t.start}-${t.end}|cheetah`}const xt=(0,q.xb)(Y),Et=new Set(["onboarding","gdocsOnboardingPopup","loginSSO","accountMigration","standWithUkraineGrammarlySuspended","claimedUser","dataControl","noPaymentMethodSubscription","grammarlyBusinessSigninPopup","gdocsFeedbackUI"]),Ut=new Set(["onboarding","gdocsOnboardingPopup","loginSSO","accountMigration","standWithUkraineGrammarlySuspended","claimedUser","dataControl","grammarlyBusinessSigninPopup"]),kt=e=>"opened"===e.kind;class Bt{constructor(e){this._params=e,this._subs=new p.w,this._log=c.Y.create("CheetahFeatureImpl"),this._inlineButtonUI=j.h.create(null),this._ideateButtonUI=j.h.create(null),this._expandedIdeateButtonUI=j.h.create(null),this._assistantUI=j.h.create(null),this._highlightUI=j.h.create(null),this._quasiCaretUI=j.h.create(null),this._onboardingUI=j.h.create(null),this._nativeCursorHider=j.h.create(N.none),this._lastRestartAttemptTime=j.h.create(0),this._contextHighlight=j.h.create(N.none),this._highlightsUpdater=new Rt({getAlertById:e=>this._params.alertProcessor.alerts.getAlertById(e),highlightCollection:this._params.highlightCollection,alertStateService:this._params.alertStateService,logger:c.Y.create("cheetah.revision.highlights")}),this.inlineButtonUI=this._inlineButtonUI.view(),this.ideateButtonUI=this._ideateButtonUI.view(),this.expandedIdeateButtonUI=this._expandedIdeateButtonUI.view(),this.assistantUI=this._assistantUI.view(),this.highlightUI=this._highlightUI.view(),this.quasiCaretUI=this._quasiCaretUI.view(),this.onboardingUI=this._onboardingUI.view(),this._ideateButtonTooltipNotificationState=j.h.create(N.none),this._assistantFocused=j.h.create(!1),this._inlineButtonRecentlyPressed=j.h.create(!1),this._ideateButtonRecentlyHovered=j.h.create(!1),this._selectionRange=j.h.create(N.none),this._highlights=j.h.create([]),this._quasiCaretRect=j.h.create(N.none),this._assistantSession=j.h.create(N.none),this._onboardingViewModel=j.h.create(N.none),this._ideateButtonRefChange=new g.xQ,this._disposed=new g.xQ,this._initialOnboardingBlockedForSession=j.h.create(!1),this.assistantState=this._assistantSession.view(N.fold((()=>({kind:"closed"})),(()=>({kind:"opened",supportsRevision:this._params.supportsRevision})))),this._cheetahServices=function(e,t,i,s,a,o,d,h,c,m,_,f,w,C,x,E,U,k,B,H,F,q,V,L,$,Z,Q,Y){const K=new g.xQ,J=()=>(0,l.zG)(e.get(),D.fromOption((()=>new Error("checking service not initialized")))),X={notify(e){null==Y||Y.info("received monitoring event",{event:e}),(0,l.zG)(J(),D.map((e=>e.sessionUuid)),D.map((t=>{(0,ze.fz)(e)?(Q.cheetah.error(e,$,t),"waitForContextTimeout"!==e.name&&"waitForAckTimeout"!==e.name||"getContext"!==e.sourceCommand||(Date.now()-L.get()>u.LK(5)?(L.set(Date.now()),Z()):(0,l.zG)(e.name,(e=>"waitForAckTimeout"===e?"ack":"waitForContextTimeout"===e?"setContext":void(0,W.L0)(e)),(e=>Q.cheetah.sessionRestartTimeout(e,$,t))))):(0,ze.lu)(e)?Q.cheetah.info(e,$,t):(0,ze.pm)(e)?Q.cheetah.warning(e,$,t):(0,W.L0)(e)})))}},ee=new Ne.t({inboundCAPIMessages:t,sendCAPIMessage:({action:e,data:t,shouldInjectRev:i,shouldInjectSessionId:s})=>(0,l.zG)(n.Uo(J()),n.tS((a=>a.sendMessage(e,t,i,s)))),monitoringService:X}),te=new He.c(ee),ie={user:j.h.combine(i,s,((e,t)=>({id:Fe.n.Id.create(e.id),isPremium:Ve.n5.isPremium(e),dialect:t}))),setDialect:a},se=new De.L(ee,h.view((0,l.ls)(N.chain((e=>N.fromNullable(e.cheetahState))),N.fold((()=>({enabled:!1})),(e=>({enabled:!0,userState:e})))))),ae=o.pipe(v.w(N.fold((()=>R.of(N.none)),(e=>e.sessionService.session.view(N.some))))),ne=c.pipe(P.QV(M.E),O.R(((e,t)=>{const i=e.filter(Mt);return t&&Mt(t)?[...i,t]:i}),[]),A.U(ye.Z$),T.shareReplay({bufferSize:1,refCount:!0})),re=y.aj([ne,m,_]).pipe(A.U((([e,t,i])=>(0,l.zG)(e,N.filter((()=>t)),N.fold((()=>({})),(e=>({[We.n.initialPopupAnchor]:i?{reference:e,placement:"top",offset:8,boundaryAreaPadding:10}:void 0,[We.n.initialBTSPopupAnchor]:i?{reference:e,placement:"top",offset:8,boundaryAreaPadding:10}:void 0,[We.n.rewriteTooltipAnchor]:{reference:e,placement:"top",offset:8,boundaryAreaPadding:10}}))))))),oe=o.pipe(v.w(N.fold((()=>R.of(!1)),(e=>e.viewModels.position.state.view((e=>"dragged"===e.kind&&e.dragging)))))),le=e=>{null==Y||Y.debug(`Completing step [${e}]`);w.get()[e].extension.completed||C({[e]:{completed:!0,lastSeen:Date.now()}})},de=()=>{const e=new Set;x.get().rewrite&&E||e.add(Ce.T.StepName.rewrite),x.get().compose||e.add(Ce.T.StepName.initial),x.get().onboarding||(e.add(Ce.T.StepName.initial),e.add(Ce.T.StepName.initialBTS),e.add(Ce.T.StepName.rewrite),e.add(Ce.T.StepName.prompts),e.add(Ce.T.StepName.review),e.add(Ce.T.StepName.knowledgeHub),e.add(Ce.T.StepName.references));const t=(0,l.zG)(h.get(),N.map((e=>"ASSIGNMENT_WRITING"===e.defaultDocumentContext.writingIntent)),N.getOrElse(l.jv));return x.get().onboardingBTS&&t||e.add(Ce.T.StepName.initialBTS),x.get().knowledgeHubIntegration||e.add(Ce.T.StepName.knowledgeHub),(0,qe.k)({upstreamOnboardingState:w,session:ae,textStats:d,forceDisabledOnboardingSteps:e,assistantUIActions:K,externalElements:re,hideAssistantOnboardingTooltips:oe,promptsAllocated:se.availability.view(Re._.getPromptsAllocated),client:"extension",trackingService:te,disposed:f,logger:Qe.C8.Logging.getLogger("OnboardingCompletionEffects"),completeOnboardingStep:le})},he={reportUphookShow:e=>n.tD((()=>{e.isPremium||((0,$e.n)(V,{placement:"grammarlyGoPrompts",upgradeHookName:"grammarlyGoPrompts",upgradeHookSlot:"grammarlyGo"}),Q.upgradeHooks.showUpgradeHook("grammarlyGoPrompts","grammarlyGo"))})),reportUphookClick:e=>n.tD((()=>{e.isPremium?self.open(r.Rd().appConfig.url.support):((0,$e.Q)(V,{placement:"grammarlyGoPrompts",upgradeHookName:"grammarlyGoPrompts",upgradeHookSlot:"grammarlyGo"}),Q.upgradeHooks.clickUpgradeHook("grammarlyGoPrompts","grammarlyGo"),(0,Le.wW)("upHook","grammarlyGoPrompts"))}))};return{capiService:ee,userService:ie,genAIAvailabilityService:se,trackingService:te,textEditorService:{flush:()=>n.fF((()=>new G.y((t=>{const i=new p.w;return U.empty.get()?t.next(void 0):(U.flush(),(0,l.zG)(e.get(),N.fold((()=>t.next(void 0)),(e=>{i.add(e.messages.pipe(b.h((e=>e._tag===we.J8.Type.submitOtAck)),z.L(500,R.of(null)),I.b((()=>t.next(void 0)))).subscribe())})))),()=>i.unsubscribe()})).pipe(S.q(1)).toPromise())),getText:e=>n.tD((()=>k(e))),insertText:e=>n.tD((()=>B(e))),setContextHighlight:(e,t)=>{q.set(N.some({range:e,visibility:t}))},selectedRange:H,textUpdated:F},feedbackService:{submitFeedback:e=>n.Y3((()=>(0,l.zG)(e.source,(e=>e===je.x.Source.resultCard?"cheetah-card":e===je.x.Source.quickReplyInitialActions?"cheetah-quick-reply":void(0,W.L0)(e)),(t=>V.feedbackFormSubmit(e.mood,t,e.domain,e.message)))),(e=>new Error(String(e))))},uphookService:he,monitoringService:X,createOnboardingViewModel:de,notifyAssistantUIAction:e=>K.next(e),dispose:()=>se.dispose()}}(this._params.checkingService,this._params.checkingService.pipe(m.oA,v.w((e=>e.capiMessages))),this._params.user,this._params.dapiSettings.view((e=>e.dialectStrong?Ae.L.Dialect.Value.fromString(e.dialectStrong):e.dialectWeak?Ae.L.Dialect.Value.fromString(e.dialectWeak):Ae.L.Dialect.Value.american)),(e=>n.fF((()=>this._params.dapiActions.changeStrongDialect(e)))),this._assistantSession,this._params.textStats,this._params.capiStartAckMessage,this._ideateButtonRefChange,j.h.combine(this._params.integration.canShowIdeateButtonPopups,this._params.gButtonPopupState.view("type").view((e=>!Et.has(e))),H.xD),j.h.combine(this._params.csPageState.view("cheetah").view((e=>(null==e?void 0:e.canShowInitialOnboarding)||(null==e?void 0:e.canShowInitialBTSOnboarding)||!1)),this._initialOnboardingBlockedForSession,((e,t)=>e&&!t)),_.T(this._params.csPageState.view("isActiveTab").pipe(b.h((e=>!e))),this._disposed).pipe(S.q(1)),this._params.dapiSettings.view((e=>function(e){const t=Ie.Z.State.toClientState(Ie.Z.decode(e.extension||""),"extension"),i=Ie.Z.State.toClientState(Ie.Z.decode(e.editor||""),"editor"),s=Ie.Z.State.toClientState(Ie.Z.decode(e.llamaMac||""),"llamaMac"),a=Ie.Z.State.toClientState(Ie.Z.decode(e.llamaWindows||""),"llamaWin");return(0,l.zG)(Ie.Z.State.empty,Ie.Z.State.patch(t,"extension"),Ie.Z.State.patch(i,"editor"),Ie.Z.State.patch(s,"llamaMac"),Ie.Z.State.patch(a,"llamaWin"))}({extension:e["cheetah:onboardingState"],editor:e["cheetah:onboardingState:editor"],llamaMac:e["cheetah:onboardingState:llamaMac"],llamaWindows:e["cheetah:onboardingState:llamaWindows"]}))),(e=>{this._params.dapiActions.modifyCheetahOnboardingState((0,l.ls)(Ie.Z.decode,(t=>(0,l.zG)(Ie.Z.State.toClientState(t,"extension"),(t=>({...t,...e})),(e=>Ie.Z.State.patch(e,"extension")(t)))),Ie.Z.encode))}),this._params.featureFlags,this._params.integration.enableInlineRewrites,this._params.textChangeBuffer,(e=>this._params.integration.getText(e)),(e=>this._insertText(e)),this._selectionRange,this._params.integration.textUpdated,this._contextHighlight,this._params.gnar,this._lastRestartAttemptTime,this._params.domain,(()=>this._restartSession()),this._params.telemetry,this._log),this._isOnboardingPopupVisible=j.h.create(!1),this._entryPointsEnabled=j.h.create(!1),this.isOnboardingPopupVisible=this._isOnboardingPopupVisible.view(),this.isAvailable=j.h.combine(this._cheetahServices.genAIAvailabilityService.availability.view((0,H.ff)(Re._.isUnavailable)),this._params.csPageState.view("cheetah"),((e,t)=>{var i;return e&&!0===(null===(i=null==t?void 0:t.status)||void 0===i?void 0:i.cheetahEnabled)})),this.userSettings=this._cheetahServices.genAIAvailabilityService.availability.view("userSettings"),this._params.dapiActions.reloadPropsRateLimited(),this._subs.add(this._params.checkingService.pipe(m.oA,v.w((e=>e.readyState)),b.h((e=>e===we.kQ.ready)),S.q(1)).subscribe((()=>this._init()))),this._subs.add(this._setupIdeateTooltipStateObs());const t=this._onboardingViewModel.pipe(v.w(N.fold((()=>f.E),(e=>e.uiActions))));this._subs.add(t.pipe(b.h(Tt)).subscribe((()=>{this._params.cheetahCSActions.cheetahInitialOnboardingShown()}))),this._subs.add(t.pipe(b.h(Gt)).subscribe((()=>{this._params.cheetahCSActions.cheetahInitialBTSOnboardingShown()}))),this._subs.add(this._getOnboardingVMStepActive([Ce.T.StepName.initial,Ce.T.StepName.initialBTS]).subscribe(w.wW(this._isOnboardingPopupVisible))),this._subs.add(this._params.gButtonPopupState.view("type").view((e=>Ut.has(e))).subscribe((e=>{e&&this._initialOnboardingBlockedForSession.set(!0)}))),this._subs.add(y.aj([this._params.gButtonDisabledReason,this._params.integration.entryPointsEnabled]).pipe(A.U((([e,t])=>t&&!function(e){const t=new Set([Ye.P.DATA_CONTROL_ACTIVE,Ye.P.OFFLINE,Ye.P.STAND_WITH_UKRAINE,Ye.P.USER_CLAIMED,Ye.P.USER_EDC_BLOCKED,Ye.P.SIGNED_OUT_GB]);return null!==e&&t.has(e)}(e)))).subscribe(w.wW(this._entryPointsEnabled))),this._subs.add(this._params.csPageState.view("cheetah").view((e=>{var t;return!1===(null===(t=null==e?void 0:e.status)||void 0===t?void 0:t.cheetahEnabled)})).subscribe((()=>this._terminateAssistantSession(Ze.R.disposed)))),this._subs.add(this._params.openAssistant.pipe(v.w((e=>this._startNewAssistantSession(e)))).subscribe()),this._registerDebugHelpers()}closeAssistant(e){this._terminateAssistantSession(e)}getHoveredStateBehavior(e){return this._highlightsUpdater.getHighlightVisualState(e)}_init(){this._subs.add(this._assistantFocused.subscribe((e=>this._log.debug("Assistant "+(e?"focused":"blurred"))))),this._subs.add(this._getInlineButtonUI().subscribe(w.wW(this._inlineButtonUI))),this._subs.add(this._getIdeateButtonUI().subscribe(w.wW(this._ideateButtonUI))),this._subs.add(this._getExpandedIdeateButtonUI().subscribe(w.wW(this._expandedIdeateButtonUI))),this._subs.add(this._getAssistantUI().subscribe(w.wW(this._assistantUI))),this._subs.add(this._getHighlightUI().subscribe(w.wW(this._highlightUI))),this._subs.add(this._getQuasiCaretUI().subscribe(w.wW(this._quasiCaretUI))),this._subs.add(this._getOnboardingUI().subscribe(w.wW(this._onboardingUI))),this._subs.add(this._updateSelectionRange().subscribe(w.wW(this._selectionRange))),this._subs.add(this._updateHighlightRects().subscribe(w.wW(this._highlights))),this._subs.add(this._updateQuasiCaretRect().subscribe(w.wW(this._quasiCaretRect))),this._subs.add(this._updateNativeCursor().subscribe()),this._subs.add(this._closeRewriteAssistantWhenUnfocused().subscribe()),this._subs.add(this._assistantSession.view(N.isSome).subscribe((e=>{e&&this._params.closeLegacyAssistant()}))),this._subs.add(this._createOnboardingViewModelWhenCheetahAvailable().subscribe()),this._subs.add(this._handleTryItOut().subscribe())}_handleTryItOut(){return this._onboardingViewModel.pipe(v.w(N.fold((()=>f.E),(e=>e.uiActions))),b.h(xe.l.is(xe.l.Kind.tryItOut)),I.b((()=>this._params.openAssistant.next({mode:Pt(this._params.integration.quickReplyContext.get())&&this._params.featureFlags.get().quickReply?Ee.w.quickReply:Ee.w.ideation}))))}_getOnboardingVMStepActive(e){return this._onboardingViewModel.pipe(v.w(N.fold((()=>R.of(!1)),(t=>t.activeStep.view((0,l.ls)(N.filter((e=>e.show)),N.map((t=>e.includes(t.name))),N.getOrElse(l.jv)))))),C.x())}_setupIdeateTooltipStateObs(){return this._cheetahServices.genAIAvailabilityService.availability.pipe(x.O(null),E.G(),A.U((([e,t])=>e&&t&&Re._.isPassive(e)&&Re._.isActive(t)?N.some("Youâ€™ve got prompts!"):N.none)),v.w(N.fold((()=>R.of(N.none)),(e=>_.T(R.of(N.some(e)),R.of(N.none).pipe(U.g(3e3))))))).subscribe(w.wW(this._ideateButtonTooltipNotificationState))}_registerDebugHelpers(){!function(e){const t=self;t&&(t.cheetahDebug=t.cheetahDebug||{},Object.assign(t.cheetahDebug,e))}({clearOnboarding:()=>this._params.dapiActions.modifyCheetahOnboardingState((()=>Ie.Z.encode(Ie.Z.State.empty)))})}_createOnboardingViewModelWhenCheetahAvailable(){return j.h.combine(this._params.featureFlags,this._cheetahServices.genAIAvailabilityService.availability.view(Re._.isUsable),((e,t)=>e.onboarding&&t)).pipe(I.b((e=>this._onboardingViewModel.modify((t=>((0,l.zG)(t,F.bw((e=>e.dispose()))),e?N.some(this._cheetahServices.createOnboardingViewModel()):N.none))))))}_closeRewriteAssistantWhenUnfocused(){return this._assistantFocused.pipe(k.b(100),b.h((e=>!e&&(0,l.zG)(this._assistantSession.get(),N.fold(l.jv,(e=>e.sessionService.session.view((e=>"started"===e.kind&&Ee.w.isRewriteOrQuickRewrite(e.mode)&&N.isNone(e.inProgressResult)&&0===e.results.length)).get()))))),I.b((()=>this._terminateAssistantSession(Ze.R.assistantBlurred))))}_onClickIdeateButton(e){N.isSome(this._assistantSession.get())?this._terminateAssistantSession(Ze.R.closed):this._params.openAssistant.next({mode:e})}_updateSelectionRange(){return y.aj([this._params.integration.selectionRange,this._assistantUI.pipe(b.h((e=>null===e)))]).pipe(A.U((([e,t])=>({selectionRange:e,assistantIsFocused:this._assistantFocused.get(),inlineButtonRecentlyPressed:this._inlineButtonRecentlyPressed.get(),ideateButtonRecentlyHovered:this._ideateButtonRecentlyHovered.get(),initialPopupOnboardingStepIsActive:this.isOnboardingPopupVisible.get(),assistantIsHidden:t}))),I.b((({inlineButtonRecentlyPressed:e,ideateButtonRecentlyHovered:t})=>{e&&this._inlineButtonRecentlyPressed.set(!1),t&&this._ideateButtonRecentlyHovered.set(!1)})),b.h((({selectionRange:e,assistantIsFocused:t,inlineButtonRecentlyPressed:i,ideateButtonRecentlyHovered:s,initialPopupOnboardingStepIsActive:a,assistantIsHidden:n})=>!!n||!i&&!s&&(!N.isNone(e)||!t&&!a))),A.U((({selectionRange:e})=>e)))}_updateHighlightRects(){return e=this._selectionRange,t=this._contextHighlight,i=this._params.integration,y.aj([e.pipe(v.w(N.fold((()=>R.of([])),(e=>i.getHighlightRects(e).pipe(A.U((e=>e.map((e=>({rect:e,visibility:"visible"})))))))))),t.pipe(v.w(N.fold((()=>R.of([])),(e=>i.getHighlightRects(e.range).pipe(A.U((t=>t.map((t=>({rect:t,visibility:e.visibility}))))))))))]).pipe(A.U((([e,t])=>t.find((e=>"hidden"!==e.visibility))?t:e)));var e,t,i}_updateQuasiCaretRect(){return this._selectionRange.pipe(v.w((e=>(0,l.zG)(e,N.filter(h.SV.isCollapsed),N.fold((()=>R.of([])),(e=>this._params.integration.getHighlightRects(e)))))),A.U((e=>(0,l.zG)(e,a.c2,N.map((e=>e[e.length-1]))))))}_updateNativeCursor(){return j.h.combine(this._quasiCaretRect,this._assistantSession.view(N.isSome),((e,t)=>(0,l.zG)(s.Y(N.option)({nativeUIHider:N.fromNullable(this._params.integration.createNativeUIHider),quasiCaretRect:e}),N.filter((()=>t)),F.ew((()=>{this._nativeCursorHider.modify((e=>((0,l.zG)(e,F.bw((e=>e.dispose()))),N.none)))})),F.bw((({nativeUIHider:e})=>{this._nativeCursorHider.modify((t=>((0,l.zG)(t,F.bw((e=>e.dispose()))),N.some(e()))))})))))}_terminateAssistantSession(e){this._assistantSession.modify(N.chain((t=>(t.dispose(e),N.none)))),e!==Ze.R.closed&&e!==Ze.R.assistantBlurred||this._params.integration.focusTextField()}_restartSession(){this._log.info("reconnecting checking service and restarting session"),(0,l.zG)(this._assistantSession.get(),F.bw((e=>{const t=e.sessionService.session.get().mode;var i;e.dispose(),this._assistantSession.set(N.none),(0,l.zG)(this._params.checkingService.get(),F.bw((e=>{e.reconnect()}))),i=t,Ee.w.isPushRewrite(i)?this._params.openAssistant.next({mode:Ee.w.ideation}):this._params.openAssistant.next({mode:t})})))}async _startNewAssistantSession(e){N.isSome(this._assistantSession.get())&&this._terminateAssistantSession(Ze.R.disposed),this._assistantFocused.set(!0);const t=function(e,t,i,s){switch(e.mode){case Ee.w.ideation:return{mode:e.mode,metadata:t,documentUrl:s};case Ee.w.rewrite:case Ee.w.quickRewrite:return{mode:e.mode,metadata:t};case Ee.w.quickReply:return{mode:e.mode,quickReplyContext:(0,l.zG)(i,N.fold((()=>et.H.empty),nt)),metadata:t};case Ee.w.pushRewrite:return{mode:e.mode,writingExpertContext:e.writingExpertContext};default:(0,W.L0)(e)}}(e,{disableKnowledgeEngine:"disabled"===this._params.dapiSettings.get().serengetiState||void 0},this._params.integration.quickReplyContext.get(),this._params.url);e.mode===Ee.w.pushRewrite&&this._selectionRange.set(N.some(e.transformRange));const i=new Ue.j(j.h.create({contextUpdatesClient:this._params.experimentClient.isGateEnabled(Ke.K.CheetahSelectionContextUpdates)&&"test"===this._params.experimentClient.getTreatment(Je.p.CheetahSelectionContextUpdates),contextUpdatesServer:this._params.experimentClient.isGateEnabled(Ke.K.CheetahSelectionContextUpdatesServer)&&"test"===this._params.experimentClient.getTreatment(Je.p.CheetahSelectionContextUpdates)})),s=new ke.Z({startSessionOptions:t,textEditorService:this._cheetahServices.textEditorService,capiService:this._cheetahServices.capiService,userService:this._cheetahServices.userService,trackingService:this._cheetahServices.trackingService,monitoringService:this._cheetahServices.monitoringService,selectionContextAvailability:i.availability}),a=new Be.p({capiService:this._cheetahServices.capiService,monitoringService:this._cheetahServices.monitoringService}),{revisionEngine:r,dispose:o}=this._params.supportsRevision?await bt({capiService:this._cheetahServices.capiService,sduiBufferService:this._params.sduiBufferService,alertProcessor:this._params.alertProcessor,initialFeed:at(e),highlightsUpdater:this._highlightsUpdater,replacementService:this._params.replacementService,getFormattingService:this._params.getFormattingService,requestAwaitService:this._params.requestAwaitService,alertStateService:this._params.alertStateService,domain:this._params.domain,getSessionUuid:()=>{var e,t;return null!==(t=null===(e=N.toNullable(this._params.checkingService.get()))||void 0===e?void 0:e.sessionUuid)&&void 0!==t?t:null},telemetry:this._params.telemetry}):{revisionEngine:void 0,dispose:l.Q1},d=Pe.s.create({textEditorService:this._cheetahServices.textEditorService,userService:this._cheetahServices.userService,genAIAvailabilityService:this._cheetahServices.genAIAvailabilityService,trackingService:this._cheetahServices.trackingService,uphookService:this._cheetahServices.uphookService,feedbackService:this._cheetahServices.feedbackService,monitoringService:this._cheetahServices.monitoringService,sessionService:s,userSurveyService:a,positionInfo:this._params.integration.assistantPlacement.pipe(m.oA),handlers:{onFocusChange:e=>this._assistantFocused.set(e),close:()=>n.tD((()=>this._terminateAssistantSession(Ze.R.closed)))},revisionEngine:r,selectionContextAvailabilityService:i}),h=d.actions.subscribe((e=>this._cheetahServices.notifyAssistantUIAction(e))),c={sessionService:s,viewModels:d,dispose:()=>{o(),h.unsubscribe(),s.dispose(),a.dispose(),d.dispose(),this._assistantFocused.set(!1)}};this._assistantSession.set(N.some(c))}_getInlineButtonUI(){return(0,l.zG)(s.Y(o.P)({inlineButtonInfo:this._params.integration.inlineButtonPlacement,selectionRange:this._selectionRange,selectionOngoing:_.T(this._params.integration.selectionRange.pipe(A.U((e=>(0,l.zG)(e,N.isSome)))),this._params.integration.selectionRange.pipe(k.b(100),B.h(!1))),assistantClosed:this._assistantSession.view(N.isNone),textMapIsEmpty:this._params.integration.textMapIsEmpty,quickReplyContext:this._params.integration.quickReplyContext,availability:this._cheetahServices.genAIAvailabilityService.availability,entryPointsEnabled:this._entryPointsEnabled,featureFlags:this._params.featureFlags})).pipe(A.U((({inlineButtonInfo:e,selectionRange:t,selectionOngoing:i,assistantClosed:s,textMapIsEmpty:a,quickReplyContext:n,availability:r,entryPointsEnabled:o,featureFlags:h})=>(0,l.zG)(e,N.filter((()=>o)),N.filter((()=>s)),N.filter((()=>Re._.isUsable(r))),N.fold(l.gn,(e=>(0,l.zG)(t,N.fold(l.gn,(t=>a&&N.isSome(n)&&h.inlineQuickReply?d.createElement(he,{disabled:!1,referenceElement:e.referenceElement,placement:e.placement,offset:N.toNullable(e.offset),onClick:()=>{this._inlineButtonRecentlyPressed.set(!0),this._params.openAssistant.next({mode:Ee.w.quickReply})}}):Ot(t)&&(h.inlineRewrite||h.magicRewrite)&&this._params.integration.enableInlineRewrites?d.createElement(ue,{disabled:i,referenceElement:e.referenceElement,placement:e.placement,offset:N.toNullable(e.offset),onOpenRewriteClick:h.inlineRewrite?()=>{this._inlineButtonRecentlyPressed.set(!0),this._params.openAssistant.next({mode:Ee.w.rewrite})}:void 0,onMagicRewriteClick:h.magicRewrite?()=>{this._inlineButtonRecentlyPressed.set(!0),this._params.openAssistant.next({mode:Ee.w.quickRewrite})}:void 0}):null)))))))))}_getAssistantUI(){return this._assistantSession.view(N.fold(l.gn,(e=>d.createElement(oe,{isMac:this._params.isMac},V.UI.mount((0,Me.I)(e.viewModels),(0,Oe.Q)(e.viewModels,{contentFlowOptions:{chatFlowOptions:{assistantMaxHeight:j.h.create(N.none)},feedbackFormFlowOptions:{showDomainCheckbox:N.some(this._params.domain)}}}))))))}_getOnboardingUI(){return this._onboardingViewModel.view(N.fold(l.gn,(e=>d.createElement(oe,{isMac:this._params.isMac},V.UI.mount(Te.T,(0,Ge.A)(e))))))}_getHighlightUI(){return j.h.combine(this._highlights,this._assistantSession.view(N.isSome),this._assistantFocused,((e,t,i)=>t&&i?e.map((({rect:e,visibility:t},i)=>d.createElement($,{key:`cheetah-highlight-rect-${i}`,top:e.top,left:e.left,width:e.width,height:e.height,visibility:t}))):null))}_getQuasiCaretUI(){return j.h.combine(this._quasiCaretRect,this._assistantSession.view(N.isSome),((e,t)=>(0,l.zG)(e,N.filter((()=>t)),N.fold((()=>null),(e=>d.createElement(be,{left:e.left,top:e.top,height:e.height,overflow:this._params.integration.allowCustomCaretOverflow}))))))}_getIdeateButtonUI(){return j.h.combine(this._params.featureFlags,this._inlineButtonUI,this._selectionRange,this._params.integration.quickReplyContext,this._cheetahServices.genAIAvailabilityService.availability,this._entryPointsEnabled,((e,t,i,s,a,n)=>(0,l.zG)(t,N.fromPredicate((e=>null===e)),N.filter((()=>n&&e.ideateButton)),N.filter((()=>Re._.isUsable(a))),N.fold(l.gn,(()=>this._getIdeateButtonForSelectionRange(i,s,e))))))}_getExpandedIdeateButtonUI(){return this._params.supportsRevision?j.h.create(null):j.h.combine(this._params.featureFlags,this._selectionRange,this._params.integration.quickReplyContext,this._cheetahServices.genAIAvailabilityService.availability,this._entryPointsEnabled,((e,t,i,s,a)=>(0,l.zG)(s,N.fromPredicate((e=>Re._.isVisible(e))),N.filter((()=>a&&e.ideateButton)),N.fold(l.gn,(()=>this._getIdeateButtonForSelectionRange(t,i,e))))))}_getIdeateButtonForSelectionRange(e,t,i){return this._params.supportsRevision?null:(0,l.zG)(e,N.filter((e=>Ot(e)&&i.rewrite)),N.fold((()=>Pt(t)&&i.quickReply?Ee.w.quickReply:i.compose?Ee.w.ideation:null),(()=>Ee.w.rewrite)),N.fromNullable,N.fold(l.gn,(e=>d.createElement(xt,{onMouseEnter:()=>this._ideateButtonRecentlyHovered.set(!0),onMouseLeave:()=>this._ideateButtonRecentlyHovered.set(!1),onClick:()=>this._onClickIdeateButton(e),mount:e=>this._ideateButtonRefChange.next(e),forceTooltipMessage:this._ideateButtonTooltipNotificationState.view(N.toUndefined)}))))}_insertText(e){""!==e?this._params.integration.insertText(e,this._selectionRange.get()):this._log.warn("insert() - attempting to insert empty response, skipping insert.")}dispose(){var e;this._disposed.next(null),this._highlightsUpdater.dispose(),this._terminateAssistantSession(Ze.R.disposed),null===(e=N.toUndefined(this._onboardingViewModel.get()))||void 0===e||e.dispose(),this._cheetahServices.dispose(),this._subs.unsubscribe(),(0,l.zG)(this._nativeCursorHider.get(),F.bw((e=>e.dispose()))),this._params.integration.dispose()}}function Pt(e){return(0,l.zG)(e,N.exists((e=>Object.values(e).filter((e=>void 0!==e)).length>0)))}function Mt(e){return e.isConnected&&null!==e.offsetParent}function Ot(e){const t=e.end-e.start;return t>=10&&t<5e3}function Tt(e){return(0,H.W9)(xe.l.is(xe.l.Kind.mount),(e=>e.step===Ce.T.StepName.initial))(e)}function Gt(e){return(0,H.W9)(xe.l.is(xe.l.Kind.mount),(e=>e.step===Ce.T.StepName.initialBTS))(e)}},67534:(e,t,i)=>{i.d(t,{B:()=>o,g:()=>r});var s=i(17528),a=i(48015),n=i(36991);const r=e=>e.reduce((({actions:e,index:t},i)=>{const s=e[0];return n.s.isInsertString(i)?(e.unshift({pos:{start:t,end:t},value:i.insert}),{actions:e,index:t}):n.s.isInsertEmbed(i)?{actions:e,index:t+1}:n.s.isRetain(i)?{actions:e,index:t+i.retain}:n.s.isDelete(i)?(s&&s.pos.start===s.pos.end&&s.pos.end===t?s.pos={...s.pos,end:s.pos.end+i.delete}:e.unshift({pos:{start:t,end:t+i.delete},value:""}),{actions:e,index:t+i.delete}):void(0,a.vE)(i)}),{actions:[],index:0}).actions.reduce(((e,t)=>(e.length&&e[e.length-1].value&&e[e.length-1].pos.start===t.pos.start?e[e.length-1].value=`${t.value}${e[e.length-1].value}`:e.push(t),e)),[]),o=e=>e.reduce((({formattings:e,index:t},i)=>s.m.hasFormatting(i)?n.s.isInsertString(i)?(e.push({range:{start:t,end:"\n"===i.insert?t:t+i.insert.length},formatting:i.attributes}),{formattings:e,index:t+i.insert.length}):n.s.isInsertEmbed(i)?{formattings:e,index:t+1}:n.s.isRetain(i)?(e.push({range:{start:t,end:t+i.retain},formatting:i.attributes}),{formattings:e,index:t+i.retain}):{formattings:e,index:t}:n.s.isInsertString(i)?{formattings:e,index:t+i.insert.length}:n.s.isInsertEmbed(i)?{formattings:e,index:t+1}:n.s.isRetain(i)?{formattings:e,index:t+i.retain}:n.s.isDelete(i)?{formattings:e,index:t}:void(0,a.vE)(i)),{formattings:[],index:0}).formattings},88571:(e,t,i)=>{i.d(t,{Q:()=>l});var s=i(27378),a=i(15073),n=i(60797),r=i(95300),o=i(5114);const l=({children:e,remSize:t,setter:i})=>(d+=1,s.useEffect((()=>{const e=t.subscribe((e=>{h.next(o.some(e)),i(o.some(e))}));return()=>{e.unsubscribe(),d-=1,0===d&&(h.next(o.none),i(o.none))}}),[t]),s.createElement(a.u.Context.Provider,{value:h.pipe(n.oA)},e));let d=0;const h=new r.X(o.none)},51325:e=>{e.exports={highlightRect:"XWxTA",hidden:"o979x",attention:"bHjcD",blink:"oy7wj"}},16805:e=>{e.exports={ideateButton:"_ErYR",ideateButtonIcon:"i8HXG",spin:"CSZH1"}},87491:e=>{e.exports={entryButton:"cDocn",entryButtonItem:"dJCJe",rewriteIcon:"wGNWN",openIcon:"vIUqu",spin:"A8MjA"}},50783:e=>{e.exports={replyButton:"ZfD1U",icon:"BdxRh",spin:"MBS28"}},48033:e=>{e.exports={quasiCaret:"WhbAl",icon:"Yd_W5"}}}]);