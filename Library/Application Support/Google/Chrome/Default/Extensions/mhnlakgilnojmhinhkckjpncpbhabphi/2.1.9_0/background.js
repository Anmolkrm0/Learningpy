import{a as as}from"./chunks/57RCHQPK.js";import{a as ss,b as lt,c as ue,e as ns,f as rs}from"./chunks/WSSPBX2D.js";import{a as ts,c as pa}from"./chunks/SVN3RKFH.js";import{b as Vt,f as es}from"./chunks/4NAB6M5G.js";import{a as Ze}from"./chunks/X52TO7MR.js";import{b as Jt}from"./chunks/KIFV56CW.js";import{$ as x,Q as Je,R as Ke,S as Xe,a as Ue,ba as qt}from"./chunks/PEYNS6YO.js";import{A as je,B as ze,a as Oe,b as ut,j as Ne,k as He,l as vt,m as Dt,n as M,o as qe,p as de,q as It,s as Wt,t as Nt,u as Qe,v as bt,w as Ht,y as $e,z as q}from"./chunks/OQCOQ46A.js";import"./chunks/4JVVI5M5.js";import"./chunks/HVTOQRAB.js";import"./chunks/DETFCCYF.js";import{a as G}from"./chunks/YSIM5RLZ.js";import{d as Ye,f as zt}from"./chunks/RW4DAJBJ.js";import{a as Ve,b as Qt,c as $t,d as jt}from"./chunks/SHNRUDHL.js";import"./chunks/GZO7NFQH.js";import{B as Ge,I as P,K as Be,L as j,M as De,N as U,O as Gt,P as H,T as ce,U as ht,W as Bt,X as L,Y as We,a as g,b as Re,k as Le,n as Lt,w as K}from"./chunks/SVGE6UYD.js";import"./chunks/QPPETRF6.js";import{o as Me}from"./chunks/AA7KRV4Y.js";import{M as Fe}from"./chunks/LVENEOJP.js";import{D as ie,E as Rt,I as W,J as ct,K as Ut,L as dt,R as _,i as V,j as J,k as Ee,v as C,z as Ot}from"./chunks/CIA73AT4.js";import"./chunks/64D36THL.js";import{c as Mt,f as w}from"./chunks/PQ35KENF.js";var ws=Mt((Nr,bs)=>{(function(){var r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t={rotl:function(e,a){return e<<a|e>>>32-a},rotr:function(e,a){return e<<32-a|e>>>a},endian:function(e){if(e.constructor==Number)return t.rotl(e,8)&16711935|t.rotl(e,24)&4278255360;for(var a=0;a<e.length;a++)e[a]=t.endian(e[a]);return e},randomBytes:function(e){for(var a=[];e>0;e--)a.push(Math.floor(Math.random()*256));return a},bytesToWords:function(e){for(var a=[],s=0,n=0;s<e.length;s++,n+=8)a[n>>>5]|=e[s]<<24-n%32;return a},wordsToBytes:function(e){for(var a=[],s=0;s<e.length*32;s+=8)a.push(e[s>>>5]>>>24-s%32&255);return a},bytesToHex:function(e){for(var a=[],s=0;s<e.length;s++)a.push((e[s]>>>4).toString(16)),a.push((e[s]&15).toString(16));return a.join("")},hexToBytes:function(e){for(var a=[],s=0;s<e.length;s+=2)a.push(parseInt(e.substr(s,2),16));return a},bytesToBase64:function(e){for(var a=[],s=0;s<e.length;s+=3)for(var n=e[s]<<16|e[s+1]<<8|e[s+2],i=0;i<4;i++)s*8+i*6<=e.length*8?a.push(r.charAt(n>>>6*(3-i)&63)):a.push("=");return a.join("")},base64ToBytes:function(e){e=e.replace(/[^A-Z0-9+\/]/ig,"");for(var a=[],s=0,n=0;s<e.length;n=++s%4)n!=0&&a.push((r.indexOf(e.charAt(s-1))&Math.pow(2,-2*n+8)-1)<<n*2|r.indexOf(e.charAt(s))>>>6-n*2);return a}};bs.exports=t})()});var Ie=Mt((Hr,As)=>{var ve={utf8:{stringToBytes:function(r){return ve.bin.stringToBytes(unescape(encodeURIComponent(r)))},bytesToString:function(r){return decodeURIComponent(escape(ve.bin.bytesToString(r)))}},bin:{stringToBytes:function(r){for(var t=[],e=0;e<r.length;e++)t.push(r.charCodeAt(e)&255);return t},bytesToString:function(r){for(var t=[],e=0;e<r.length;e++)t.push(String.fromCharCode(r[e]));return t.join("")}}};As.exports=ve});var _s=Mt((qr,Ts)=>{Ts.exports=function(r){return r!=null&&(Ps(r)||sn(r)||!!r._isBuffer)};function Ps(r){return!!r.constructor&&typeof r.constructor.isBuffer=="function"&&r.constructor.isBuffer(r)}function sn(r){return typeof r.readFloatLE=="function"&&typeof r.slice=="function"&&Ps(r.slice(0,0))}});var Ss=Mt((Qr,xs)=>{(function(){var r=ws(),t=Ie().utf8,e=_s(),a=Ie().bin,s=function(n,i){n.constructor==String?i&&i.encoding==="binary"?n=a.stringToBytes(n):n=t.stringToBytes(n):e(n)?n=Array.prototype.slice.call(n,0):!Array.isArray(n)&&n.constructor!==Uint8Array&&(n=n.toString());for(var c=r.bytesToWords(n),u=n.length*8,o=1732584193,d=-271733879,h=-1732584194,l=271733878,p=0;p<c.length;p++)c[p]=(c[p]<<8|c[p]>>>24)&16711935|(c[p]<<24|c[p]>>>8)&4278255360;c[u>>>5]|=128<<u%32,c[(u+64>>>9<<4)+14]=u;for(var m=s._ff,v=s._gg,I=s._hh,f=s._ii,p=0;p<c.length;p+=16){var B=o,N=d,D=h,Ct=l;o=m(o,d,h,l,c[p+0],7,-680876936),l=m(l,o,d,h,c[p+1],12,-389564586),h=m(h,l,o,d,c[p+2],17,606105819),d=m(d,h,l,o,c[p+3],22,-1044525330),o=m(o,d,h,l,c[p+4],7,-176418897),l=m(l,o,d,h,c[p+5],12,1200080426),h=m(h,l,o,d,c[p+6],17,-1473231341),d=m(d,h,l,o,c[p+7],22,-45705983),o=m(o,d,h,l,c[p+8],7,1770035416),l=m(l,o,d,h,c[p+9],12,-1958414417),h=m(h,l,o,d,c[p+10],17,-42063),d=m(d,h,l,o,c[p+11],22,-1990404162),o=m(o,d,h,l,c[p+12],7,1804603682),l=m(l,o,d,h,c[p+13],12,-40341101),h=m(h,l,o,d,c[p+14],17,-1502002290),d=m(d,h,l,o,c[p+15],22,1236535329),o=v(o,d,h,l,c[p+1],5,-165796510),l=v(l,o,d,h,c[p+6],9,-1069501632),h=v(h,l,o,d,c[p+11],14,643717713),d=v(d,h,l,o,c[p+0],20,-373897302),o=v(o,d,h,l,c[p+5],5,-701558691),l=v(l,o,d,h,c[p+10],9,38016083),h=v(h,l,o,d,c[p+15],14,-660478335),d=v(d,h,l,o,c[p+4],20,-405537848),o=v(o,d,h,l,c[p+9],5,568446438),l=v(l,o,d,h,c[p+14],9,-1019803690),h=v(h,l,o,d,c[p+3],14,-187363961),d=v(d,h,l,o,c[p+8],20,1163531501),o=v(o,d,h,l,c[p+13],5,-1444681467),l=v(l,o,d,h,c[p+2],9,-51403784),h=v(h,l,o,d,c[p+7],14,1735328473),d=v(d,h,l,o,c[p+12],20,-1926607734),o=I(o,d,h,l,c[p+5],4,-378558),l=I(l,o,d,h,c[p+8],11,-2022574463),h=I(h,l,o,d,c[p+11],16,1839030562),d=I(d,h,l,o,c[p+14],23,-35309556),o=I(o,d,h,l,c[p+1],4,-1530992060),l=I(l,o,d,h,c[p+4],11,1272893353),h=I(h,l,o,d,c[p+7],16,-155497632),d=I(d,h,l,o,c[p+10],23,-1094730640),o=I(o,d,h,l,c[p+13],4,681279174),l=I(l,o,d,h,c[p+0],11,-358537222),h=I(h,l,o,d,c[p+3],16,-722521979),d=I(d,h,l,o,c[p+6],23,76029189),o=I(o,d,h,l,c[p+9],4,-640364487),l=I(l,o,d,h,c[p+12],11,-421815835),h=I(h,l,o,d,c[p+15],16,530742520),d=I(d,h,l,o,c[p+2],23,-995338651),o=f(o,d,h,l,c[p+0],6,-198630844),l=f(l,o,d,h,c[p+7],10,1126891415),h=f(h,l,o,d,c[p+14],15,-1416354905),d=f(d,h,l,o,c[p+5],21,-57434055),o=f(o,d,h,l,c[p+12],6,1700485571),l=f(l,o,d,h,c[p+3],10,-1894986606),h=f(h,l,o,d,c[p+10],15,-1051523),d=f(d,h,l,o,c[p+1],21,-2054922799),o=f(o,d,h,l,c[p+8],6,1873313359),l=f(l,o,d,h,c[p+15],10,-30611744),h=f(h,l,o,d,c[p+6],15,-1560198380),d=f(d,h,l,o,c[p+13],21,1309151649),o=f(o,d,h,l,c[p+4],6,-145523070),l=f(l,o,d,h,c[p+11],10,-1120210379),h=f(h,l,o,d,c[p+2],15,718787259),d=f(d,h,l,o,c[p+9],21,-343485551),o=o+B>>>0,d=d+N>>>0,h=h+D>>>0,l=l+Ct>>>0}return r.endian([o,d,h,l])};s._ff=function(n,i,c,u,o,d,h){var l=n+(i&c|~i&u)+(o>>>0)+h;return(l<<d|l>>>32-d)+i},s._gg=function(n,i,c,u,o,d,h){var l=n+(i&u|c&~u)+(o>>>0)+h;return(l<<d|l>>>32-d)+i},s._hh=function(n,i,c,u,o,d,h){var l=n+(i^c^u)+(o>>>0)+h;return(l<<d|l>>>32-d)+i},s._ii=function(n,i,c,u,o,d,h){var l=n+(c^(i|~u))+(o>>>0)+h;return(l<<d|l>>>32-d)+i},s._blocksize=16,s._digestsize=16,xs.exports=function(n,i){if(n==null)throw new Error("Illegal argument "+n);var c=r.wordsToBytes(s(n,i));return i&&i.asBytes?c:i&&i.asString?a.bytesToString(c):r.bytesToHex(c)}})()});var b=w(_());var S=w(_());var O=new G("ChatGPT/OpenAIChat"),wt=class extends M{constructor(){super("OpenAIChat");this.status="needAuth";this.isAnswering=!1;this.sendQuestion=async(e,a,s,n)=>{if(!this.isAnswering){if(Xe().then().catch(),this.questionSender=a,this.isAnswering=!0,(await q("OPENAI"))?.model==="gpt-4-code-interpreter"){let c=this.chatFiles.filter(u=>u.uploadStatus==="success"&&u.uploadedFileId);c.length>0&&(n.meta||(n.meta={}),n.meta.attachments=c.map(u=>({name:u.fileName,id:u.uploadedFileId,size:u.fileSize})),this.chatFiles=[],U("Client_listenUploadFilesChange",{files:this.chatFiles}))}await this.sendDaemonProcessTask("OpenAIDaemonProcess_askChatGPTQuestion",{taskId:e,question:s,options:n})}};this.init()}init(){H(async(e,a,s,n)=>{if(e==="daemon_process")switch(a){case"OpenAIDaemonProcess_daemonProcessExist":{if(!this.active)break;let i=this.chatGPTProxyInstance&&await Ht(this.chatGPTProxyInstance)||!1;return i&&n.tab?.id&&(i=n.tab.id!==this.chatGPTProxyInstance?.id,O.info("OpenAIDaemonProcess_daemonProcessExist","\u662F\u5426\u540C\u4E00\u4E2Atab",n.tab.id===this.chatGPTProxyInstance?.id)),O.info("OpenAIDaemonProcess_daemonProcessExist",i),{success:!0,message:"",data:{isExist:i}}}case"OpenAIDaemonProcess_setDaemonProcess":{if(!this.active)break;return O.info("OpenAIDaemonProcess_setDaemonProcess"),this.chatGPTProxyInstance=n.tab,this.status="success",await this.updateClientStatus(),this.listenDaemonProcessTab(),this.lastActiveTabId&&this.lastActiveTabId>0&&(await S.default.tabs.update(this.lastActiveTabId,{active:!0}),this.lastActiveTabId=void 0),{success:!0,message:"",data:{}}}break;case"OpenAIDaemonProcess_taskResponse":{if(!this.active)break;O.info("OpenAIDaemonProcess_taskResponse",s);let{taskId:i,data:c,done:u,error:o}=s;if(this.questionSender&&s){let{tab:d}=this.questionSender;d&&d.id&&(this.currentTaskId=i,await S.default.tabs.sendMessage(d.id,{id:C,event:"Client_askChatGPTQuestionResponse",data:{taskId:i,data:c,done:u,error:o}}),u&&(this.isAnswering=!1,this.currentTaskId=void 0))}}break;case"OpenAIDaemonProcess_daemonProcessSessionExpired":{if(O.info("OpenAIDaemonProcess_daemonProcessSessionExpired"),this.status="needAuth",!this.active)break;if(await this.updateClientStatus(),n.tab){let{tab:i}=n;i&&i.id&&(await S.default.tabs.update(i.id,{active:!0}),i.windowId&&await S.default.windows.update(i.windowId,{focused:!0,state:"normal"}))}return{success:!0,message:"",data:{}}}case"OpenAIDaemonProcess_pong":return O.info("DaemonProcess_pong",this.chatGPTProxyInstance),{success:!0,message:"",data:{}};default:break}})}async preAuth(){if(this.active=!0,this.status!=="needAuth"&&this.cacheLastTimeChatGPTProxyInstance&&this.cacheLastTimeChatGPTProxyInstance.id){let e=await L(this.cacheLastTimeChatGPTProxyInstance.id);if(e&&e.id&&e?.url?.startsWith("https://chat.openai.com")){let a=await S.default.tabs.sendMessage(e.id,{id:C,event:"OpenAIDaemonProcess_ping"});a&&a.success?(this.chatGPTProxyInstance=e,this.status="success"):(this.cacheLastTimeChatGPTProxyInstance=void 0,this.status="needAuth")}}else this.status="needAuth";await this.updateClientStatus()}async auth(e){if(this.lastActiveTabId=e,this.active=!0,this.status="loading",await this.updateClientStatus(),!this.chatGPTProxyInstance)if(this.cacheLastTimeChatGPTProxyInstance&&this.cacheLastTimeChatGPTProxyInstance.id){let a=await L(this.cacheLastTimeChatGPTProxyInstance.id);this.chatGPTProxyInstance=a||await bt()}else this.chatGPTProxyInstance=await bt();if(this.chatGPTProxyInstance){let a=this.chatGPTProxyInstance.windowId;if(a)try{await S.default.windows.update(a,{focused:!0})}catch{}await S.default.tabs.update(this.chatGPTProxyInstance.id,{active:!0}),await S.default.tabs.reload(this.chatGPTProxyInstance.id),this.status="complete",this.listenDaemonProcessTab(),await this.updateClientStatus(),this.cacheLastTimeChatGPTProxyInstance=this.chatGPTProxyInstance,this.keepAlive()}}async createConversation(e){if(this.conversation&&(this.conversation=await P.conversationDB.getConversationById(this.conversation.id)),!this.conversation){let a=(await q("OPENAI"))?.model;a?await super.createConversation({...e,meta:{...e.meta,AIModel:a}}):await super.createConversation()}return await this.sendDaemonProcessTask("OpenAIDaemonProcess_createConversation",{conversationId:this.conversation?.meta?.AIConversationId||"",model:this.conversation?.meta?.AIModel||""}),this.conversation?.id||""}async removeConversation(e){if(this.conversation&&(this.conversation=await P.conversationDB.getConversationById(this.conversation.id)),!this.conversation?.meta.AIConversationId)return await this.removeConversationWithCache(),!0;O.info("removeConversation",e);let a=await this.sendDaemonProcessTask("OpenAIDaemonProcess_removeConversation",{conversationId:this.conversation.meta.AIConversationId});return await this.removeConversationWithCache(),a.success}async abortAskQuestion(e){let a=await this.sendDaemonProcessTask("OpenAIDaemonProcess_abortAskChatGPTQuestion",{messageId:e});return this.isAnswering=!1,a.success}async destroy(){O.info("destroy"),this.clearFiles(),this.chatGPTProxyInstance&&this.chatGPTProxyInstance.id&&(this.cacheLastTimeChatGPTProxyInstance=this.chatGPTProxyInstance),this.active=!1}async sendDaemonProcessTask(e,a){if(this.chatGPTProxyInstance&&await Ht(this.chatGPTProxyInstance)&&this.chatGPTProxyInstance.id){let s=await S.default.tabs.sendMessage(this.chatGPTProxyInstance.id,{id:C,event:e,data:a});return O.info("sendDaemonProcessTask",s),s}return await this.destroy(),{success:!1,data:{},message:"daemon process not exist"}}async updateClientStatus(){this.active&&await U("Client_ChatGPTStatusUpdate",{status:this.status})}async keepAlive(){this.chatGPTProxyInstance&&await Ht(this.chatGPTProxyInstance)&&this.chatGPTProxyInstance.id&&(O.info("keepAliveDaemonProcess"),S.default.tabs.sendMessage(this.chatGPTProxyInstance.id,{id:C,event:"OpenAIDaemonProcess_ping"})),await(a=>new Promise(s=>setTimeout(s,a)))(20*1e3),this.active&&await this.keepAlive()}async tabRemoveListener(e){if(this.chatGPTProxyInstance?.id&&e===this.chatGPTProxyInstance.id){if(O.info("\u5B88\u62A4\u8FDB\u7A0B\u5173\u95ED"),this.questionSender&&this.isAnswering){let{tab:a}=this.questionSender;a&&a.id&&this.currentTaskId&&await S.default.tabs.sendMessage(a.id,{id:C,event:"Client_askChatGPTQuestionResponse",data:{taskId:this.currentTaskId,data:null,done:!0,error:"manual aborted request."}})}this.isAnswering=!1,this.chatGPTProxyInstance=void 0,this.cacheLastTimeChatGPTProxyInstance=void 0,this.status="needAuth",await this.updateClientStatus()}}async tabUpdateListener(e,a){if(e===this.chatGPTProxyInstance?.id){let s=!a.url?.includes("https://chat.openai.com"),n=a.url?.includes("https://chat.openai.com/auth");a.url&&(s||n)&&(O.info("\u5B88\u62A4\u8FDB\u7A0Burl\u53D1\u751F\u53D8\u5316\uFF0C\u5B88\u62A4\u8FDB\u7A0B\u5173\u95ED"),this.cacheLastTimeChatGPTProxyInstance=this.chatGPTProxyInstance,this.chatGPTProxyInstance=void 0,this.status="needAuth",await this.updateClientStatus()),this.active?(a.status==="loading"||a.status==="complete")&&(O.info("\u5B88\u62A4\u8FDB\u7A0Burl\u72B6\u6001\u66F4\u65B0",a.status),this.status=a.status,await this.updateClientStatus(),await this.pingAwaitSuccess()):(this.cacheLastTimeChatGPTProxyInstance=this.chatGPTProxyInstance,this.chatGPTProxyInstance=void 0,this.status="needAuth",await this.updateClientStatus())}}async pingAwaitSuccess(){let e=a=>new Promise(s=>setTimeout(s,a));if(this.chatGPTProxyInstance?.id&&this.active){O.info("start ping await success");let a=!1;for(let s=0;s<20&&!(a||!this.chatGPTProxyInstance?.id);s++)S.default.tabs.sendMessage(this.chatGPTProxyInstance.id,{id:C,event:"OpenAIDaemonProcess_ping"}).then(n=>{n&&n.success&&(O.info("ping await success"),this.status="success",this.updateClientStatus(),a=!0)}),await e(1e3)}}listenDaemonProcessTab(){S.default.tabs.onRemoved.addListener(this.tabRemoveListener.bind(this)),S.default.tabs.onUpdated.addListener(this.tabUpdateListener.bind(this))}removeListener(){S.default.tabs.onRemoved.removeListener(this.tabRemoveListener.bind(this)),S.default.tabs.onUpdated.removeListener(this.tabUpdateListener.bind(this))}async minimizedDaemonProcessWindow(){this.chatGPTProxyInstance?.windowId&&await S.default.windows.update(this.chatGPTProxyInstance.windowId,{state:"minimized"})}async uploadFiles(e){if(this.chatFiles=e,e.filter(a=>a.uploadStatus!=="success").length>0){if(!(await this.sendDaemonProcessTask("OpenAIDaemonProcess_pingFilesUpload",{})).success){this.chatFiles=this.chatFiles.map(n=>(n.uploadStatus="error",n.uploadErrorMessage="Your previous upload didn't go through as the Code Interpreter was initializing. It's now ready for your file. Please try uploading it again.",n));let s=this.chatGPTProxyInstance?.id;s&&((await q("OPENAI"))?.modelOptions?.find(i=>i.slug==="gpt-4-code-interpreter")?L(s).then(i=>{i&&S.default.tabs.update(i.id,{url:"https://chat.openai.com/?model=gpt-4-code-interpreter"})}):L(s).then(i=>{i&&S.default.tabs.update(i.id,{url:"https://chat.openai.com/?model=gpt-4"})}));return}this.chatFiles=this.chatFiles.map(s=>(s.uploadStatus="uploading",s)),await this.sendDaemonProcessTask("OpenAIDaemonProcess_filesUpload",{files:e})}}};var he=w(_());var Q=new G("Background/Chat/UseChatGPTPlusChat"),X=class extends M{constructor(){super("UseChatGPTPlusChat");this.status="needAuth";this.init()}init(){Q.info("init")}async preAuth(){this.active=!0,await this.checkTokenAndUpdateStatus()}async auth(e){this.active=!0,this.lastActiveTabId=e,await this.checkTokenAndUpdateStatus(),this.status==="needAuth"&&await he.default.tabs.create({active:!0,url:Ut}),await this.updateClientStatus()}async checkTokenAndUpdateStatus(){let e=this.status;this.token=await this.getToken(),this.status=this.token?"success":"needAuth",e!==this.status&&(Q.info("checkTokenAndUpdateStatus",this.status,this.lastActiveTabId),this.lastActiveTabId=void 0),await this.updateClientStatus()}async askChatGPT(e,a,s){if(await this.checkTokenAndUpdateStatus(),this.status!=="success"){s&&s({type:"error",done:!0,error:"Your session has expired. Please log in.",data:{text:"",conversationId:""}});return}let{taskId:n,doc_id:i,backendAPI:c="get_chatgpt_response",streaming:u=!0,chat_history:o=[],meta:d}=a||{},h=await q("USE_CHAT_GPT_PLUS"),l=Math.min(Le(h?.temperature)?h.temperature:1,1.2);Me(d?.temperature)&&(l=d?.temperature);let p=Object.assign({chat_history:o,streaming:u,message_content:e,chrome_extension_version:V,model_name:this.conversation?.meta.AIModel||h.model||Dt[0].value,prompt_id:d?.contextMenu?.id||c==="chat_with_document"?"summary_chat":"chat",prompt_name:d?.contextMenu?.text||c==="chat_with_document"?"summary_chat":"chat",temperature:l},i?{doc_id:i}:{});c==="chat_with_document"&&(p.model_name="gpt-3.5-turbo-16k");let m=new AbortController,v=m.signal;n&&(this.taskList[n]=()=>m.abort()),Q.info("streaming start",p);let I="",f=!1,B=!1,N=0,D=this.conversation?.id||"",ft=(await he.default.storage.local.get(dt))[dt]||{},Et=ft.interval||50,yt=ft.rate||.5,Ft=T=>new Promise(F=>setTimeout(F,T)),E=async()=>{if(B)return;if(f&&N===I.length){Q.info("streaming end success"),s&&s({done:!0,type:"message",error:"",data:{text:"",conversationId:D}});return}let T=0,F=Math.floor(I.length-N);if(f){let oe=Math.max(Math.floor(I.length*.1),10);T=I.slice(N,oe+N).length}else{let oe=Math.floor(F*yt);T=I.slice(N,oe+N).length}T>0&&(Q.debug("streaming echo message",f?"\u4E00\u79D2\u53D1\u9001\u5B8C\u5269\u4E0B\u7684\u6587\u672C":`\u6BCF${Et}\u6BEB\u79D2\u53D1\u9001\u5269\u4F59\u6587\u672C\u7684${(yt*100).toFixed(0)}%`,N,T,I.length),N+=T,s&&s({type:"message",done:!1,error:"",data:{text:I.slice(0,N),conversationId:D}})),await Ft(f?100:Et),await E()};E();let A=!1;await ut(`${ct}/gpt/${c}`,{provider:W.USE_CHAT_GPT_PLUS,method:"POST",signal:v,headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify(p),onMessage:T=>{try{let F=JSON.parse(T);F?.conversation_id&&(D=F.conversation_id),F?.text&&(I+=F.text),Q.debug("streaming on message",I)}catch(F){Q.error("parse message.data error: 	",F)}}}).then().catch(T=>{if(Q.info("streaming end error",T),f=!0,B=!0,T?.message==="BodyStreamBuffer was aborted"||T?.message==="The user aborted a request."){s&&s({type:"error",error:"manual aborted request.",done:!0,data:{text:"",conversationId:D}});return}try{let F=JSON.parse(T.message||T);if(F.msg&&qt(F.msg)){s&&s({type:"error",error:F.msg,done:!0,data:{text:"",conversationId:D}});return}F?.code===401&&(A=!0),Q.error("sse error",T),s&&s({done:!0,type:"error",error:F.message||F.detail||"Network error.",data:{text:"",conversationId:D}})}catch{s&&s({done:!0,type:"error",error:"Network error.",data:{text:"",conversationId:D}})}}),f||(Q.info("streaming end success"),I===""?(Jt("[API] response empty string.",JSON.stringify({model:p.model_name,promptTextLength:p.message_content.length},null,2),{uuid:"6f02f533-def6-4696-b14e-1b00c2d9a4df"}),s&&s({done:!0,type:"error",error:"Something went wrong, please try again. If this issue persists, contact us via email.",data:{text:"",conversationId:D}})):f=!0),A&&(Q.info("user token expired"),this.status="needAuth",await ht(),await this.updateClientStatus())}async abortTask(e){return this.taskList[e]&&(this.taskList[e](),delete this.taskList[e]),!0}async destroy(){Q.info("destroy"),this.status="needAuth",this.active=!1}async getToken(){return await lt()}async updateClientStatus(){this.active&&await U("Client_ChatGPTStatusUpdate",{status:this.status})}};var ma=/"(?:_|\\u0{2}5[Ff]){2}(?:p|\\u0{2}70)(?:r|\\u0{2}72)(?:o|\\u0{2}6[Ff])(?:t|\\u0{2}74)(?:o|\\u0{2}6[Ff])(?:_|\\u0{2}5[Ff]){2}"\s*:/,ga=/"(?:c|\\u0063)(?:o|\\u006[Ff])(?:n|\\u006[Ee])(?:s|\\u0073)(?:t|\\u0074)(?:r|\\u0072)(?:u|\\u0075)(?:c|\\u0063)(?:t|\\u0074)(?:o|\\u006[Ff])(?:r|\\u0072)"\s*:/,Ca=/^\s*["[{]|^\s*-?\d[\d.]{0,14}\s*$/;function fa(r,t){if(r!=="__proto__"&&!(r==="constructor"&&t&&typeof t=="object"&&"prototype"in t))return t}function os(r,t={}){if(typeof r!="string")return r;let e=r.toLowerCase().trim();if(e==="true")return!0;if(e==="false")return!1;if(e==="null")return null;if(e==="nan")return Number.NaN;if(e==="infinity")return Number.POSITIVE_INFINITY;if(e!=="undefined"){if(!Ca.test(r)){if(t.strict)throw new SyntaxError("Invalid JSON");return r}try{return ma.test(r)||ga.test(r)?JSON.parse(r,fa):JSON.parse(r)}catch(a){if(t.strict)throw a;return r}}}var Yn=String.fromCharCode;var ya=/#/g,va=/&/g;var Ia=/=/g;var ge=/\+/g,ba=/%5e/gi,wa=/%60/gi;var Aa=/%7c/gi;var Pa=/%20/gi;function Ta(r){return encodeURI(""+r).replace(Aa,"|")}function pe(r){return Ta(typeof r=="string"?r:JSON.stringify(r)).replace(ge,"%2B").replace(Pa,"+").replace(ya,"%23").replace(va,"%26").replace(wa,"`").replace(ba,"^")}function le(r){return pe(r).replace(Ia,"%3D")}function cs(r=""){try{return decodeURIComponent(""+r)}catch{return""+r}}function _a(r){return cs(r.replace(ge," "))}function xa(r){return cs(r.replace(ge," "))}function Sa(r=""){let t={};r[0]==="?"&&(r=r.slice(1));for(let e of r.split("&")){let a=e.match(/([^=]+)=?(.*)/)||[];if(a.length<2)continue;let s=_a(a[1]);if(s==="__proto__"||s==="constructor")continue;let n=xa(a[2]||"");t[s]===void 0?t[s]=n:Array.isArray(t[s])?t[s].push(n):t[s]=[t[s],n]}return t}function ka(r,t){return(typeof t=="number"||typeof t=="boolean")&&(t=String(t)),t?Array.isArray(t)?t.map(e=>`${le(r)}=${pe(e)}`).join("&"):`${le(r)}=${pe(t)}`:le(r)}function Ea(r){return Object.keys(r).filter(t=>r[t]!==void 0).map(t=>ka(t,r[t])).filter(Boolean).join("&")}var Fa=/^[\s\w\0+.-]{2,}:([/\\]{1,2})/,Ma=/^[\s\w\0+.-]{2,}:([/\\]{2})?/,Oa=/^([/\\]\s*){2,}[^/\\]/;function ds(r,t={}){return typeof t=="boolean"&&(t={acceptRelative:t}),t.strict?Fa.test(r):Ma.test(r)||(t.acceptRelative?Oa.test(r):!1)}var Ra=/\/$|\/\?/;function me(r="",t=!1){return t?Ra.test(r):r.endsWith("/")}function Ua(r="",t=!1){if(!t)return(me(r)?r.slice(0,-1):r)||"/";if(!me(r,!0))return r||"/";let[e,...a]=r.split("?");return(e.slice(0,-1)||"/")+(a.length>0?`?${a.join("?")}`:"")}function La(r="",t=!1){if(!t)return r.endsWith("/")?r:r+"/";if(me(r,!0))return r||"/";let[e,...a]=r.split("?");return e+"/"+(a.length>0?`?${a.join("?")}`:"")}function us(r,t){if(Ga(t)||ds(r))return r;let e=Ua(t);return r.startsWith(e)?r:Wa(e,r)}function hs(r,t){let e=ls(r),a={...Sa(e.search),...t};return e.search=Ea(a),Na(e)}function Ga(r){return!r||r==="/"}function Ba(r){return r&&r!=="/"}var Da=/^\.?\//;function Wa(r,...t){let e=r||"";for(let a of t.filter(s=>Ba(s)))if(e){let s=a.replace(Da,"");e=La(e)+s}else e=a;return e}function ls(r="",t){let e=r.match(/^[\s\0]*(blob:|data:|javascript:|vbscript:)(.*)/);if(e){let[,h,l=""]=e;return{protocol:h,pathname:l,href:h+l,auth:"",host:"",search:"",hash:""}}if(!ds(r,{acceptRelative:!0}))return t?ls(t+r):is(r);let[,a="",s,n=""]=r.replace(/\\/g,"/").match(/^[\s\0]*([\w+.-]{2,}:)?\/\/([^/@]+@)?(.*)/)||[],[,i="",c=""]=n.match(/([^#/?]*)(.*)?/)||[],{pathname:u,search:o,hash:d}=is(c.replace(/\/(?=[A-Za-z]:)/,""));return{protocol:a,auth:s?s.slice(0,Math.max(0,s.length-1)):"",host:i,pathname:u,search:o,hash:d}}function is(r=""){let[t="",e="",a=""]=(r.match(/([^#?]*)(\?[^#]*)?(#.*)?/)||[]).splice(1);return{pathname:t,search:e,hash:a}}function Na(r){let t=r.pathname||"",e=r.search?(r.search.startsWith("?")?"":"?")+r.search:"",a=r.hash||"",s=r.auth?r.auth+"@":"",n=r.host||"";return(r.protocol?r.protocol+"//":"")+s+n+t+e+a}var Ce=class extends Error{constructor(){super(...arguments),this.name="FetchError"}};function Ha(r,t,e){let a="";t&&(a=t.message),r&&e?a=`${a} (${e.status} ${e.statusText} (${r.toString()}))`:r&&(a=`${a} (${r.toString()})`);let s=new Ce(a);return Object.defineProperty(s,"request",{get(){return r}}),Object.defineProperty(s,"response",{get(){return e}}),Object.defineProperty(s,"data",{get(){return e&&e._data}}),Object.defineProperty(s,"status",{get(){return e&&e.status}}),Object.defineProperty(s,"statusText",{get(){return e&&e.statusText}}),Object.defineProperty(s,"statusCode",{get(){return e&&e.status}}),Object.defineProperty(s,"statusMessage",{get(){return e&&e.statusText}}),s}var qa=new Set(Object.freeze(["PATCH","POST","PUT","DELETE"]));function ps(r="GET"){return qa.has(r.toUpperCase())}function Qa(r){if(r===void 0)return!1;let t=typeof r;return t==="string"||t==="number"||t==="boolean"||t===null?!0:t!=="object"?!1:Array.isArray(r)?!0:r.constructor&&r.constructor.name==="Object"||typeof r.toJSON=="function"}var $a=new Set(["image/svg","application/xml","application/xhtml","application/html"]),ja=/^application\/(?:[\w!#$%&*.^`~-]*\+)?json(;.+)?$/i;function za(r=""){if(!r)return"json";let t=r.split(";").shift()||"";return ja.test(t)?"json":$a.has(t)||t.startsWith("text/")?"text":"blob"}var Va=new Set([408,409,425,429,500,502,503,504]);function fe(r){let{fetch:t,Headers:e}=r;function a(i){let c=i.error&&i.error.name==="AbortError"||!1;if(i.options.retry!==!1&&!c){let o;typeof i.options.retry=="number"?o=i.options.retry:o=ps(i.options.method)?0:1;let d=i.response&&i.response.status||500;if(o>0&&Va.has(d))return s(i.request,{...i.options,retry:o-1})}let u=Ha(i.request,i.error,i.response);throw Error.captureStackTrace&&Error.captureStackTrace(u,s),u}let s=async function(c,u={}){let o={request:c,options:{...r.defaults,...u},response:void 0,error:void 0};o.options.onRequest&&await o.options.onRequest(o),typeof o.request=="string"&&(o.options.baseURL&&(o.request=us(o.request,o.options.baseURL)),(o.options.query||o.options.params)&&(o.request=hs(o.request,{...o.options.params,...o.options.query})),o.options.body&&ps(o.options.method)&&Qa(o.options.body)&&(o.options.body=typeof o.options.body=="string"?o.options.body:JSON.stringify(o.options.body),o.options.headers=new e(o.options.headers),o.options.headers.has("content-type")||o.options.headers.set("content-type","application/json"),o.options.headers.has("accept")||o.options.headers.set("accept","application/json"))),o.response=await t(o.request,o.options).catch(async h=>(o.error=h,o.options.onRequestError&&await o.options.onRequestError(o),a(o)));let d=(o.options.parseResponse?"json":o.options.responseType)||za(o.response.headers.get("content-type")||"");if(d==="json"){let h=await o.response.text(),l=o.options.parseResponse||os;o.response._data=l(h)}else d==="stream"?o.response._data=o.response.body:o.response._data=await o.response[d]();return o.options.onResponse&&await o.options.onResponse(o),o.response.status>=400&&o.response.status<600?(o.options.onResponseError&&await o.options.onResponseError(o),a(o)):o.response},n=function(c,u){return s(c,u).then(o=>o._data)};return n.raw=s,n.native=t,n.create=(i={})=>fe({...r,defaults:{...r.defaults,...i}}),n}var ms=function(){if(typeof globalThis<"u")return globalThis;if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("unable to locate global object")}(),Ja=ms.fetch||(()=>Promise.reject(new Error("[ofetch] global.fetch is not supported!"))),Ka=ms.Headers,R=fe({fetch:Ja,Headers:Ka});function gs(r,t){return new RegExp(`"${r}":"([^"]+)"`).exec(t)?.[1]}var Cs=async()=>{try{let r=await R("https://bard.google.com/faq",{cache:"reload"}),t=gs("SNlM0e",r),e=gs("cfb2h",r);return{atValue:t,blValue:e}}catch{return{atValue:"",blValue:""}}},fs=r=>{let t=JSON.parse(r.split(`
`)[3]),e=JSON.parse(t[0][2]);return e?{text:e[4][0][1][0],error:"",ids:[...e[1],e[4][0][0]]}:{text:"",error:"Please log into [bard.google.com](https://bard.google.com) and try again.",ids:["","",""]}};var ys=w(_());function Xa(){return Math.floor(Math.random()*9e5)+1e5}var Y=class extends M{constructor(){super("BardChat");this.contextIds=["","",""];this.token=void 0,this.init()}async init(){let e=await j();e&&(this.status=e.ON_BOARDING_RECORD_AI_PROVIDER_HAS_AUTH_BARD?"success":"needAuth")}async checkAuth(){this.active=!0,this.token?await this.updateClientStatus("success"):await this.updateClientStatus("needAuth")}async auth(){this.active=!0,await this.syncBardToken()?await this.updateClientStatus("success"):(await this.updateClientStatus("needAuth"),await ys.default.tabs.create({url:"https://bard.google.com/",active:!0}))}async askChatGPT(e,a,s){this.conversation||await super.createConversation({meta:{AIProvider:"BARD",AIModel:vt[0].value,maxTokens:vt[0].maxTokens}});let{taskId:n}=a||{};if(!this.token){let o=await this.syncBardToken();this.status="needAuth",await this.updateClientStatus(this.status),s?.({type:"error",done:!0,error:"Please log into [bard.google.com](https://bard.google.com) and try again.",data:{text:"",conversationId:""}});return}let i=new AbortController,c=i.signal,u=!1;n&&(this.taskList[n]=()=>i.abort());try{let o=this.chatFiles?.[0],d=[null,JSON.stringify([[JSON.stringify(e),0,null,o?.uploadedUrl?[[[o.uploadedUrl,1],o.fileName]]:[]],null,this.contextIds])],h=await R("https://bard.google.com/_/BardChatUi/data/assistant.lamda.BardFrontendService/StreamGenerate",{method:"POST",signal:c,query:{bl:this.token.blValue,_reqid:Xa(),rt:"c"},body:new URLSearchParams({at:this.token.atValue,"f.req":JSON.stringify(d)}),parseResponse:v=>v}).catch(v=>{if(v?.message.includes("The user aborted a request.")){u=!0,s&&s({type:"error",error:"manual aborted request.",done:!0,data:{text:"",conversationId:""}});return}}).finally(()=>{this.clearFiles()}),{text:l,ids:p,error:m}=fs(h);if(this.log.debug("result",h,l,p),p){if(u)return;m?s&&s({type:"message",done:!0,error:m,data:{text:"",conversationId:this.conversation?.id||""}}):l&&(s&&s({type:"message",done:!1,error:"",data:{text:l,conversationId:this.conversation?.id||""}}),s&&s({type:"message",done:!0,error:"",data:{text:l,conversationId:this.conversation?.id||""}}),this.contextIds=p)}else s&&s({type:"error",done:!0,error:"BardChat: Unknown Error",data:{text:"",conversationId:this.conversation?.id||""}})}catch(o){this.log.error(o)}}async syncBardToken(){let{atValue:e,blValue:a}=await Cs();return!e||!a?(this.token=void 0,!1):(this.token={atValue:e,blValue:a},!0)}reset(){this.contextIds=["","",""]}async uploadFiles(e){this.chatFiles=e,this.chatFiles=await Promise.all(e.map(async a=>{if(a.uploadStatus!=="success"){let[s,n]=Vt(a.file),i=new Blob([s],{type:n}),c={"content-type":"application/x-www-form-urlencoded;charset=UTF-8","push-id":"feeds/mcudyrk2a4khkz","x-goog-upload-header-content-length":a.fileSize.toString(),"x-goog-upload-protocol":"resumable","x-tenant-id":"bard-storage"},o=(await R.raw("https://content-push.googleapis.com/upload/",{method:"POST",headers:{...c,"x-goog-upload-command":"start"},body:new URLSearchParams({[`File name: ${a.fileName}`]:""})})).headers.get("x-goog-upload-url");if(this.log.debug("Bard upload url",o),!o)return a.uploadErrorMessage="Failed to get upload url",a.uploadStatus="error",a;let d=await R.raw(o,{method:"POST",headers:{...c,"x-goog-upload-command":"upload, finalize","x-goog-upload-offset":"0"},body:i});return this.log.debug("Bard upload result",d?._data),d.status===200?(a.uploadedUrl=d._data,a.uploadStatus="success"):(a.uploadErrorMessage="Failed to upload file",a.uploadStatus="error"),a}return a}))}async destroy(){await this.clearFiles(),await this.updateClientStatus("needAuth"),this.active=!1}};function Ya(){return`13.${Lt(104,107)}.${Lt(0,255)}.${Lt(0,255)}`}var vs="https://www.bing.com/turing/conversation/create";async function Is(){let r={"x-ms-client-request-id":g(),"x-ms-useragent":"azsdk-js-api-client-factory/1.0.0-beta.1 core-rest-pipeline/1.10.3 OS/macOS"},t;try{if(t=await R.raw(vs,{headers:r,redirect:"error"}),!t._data?.result)throw new Error("Please sign in to [bing.com](https://bing.com/), complete any required verifications, then try again.")}catch{if(t=await R.raw(vs,{headers:{...r,"x-forwarded-for":Ya()},redirect:"error"}),!t._data)throw new Error("Please sign in to [bing.com](https://bing.com/), complete any required verifications, then try again.")}let e=t._data;if(e.result.value!=="Success"){let n=`${e.result.value}: ${e.result.message}

Please sign in to [bing.com](http://bing.com/), complete any required verifications, then try again.`;throw e.result.value==="UnauthorizedRequest"&&(n+=`
[Log into bing.com to continue.](https://www.bing.com/)`),e.result.value==="Forbidden"&&(n+=`
[Log into bing.com to continue.](https://www.bing.com/)`),new Error(n)}let a=t.headers.get("x-sydney-conversationsignature"),s=t.headers.get("x-sydney-encryptedconversationsignature")||void 0;return e.conversationSignature=e.conversationSignature||a,e.encryptedConversationSignature=s,e}var ye=w(_());var Kt=class{constructor(t,e){this.unpackListeners=[];this.closeListeners=[];this.messageListeners=[];this.id=g(),this.url=t,this.options=e||{}}async init(t){let e=await L(t),a=(await ye.default.tabs.query({active:!0}))?.[0];this.clientTabId=e?.id||a?.id,this.clearListener=H(async(s,n,i)=>{if(s==="client"&&n==="Client_ListenProxyWebsocketResponse"){let{taskId:c,listenerType:u,data:o}=i;if(c===this.id){switch(u){case"onUnpackedMessage":for(let d of this.unpackListeners)d(o);break;case"onClose":for(let d of this.closeListeners)d(o);break;case"onMessage":for(let d of this.messageListeners)d(o)}return{success:!0,message:"ok",data:!0}}}})}async open(t){await this.sendMessageToClient("Open",{url:this.url,mode:t})}async close(){this.removeAllListeners(),await this.sendMessageToClient("Close",{url:this.url}),this.clearListener?.()}async sendPacked(t){await this.sendMessageToClient("SendPacked",t)}removeAllListeners(){this.onMessage.removeAllListeners(),this.onUnpackedMessage.removeAllListeners(),this.onClose.removeAllListeners()}get onUnpackedMessage(){return{addListener:t=>{this.unpackListeners.push(t)},removeListener:t=>{this.unpackListeners=this.unpackListeners.filter(e=>e!==t)},removeAllListeners:()=>{this.unpackListeners=[]}}}get onMessage(){return{addListener:t=>{this.messageListeners.push(t)},removeListener:t=>{this.messageListeners=this.messageListeners.filter(e=>e!==t)},removeAllListeners:()=>{this.messageListeners=[]}}}get onClose(){return{addListener:t=>{this.closeListeners.push(t)},removeListener:t=>{this.closeListeners=this.closeListeners.filter(e=>e!==t)},removeAllListeners:()=>{this.closeListeners=[]}}}async sendMessageToClient(t,e){if(this.clientTabId)try{return await ye.default.tabs.sendMessage(this.clientTabId,{id:C,data:{taskId:this.id,type:t,data:e},event:"Client_ListenProxyWebsocket"})}catch{return await this.close(),null}}};var Za={balanced:"",creative:"h3imaginative",precise:"h3precise"},tn=["nlu_direct_response_filter","deepleo","disable_emoji_spoken_text","responsible_ai_policy_235","enablemm","dv3sugg","iyxapbing","iycapbing","galileo","saharagenconv5","log2sph","savememfilter","uprofgen","uprofupd","uprofupdasy","vidsumsnip"],en=["tnaenableux","adssqovr","tnaenable","arankc_1_9_3","rankcf","0731ziv2s0","926buffall","inosanewsmob","wrapnoins","prechr","sydtransl","806log2sph","927uprofasy","919vidsnip","829suggtrims0"],Xt=class{buildChatRequest(t,e,a){let s=g(),n=Za[t.conversationStyle];return{arguments:[{source:"cib",optionsSets:tn.concat(n||[]),allowedMessageTypes:["Chat","InternalSearchQuery","Disengaged","InternalLoaderMessage","SemanticSerp","GenerateContentQuery","SearchQuery"],sliceIds:en,verbosity:"verbose",scenario:"SERP",plugins:[],isStartOfSession:t.invocationId===0,message:{timestamp:new Date().toISOString(),author:"user",inputMethod:"Keyboard",text:e,imageUrl:a,messageType:"Chat",requestId:s,messageId:s},requestId:s,conversationId:t.conversationId,conversationSignature:t.conversationSignature,participant:{id:t.clientId}}],invocationId:t.invocationId.toString(),target:"chat",type:4}}async doSendMessage(t){if(!this.conversationContext)try{let s=await Is(),n=await q("BING");this.conversationContext={conversationId:s.conversationId,conversationSignature:s.conversationSignature,encryptedConversationSignature:s.encryptedConversationSignature,clientId:s.clientId,invocationId:0,conversationStyle:n?.conversationStyle||"balanced"}}catch(s){t.onEvent({type:"ERROR",error:s.message||s});return}let e=this.conversationContext,a=new Kt(e.encryptedConversationSignature?`wss://sydney.bing.com/sydney/ChatHub?sec_access_token=${encodeURIComponent(e.encryptedConversationSignature)}`:"wss://sydney.bing.com/sydney/ChatHub");await a.init(t.clientTabId),a.onUnpackedMessage.addListener(s=>{for(let n of s)if(JSON.stringify(n)==="{}")a.sendPacked({type:6}),a.sendPacked(this.buildChatRequest(e,t.prompt,t.imageUrl)),e.invocationId+=1;else if(n.type===6)a.sendPacked({type:6});else if(n.type===3)t.onEvent({type:"DONE",data:{conversationId:e.conversationId}}),a.removeAllListeners(),a.close();else if(n.type===1){let i=n.arguments[0]?.messages?.[0],c=i?es(i):"";c&&t.onEvent({type:"UPDATE_ANSWER",data:{text:c,conversationId:e.conversationId}})}else if(n.type===2){let i=n?.item?.messages||[],c=n?.item?.result?.error,u=!1;if(i.some(d=>d.contentOrigin==="TurnLimiter")&&(u=!0,t.onEvent({type:"ERROR",error:"Sorry, you have reached chat turns limit in this conversation."})),c==="User needs to solve CAPTCHA to continue."){u=!0;let d=`

Please visit [bing.com/turing/captcha/challenge](https://www.bing.com/turing/captcha/challenge), complete any required verifications, then try again.`;t.onEvent({type:"ERROR",error:c+d})}if(i.length===0&&n?.item?.result?.value==="UnauthorizedRequest"){u=!0,t.onEvent({type:"ERROR",error:c+`

Please sign in to [bing.com](http://bing.com/), complete any required verifications, then try again.`});return}u&&(this.conversationContext=void 0)}}),a.onClose.addListener(()=>{t.onEvent({type:"DONE",data:{conversationId:e.conversationId}})}),t.signal?.addEventListener("abort",()=>{a.removeAllListeners(),a.close(),t.onEvent({type:"ERROR",error:"manual aborted request."})}),await a.open("bing"),await a.sendPacked({protocol:"json",version:1})}resetConversation(){this.conversationContext=void 0}};var Z=class extends M{constructor(){super("BingChat");this.bingLib=new Xt,this.status="success",this.init()}async init(){this.log.info("init");let e=await j();e&&(this.status=e.ON_BOARDING_RECORD_AI_PROVIDER_HAS_AUTH_BING?"success":"needAuth")}async auth(){this.active=!0,await this.updateClientStatus("success")}async askChatGPT(e,a,s){let{taskId:n,clientTabId:i}=a||{};this.log.info("askChatGPT");let c=new AbortController,u=c.signal;n&&(this.taskList[n]=()=>c.abort());let o=this.chatFiles?.[0];await We("wss://*.bing.com/")||s?.({type:"error",done:!0,error:"Missing bing.com permission",data:{text:"Missing bing.com permission",conversationId:""}}),await this.bingLib.doSendMessage({clientTabId:i,prompt:e,imageUrl:o?.uploadedUrl,signal:u,onEvent:d=>{d.type==="ERROR"?(s?.({type:"error",done:!0,error:d.error,data:{text:"",conversationId:""}}),n&&(this.abortTask(n),this.bingLib.resetConversation())):d.type==="UPDATE_ANSWER"?s?.({type:"message",done:!1,error:"",data:{text:d.data.text,conversationId:d.data.conversationId}}):d.type==="DONE"&&s?.({type:"message",done:!0,error:"",data:{text:"",conversationId:d.data.conversationId}})}}),await this.clearFiles()}async uploadFiles(e){this.chatFiles=e,this.chatFiles=await Promise.all(e.map(async a=>{if(a.uploadStatus!=="success"&&a.base64Data){try{let s=new FormData;s.append("knowledgeRequest",JSON.stringify({imageInfo:{},knowledgeRequest:{invokedSkills:["ImageById"],subscriptionId:"Bing.Chat.Multimodal.Underside",invokedSkillsRequestData:{enableFaceBlur:!0},convoData:{convoid:"",convotone:"Balanced"}}})),s.append("imageBase64",a.base64Data.replace("data:","").replace(/^.+,/,""));let n=await R("https://www.bing.com/images/kblob",{method:"POST",body:s});n?.blobId?(a.uploadedUrl=`https://www.bing.com/images/blob?bcid=${n.blobId}`,a.uploadStatus="success"):(a.uploadStatus="error",a.uploadErrorMessage="Failed to upload image"),this.log.info("uploadFiles",a)}catch(s){a.uploadStatus="error",a.uploadErrorMessage="Failed to upload image",this.log.error("uploadFiles",s,a)}return a}return a}))}async removeConversation(){return this.bingLib.resetConversation(),Promise.resolve(!0)}async destroy(){this.bingLib.resetConversation(),await this.clearFiles()}};var Bs=w(pa()),Ds=w(_());var Us=w(Ss());var ks=`query ChatViewQuery($bot: String!) {
  chatOfBot(bot: $bot) {
    id
    chatId
    defaultBotNickname
    shouldShowDisclaimer
  }
}
`;var Es=`mutation AddMessageBreakMutation($chatId: BigInt!) {
  messageBreakCreate(chatId: $chatId) {
    message {
      id
      __typename
      messageId
      text
      linkifiedText
      authorNickname
      state
      vote
      voteReason
      creationTime
      suggestedReplies
    }
  }
}
`;var Fs=`mutation chatHelpers_sendMessageMutation_Mutation(
  $chatId: BigInt!
  $bot: String!
  $query: String!
  $source: MessageSource
  $withChatBreak: Boolean!
) {
  messageEdgeCreate(chatId: $chatId, bot: $bot, query: $query, source: $source, withChatBreak: $withChatBreak) {
    chatBreak {
      cursor
      node {
        id
        messageId
        text
        author
        suggestedReplies
        creationTime
        state
      }
      id
    }
    message {
      cursor
      node {
        id
        messageId
        text
        author
        suggestedReplies
        creationTime
        state
        chat {
          shouldShowDisclaimer
          id
        }
      }
      id
    }
  }
}
`;var Ms=`mutation subscriptionsMutation($subscriptions: [AutoSubscriptionQuery!]!) {
  autoSubscribe(subscriptions: $subscriptions) {
    viewer {
      id
    }
  }
}
`;var Os=`subscription messageAdded($chatId: BigInt!) {
  messageAdded(chatId: $chatId) {
    id
    messageId
    creationTime
    state
    ...ChatMessage_message
    ...chatHelpers_isBotMessage
  }
}

fragment ChatMessageDownvotedButton_message on Message {
  ...MessageFeedbackReasonModal_message
  ...MessageFeedbackOtherModal_message
}

fragment ChatMessageDropdownMenu_message on Message {
  id
  messageId
  vote
  text
  linkifiedText
  ...chatHelpers_isBotMessage
}

fragment ChatMessageFeedbackButtons_message on Message {
  id
  messageId
  vote
  voteReason
  ...ChatMessageDownvotedButton_message
}

fragment ChatMessageOverflowButton_message on Message {
  text
  ...ChatMessageDropdownMenu_message
  ...chatHelpers_isBotMessage
}

fragment ChatMessageSuggestedReplies_SuggestedReplyButton_message on Message {
  messageId
}

fragment ChatMessageSuggestedReplies_message on Message {
  suggestedReplies
  ...ChatMessageSuggestedReplies_SuggestedReplyButton_message
}

fragment ChatMessage_message on Message {
  id
  messageId
  text
  author
  linkifiedText
  state
  ...ChatMessageSuggestedReplies_message
  ...ChatMessageFeedbackButtons_message
  ...ChatMessageOverflowButton_message
  ...chatHelpers_isHumanMessage
  ...chatHelpers_isBotMessage
  ...chatHelpers_isChatBreak
  ...chatHelpers_useTimeoutLevel
  ...MarkdownLinkInner_message
}

fragment MarkdownLinkInner_message on Message {
  messageId
}

fragment MessageFeedbackOtherModal_message on Message {
  id
  messageId
}

fragment MessageFeedbackReasonModal_message on Message {
  id
  messageId
}

fragment chatHelpers_isBotMessage on Message {
  ...chatHelpers_isHumanMessage
  ...chatHelpers_isChatBreak
}

fragment chatHelpers_isChatBreak on Message {
  author
}

fragment chatHelpers_isHumanMessage on Message {
  author
}

fragment chatHelpers_useTimeoutLevel on Message {
  id
  state
  text
  messageId
}
`;var Rs=`subscription viewerStateUpdated {
  viewerStateUpdated {
    id
    ...ChatPageBotSwitcher_viewer
  }
}

fragment BotHeader_bot on Bot {
  displayName
  messageLimit {
    dailyLimit
  }
  ...BotImage_bot
}

fragment BotImage_bot on Bot {
  image {
    __typename
    ... on LocalBotImage {
      localName
    }
    ... on UrlBotImage {
      url
    }
  }
  displayName
}

fragment BotLink_bot on Bot {
  displayName
}

fragment ChatPageBotSwitcher_viewer on Viewer {
  availableBots {
    id
    messageLimit {
      dailyLimit
    }
    ...BotLink_bot
    ...BotHeader_bot
  }
  allowUserCreatedBots: booleanGate(gateName: "enable_user_created_bots")
}
`;var be={AddMessageBreakMutation:Es,ChatViewQuery:ks,SendMessageMutation:Fs,SubscriptionsMutation:Ms,MessageAddedSubscription:Os,ViewerStateUpdatedSubscription:Rs};async function un(){let e=(await R("https://poe.com",{parseResponse:i=>i})).match(/<script>if(.+)throw new Error;(.+),window.+<\/script>/)[2],a=e.match(/var .="(\w+)"/)[1],s=Array.from(e.matchAll(/\[(\d+)\]=.\[(\d+)\]/g)).map(i=>[Number(i[1]),Number(i[2])]),n=Array(s.length);for(let[i,c]of s)n[i]=a[c];return n.join("")}async function Ls(){let[r,t]=await Promise.all([R("https://poe.com/api/settings"),un().catch(e=>{throw new Error("Failed to get formkey")})]);return r.formkey=t,r}async function At(r,t,e){let s={query:be[r],variables:t},n=(0,Us.default)(JSON.stringify(s)+e.formkey+"WpuLMiXEKKE98j56k");return R("https://poe.com/api/gql_POST",{method:"POST",body:s,headers:{"poe-formkey":e.formkey,"poe-tag-id":n,"poe-tchannel":e.tchannelData.channel}})}async function Gs(r,t){let e=await At("ChatViewQuery",{bot:r},t);if(!e.data)throw new Error("[Log into poe.com to continue.](https://www.poe.com)");return e.data.chatOfBot.chatId}async function hn(r){return Ds.default.permissions.request({origins:[r]})}var Yt=class{async doSendMessage(t){if(!await hn("https://*.poe.com/")){t.onEvent({type:"ERROR",error:"Missing poe.com permission."});return}if(!this.conversationContext){let s=await Nt(),{poeModel:n}={poeModel:s.thirdProviderSettings?.CLAUDE?.model||"a2"};try{let{poeSettings:i,chatId:c}=await this.getChatInfo(n),u=await this.connectWebsocket(i);await this.subscribe(i),this.conversationContext={botId:n,chatId:c,poeSettings:i,wsp:u}}catch(i){t.onEvent({type:"ERROR",error:i.message});return}}let e=this.conversationContext.wsp,a=s=>{let n=s.messages.map(i=>JSON.parse(i));for(let i of n)if(i.message_type==="subscriptionUpdate"&&i.payload.subscription_name==="messageAdded"){let c=i.payload.data.messageAdded;t.onEvent({type:"UPDATE_ANSWER",data:{text:c.text,conversationId:String(this.conversationContext?.chatId||"")}}),c.state==="complete"&&(t.onEvent({type:"DONE",data:{conversationId:String(this.conversationContext?.chatId||"")}}),e.onUnpackedMessage.removeAllListeners())}};e.onUnpackedMessage.addListener(a);try{await e.open()}catch{e.removeAllListeners(),e.close(),t.onEvent({type:"ERROR",error:"Please ensure [you've logged into poe.com](https://www.poe.com) and retry."});return}try{await this.sendMessageRequest(t.prompt)}catch(s){e.removeAllListeners(),e.close(),t.onEvent({type:"ERROR",error:s.message})}}resetConversation(){if(!this.conversationContext)return;let t=this.conversationContext.wsp;t.removeAllListeners(),t.close(),this.sendChatBreak(),this.conversationContext=void 0}async getChatInfo(t){let e=await Ls(),a=await Gs(t,e);return{poeSettings:e,chatId:a}}async sendMessageRequest(t){let{poeSettings:e,botId:a,chatId:s}=this.conversationContext;if(!(await At("SendMessageMutation",{bot:a,chatId:s,query:t,source:null,withChatBreak:!1},e)).data.messageEdgeCreate.message)throw new Error("You\u2019ve reached the daily free message limit for this model")}async sendChatBreak(){let{chatId:t,poeSettings:e}=this.conversationContext;await At("AddMessageBreakMutation",{chatId:t},e)}async subscribe(t){await At("SubscriptionsMutation",{subscriptions:[{subscriptionName:"messageAdded",query:be.MessageAddedSubscription}]},t)}async getWebsocketUrl(t){let e=`tch${Math.floor(Math.random()*1e6)+1}`,a=t.tchannelData;return`wss://${e}.tch.${a.baseHost}/up/${a.boxName}/updates?min_seq=${a.minSeq}&channel=${a.channel}&hash=${a.channelHash}`}async connectWebsocket(t){let e=await this.getWebsocketUrl(t);return new Bs.default(e,{packMessage:s=>JSON.stringify(s),unpackMessage:s=>JSON.parse(s)})}};var Pt=class extends M{constructor(){super("PoeChat");this.poeLib=new Yt,this.status="success",this.init()}async init(){this.log.info("init");let e=await j();e&&(this.status=e.ON_BOARDING_RECORD_AI_PROVIDER_HAS_AUTH_POE?"success":"needAuth")}async auth(){this.active=!0,await this.updateClientStatus("success")}async askChatGPT(e,a,s){let{taskId:n}=a||{};this.log.info("askChatGPT");let i=new AbortController,c=i.signal;n&&(this.taskList[n]=()=>i.abort()),await this.poeLib.doSendMessage({prompt:e,signal:c,onEvent(u){u.type==="ERROR"?s?.({type:"error",done:!0,error:u.error,data:{text:"",conversationId:""}}):u.type==="UPDATE_ANSWER"?s?.({type:"message",done:!1,error:"",data:{text:u.data.text,conversationId:u.data.conversationId}}):u.type==="DONE"&&s?.({type:"message",done:!0,error:"",data:{text:"",conversationId:u.data.conversationId}})}})}resetConversation(){this.poeLib.resetConversation()}};var Tt=async()=>{try{return(await(await fetch("https://claude.ai/api/organizations",{redirect:"error",cache:"no-cache"})).json())?.[0]?.uuid}catch{return""}},Ws=async(r,t)=>{try{if(!r)return;let e=g(),a=await fetch(`https://claude.ai/api/organizations/${r}/chat_conversations`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t||"",uuid:e})});if(a.status===201||a.status===200){let s=await a.json();return s.uuid?s:void 0}else return}catch{return}},ln=async r=>{try{let t=await fetch(`https://claude.ai/api/organizations/${r}/chat_conversations`,{method:"GET"});if(t.status===200){let e=await t.json();return e.length?e:[]}return[]}catch{return[]}},Ns=async(r,t)=>{let e=await ln(r);e=e.filter(s=>s.name===t);let a=[];for(;e.length;)a=e.splice(0,5).map(s=>s.uuid),await Promise.all(a.map(s=>we(r,s))),await new Promise(s=>setTimeout(s,5e3))},we=async(r,t)=>{try{let e=await fetch(`https://claude.ai/api/organizations/${r}/chat_conversations/${t}`,{method:"DELETE"});return e.status===204||e.status===200}catch{return!1}},Hs=async(r,t,e)=>{let a=new FormData;a.append("file",t,e||t?.name||""),a.append("orgUuid",r);let s=await fetch("https://claude.ai/api/convert_document",{method:"POST",body:a});if(s.status===200){let i=await s.json();if(i.extracted_content)return i.file_name=e||t?.name||i.file_name||"",{success:!0,data:i,error:""}}let n="Upload failed.";return s.status===429&&(n="Exceeded file upload rate limit"),{success:!1,data:void 0,error:n}};var Zt=class{constructor(t){this.attachments=[];this.organizationId=t}get conversationId(){return this.conversation?.uuid}async createConversation(t){return this.organizationId||(this.organizationId=await Tt()),this.organizationId&&(this.conversation=await Ws(this.organizationId,t)),this.conversation?.uuid||""}async sendMessage(t,e){let{regenerate:a=!1,onMessage:s}=e||{},n=this.conversation?.uuid;if((!n||!this.organizationId)&&(n=await this.createConversation(),!n||!this.organizationId)){s?.({completion:"",log_id:"",messageLimit:{type:"within_limit"},model:"",stop:!0,stop_reason:"Please log into [Claude.ai](https://claude.ai/chats) and try again."});return}this.abortController=new AbortController;let i=this.abortController.signal,c=a?"https://claude.ai/api/retry_message":"https://claude.ai/api/append_message";a&&(t=""),await ut(c,{signal:i,method:"POST",provider:"CLAUDE",headers:{"Content-Type":"application/json"},body:JSON.stringify({attachments:this.attachments.map(u=>{let o=Fe(u);return delete o.id,o}),completion:{incremental:!0,model:"claude-2",prompt:t,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone},conversation_uuid:n,organization_uuid:this.organizationId,text:t}),onMessage:u=>{try{let o=JSON.parse(u);if(o.log_id)s?.(o);else if(o?.error?.message){let d=o?.error?.message||"Network Error";d==="Overloaded"&&(d="You've sent too many requests to the Claude model. You can continue with the other AI Providers now, or try again later."),s?.({completion:"",log_id:"",messageLimit:{type:"within_limit"},model:"",stop:!0,stop_reason:d})}}catch{}}}).then(()=>{}).catch(u=>{if(u?.message==="BodyStreamBuffer was aborted"||u?.message==="The user aborted a request."){s?.({completion:"",log_id:"",messageLimit:{type:"within_limit"},model:"",stop:!0,stop_reason:"The user aborted a request."});return}try{let o=JSON.parse(u.message),d=o?.error?.message||o?.message||"Network Error";s?.({completion:"",log_id:"",messageLimit:{type:"within_limit"},model:"",stop:!0,stop_reason:d})}catch{s?.({completion:"",log_id:"",messageLimit:{type:"within_limit"},model:"",stop:!0,stop_reason:"Network Error"})}}),this.resetAttachments()}abortSendMessage(){this.abortController?.abort()}async resetConversation(){if(this.conversation?.uuid&&this.organizationId){let t=await we(this.organizationId,this.conversation.uuid)}return this.conversation=void 0,!0}async uploadAttachment(t,e){if(!this.organizationId&&(this.organizationId=await Tt(),!this.organizationId))return{success:!1,error:"organization id not found",data:void 0};if(t.size>10*1024*1024)return{success:!1,error:"file size too large",data:void 0};let a=await Hs(this.organizationId,t,e||t.name);if(a.success&&a.data){let s=a.data;return s.id=g(),this.attachments.push(s),{success:!0,error:void 0,data:s}}else return{success:!1,error:a.error||"Upload failed.",data:void 0}}resetAttachments(){return this.attachments=[],!0}removeAttachment(t){let e=this.attachments.findIndex(a=>a.id===t);return e>-1&&this.attachments.splice(e,1),!0}};var mt=w(_());var pt="CHROME_EXTENSION_LOCAL_STORAGE_CLAUDE_TOKEN_KEY",qs="MaxAI.me",tt=class extends M{constructor(){super("ClaudeChat");this.claude=new Zt,this.status="needAuth"}async init(){this.log.info("init")}async preAuth(){this.active=!0;let e=await mt.default.storage.local.get(pt);e[pt]&&(this.claude.organizationId=e[pt]),this.status=this.claude.organizationId?"success":"needAuth",await this.updateClientStatus(this.status)}async auth(){this.active=!0,this.claude.organizationId=await Tt(),this.claude.organizationId?(this.status="success",await mt.default.storage.local.set({[pt]:this.claude.organizationId}),await this.updateClientStatus("success")):await mt.default.tabs.create({url:"https://claude.ai/chats",active:!0})}async createConversation(e){if(this.conversation||await super.createConversation(e),this.conversation?.meta.AIConversationId)return this.conversation.id;let a=await this.claude.createConversation(qs);return this.claude.organizationId?await mt.default.storage.local.set({[pt]:this.claude.organizationId}):(await mt.default.storage.local.remove(pt),this.status="needAuth",await this.updateClientStatus("needAuth")),this.conversation&&(this.conversation.meta.AIConversationId=a,await P.conversationDB.addOrUpdateConversation(this.conversation)),this.conversation?.id||""}async askChatGPT(e,a,s){let{regenerate:n}=a||{},i="";this.log.info("ClaudeChat send"),await this.claude.sendMessage(e,{regenerate:n,onMessage:c=>{c.stop?c.stop_reason==="stop_sequence"?s?.({type:"message",done:!0,error:"",data:{text:i,conversationId:this.claude.conversationId}}):c.stop_reason==="The user aborted a request."?s?.({type:"error",error:"manual aborted request.",done:!0,data:{text:"",conversationId:this.claude.conversationId}}):s?.({type:"error",done:!0,error:c.stop_reason||"Network Error",data:{text:i,conversationId:this.claude.conversationId}}):(i+=c.completion||"",s?.({type:"message",done:!1,error:"",data:{text:i,conversationId:this.claude.conversationId}}))}}),await this.clearFiles()}async abortTask(e){return this.claude.abortSendMessage(),!0}async removeConversation(){this.conversation=void 0,await this.claude.resetConversation(),this.claude.organizationId&&Ns(this.claude.organizationId,qs).then().catch()}async getUploadFileToken(){return this.claude.organizationId||await this.auth(),this.claude.organizationId}async uploadFiles(e){this.chatFiles=e,this.chatFiles=await Promise.all(e.map(async a=>{if(a.uploadStatus!=="success"){let[s,n]=Vt(a.file),i=new Blob([s],{type:n});if(n.includes("pdf")){let c=await this.claude.uploadAttachment(i,a.fileName);return c.success&&c.data?{...a,id:c.data.id,file:void 0,uploadStatus:"success",uploadProgress:100}:{...a,file:void 0,uploadStatus:"error",uploadProgress:0,uploadErrorMessage:c.error}}else{let c=await i.text(),u={id:g(),extracted_content:c,file_name:a.fileName,file_size:a.fileSize,file_type:n,totalPages:1};return this.claude.attachments.push(u),{...a,id:u.id,file:void 0,uploadStatus:"success",uploadProgress:100}}}return a}))}async removeFiles(e){return await super.removeFiles(e),e.forEach(a=>{this.claude.removeAttachment(a)}),!0}async destroy(){await this.clearFiles(),this.claude.resetAttachments(),this.status="needAuth",await this.updateClientStatus("needAuth"),this.active=!1}};var Qs=w(_());var pn=new G("Background/Chat/ChatSystem"),_t=class{constructor(){this.adapters={};this.sendQuestion=(t,e,a,s)=>this.currentAdapter?.sendQuestion(t,e,a,s)||Promise.resolve();this.initChatSystem()}get conversation(){return this.currentAdapter?.conversation}get status(){return this.currentAdapter?this.currentAdapter.status:"needAuth"}get currentAdapter(){return this.currentProvider?this.adapters[this.currentProvider]:void 0}get chatFiles(){return this.currentAdapter?.chatFiles||[]}initChatSystem(){H(async(t,e,a,s)=>{if(t==="client")switch(e){case"Client_switchAIProvider":{let{provider:n}=a;return await this.switchAdapter(n),{success:!0,data:{provider:n},message:""}}break;case"Client_authChatGPTProvider":{let{provider:n}=a;return await this.switchAdapter(n),await this.auth(s.tab?.id||0),{success:!0,data:{},message:""}}case"Client_checkChatGPTStatus":return{success:!0,data:{status:this.status},message:""};case"Client_createChatGPTConversation":{let n=a.initConversationData||{};n.meta.AIProvider&&this.currentProvider!==n.meta.AIProvider&&await this.switchAdapter(n.meta.AIProvider);let i=await this.createConversation(n||{});return i?{success:!0,data:{conversationId:i},message:""}:{success:!1,data:{conversationId:i},message:"create conversation failed"}}case"Client_changeConversation":{let{conversationId:n}=a;if(n){let i=await P.conversationDB.getConversationById(n);if(i)return await this.switchAdapterWithConversation(i),{success:!0,data:{conversationId:n}}}return{success:!1,data:{},message:""}}case"Client_askChatGPTQuestion":{let n=a.taskId,i=a.question,c=a.options;if(i.conversationId){let u=await P.conversationDB.getConversationById(i.conversationId);if(u){u?.meta?.AIProvider&&u.meta.AIProvider!==this.currentProvider?await this.switchAdapterWithConversation(u):u.id&&await this.currentAdapter?.createConversation(u);let o=await ze(u,i,c);i=o.question,c=o.options,await this.updateClientConversationMessages(u.id)}}await this.sendQuestion(n,s,i,c),this.updateClientFiles()}break;case"Client_removeChatGPTConversation":{let{conversationId:n}=a,i=await this.removeConversation(n||"");return await this.updateClientConversationMessages(n),{success:i,data:{},message:""}}case"Client_abortAskChatGPTQuestion":{let{messageId:n}=a;return await this.abortAskQuestion(n),{success:!0,data:{},message:""}}case"Client_destroyWithLogout":return await this.destroy(),{success:!0,data:{},message:""};case"Client_chatGetFiles":return{success:!0,data:this.chatFiles,message:""};case"Client_chatUploadFiles":{let{files:n}=a;return await this.uploadFiles(n),this.updateClientFiles(),{success:!0,data:this.chatFiles,message:""}}break;case"Client_chatAbortUploadFiles":{let{files:n}=a,i=await this.abortUploadFiles(n.map(c=>c.id));return this.updateClientFiles(),{success:i,data:this.chatFiles,message:""}}break;case"Client_chatRemoveFiles":{let{files:n}=a,i=await this.removeFiles(n.map(c=>c.id));return this.updateClientFiles(),{success:i,data:this.chatFiles,message:""}}break;case"Client_chatClearFiles":{let n=await this.clearFiles();return this.updateClientFiles(),{success:n,data:this.chatFiles,message:""}}break;case"Client_chatUploadFilesChange":{let{files:n}=a;return await this.updateFiles(n),await this.updateClientFiles(),{success:!0,data:{},message:"ok"}}break;case"Client_chatGetUploadFileToken":return{success:!0,data:await this.getUploadFileToken(),message:"ok"};default:break}}),Nt().then(async t=>{t.currentAIProvider&&await this.switchAdapter(t.currentAIProvider)})}addAdapter(t,e){this.adapters[t]=e}async switchAdapter(t){this.currentProvider=t,await Qe({currentAIProvider:t}),await this.preAuth();try{Qs.default.runtime.setUninstallURL(`${Rt}/survey/uninstall?version=${V}&provider=${t}`)}catch(e){pn.error("switchAdapter","setUninstallURL",e)}return await U("Client_updateAppSettings",{data:{}}),this.currentAdapter}async auth(t){if(this.currentAdapter){await this.currentAdapter.auth(t);let e=await j(),a=`ON_BOARDING_RECORD_AI_PROVIDER_HAS_AUTH_${this.currentProvider}`;Object.prototype.hasOwnProperty.call(e,a)&&await Be(a,!0)}}async preAuth(){if(this.currentAdapter){let t=await j(),e=`ON_BOARDING_RECORD_AI_PROVIDER_HAS_AUTH_${this.currentProvider}`;Object.prototype.hasOwnProperty.call(t,e)?t[e]?await this.currentAdapter.preAuth():await U("Client_ChatGPTStatusUpdate",{status:"needAuth"}):await this.currentAdapter.preAuth()}}async abortAskQuestion(t){return this.currentAdapter?await this.currentAdapter.abortAskQuestion(t):!1}async createConversation(t){return this.currentAdapter&&await this.currentAdapter?.createConversation(t)||""}async removeConversation(t){if(!this.currentAdapter||!t)return!1;let e=await P.conversationDB.getConversationById(t);return e&&await this.switchAdapterWithConversation(e,!1),await this.currentAdapter?.removeConversation(t)}async destroy(){await this.currentAdapter?.removeConversation(""),await this.currentAdapter?.destroy(),await this.currentAdapter?.clearFiles()}async uploadFiles(t){if(this.currentAdapter)return await this.currentAdapter.uploadFiles(t)}async updateFiles(t){if(this.currentAdapter)return await this.currentAdapter.updateFiles(t)}async abortUploadFiles(t){return this.currentAdapter?await this.currentAdapter.abortUploadFiles(t):!1}async removeFiles(t){return this.currentAdapter?await this.currentAdapter.removeFiles(t):!1}async getFiles(){return this.chatFiles}async getUploadFileToken(){return this.currentAdapter?await this.currentAdapter.getUploadFileToken():null}async clearFiles(){return this.currentAdapter?await this.currentAdapter.clearFiles():!1}async updateClientFiles(){U("Client_listenUploadFilesChange",{files:this.chatFiles})}async updateClientConversationMessages(t){let e=await P.getClientConversation(t);U("Client_listenUpdateConversationMessages",{conversation:e,conversationId:t})}async switchAdapterWithConversation(t,e=!0){let a=t.meta.AIProvider;if(a){let s=await q(a);await je(a,{...s,model:t.meta.AIModel||s?.model}),await this.switchAdapter(a),await this.currentAdapter?.createConversation(t),e&&await this.updateClientConversationMessages(t.id)}}};var Ae=w(_());var $=new G("Background/Chat/MaxAIClaudeChat"),et=class extends M{constructor(){super("MaxAIClaudeChat");this.status="needAuth";this.init()}init(){$.info("init")}async preAuth(){this.active=!0,await this.checkTokenAndUpdateStatus()}async auth(e){this.active=!0,this.lastActiveTabId=e,await this.checkTokenAndUpdateStatus(),this.status==="needAuth"&&await Ae.default.tabs.create({active:!0,url:Ut}),await this.updateClientStatus()}async checkTokenAndUpdateStatus(){let e=this.status;this.token=await this.getToken(),this.status=this.token?"success":"needAuth",e!==this.status&&($.info("checkTokenAndUpdateStatus",this.status,this.lastActiveTabId),this.lastActiveTabId=void 0),await this.updateClientStatus()}async askChatGPT(e,a,s){if(await this.checkTokenAndUpdateStatus(),this.status!=="success"){s&&s({type:"error",done:!0,error:"Your session has expired. Please log in.",data:{text:"",conversationId:""}});return}let{taskId:n,streaming:i=!0,regenerate:c=!1,chat_history:u=[],meta:o}=a||{},d=await q("MAXAI_CLAUDE"),h=Object.assign({chat_history:u,regenerate:c,streaming:i,message_content:e,chrome_extension_version:V,model_name:this.conversation?.meta.AIModel||d.model||Wt[0].value,prompt_id:o?.contextMenu?.id||"chat",prompt_name:o?.contextMenu?.text||"chat"}),l=new AbortController,p=l.signal;n&&(this.taskList[n]=()=>l.abort()),$.info("streaming start",h);let m="",v=!1,I=!1,f=0,B=this.conversation?.id||"",D=(await Ae.default.storage.local.get(dt))[dt]||{},Ct=D.interval||50,ft=D.rate||.5,Et=E=>new Promise(A=>setTimeout(A,E)),yt=async()=>{if(I)return;if(v&&f===m.length){$.info("streaming end success"),s&&s({done:!0,type:"message",error:"",data:{text:"",conversationId:B}});return}let E=0,A=Math.floor(m.length-f);if(v){let T=Math.max(Math.floor(m.length*.1),10);E=m.slice(f,T+f).length}else{let T=Math.floor(A*ft);E=m.slice(f,T+f).length}E>0&&($.debug("streaming echo message",v?"\u4E00\u79D2\u53D1\u9001\u5B8C\u5269\u4E0B\u7684\u6587\u672C":`\u6BCF${Ct}\u6BEB\u79D2\u53D1\u9001\u5269\u4F59\u6587\u672C\u7684${(ft*100).toFixed(0)}%`,f,E,m.length),f+=E,s&&s({type:"message",done:!1,error:"",data:{text:m.slice(0,f),conversationId:B}})),await Et(v?100:Ct),await yt()};yt();let Ft=!1;await ut(`${ct}/gpt/get_claude_response`,{provider:W.USE_CHAT_GPT_PLUS,method:"POST",signal:p,headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify(h),onMessage:E=>{try{let A=JSON.parse(E);A?.conversation_id&&(B=A.conversation_id),A?.text&&(m+=A.text),$.debug("streaming on message",m)}catch(A){$.error("parse message.data error: 	",A)}}}).then().catch(E=>{if($.info("streaming end error",E),v=!0,I=!0,E?.message==="BodyStreamBuffer was aborted"||E?.message==="The user aborted a request."){s&&s({type:"error",error:"manual aborted request.",done:!0,data:{text:"",conversationId:B}});return}try{let A=JSON.parse(E.message||E);if(A.msg&&qt(A.msg)){s&&s({type:"error",error:A.msg,done:!0,data:{text:"",conversationId:B}});return}A?.code===401&&(Ft=!0),$.error("sse error",E),s&&s({done:!0,type:"error",error:A.message||A.detail||"Network error.",data:{text:"",conversationId:B}})}catch{s&&s({done:!0,type:"error",error:"Network error.",data:{text:"",conversationId:B}})}}),v||($.info("streaming end success"),m===""?(Jt("[API] response empty string.",JSON.stringify({model:h.model_name,promptTextLength:h.message_content.length},null,2),{uuid:"6f02f533-def6-4696-b14e-1b00c2d9a4df"}),s&&s({done:!0,type:"error",error:"Something went wrong, please try again. If this issue persists, contact us via email.",data:{text:"",conversationId:B}})):v=!0),Ft&&($.info("user token expired"),this.status="needAuth",await ht(),await this.updateClientStatus())}async abortTask(e){return this.taskList[e]&&(this.taskList[e](),delete this.taskList[e]),!0}async destroy(){$.info("destroy"),this.status="needAuth",this.active=!1}async getToken(){return await lt()}async updateClientStatus(){this.active&&await U("Client_ChatGPTStatusUpdate",{status:this.status})}};var xt=class{constructor(t){this.sendQuestion=(t,e,a,s)=>this.openAIChat.sendQuestion(t,e,a,s);this.openAIChat=t}async preAuth(){return this.openAIChat.preAuth()}async auth(t){await this.openAIChat.auth(t)}get status(){return this.openAIChat.status}get conversation(){return this.openAIChat.conversation}async abortAskQuestion(t){return await this.openAIChat.abortAskQuestion(t)}async createConversation(t){return t?.id&&this.openAIChat.conversation?.id&&t.id!==this.openAIChat.conversation.id&&await this.openAIChat.removeConversation(this.openAIChat.conversation.id),await this.openAIChat.createConversation(t)}async removeConversation(t){return await this.openAIChat.removeConversation(t)}destroy(){return this.openAIChat.destroy()}get chatFiles(){return this.openAIChat.chatFiles}async uploadFiles(t){return await this.openAIChat.uploadFiles(t)}async updateFiles(t){return await this.openAIChat.updateFiles(t)}async removeFiles(t){return await this.openAIChat.removeFiles(t)}async getFiles(){return await this.openAIChat.getFiles()}async getUploadFileToken(){return await this.openAIChat.getUploadFileToken()}async abortUploadFiles(t){return await this.openAIChat.abortUploadFiles(t)}async clearFiles(){return await this.openAIChat.clearFiles()}};var k=class{constructor(t){this.sendQuestion=(t,e,a,s)=>this.chatAdapter.sendQuestion(t,e,a,s);this.chatAdapter=t}async preAuth(){await this.chatAdapter.preAuth()}async auth(t){await this.chatAdapter.auth(t)}get status(){return this.chatAdapter.status}get conversation(){return this.chatAdapter.conversation}async abortAskQuestion(t){return await this.chatAdapter.abortAskQuestion(t)}async destroy(){await this.chatAdapter.destroy()}async createConversation(t){return await this.chatAdapter.createConversation(t)}async removeConversation(t){return await this.chatAdapter.removeConversation(t)}get chatFiles(){return this.chatAdapter.chatFiles}async getUploadFileToken(){return await this.chatAdapter.getUploadFileToken()}async updateFiles(t){await this.chatAdapter.updateFiles(t)}async uploadFiles(t){return await this.chatAdapter.uploadFiles(t)}async abortUploadFiles(t){return await this.chatAdapter.abortUploadFiles(t)}async removeFiles(t){return await this.chatAdapter.removeFiles(t)}async getFiles(){return await this.chatAdapter.getFiles()}async clearFiles(){return await this.chatAdapter.clearFiles()}};var $s=w(_());var st=class{constructor(t){this.sendQuestion=async(t,e,a,s)=>{let n=g(),i=[{role:"system",content:this.openAiApiChat.conversation?.meta.systemPrompt||qe}];s.historyMessages?.forEach(c=>{i.push({role:c.type==="ai"?"assistant":"user",content:c.text})}),await this.openAiApiChat.askChatGPT(a.question,{taskId:a.messageId,regenerate:s.regenerate,include_history:s.includeHistory,max_history_message_cnt:s.maxHistoryMessageCnt,history:i,meta:s.meta},async({type:c,done:u,error:o,data:d})=>{e.tab?.id&&await this.sendResponseToClient(e.tab.id,{taskId:t,data:{text:d.text,parentMessageId:a.messageId,conversationId:d.conversationId,messageId:n},error:o,done:u})})};this.openAiApiChat=t}async auth(t){await this.openAiApiChat.auth()}async preAuth(){await this.openAiApiChat.preAuth()}get status(){return this.openAiApiChat.checkApiKey(),this.openAiApiChat.status}get conversation(){return this.openAiApiChat.conversation}async createConversation(t){return t?.id&&this.openAiApiChat.conversation?.id&&t.id!==this.openAiApiChat.conversation.id&&await this.openAiApiChat.resetMessagesContext(),await this.openAiApiChat.createConversation(t)}async removeConversation(t){return await this.openAiApiChat.removeConversationWithCache(),await this.openAiApiChat.resetMessagesContext(),Promise.resolve(!0)}async abortAskQuestion(t){return await this.openAiApiChat.abortTask(t)}async destroy(){await this.openAiApiChat.destroy()}async sendResponseToClient(t,e){await $s.default.tabs.sendMessage(t,{id:C,event:"Client_askChatGPTQuestionResponse",data:e})}get chatFiles(){return this.openAiApiChat.chatFiles}async uploadFiles(t){return await this.openAiApiChat.uploadFiles(t)}async updateFiles(t){return await this.openAiApiChat.updateFiles(t)}async getUploadFileToken(){return await this.openAiApiChat.getUploadFileToken()}async removeFiles(t){return await this.openAiApiChat.removeFiles(t)}async getFiles(){return await this.openAiApiChat.getFiles()}async abortUploadFiles(t){return await this.openAiApiChat.abortUploadFiles(t)}async clearFiles(){return await this.openAiApiChat.clearFiles()}};var js=w(_());var at=class{constructor(t){this.sendQuestion=async(t,e,a,s)=>{let n=g(),i=[],u=(await P.conversationDB.getConversationById(a.conversationId))?.meta?.docId;this.useChatGPTPlusChat.conversation&&(!u&&this.useChatGPTPlusChat.conversation.meta.systemPrompt&&i.push({type:"system",data:{content:this.useChatGPTPlusChat.conversation.meta.systemPrompt,additional_kwargs:{}}}),s.historyMessages?.forEach(o=>{i.push({type:o.type==="ai"?"ai":"human",data:{content:o.text,additional_kwargs:{}}})})),u&&i?.[0]?.type==="human"&&i.splice(0,2),await this.useChatGPTPlusChat.askChatGPT(a.question,{doc_id:u,backendAPI:u?"chat_with_document":"get_chatgpt_response",taskId:a.messageId,chat_history:i,meta:s.meta},async({type:o,done:d,error:h,data:l})=>{e.tab?.id&&await this.sendResponseToClient(e.tab.id,{taskId:t,data:{text:l.text,parentMessageId:a.messageId,conversationId:l.conversationId,messageId:n},error:h,done:d})})};this.useChatGPTPlusChat=t}async auth(t){await this.useChatGPTPlusChat.auth(t)}async preAuth(){await this.useChatGPTPlusChat.preAuth()}get status(){return this.useChatGPTPlusChat.status}get conversation(){return this.useChatGPTPlusChat.conversation}async createConversation(t){return await this.useChatGPTPlusChat.createConversation(t)}async removeConversation(t){return await this.useChatGPTPlusChat.removeConversationWithCache(),Promise.resolve(!0)}async abortAskQuestion(t){return await this.useChatGPTPlusChat.abortTask(t)}async destroy(){await this.useChatGPTPlusChat.destroy()}async sendResponseToClient(t,e){await js.default.tabs.sendMessage(t,{id:C,event:"Client_askChatGPTQuestionResponse",data:e})}get chatFiles(){return this.useChatGPTPlusChat.chatFiles}async uploadFiles(t){return await this.useChatGPTPlusChat.uploadFiles(t)}async updateFiles(t){return await this.useChatGPTPlusChat.updateFiles(t)}async getUploadFileToken(){return await this.useChatGPTPlusChat.getUploadFileToken()}async removeFiles(t){return await this.useChatGPTPlusChat.removeFiles(t)}async getFiles(){return await this.useChatGPTPlusChat.getFiles()}async abortUploadFiles(t){return await this.useChatGPTPlusChat.abortUploadFiles(t)}async clearFiles(){return await this.useChatGPTPlusChat.clearFiles()}};var zs=w(_());var nt=class{constructor(t){this.sendQuestion=async(t,e,a,s)=>{let n=g();await this.bardChat.askChatGPT(a.question,{taskId:a.messageId,regenerate:s.regenerate,include_history:s.includeHistory,max_history_message_cnt:s.maxHistoryMessageCnt},async({type:i,done:c,error:u,data:o})=>{e.tab?.id&&await this.sendResponseToClient(e.tab.id,{taskId:t,data:{text:o.text,parentMessageId:a.messageId,conversationId:o.conversationId,messageId:n},error:u,done:c})})};this.bardChat=t}async auth(t){await this.bardChat.auth()}async preAuth(){await this.bardChat.checkAuth()}get status(){return this.bardChat.status}get conversation(){return this.bardChat.conversation}async createConversation(t){return t.id&&this.bardChat.conversation?.id&&t.id!==this.bardChat.conversation.id&&await this.bardChat.reset(),await this.bardChat.createConversation(t)}async removeConversation(t){return await this.bardChat.removeConversationWithCache(),await this.bardChat.reset(),Promise.resolve(!0)}async abortAskQuestion(t){return await this.bardChat.abortTask(t)}async destroy(){await this.bardChat.destroy()}async sendResponseToClient(t,e){await zs.default.tabs.sendMessage(t,{id:C,event:"Client_askChatGPTQuestionResponse",data:e})}get chatFiles(){return this.bardChat.chatFiles}async updateFiles(t){return await this.bardChat.updateFiles(t)}async uploadFiles(t){return await this.bardChat.uploadFiles(t)}async getUploadFileToken(){return await this.bardChat.getUploadFileToken()}async removeFiles(t){return await this.bardChat.removeFiles(t)}async getFiles(){return await this.bardChat.getFiles()}async abortUploadFiles(t){return await this.bardChat.abortUploadFiles(t)}async clearFiles(){return await this.bardChat.clearFiles()}};var Vs=w(_());var rt=class{constructor(t){this.sendQuestion=async(t,e,a,s)=>{let n=g();await this.bingChat.askChatGPT(a.question,{taskId:a.messageId,regenerate:s.regenerate,include_history:s.includeHistory,max_history_message_cnt:s.maxHistoryMessageCnt,clientTabId:e.tab?.id},async({type:i,done:c,error:u,data:o})=>{e.tab?.id&&await this.sendResponseToClient(e.tab.id,{taskId:t,data:{text:o.text,parentMessageId:a.messageId,conversationId:o.conversationId,messageId:n},error:u,done:c})})};this.bingChat=t}async auth(t){await this.bingChat.auth()}async preAuth(){await this.bingChat.auth()}get status(){return this.bingChat.status}get conversation(){return this.bingChat.conversation}async createConversation(t){return t?.id&&this.bingChat.conversation?.id&&t.id!==this.bingChat.conversation.id&&await this.bingChat.removeConversation(),await this.bingChat.createConversation(t)}async removeConversation(t){return await this.bingChat.removeConversationWithCache(),await this.bingChat.removeConversation(),Promise.resolve(!0)}async abortAskQuestion(t){return await this.bingChat.abortTask(t)}async destroy(){await this.bingChat.destroy()}async sendResponseToClient(t,e){await Vs.default.tabs.sendMessage(t,{id:C,event:"Client_askChatGPTQuestionResponse",data:e})}get chatFiles(){return this.bingChat.chatFiles}async updateFiles(t){return await this.bingChat.updateFiles(t)}async uploadFiles(t){return await this.bingChat.uploadFiles(t)}async getUploadFileToken(){return await this.bingChat.getUploadFileToken()}async removeFiles(t){return await this.bingChat.removeFiles(t)}async getFiles(){return await this.bingChat.getFiles()}async abortUploadFiles(t){return await this.bingChat.abortUploadFiles(t)}async clearFiles(){return await this.bingChat.clearFiles()}};var Js=w(_());var St=class{constructor(t){this.sendQuestion=async(t,e,a,s)=>{let n=g();await this.poeChat.askChatGPT(a.question,{taskId:a.messageId,regenerate:s.regenerate,include_history:s.includeHistory,max_history_message_cnt:s.maxHistoryMessageCnt},async({type:i,done:c,error:u,data:o})=>{e.tab?.id&&await this.sendResponseToClient(e.tab.id,{taskId:t,data:{text:o.text,parentMessageId:a.messageId,conversationId:o.conversationId,messageId:n},error:u,done:c})})};this.poeChat=t}async auth(t){await this.poeChat.auth()}async preAuth(){await this.poeChat.auth()}get status(){return this.poeChat.status}get conversation(){return this.poeChat.conversation}async createConversation(){return Promise.resolve("")}async removeConversation(t){return this.poeChat.resetConversation(),Promise.resolve(!0)}async abortAskQuestion(t){return await this.poeChat.abortTask(t)}async destroy(){await this.poeChat.destroy()}async sendResponseToClient(t,e){await Js.default.tabs.sendMessage(t,{id:C,event:"Client_askChatGPTQuestionResponse",data:e})}get chatFiles(){return this.poeChat.chatFiles}async uploadFiles(t){return await this.poeChat.uploadFiles(t)}async updateFiles(t){return await this.poeChat.updateFiles(t)}async removeFiles(t){return await this.poeChat.removeFiles(t)}async getFiles(){return await this.poeChat.getFiles()}async getUploadFileToken(){return await this.poeChat.getUploadFileToken()}async abortUploadFiles(t){return await this.poeChat.abortUploadFiles(t)}async clearFiles(){return await this.poeChat.clearFiles()}};var Ks=w(_());var ot=class{constructor(t){this.sendQuestion=async(t,e,a,s)=>{let n=g();await this.claudeWebappChat.askChatGPT(a.question,{taskId:a.messageId,regenerate:s.regenerate,include_history:s.includeHistory,max_history_message_cnt:s.maxHistoryMessageCnt},async({type:i,done:c,error:u,data:o})=>{e.tab?.id&&await this.sendResponseToClient(e.tab.id,{taskId:t,data:{text:o.text,parentMessageId:a.messageId,conversationId:o.conversationId,messageId:n},error:u,done:c})})};this.claudeWebappChat=t}async auth(t){await this.claudeWebappChat.auth()}async preAuth(){await this.claudeWebappChat.preAuth()}get status(){return this.claudeWebappChat.status}get conversation(){return this.claudeWebappChat.conversation}async createConversation(t){return t?.id&&this.claudeWebappChat.conversation?.id&&t.id!==this.claudeWebappChat.conversation.id&&await this.claudeWebappChat.removeConversation(),await this.claudeWebappChat.createConversation(t)}async removeConversation(){return await this.claudeWebappChat.removeConversationWithCache(),await this.claudeWebappChat.removeConversation(),Promise.resolve(!0)}async abortAskQuestion(t){return await this.claudeWebappChat.abortTask(t)}async destroy(){await this.claudeWebappChat.destroy()}async sendResponseToClient(t,e){await Ks.default.tabs.sendMessage(t,{id:C,event:"Client_askChatGPTQuestionResponse",data:e})}get chatFiles(){return this.claudeWebappChat.chatFiles}async updateFiles(t){return await this.claudeWebappChat.updateFiles(t)}async uploadFiles(t){return await this.claudeWebappChat.uploadFiles(t)}async getUploadFileToken(){return await this.claudeWebappChat.getUploadFileToken()}async removeFiles(t){return await this.claudeWebappChat.removeFiles(t)}async getFiles(){return await this.claudeWebappChat.getFiles()}async abortUploadFiles(t){return await this.claudeWebappChat.abortUploadFiles(t)}async clearFiles(){return await this.claudeWebappChat.clearFiles()}};var Xs=w(_());var it=class{constructor(t){this.sendQuestion=async(t,e,a,s)=>{let n=g(),i=[];this.maxAIClaudeChat.conversation&&(this.maxAIClaudeChat.conversation.meta.systemPrompt&&i.push({type:"system",data:{content:this.maxAIClaudeChat.conversation.meta.systemPrompt,additional_kwargs:{}}}),s.historyMessages?.forEach(c=>{i.push({type:c.type==="ai"?"ai":"human",data:{content:c.text,additional_kwargs:{}}})}),s.includeHistory=!1,s.maxHistoryMessageCnt=0),await this.maxAIClaudeChat.askChatGPT(a.question,{taskId:a.messageId,regenerate:s.regenerate,chat_history:i,meta:s.meta},async({type:c,done:u,error:o,data:d})=>{e.tab?.id&&await this.sendResponseToClient(e.tab.id,{taskId:t,data:{text:d.text,parentMessageId:a.messageId,conversationId:d.conversationId,messageId:n},error:o,done:u})})};this.maxAIClaudeChat=t}async auth(t){await this.maxAIClaudeChat.auth(t)}async preAuth(){await this.maxAIClaudeChat.preAuth()}get status(){return this.maxAIClaudeChat.status}get conversation(){return this.maxAIClaudeChat.conversation}async createConversation(t){return await this.maxAIClaudeChat.createConversation(t)}async removeConversation(t){return await this.maxAIClaudeChat.removeConversationWithCache(),Promise.resolve(!0)}async abortAskQuestion(t){return await this.maxAIClaudeChat.abortTask(t)}async destroy(){await this.maxAIClaudeChat.destroy()}async sendResponseToClient(t,e){await Xs.default.tabs.sendMessage(t,{id:C,event:"Client_askChatGPTQuestionResponse",data:e})}get chatFiles(){return this.maxAIClaudeChat.chatFiles}async uploadFiles(t){return await this.maxAIClaudeChat.uploadFiles(t)}async updateFiles(t){return await this.maxAIClaudeChat.updateFiles(t)}async getUploadFileToken(){return await this.maxAIClaudeChat.getUploadFileToken()}async removeFiles(t){return await this.maxAIClaudeChat.removeFiles(t)}async getFiles(){return await this.maxAIClaudeChat.getFiles()}async abortUploadFiles(t){return await this.maxAIClaudeChat.abortUploadFiles(t)}async clearFiles(){return await this.maxAIClaudeChat.clearFiles()}};var y=w(_());var mn=async(r,t)=>{try{let e=await Ve();return e?await(await fetch(`${ct}${r}`,{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`}})).json():new Error("No access token")}catch{}},Ys=async r=>{try{await mn("/user/cardlog",r)}catch{}};var Zs=async(r,t)=>{let e=Ze.load(t),a=e('script[type="application/ld+json"]').html(),s=a?JSON.parse(a):null,n={};e('meta[property^="og:"]').each((h,l)=>{let p=e(l).attr("property"),m=e(l).attr("content");p&&m&&(n[p.replace("og:","")]=m)});let i=e("title").text(),c=e('meta[name="description"]').attr("content"),u=e('link[rel="logo"]').attr("href"),o=e('link[rel="icon"]').attr("href");return{jsonLD:s,openGraph:Object.keys(n).length>0?n:void 0,title:i,description:c,logo:u,favicon:o}};var Pe=class{constructor(t,e,a){this.databaseName=t,this.databaseVersion=e,this.objectStoreName=a}openDatabase(){return new Promise((t,e)=>{let a=indexedDB.open(this.databaseName,this.databaseVersion);a.onerror=s=>{e(s.target?.error||"")},a.onsuccess=s=>{let n=s.target?.result;t(n)},a.onupgradeneeded=s=>{let n=s.target?.result;if(!n.objectStoreNames.contains(this.objectStoreName)){let i=n.createObjectStore(this.objectStoreName,{keyPath:"id"});i.createIndex("id","id",{unique:!0}),i.createIndex("url","url",{unique:!1}),i.createIndex("title","meta.title",{unique:!1}),i.createIndex("summary","summary",{unique:!1})}}})}addOrUpdateWebsite(t){return new Promise(async(e,a)=>{try{let n=(await this.openDatabase()).transaction([this.objectStoreName],"readwrite"),i=n.objectStore(this.objectStoreName);t.updated_at=new Date().toISOString(),i.put(t),n.oncomplete=()=>{e()},n.onerror=c=>{a(c.target?.error||"")}}catch(s){a(s)}})}deleteWebsiteContext(t){return new Promise(async(e,a)=>{try{let n=(await this.openDatabase()).transaction([this.objectStoreName],"readwrite");n.objectStore(this.objectStoreName).delete(t),n.oncomplete=()=>{e()},n.onerror=c=>{a(c.target?.error||"")}}catch(s){a(s)}})}getWebsiteContextById(t){return new Promise(async(e,a)=>{try{let c=(await this.openDatabase()).transaction([this.objectStoreName],"readonly").objectStore(this.objectStoreName).get(t);c.onsuccess=u=>{let o=u.target?.result;e(o)},c.onerror=u=>{a(u.target?.error||"")}}catch(s){a(s)}})}getAllWebsiteContext(){return new Promise(async(t,e)=>{try{let i=(await this.openDatabase()).transaction([this.objectStoreName],"readonly").objectStore(this.objectStoreName).getAll();i.onsuccess=c=>{let u=c.target?.result||[];t(u)},i.onerror=c=>{e(c.target?.error||"")}}catch(a){e(a)}})}async removeUnnecessaryWebsiteContext(){let t=await this.getAllWebsiteContext(),e=[],a=t.filter(s=>{let i=new Date(s.updated_at).getTime();return new Date().getTime()-i<=31536e6?!0:(e.push(s),!1)});a=a.sort((s,n)=>{let i=new Date(s.updated_at).getTime(),c=new Date(n.updated_at).getTime();return i-c});for(let s=0;s<a.length-3e3;s++)e.push(a[s]);await Promise.all(e.map(s=>this.deleteWebsiteContext(s.id)))}async clearAllWebsiteContexts(){let t=await this.getAllWebsiteContext();await Promise.all(t.map(e=>this.deleteWebsiteContext(e.id)))}},gn=r=>{try{return r&&r.startsWith("http")&&new URL(r).host.replace(/^www\./,"").replace(/:\d+$/,"").includes("larksuite.com")?"larksuite.com":""}catch{return""}},z=class r{static{this.websiteContextDB=new Pe("websiteContextDB",1,"website_context")}static async createWebsiteContext(t){let e=K([{id:g(),created_at:new Date().toISOString(),updated_at:new Date().toISOString(),host:t.host||gn(t.url),url:"",meta:{},sidebarType:"Chat"},t]);if(t.id){let s=await this.websiteContextDB.getWebsiteContextById(t.id);s&&(e=K([e,s]))}await this.websiteContextDB.addOrUpdateWebsite(K([e,t]));let a=await this.analyzeWebsiteContextMetaData(e.id,t.html);return this.websiteContextDB.removeUnnecessaryWebsiteContext(),a||e}static async updateWebsiteContext(t,e){let a=await this.websiteContextDB.getWebsiteContextById(t);if(!a)return null;let s=K([a,e]);return await this.websiteContextDB.addOrUpdateWebsite(s),s}static async getWebsiteContextById(t){return this.websiteContextDB.getWebsiteContextById(t)}static async getAllWebsiteContext(){return this.websiteContextDB.getAllWebsiteContext()}static async clearAllWebsiteContexts(){return this.websiteContextDB.clearAllWebsiteContexts()}static async deleteWebsiteContext(t){return this.websiteContextDB.deleteWebsiteContext(t)}static async analyzeWebsiteContextMetaData(t,e){if(!t)return;let a=await r.websiteContextDB.getWebsiteContextById(t);if(a){if(e&&(a.html=e),a.html){let s=await Zs(a.url,a.html);a.meta=K([a.meta,s]),a.html=""}return await r.websiteContextDB.addOrUpdateWebsite(a),a}}};var Te=w(_()),Cn=async(r,t,e)=>new Promise(async a=>{try{let s=t?Te.default?.[r]?.[t]:Te.default?.[r];if(typeof s=="function"){let n=await s(...e);a(n)}else a(s)}catch{a(void 0)}}),ta=Cn;var fn=new G("Background/Client"),ea=()=>{H(async(r,t,e,a)=>{if(r==="client")switch(t){case"Client_ping":return{data:!0,success:!0,message:"ok"};case"Client_closeUrl":{let{url:s,tabId:n}=e,i=null;return n?i=await L(n):s&&(i=(await y.default.tabs.query({url:s}))?.[0]||null),i?.id?(await y.default.tabs.remove(i.id),{success:!0,data:!0,message:"ok"}):{success:!0,data:!1,message:"Cannot find close tab."}}break;case"Client_openUrl":{let{url:s,key:n,query:i="",active:c=!0}=e;if(s){if(s===y.default.runtime.getURL("/pages/chat/index.html")){if(a?.url&&a.url===y.default.runtime.getURL("/pages/popup/index.html")){let d=await y.default.tabs.query({active:!0});for(let h of d)h.id&&(h.pendingUrl==="chrome://newtab/"||h.pendingUrl==="about:blank"||h.url==="chrome://newtab/"||h.url==="about:blank")&&await y.default.tabs.remove(h.id)}let o=(await y.default.tabs.query({url:s}))?.[0]||null;if(o){await y.default.tabs.update(o.id,{active:!0});return}}return{data:{tabId:(await y.default.tabs.create({url:s,active:c})).id},success:!0,message:"ok"}}else if(n){let u;return n==="current_page"?a.tab?.id&&(await y.default.tabs.update(a.tab.id,{active:c}),u=a.tab.id):n==="shortcuts"?u=(await y.default.tabs.create({url:"chrome://extensions/shortcuts",active:c})).id:n==="options"?u=await ce(i):n==="chatgpt"?u=(await bt()).id:n==="manage_extension"&&(u=(await y.default.tabs.create({url:`chrome://extensions/?id=${y.default.runtime.id}`,active:c})).id),{data:{tabId:u},success:!0,message:"ok"}}}break;case"Client_emitCMDJ":a.tab?.id&&await y.default.tabs.sendMessage(a.tab.id,{id:C,event:"Client_listenOpenChatMessageBox",data:{}});break;case"Client_updateIcon":{let{mode:s}=e;return J?{data:!1,success:!1,message:"ok"}:(s==="dark"?await y.default.action.setIcon({path:{16:"assets/USE_CHAT_GPT_AI/icons/maxai_16_normal.png",32:"assets/USE_CHAT_GPT_AI/icons/maxai_32_normal.png",48:"assets/USE_CHAT_GPT_AI/icons/maxai_48_normal.png",128:"assets/USE_CHAT_GPT_AI/icons/maxai_128_normal.png"}}):await y.default.action.setIcon({path:{16:"assets/USE_CHAT_GPT_AI/icons/maxai_16_normal.png",32:"assets/USE_CHAT_GPT_AI/icons/maxai_32_normal.png",48:"assets/USE_CHAT_GPT_AI/icons/maxai_48_normal.png",128:"assets/USE_CHAT_GPT_AI/icons/maxai_128_normal.png"}}),{data:!0,success:!0,message:"ok"})}break;case"Client_getChromeExtensionCommands":return{data:await y.default.commands.getAll()||[],success:!0,message:"ok"};case"Client_updateTabVisible":{let{visible:s,windowVisible:n,windowFocus:i}=e||{};if(a.tab?.id){let c=await y.default.tabs.update(a.tab.id,{active:s});if(c.windowId){let u=await y.default.windows.get(c.windowId);if(u.id&&u.id!==y.default.windows.WINDOW_ID_NONE){let d=await $e()!==u.id||n?void 0:"minimized",h=await y.default.tabs.query({windowId:u.id});h=h.filter(l=>l.url&&!/.*:\/\/newtab/.test(l.url)),h.length===1&&await y.default.windows.update(u.id,{focused:i,state:d})}}}return{data:!0,success:!0,message:"ok"}}break;case"Client_updateIframeInput":return a.tab?.id&&await y.default.tabs.sendMessage(a.tab.id,{event:"Client_listenUpdateIframeInput",data:e,id:C}),{data:!0,success:!0,message:"ok"};case"Client_restartApp":return await Bt(),{data:!0,success:!0,message:"ok"};case"Client_logCallApiRequest":return{data:await ss(e),success:!0,message:"ok"};case"Client_updateUseChatGPTAuthInfo":{let s=await lt(),{accessToken:n,refreshToken:i,userInfo:c}=e;if(fn.info("Client_updateUseChatGPTAuthInfo",n,i,c),n&&i){let u=await y.default.storage.local.get(Ot);await y.default.storage.local.set({[Ot]:{accessToken:n,refreshToken:i,userInfo:c,userData:u[Ot]?.userData}})}else await ht();return!s&&n&&(await ce("",!1),await $t()||await jt(),await Qt()),await y.default.tabs.update(a.tab?.id,{active:!0}),{data:!0,success:!0,message:"ok"}}break;case"Client_getUseChatGPTUserInfo":return{success:!0,data:await ue(!1),message:"ok"};case"Client_getUseChatGPTUserSubscriptionInfo":return{success:!0,data:(await ue(!0))?.role,message:"ok"};case"Client_emitPricingHooks":{let{action:s,name:n}=e;return n&&await Ys({action:s,name:n}),{success:!0,data:!0,message:"ok"}}case"Client_getLiteChromeExtensionSettings":{let s=a.tab?.url||a.url;return s||(s=(await y.default.tabs.query({active:!0,currentWindow:!0}))[0]?.url),{success:!0,data:await zt(s),message:"ok"}}case"Client_getContextMenuActions":{let{contextMenuId:s}=e;return{success:!0,data:await Ye(s),message:"ok"}}case"Client_getLiteConversation":{let{conversationId:s}=e,n=await P.getClientConversation(s);return{success:!!n?.id,data:n,message:"ok"}}break;case"Client_updateConversation":{let{conversationId:s,updateConversationData:n}=e,i=await P.conversationDB.getConversationById(s);if(i){await P.conversationDB.addOrUpdateConversation(K([i,n]));let c=await P.getClientConversation(s);return a.tab?.id&&await y.default.tabs.sendMessage(a.tab.id,{event:"Client_listenUpdateConversationMessages",id:C,data:{conversation:c,conversationId:s}}),{success:!0,data:c,message:"ok"}}return{success:!1,data:!1,message:"ok"}}break;case"Client_modifyMessages":{let{conversationId:s,action:n,deleteCount:i,newMessages:c}=e,u=!1;if(n==="add"){if(c.length===0)return{success:!0,data:!0,message:"ok"};u=await P.pushMessages(s,c)}else n==="delete"?u=await P.deleteMessages(s,i):n==="clear"&&(u=await P.deleteMessages(s,99999999));return a.tab?.id&&await y.default.tabs.sendMessage(a.tab.id,{event:"Client_listenUpdateConversationMessages",id:C,data:{conversation:await P.getClientConversation(s),conversationId:s}}),{success:u,data:!0,message:"ok"}}break;case"Client_proxyFetchAPI":try{let{url:s,options:n}=e,{parse:i="json",...c}=n,u=await fetch(s,c);return{success:!0,data:i==="json"?await u.json():await u.text(),message:"ok"}}catch(s){return{success:!1,data:s,message:"ok"}}case"Client_getIframePageContent":{let{taskId:s}=e;return a.tab?.id&&s?(await y.default.tabs.sendMessage(a.tab.id,{event:"Iframe_ListenGetPageContent",id:C,data:{taskId:s,originPageUrl:a.tab.url||a.url}}),{success:!0,data:s,message:"ok"}):{success:!1,data:"",message:"ok"}}break;case"Iframe_sendPageContent":{let{taskId:s,pageContent:n}=e;return s&&a.tab?.id?(await y.default.tabs.sendMessage(a.tab.id,{event:"Client_ListenGetIframePageContentResponse",id:C,data:{taskId:s,pageContent:n}}),{success:!0,data:s,message:"ok"}):{success:!1,data:"",message:"ok"}}case"WebsiteContext_getWebsiteContext":{let{id:s}=e,n;return s&&(n=await z.getWebsiteContextById(s)),{success:!0,data:n,message:"ok"}}case"WebsiteContext_searchWebsiteContext":return{success:!0,data:[],message:"ok"};case"WebsiteContext_deleteWebsiteContext":{let{id:s}=e;return s?(await z.deleteWebsiteContext(s),{success:!0,data:!0,message:"ok"}):{success:!1,data:!1,message:"ok"}}case"WebsiteContext_clearAllWebsiteContext":return await z.clearAllWebsiteContexts(),{success:!0,data:!0,message:"ok"};case"WebsiteContext_updateWebsiteContext":{let{query:s,websiteContext:n}=e;return s.id?(await z.updateWebsiteContext(s.id,n),{success:!0,data:!0,message:"ok"}):{success:!1,data:!1,message:"ok"}}case"WebsiteContext_createWebsiteContext":{let{websiteContext:s}=e;return{success:!0,data:await z.createWebsiteContext(s),message:"ok"}}case"Client_backgroundRunFunction":{let s=await ta(e.command,e.commandFunctionName,e.commandFunctionData);return{success:!!s,data:s,message:"ok"}}default:break}})};var te=w(_());var yn=new G("PDF"),sa=async()=>{te.default.tabs.onUpdated.addListener(async(r,t,e)=>{if(e.active){let a=e.url||e.pendingUrl;if((a?.startsWith("file://")||a?.startsWith("ftp://"))&&(a.endsWith(".pdf")||a.endsWith(".PDF"))&&(await zt()).userSettings?.pdf?.enabled){let n=te.default.runtime.getURL(`/pages/pdf/web/viewer.html?file=${encodeURIComponent(a)}`);yn.info("pdfSnifferStartListener success",a,n),await te.default.tabs.update(r,{url:n})}}})};var aa=()=>{H(async(r,t,e,a)=>{if(r==="shortcut")switch(t){case"ShortCuts_getContentOfURL":{let{URL:s}=e,n=await Je(s);return{data:n,success:n.success,message:"ok"}}case"ShortCuts_getContentOfSearchEngine":{let{URL:s}=e,n=await Ke(s);return{data:n,success:n.success,message:"ok"}}case"ShortCuts_OperationPageElement":{let s=e.OperationElementConfig,n=e.OperationElementTabID||a.tab?.id,i=null;if(n&&(i=await L(n)),!i?.id)return{data:null,success:!1,message:"No tabId to execute operation page element."};if(n=i.id,n!==a.tab?.id){let o=l=>new Promise(p=>setTimeout(p,l)),d=!1,h=0;for(;!d&&h<20;){let l=await L(n);if(!l)break;l.status==="complete"&&(d=!0),h++,await o(500)}if(d){let l=await ts(n,s);return{data:l,success:l.success,message:"ok"}}}return{data:null,success:!1,message:"Page not loaded."}}break;default:break}})};var kt="text-davinci-002-render-sha";async function*na(r){let t=r.getReader();try{for(;;){let{done:e,value:a}=await t.read();if(e)return;yield a}}finally{t.releaseLock()}}var ra=async(r,t)=>{let{onMessage:e,...a}=t,s=await fetch(r,a);if(!s.ok){let i=await s.json().catch(()=>({}));throw new Error(JSON.stringify(Re(i)?{message:`${s.status} ${s.statusText}`,detail:""}:i))}if(a.body&&JSON.parse(a.body).streaming===!1)return await s.json();let n=Oe(i=>{i.type==="event"&&e(i.data)});for await(let i of na(s.body)){let c=new TextDecoder().decode(i);n.feed(c)}};var ia="https://chat.openai.com",ee="MaxAI.me - Search With AI",gt=(r,t,e,a)=>fetch(`${ia}${e}`,{method:t,headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:a===void 0?void 0:JSON.stringify(a)}),vn=async r=>{try{let{token:t,offset:e=0,limit:a=100,order:s="updated"}=r;return(await(await gt(t,"GET",`/backend-api/conversations?offset=${e}&limit=${a}&order=${s}`)).json())?.items||[]}catch{return[]}},oa=async({token:r,conversationId:t,messageId:e,input:a})=>{try{await gt(r,"POST","/backend-api/moderations",{conversation_id:t,message_id:e,input:a,model:"text-moderation-playground"})}catch{}},_e=async(r,t,e)=>{await gt(r,"PATCH",`/backend-api/conversation/${t}`,e)},xe=async(r=!1)=>{let t=await fetch("https://chat.openai.com/api/auth/session");if(t.status===403&&!r)throw new Error("CLOUDFLARE");let e=await t.json().catch(()=>({}));if(!e.accessToken&&!r)throw new Error("UNAUTHORIZED");return e?.accessToken||""},Se=class{constructor(t){this.isCleaningCache=!1;this.token=t.token,this.model=t.model,this.lastChatGPTAnswerMessageId=g(),this.id=g(),this.conversationId=t.conversationId||void 0,this.conversationInfo={title:"",messages:[]}}async updateTitle(t){!this.conversationId||this.conversationInfo.title===t||(await _e(this.token,this.conversationId,{title:t}),this.conversationInfo.title=t)}async fetchHistoryAndConfig(){if(this.conversationId)try{let e=await(await gt(this.token,"GET",`/backend-api/conversation/${this.conversationId}`)).json();this.conversationInfo={title:e.title,messages:Ue(e.current_node,e.mapping),raw:e},e.title!==ee&&await this.updateTitle(ee),this.lastChatGPTAnswerMessageId=e.current_node}catch{this.lastChatGPTAnswerMessageId=g(),this.conversationId=void 0,this.conversationInfo={title:"",messages:[]}}}async generateAnswer(t,e=!1){let a=t.messageId||g(),s=t.parentMessageId||this.lastChatGPTAnswerMessageId||g(),n=!1,i="",c="",u={action:e?"variant":"next",messages:[{id:a,author:{role:"user"},content:{content_type:"text",parts:[t.prompt]}}],model:this.model,parent_message_id:s,timezone_offset_min:new Date().getTimezoneOffset(),history_and_training_disabled:!1};this.conversationId&&(u.conversation_id=this.conversationId),t.meta&&(u.messages[0].metadata=t.meta),await ra(`${ia}/backend-api/conversation`,{method:"POST",signal:t.signal,headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify(Object.assign(u)),onMessage:o=>{if(o==="[DONE]"){i&&this.conversationId&&c&&(this.updateTitle(ee),oa({token:this.token,conversationId:this.conversationId,messageId:c,input:i})),t.onEvent({type:"done"});return}let d;try{d=JSON.parse(o)}catch{return}let h=d.message?.content?.parts?.[0]||d.message?.content?.text;h&&(i=h,c=d.message.id,this.conversationId=d.conversation_id,this.lastChatGPTAnswerMessageId=d.message.id,this.conversationId&&!n&&(n=!0,oa({token:this.token,conversationId:this.conversationId,messageId:a,input:t.prompt})),t.onEvent({type:"answer",data:{text:h,messageId:d.message.id,conversationId:d.conversation_id,parentMessageId:a}}))}}).then().catch(o=>{try{if(o?.message==="The user aborted a request."||o?.message==="BodyStreamBuffer was aborted"){t.onEvent({type:"error",data:{message:"manual aborted request.",detail:""}});return}let d=JSON.parse(o.message||o);t.onEvent({type:"error",data:{message:d.message,detail:d.detail}})}catch{t.onEvent({type:"error",data:{message:"Network error.",detail:""}})}})}async close(){this.conversationId&&(await _e(this.token,this.conversationId,{is_visible:!1}),this.conversationInfo={title:"",messages:[]})}async removeCacheConversation(){if(!this.isCleaningCache&&this.token){let e=(await vn({token:this.token})).filter(s=>s.title===ee&&s.id!==this.conversationId);if(e.length===0)return;this.isCleaningCache=!0;let a=s=>new Promise(n=>setTimeout(n,s));for(let s=0;s<e.length;s++)try{await _e(this.token,e[s].id,{is_visible:!1}),await a(3e3)}catch{}this.isCleaningCache=!1}}},se=class{constructor(){this.conversations=[],this.abortFunctions={},this.plugins=[],this.token=void 0,this.models=[]}async fetchModels(t){if(this.models.length>0)return this.models;let e=await gt(t,"GET","/backend-api/models").then(a=>a.json());return e?.models&&e.models.length>0&&(this.models=e.models),e.models}async fetchPlugins(t){if(this.plugins.length>0)return this.plugins;let e=await gt(t,"GET","/backend-api/aip/p?offset=0&limit=100&statuses=approved").then(a=>a.json());return e?.items&&e.items.length>0&&(this.plugins=e.items),e.items}async getModelName(t,e){try{let a=await this.fetchModels(t);if(a?.length>0){if(e){let s=a.find(n=>n.slug===e);if(s)return s.slug}return a[0].slug}return kt}catch{return kt}}async getAllModels(){if(this.models.length>0)return this.models;try{let t=this.token||await xe();return t&&(this.token=t),await this.fetchModels(t)}catch{return[]}}async getAllPlugins(){if(this.plugins.length>0)return this.plugins;try{let t=this.token||await xe();return t&&(this.token=t),await this.fetchPlugins(t)}catch{return[]}}async createConversation(t,e,a=!0){let s=this.token||await xe(),n=await this.getModelName(s,e),i=new Se({token:s,model:n,conversationId:t});return this.conversations=[i],a&&i.removeCacheConversation(),await i.fetchHistoryAndConfig(),i}getConversation(t){return this.conversations.find(e=>e.id===t||e.conversationId===t)}getConversations(){return this.conversations}async closeConversation(t){try{let e=this.getConversation(t);return e&&(this.conversations=this.conversations.filter(a=>a.conversationId!==t&&a.id!==t),await e.close()),!0}catch{return!1}}addAbortWithMessageId(t,e){this.abortFunctions[t]=e}removeAbortWithMessageId(t){delete this.abortFunctions[t]}abortWithMessageId(t){try{this.abortFunctions[t]&&(this.abortFunctions[t](),delete this.abortFunctions[t])}catch{}}removeCacheConversation(){return this.conversations?.[0]?.removeCacheConversation()}removeConversationWithId(t){let e=this.conversations.find(a=>a.conversationId===t);e&&e.close()}};var ae=new G("SearchWithAI/OpenAIChat"),ne=class extends M{constructor(){super("OpenAIChat");this.status="success";this.openAILib=new se,this.conversation=void 0,this.init()}init(){this.log.info("init")}async preAuth(){this.log.info("preAuth")}async auth(e){this.active=!0,this.status="success",await this.updateClientStatus()}async createConversation(){return this.conversation=await this.openAILib.createConversation(),this.conversation.id}async removeConversation(e){return await this.openAILib.closeConversation(e)}async askChatGPT(e,a,s){try{await this.createConversation()}catch(d){s?.({type:"error",done:!0,error:d.message||"conversation is not created",data:{text:"",conversationId:""}})}if(!this.conversation){s?.({type:"error",done:!0,error:"conversation is not created",data:{text:"",conversationId:""}});return}let n=this.openAILib,i=this.conversation,{taskId:c}=a||{};this.log.info("askChatGPT");let u=new AbortController,o=u.signal;c&&(this.taskList[c]=()=>u.abort()),await this.conversation.generateAnswer({prompt:e,signal:o,onEvent(d){if(ae.info("generateAnswer",d,a),d.type==="error"){ae.info("error"),ae.info("abort Controller remove",c),c&&n.removeAbortWithMessageId(c),s?.({type:"error",done:!0,error:d.data.message||d.data.detail||"",data:{text:"",conversationId:""}});return}if(d.type==="done"){ae.info("abort Controller remove",c),c&&n.removeAbortWithMessageId(c),s?.({type:"message",done:!0,error:"",data:{text:"",conversationId:i.conversationId}});return}s?.({type:"message",done:!1,error:"",data:{text:d.data.text,conversationId:i.conversationId}})}},a?.regenerate===!0)}async abortAskQuestion(e){return this.taskList[e]&&(this.taskList[e](),delete this.taskList[e]),this.openAILib.abortWithMessageId(e)}async destroy(){this.openAILib.removeCacheConversation()}async updateClientStatus(){this.active&&await U("Client_ChatGPTStatusUpdate",{status:this.status})}};var ca=w(_()),re=class{constructor(t){this.sendQuestion=async(t,e,a,s)=>{let n=g();await this.openAIChat.askChatGPT(a.question,{taskId:a.messageId,regenerate:s.regenerate,include_history:s.includeHistory,max_history_message_cnt:s.maxHistoryMessageCnt},async({type:i,done:c,error:u,data:o})=>{e.tab?.id&&await this.sendResponseToClient(e.tab.id,{taskId:t,data:{text:o.text,parentMessageId:a.messageId,conversationId:o.conversationId,messageId:n},error:u,done:c})})};this.chatFiles=[],this.openAIChat=t}async preAuth(){return this.openAIChat.preAuth()}async auth(t){await this.openAIChat.auth(t)}get status(){return this.openAIChat.status}async abortAskQuestion(t){try{return await this.openAIChat.abortAskQuestion(t),!0}catch{return!1}}async createConversation(){return Promise.resolve("")}async removeConversation(t){return await this.openAIChat.removeConversation(t)}destroy(){return this.openAIChat.destroy()}async sendResponseToClient(t,e){await ca.default.tabs.sendMessage(t,{id:C,event:"Client_askChatGPTQuestionResponse",data:e})}abortUploadFiles(t){return Promise.resolve(!1)}clearFiles(){return Promise.resolve(!1)}getFiles(){return Promise.resolve([])}getUploadFileToken(){return Promise.resolve(void 0)}removeFiles(t){return Promise.resolve(!1)}updateFiles(t){return Promise.resolve(void 0)}uploadFiles(t){return Promise.resolve(void 0)}};var da=()=>{let r=new k(new re(new ne)),t=new k(new at(new X)),e=new k(new st(new It)),a=new k(new nt(new Y)),s=new k(new rt(new Z)),n=new k(new ot(new tt)),i=new k(new it(new et));return{[x.OPENAI]:r,[x.USE_CHAT_GPT_PLUS]:t,[x.OPENAI_API]:e,[x.BARD]:a,[x.BING]:s,[x.CLAUDE]:n,[x.MAXAI_CLAUDE]:i}};var ke=class{constructor(){this.adapters={};this.sendQuestion=(t,e,a,s)=>(this.currentProvider===x.OPENAI_API&&(s.meta={model:de[0].value,temperature:1}),this.currentProvider===x.USE_CHAT_GPT_PLUS&&(s.meta={temperature:1}),this.currentAdapter?.sendQuestion(t,e,a,s)||Promise.resolve());this.adapters=da(),this.initChatSystem(),ns().then(t=>{this.currentProvider=t.aiProvider})}get currentAdapter(){return this.currentProvider?this.adapters[this.currentProvider]:void 0}initChatSystem(){H(async(t,e,a,s)=>{if(t==="client")switch(e){case"SWAI_switchAIProvider":{let{provider:n}=a;return await this.switchAdapter(n),await this.preAuth(),{success:!0,data:n,message:""};break}case"SWAI_askAIQuestion":{this.currentProvider!==x.BARD&&this.currentProvider!==x.CLAUDE&&await this.auth(s.tab?.id||0);let n=a.taskId,i=a.question,c=a.options;await this.createConversation(i.conversationId),await this.sendQuestion(n,s,i,c);break}case"SWAI_abortAskChatGPTQuestion":{let{taskId:n}=a;return await this.abortAskQuestion(n),{success:!0,data:{},message:""}}default:break}})}async switchAdapter(t){return await this.destroy(),this.currentProvider=t,await rs({aiProvider:t}),this.currentAdapter}async auth(t){this.currentAdapter&&await this.currentAdapter.auth(t)}async preAuth(){this.currentAdapter&&await this.currentAdapter.preAuth()}async abortAskQuestion(t){return this.currentAdapter?await this.currentAdapter.abortAskQuestion(t):!1}async createConversation(t){if(!this.currentAdapter)return"";let e={AIModel:""};return this.currentProvider===x.USE_CHAT_GPT_PLUS&&(e.AIModel=Dt[0].value),this.currentProvider===x.MAXAI_CLAUDE&&(e.AIModel=Wt[0].value),this.currentProvider===x.OPENAI_API&&(e.AIModel=de[0].value),this.currentProvider===x.OPENAI&&(e.AIModel=kt),this.currentProvider===x.CLAUDE&&(e.AIModel=He[0].value),this.currentProvider===x.BARD&&(e.AIModel=vt[0].value),this.currentProvider===x.BING&&(e.AIModel=Ne[0].value),await this.currentAdapter?.createConversation({id:t,title:"Chat - Search With AI",type:"Chat",created_at:new Date().toISOString(),updated_at:new Date().toISOString(),messages:[],meta:e})||""}async destroy(){await this.currentAdapter?.removeConversation(""),await this.currentAdapter?.destroy()}},ua=ke;var ha=()=>{new ua};var la=()=>{try{b.default.management?.getAll?.(),b.default.storage.onChanged.addListener(()=>{}),b.default.scripting.getRegisteredContentScripts(),In(),bn(),An(),Pn(),_n(),Tn(),wn(),sa().then().catch(),xn()}catch{}},In=()=>{b.default.runtime.onInstalled.addListener(async r=>{r.reason===b.default.runtime.OnInstalledReason.INSTALL?(await De(),await b.default.tabs.create({url:ie+"/get-started"})):(await Ge(),await $t()||await jt(),await Qt(),await as("textSelectPopupButton"));try{await b.default.contextMenus.remove("use-chatgpt-ai-context-menu-button")}catch{}await b.default.contextMenus.create({id:"use-chatgpt-ai-context-menu-button",title:"MaxAI.me",contexts:["all"]})})},bn=()=>{ea(),aa(),b.default.runtime.onMessage.addListener((o,d,h)=>{o?.id&&o.id!==C||o.type==="inboxsdk__injectPageWorld"&&d.tab&&b.default.scripting&&d.tab?.id&&(b.default.scripting.executeScript({target:{tabId:d.tab.id},world:"MAIN",files:["pageWorld.js"]}),h(!0))});let r=new _t,t=new k(new xt(new wt)),e=new k(new at(new X)),a=new k(new st(new It)),s=new k(new nt(new Y)),n=new k(new rt(new Z)),i=new k(new St(new Pt)),c=new k(new ot(new tt)),u=new k(new it(new et));r.addAdapter(W.OPENAI,t),r.addAdapter(W.OPENAI_API,a),r.addAdapter(W.USE_CHAT_GPT_PLUS,e),r.addAdapter(W.BING,n),r.addAdapter(W.BARD,s),r.addAdapter(W.POE,i),r.addAdapter(W.CLAUDE,c),r.addAdapter(W.MAXAI_CLAUDE,u),ha()},wn=()=>{J||b.default.runtime.setUninstallURL(`${Rt}/survey/uninstall?version=${V}`)},An=()=>{J||b.default.commands.onCommand.addListener(async r=>{if(r=="_execute_action"){let e=(await b.default.tabs.query({active:!0,currentWindow:!0}))[0];e&&e.id&&await Gt(e.id,"Client_listenOpenChatMessageBox",{type:"shortcut",command:r})}else if(r==="show-floating-menu"){let e=(await b.default.tabs.query({active:!0,currentWindow:!0}))[0];e&&e.id&&await Gt(e.id,"Client_listenOpenChatMessageBox",{type:"shortcut",command:r})}})},Pn=()=>{if(J)b.default.action.onClicked.addListener(async r=>{r&&r.id&&r.active&&await b.default.tabs.create({url:ie})});else{let r=async t=>{try{let e=t,a=e?.url||"",s="";e?.url?.startsWith("chrome")||e?.url?.startsWith("https://chrome.google.com/webstore")||e?.url?.startsWith("https://chat.openai.com")?a.startsWith("chrome://extensions/shortcuts")||(s="pages/popup/index.html"):e&&e.id&&(await b.default.tabs.sendMessage(e.id,{}),s=""),await b.default.action.setPopup({popup:s})}catch{await b.default.action.setPopup({popup:"pages/popup/index.html"})}};b.default.tabs.onActivated.addListener(async({tabId:t})=>{let e=await L(t);e&&await r(e)}),b.default.tabs.onUpdated.addListener(async(t,e,a)=>{e.status==="complete"&&a.active&&await r(a)}),b.default.action.onClicked.addListener(async t=>{if(t&&t.id&&t.active){if(t.url==="chrome://extensions/shortcuts")return;await Gt(t.id,"Client_listenOpenChatMessageBox",{type:"shortcut"})||await b.default.action.setPopup({popup:"pages/popup/index.html"})}})}},Tn=()=>{J||b.default.management?.onDisabled?.addListener(function(r){r.id===b.default.runtime.id&&b.default.action.setPopup({popup:"pages/popup/index.html"})})},_n=()=>{J||b.default.contextMenus.onClicked.addListener(async(r,t)=>{r.menuItemId==="use-chatgpt-ai-context-menu-button"&&t&&t.id&&await b.default.tabs.sendMessage(t.id,{id:C,event:"Client_listenOpenChatMessageBox",data:{}})})},xn=()=>{Ee||new WebSocket("ws://localhost:8181").addEventListener("message",t=>{t.data==="hot_reload_message"&&Bt().then(()=>{})})};la();
/*! Bundled license information:

is-buffer/index.js:
  (*!
   * Determine if an object is a Buffer
   *
   * @author   Feross Aboukhadijeh <https://feross.org>
   * @license  MIT
   *)
*/
