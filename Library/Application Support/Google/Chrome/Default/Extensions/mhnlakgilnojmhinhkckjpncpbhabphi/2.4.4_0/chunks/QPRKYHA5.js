import{b as n,d as R}from"./DYUK4WZS.js";import{c as C,ja as P,k as N,ka as L,n as W}from"./IQBPRLVE.js";import{s as O}from"./HEBGDMW5.js";import{a as U}from"./KG5SJQNS.js";import{c as T,j as x,k as M}from"./AAMCXCLO.js";import{B as o,L as _,j as E}from"./IPAGS25B.js";import{a as A}from"./3JX3VARJ.js";import{f as s}from"./PQ35KENF.js";var g=s(A());var k=s(W());var S=s(A()),p=s(x()),v=s(M());p.default.extend(v.default);var u="CHROME_EXTENSION_LOG_DAILY_USAGE_LIMIT_KEY",q=async a=>{let r=async()=>{try{let e=await O(),t=a.provider||e.sidebarSettings?.common?.currentAIProvider||"UNKNOWN_PROVIDER",c={ai_provider:{USE_CHAT_GPT_PLUS:"chatgpt",OPENAI:"chatgpt_web_app",OPENAI_API:"openai_api",BARD:"bard_web_app",BING:"bing_web_app",POE:"poe",CLAUDE:"claude_web_app",MAXAI_CLAUDE:"claude"}[t]||"UNKNOWN_PROVIDER",domain:a.host,prompt_id:a.id,prompt_name:a.name,browser:await R(),app_version:E};L(c.prompt_id)&&(c.prompt_id=P+c.prompt_id.slice(P.length+8),c.prompt_name=`[Suggested] ${c.prompt_name}`);let w=await U(),$=await C(),H=k.default.encrypt(JSON.stringify(c),"MaxAI").toString();if(!w)return!1;let d=await(await fetch(`${_}/user/call_api`,{method:"POST",body:JSON.stringify({info_object:H}),headers:{"Content-Type":"application/json",Authorization:`Bearer ${w}`,fp:`${$}`}})).json();return d.data&&d.status==="OK"?(await h(d.data),d.data.has_reached_limit&&b(!0).then().catch(),d.data.has_reached_limit):!1}catch(e){if(e?.message==="Failed to fetch"&&(await m())?.name==="free"){let i=await f();return i.has_reached_limit=!0,await h(i),!0}return!1}};return new Promise(async e=>{try{let t=await f();if(t)if(!t.has_reached_limit)r().then().catch(),e(!1);else{let i=await b(!1);if(i?.role?.name==="pro"||i?.role?.name==="elite")if(i.role.exp_time&&(0,p.default)(i.role.exp_time).diff((0,p.default)().utc())>0){n("[Pricing] Pro [cache] has reached the limit",`Pro user ${i?.email} use has reached the limit.
${JSON.stringify({role:i?.role,usage:t.usage})}`,{uuid:"7a04bc02-6155-4253-bcdb-ade3db6de492"}),e(!1);return}else await m(),t=await f(),e(t.has_reached_limit);if(new Date>new Date(t.next_reset_timestamp*1e3)){await m(),t=await f(),e(t.has_reached_limit);return}e(!0)}else{let i=await r();e(i)}}catch{e(!1)}})},h=async a=>{try{await S.default.storage.local.set({[u]:JSON.stringify(a)})}catch{}},f=async()=>{try{let a=await S.default.storage.local.get(u);if(a[u]){let r=JSON.parse(a[u]);return{has_reached_limit:r.has_reached_limit,next_reset_timestamp:r.next_reset_timestamp,usage:r.usage,limit_value:r.limit_value}}return{has_reached_limit:!1,next_reset_timestamp:0,usage:0,limit_value:0}}catch{return{has_reached_limit:!1,next_reset_timestamp:0,usage:0,limit_value:0}}};var l=s(x()),D=async()=>{let a=await g.default.storage.local.get(o);return a[o]?a[o]?.refreshToken:""},b=async a=>{try{let r=await g.default.storage.local.get(o);if(r[o]){let e=r[o]?.userData,t=!1;return(!e||a)&&(e=await B(),t=!0),(a||!e.role)&&(e.role=await m(),t=!0),t&&await g.default.storage.local.set({[o]:{...r[o],userData:e}}),e}return}catch{return}},m=async()=>{try{let a=await D();if(!a)return;let r=await fetch(`${_}/user/get_user_subscription_info`,{headers:{Authorization:`Bearer ${a}`}});if(r.ok){let e=await r.json();if(e.status==="OK"&&e.data&&e?.data?.roles&&T(e.data.roles)){await h({has_reached_limit:e.data.has_reached_limit,limit_value:e.data.limit_value,next_reset_timestamp:e.data.next_reset_timestamp,usage:e.data.usage});let t=e.data.roles.find(i=>i.name==="elite")||e.data.roles.find(i=>i.name==="pro")||e.data.roles[0];return t||(t={name:"free",exp_time:0}),t.name==="pro"&&e.data.has_reached_limit&&n("[Pricing] Pro [subscription_info] has reached the limit",`Pro token [${a}] call api has reached the limit.
${JSON.stringify(e?.data)}`,{uuid:"7a04bc02-6155-4253-bcdb-ade3db6de492"}),t==="pro"&&(0,l.default)().utc().diff((0,l.default)(t.exp_time))>0&&n("[API] error response roles",`Pro token [${a}]
${JSON.stringify(e?.data)}`,{uuid:"6f02f533-def6-4696-b14e-1b00c2d9a4df"}),t.name==="elite"&&e.data.has_reached_limit&&n("[Pricing] Elite [subscription_info] has reached the limit",`Elite token [${a}] call api has reached the limit.
${JSON.stringify(e?.data)}`,{uuid:"7a04bc02-6155-4253-bcdb-ade3db6de492"}),t==="elite"&&(0,l.default)().utc().diff((0,l.default)(t.exp_time))>0&&n("[API] error response roles",`Elite token [${a}]
${JSON.stringify(e?.data)}`,{uuid:"6f02f533-def6-4696-b14e-1b00c2d9a4df"}),{name:t.name,exp_time:t.exp_time}}}return}catch{return}},B=async()=>{try{let a=await D();if(!a)return;let r=await fetch(`${_}/user/get_user_info`,{headers:{Authorization:`Bearer ${a}`}}),e=await m();if(r.ok){let t=await r.json();if(t.status==="OK"&&t?.data?.email)return t.data?.conversationId&&delete t.data.conversationId,t.data.role=e,t.data}return}catch{return}};var y=s(A());var I="SEARCH_WITH_AI_STORAGE_KEY",G={aiProvider:N.OPENAI,enable:!0,triggerMode:"always",webAccessPrompt:!0,arkoseToken:""},K=async()=>{let a=await y.default.storage.local.get(I);return a[I]?a[I]:G},ne=async a=>{let r=await K()||G;await y.default.storage.local.set({[I]:{...r,...a}})};export{q as a,D as b,b as c,G as d,K as e,ne as f};
