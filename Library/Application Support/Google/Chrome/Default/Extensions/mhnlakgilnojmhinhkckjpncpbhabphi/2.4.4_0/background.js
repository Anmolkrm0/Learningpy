import{a as rs}from"./chunks/DTPRD3UH.js";import{a as ss,c as pa}from"./chunks/XSP2GWTE.js";import{b as Kt,f as as}from"./chunks/4NAB6M5G.js";import"./chunks/STYZXNUC.js";import{a as ns,b as lt,c as pt,e as Yt,f as Zt}from"./chunks/QPRKYHA5.js";import{a as es}from"./chunks/CML227OB.js";import{b as Xt}from"./chunks/DYUK4WZS.js";import"./chunks/CE4P5R6G.js";import{a as Le,b as Je,ca as Xe,da as Ye,ea as Ze,k as x,q as jt}from"./chunks/IQBPRLVE.js";import{A as Ve,a as Re,b as ut,i as He,j as qe,k as It,l as Nt,m as M,n as Qe,o as me,p as bt,r as Ht,s as qt,t as je,u as wt,v as Qt,x as $e,y as B,z as ze}from"./chunks/HEBGDMW5.js";import"./chunks/6LS5XNTR.js";import{a as G}from"./chunks/W2F53U5Z.js";import"./chunks/TYBXNNUH.js";import{d as ts,f as Jt}from"./chunks/DUIWQHLB.js";import{a as Ke,d as $t,e as zt,f as Vt}from"./chunks/KG5SJQNS.js";import"./chunks/HQC5KEMG.js";import{G as K,L as De,S as w,U as Bt,V as $,W as We,X as U,Y as Dt,Z as q,a as g,ba as pe,ca as ht,d as Ue,e as Ge,ea as Wt,fa as L,ga as Ne,r as Be,v as Gt}from"./chunks/AAMCXCLO.js";import"./chunks/CAPNT4IP.js";import"./chunks/YN4XY6JW.js";import{B as Rt,F as le,G as Ut,K as N,L as ct,M as Lt,N as dt,j as z,k as J,l as he,x as f}from"./chunks/IPAGS25B.js";import{a as _}from"./chunks/3JX3VARJ.js";import{c as Ot,f as A}from"./chunks/PQ35KENF.js";var ws=Ot((Nr,bs)=>{(function(){var r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t={rotl:function(e,a){return e<<a|e>>>32-a},rotr:function(e,a){return e<<32-a|e>>>a},endian:function(e){if(e.constructor==Number)return t.rotl(e,8)&16711935|t.rotl(e,24)&4278255360;for(var a=0;a<e.length;a++)e[a]=t.endian(e[a]);return e},randomBytes:function(e){for(var a=[];e>0;e--)a.push(Math.floor(Math.random()*256));return a},bytesToWords:function(e){for(var a=[],s=0,n=0;s<e.length;s++,n+=8)a[n>>>5]|=e[s]<<24-n%32;return a},wordsToBytes:function(e){for(var a=[],s=0;s<e.length*32;s+=8)a.push(e[s>>>5]>>>24-s%32&255);return a},bytesToHex:function(e){for(var a=[],s=0;s<e.length;s++)a.push((e[s]>>>4).toString(16)),a.push((e[s]&15).toString(16));return a.join("")},hexToBytes:function(e){for(var a=[],s=0;s<e.length;s+=2)a.push(parseInt(e.substr(s,2),16));return a},bytesToBase64:function(e){for(var a=[],s=0;s<e.length;s+=3)for(var n=e[s]<<16|e[s+1]<<8|e[s+2],o=0;o<4;o++)s*8+o*6<=e.length*8?a.push(r.charAt(n>>>6*(3-o)&63)):a.push("=");return a.join("")},base64ToBytes:function(e){e=e.replace(/[^A-Z0-9+\/]/ig,"");for(var a=[],s=0,n=0;s<e.length;n=++s%4)n!=0&&a.push((r.indexOf(e.charAt(s-1))&Math.pow(2,-2*n+8)-1)<<n*2|r.indexOf(e.charAt(s))>>>6-n*2);return a}};bs.exports=t})()});var Pe=Ot((Hr,As)=>{var Ae={utf8:{stringToBytes:function(r){return Ae.bin.stringToBytes(unescape(encodeURIComponent(r)))},bytesToString:function(r){return decodeURIComponent(escape(Ae.bin.bytesToString(r)))}},bin:{stringToBytes:function(r){for(var t=[],e=0;e<r.length;e++)t.push(r.charCodeAt(e)&255);return t},bytesToString:function(r){for(var t=[],e=0;e<r.length;e++)t.push(String.fromCharCode(r[e]));return t.join("")}}};As.exports=Ae});var _s=Ot((qr,Ts)=>{Ts.exports=function(r){return r!=null&&(Ps(r)||en(r)||!!r._isBuffer)};function Ps(r){return!!r.constructor&&typeof r.constructor.isBuffer=="function"&&r.constructor.isBuffer(r)}function en(r){return typeof r.readFloatLE=="function"&&typeof r.slice=="function"&&Ps(r.slice(0,0))}});var Ss=Ot((Qr,xs)=>{(function(){var r=ws(),t=Pe().utf8,e=_s(),a=Pe().bin,s=function(n,o){n.constructor==String?o&&o.encoding==="binary"?n=a.stringToBytes(n):n=t.stringToBytes(n):e(n)?n=Array.prototype.slice.call(n,0):!Array.isArray(n)&&n.constructor!==Uint8Array&&(n=n.toString());for(var c=r.bytesToWords(n),l=n.length*8,i=1732584193,d=-271733879,u=-1732584194,h=271733878,p=0;p<c.length;p++)c[p]=(c[p]<<8|c[p]>>>24)&16711935|(c[p]<<24|c[p]>>>8)&4278255360;c[l>>>5]|=128<<l%32,c[(l+64>>>9<<4)+14]=l;for(var m=s._ff,I=s._gg,b=s._hh,C=s._ii,p=0;p<c.length;p+=16){var D=i,H=d,W=u,Ct=h;i=m(i,d,u,h,c[p+0],7,-680876936),h=m(h,i,d,u,c[p+1],12,-389564586),u=m(u,h,i,d,c[p+2],17,606105819),d=m(d,u,h,i,c[p+3],22,-1044525330),i=m(i,d,u,h,c[p+4],7,-176418897),h=m(h,i,d,u,c[p+5],12,1200080426),u=m(u,h,i,d,c[p+6],17,-1473231341),d=m(d,u,h,i,c[p+7],22,-45705983),i=m(i,d,u,h,c[p+8],7,1770035416),h=m(h,i,d,u,c[p+9],12,-1958414417),u=m(u,h,i,d,c[p+10],17,-42063),d=m(d,u,h,i,c[p+11],22,-1990404162),i=m(i,d,u,h,c[p+12],7,1804603682),h=m(h,i,d,u,c[p+13],12,-40341101),u=m(u,h,i,d,c[p+14],17,-1502002290),d=m(d,u,h,i,c[p+15],22,1236535329),i=I(i,d,u,h,c[p+1],5,-165796510),h=I(h,i,d,u,c[p+6],9,-1069501632),u=I(u,h,i,d,c[p+11],14,643717713),d=I(d,u,h,i,c[p+0],20,-373897302),i=I(i,d,u,h,c[p+5],5,-701558691),h=I(h,i,d,u,c[p+10],9,38016083),u=I(u,h,i,d,c[p+15],14,-660478335),d=I(d,u,h,i,c[p+4],20,-405537848),i=I(i,d,u,h,c[p+9],5,568446438),h=I(h,i,d,u,c[p+14],9,-1019803690),u=I(u,h,i,d,c[p+3],14,-187363961),d=I(d,u,h,i,c[p+8],20,1163531501),i=I(i,d,u,h,c[p+13],5,-1444681467),h=I(h,i,d,u,c[p+2],9,-51403784),u=I(u,h,i,d,c[p+7],14,1735328473),d=I(d,u,h,i,c[p+12],20,-1926607734),i=b(i,d,u,h,c[p+5],4,-378558),h=b(h,i,d,u,c[p+8],11,-2022574463),u=b(u,h,i,d,c[p+11],16,1839030562),d=b(d,u,h,i,c[p+14],23,-35309556),i=b(i,d,u,h,c[p+1],4,-1530992060),h=b(h,i,d,u,c[p+4],11,1272893353),u=b(u,h,i,d,c[p+7],16,-155497632),d=b(d,u,h,i,c[p+10],23,-1094730640),i=b(i,d,u,h,c[p+13],4,681279174),h=b(h,i,d,u,c[p+0],11,-358537222),u=b(u,h,i,d,c[p+3],16,-722521979),d=b(d,u,h,i,c[p+6],23,76029189),i=b(i,d,u,h,c[p+9],4,-640364487),h=b(h,i,d,u,c[p+12],11,-421815835),u=b(u,h,i,d,c[p+15],16,530742520),d=b(d,u,h,i,c[p+2],23,-995338651),i=C(i,d,u,h,c[p+0],6,-198630844),h=C(h,i,d,u,c[p+7],10,1126891415),u=C(u,h,i,d,c[p+14],15,-1416354905),d=C(d,u,h,i,c[p+5],21,-57434055),i=C(i,d,u,h,c[p+12],6,1700485571),h=C(h,i,d,u,c[p+3],10,-1894986606),u=C(u,h,i,d,c[p+10],15,-1051523),d=C(d,u,h,i,c[p+1],21,-2054922799),i=C(i,d,u,h,c[p+8],6,1873313359),h=C(h,i,d,u,c[p+15],10,-30611744),u=C(u,h,i,d,c[p+6],15,-1560198380),d=C(d,u,h,i,c[p+13],21,1309151649),i=C(i,d,u,h,c[p+4],6,-145523070),h=C(h,i,d,u,c[p+11],10,-1120210379),u=C(u,h,i,d,c[p+2],15,718787259),d=C(d,u,h,i,c[p+9],21,-343485551),i=i+D>>>0,d=d+H>>>0,u=u+W>>>0,h=h+Ct>>>0}return r.endian([i,d,u,h])};s._ff=function(n,o,c,l,i,d,u){var h=n+(o&c|~o&l)+(i>>>0)+u;return(h<<d|h>>>32-d)+o},s._gg=function(n,o,c,l,i,d,u){var h=n+(o&l|c&~l)+(i>>>0)+u;return(h<<d|h>>>32-d)+o},s._hh=function(n,o,c,l,i,d,u){var h=n+(o^c^l)+(i>>>0)+u;return(h<<d|h>>>32-d)+o},s._ii=function(n,o,c,l,i,d,u){var h=n+(c^(o|~l))+(i>>>0)+u;return(h<<d|h>>>32-d)+o},s._blocksize=16,s._digestsize=16,xs.exports=function(n,o){if(n==null)throw new Error("Illegal argument "+n);var c=r.wordsToBytes(s(n,o));return o&&o.asBytes?c:o&&o.asString?a.bytesToString(c):r.bytesToHex(c)}})()});var v=A(_());var S=A(_());var O=new G("ChatGPT/OpenAIChat"),At=class extends M{constructor(){super("OpenAIChat");this.status="needAuth";this.isAnswering=!1;this.sendQuestion=async(e,a,s,n)=>{if(!this.isAnswering){Ze().then().catch(),this.questionSender=a,this.isAnswering=!0;let o=await B("OPENAI");if(o?.model==="gpt-4-code-interpreter"||o?.model==="gpt-4"){let c=this.chatFiles.filter(l=>l.uploadStatus==="success"&&l.uploadedFileId);c.length>0&&(n.meta||(n.meta={}),n.meta.attachments=c.map(l=>({name:l.fileName,id:l.uploadedFileId,size:l.fileSize})),this.chatFiles=[],U("Client_listenUploadFilesChange",{files:this.chatFiles}))}await this.sendDaemonProcessTask("OpenAIDaemonProcess_askChatGPTQuestion",{taskId:e,question:s,options:n})}};this.init()}init(){q(async(e,a,s,n)=>{if(e==="daemon_process")switch(a){case"OpenAIDaemonProcess_daemonProcessExist":{if(!this.active)break;let o=this.chatGPTProxyInstance&&await Qt(this.chatGPTProxyInstance)||!1;return o&&n.tab?.id&&(o=n.tab.id!==this.chatGPTProxyInstance?.id,O.info("OpenAIDaemonProcess_daemonProcessExist","\u662F\u5426\u540C\u4E00\u4E2Atab",n.tab.id===this.chatGPTProxyInstance?.id)),O.info("OpenAIDaemonProcess_daemonProcessExist",o),{success:!0,message:"",data:{isExist:o}}}case"OpenAIDaemonProcess_setDaemonProcess":{if(!this.active)break;return O.info("OpenAIDaemonProcess_setDaemonProcess"),this.chatGPTProxyInstance=n.tab,this.status="success",await this.updateClientStatus(),this.listenDaemonProcessTab(),this.lastActiveTabId&&this.lastActiveTabId>0&&(await S.default.tabs.update(this.lastActiveTabId,{active:!0}),this.lastActiveTabId=void 0),{success:!0,message:"",data:{}}}break;case"OpenAIDaemonProcess_taskResponse":{if(!this.active)break;O.info("OpenAIDaemonProcess_taskResponse",s);let{taskId:o,data:c,done:l,error:i}=s;if(this.questionSender&&s){let{tab:d}=this.questionSender;d&&d.id&&(this.currentTaskId=o,await S.default.tabs.sendMessage(d.id,{id:f,event:"Client_askChatGPTQuestionResponse",data:{taskId:o,data:c,done:l,error:i}}),l&&(this.isAnswering=!1,this.currentTaskId=void 0))}}break;case"OpenAIDaemonProcess_daemonProcessSessionExpired":{if(O.info("OpenAIDaemonProcess_daemonProcessSessionExpired"),this.status="needAuth",!this.active)break;if(await this.updateClientStatus(),n.tab){let{tab:o}=n;o&&o.id&&(await S.default.tabs.update(o.id,{active:!0}),o.windowId&&await S.default.windows.update(o.windowId,{focused:!0,state:"normal"}))}return{success:!0,message:"",data:{}}}case"OpenAIDaemonProcess_pong":return O.info("DaemonProcess_pong",this.chatGPTProxyInstance),{success:!0,message:"",data:{}};default:break}})}async preAuth(){if(this.active=!0,this.status!=="needAuth"&&this.cacheLastTimeChatGPTProxyInstance&&this.cacheLastTimeChatGPTProxyInstance.id){let e=await L(this.cacheLastTimeChatGPTProxyInstance.id);if(e&&e.id&&e?.url?.startsWith("https://chat.openai.com")){let a=await S.default.tabs.sendMessage(e.id,{id:f,event:"OpenAIDaemonProcess_ping"});a&&a.success?(this.chatGPTProxyInstance=e,this.status="success"):(this.cacheLastTimeChatGPTProxyInstance=void 0,this.status="needAuth")}}else this.status="needAuth";await this.updateClientStatus()}async auth(e){if(this.lastActiveTabId=e,this.active=!0,this.status="loading",await this.updateClientStatus(),!this.chatGPTProxyInstance)if(this.cacheLastTimeChatGPTProxyInstance&&this.cacheLastTimeChatGPTProxyInstance.id){let a=await L(this.cacheLastTimeChatGPTProxyInstance.id);this.chatGPTProxyInstance=a||await wt()}else this.chatGPTProxyInstance=await wt();if(this.chatGPTProxyInstance){let a=this.chatGPTProxyInstance.windowId;if(a)try{await S.default.windows.update(a,{focused:!0})}catch{}await S.default.tabs.update(this.chatGPTProxyInstance.id,{active:!0}),await S.default.tabs.reload(this.chatGPTProxyInstance.id),this.status="complete",this.listenDaemonProcessTab(),await this.updateClientStatus(),this.cacheLastTimeChatGPTProxyInstance=this.chatGPTProxyInstance,this.keepAlive()}}async createConversation(e){if(this.conversation&&(this.conversation=await w.conversationDB.getConversationById(this.conversation.id)),!this.conversation){let a=(await B("OPENAI"))?.model;a?await super.createConversation({...e,meta:{...e.meta,AIModel:a}}):await super.createConversation()}return await this.sendDaemonProcessTask("OpenAIDaemonProcess_createConversation",{conversationId:this.conversation?.meta?.AIConversationId||"",model:this.conversation?.meta?.AIModel||""}),this.conversation?.id||""}async removeConversation(e){if(this.conversation&&(this.conversation=await w.conversationDB.getConversationById(this.conversation.id)),!this.conversation?.meta.AIConversationId)return await this.removeConversationWithCache(),!0;O.info("removeConversation",e);let a=await this.sendDaemonProcessTask("OpenAIDaemonProcess_removeConversation",{conversationId:this.conversation.meta.AIConversationId});return await this.removeConversationWithCache(),a.success}async abortAskQuestion(e){let a=await this.sendDaemonProcessTask("OpenAIDaemonProcess_abortAskChatGPTQuestion",{messageId:e});return this.isAnswering=!1,a.success}async destroy(){O.info("destroy"),this.clearFiles(),this.chatGPTProxyInstance&&this.chatGPTProxyInstance.id&&(this.cacheLastTimeChatGPTProxyInstance=this.chatGPTProxyInstance),this.active=!1}async sendDaemonProcessTask(e,a){if(this.chatGPTProxyInstance&&await Qt(this.chatGPTProxyInstance)&&this.chatGPTProxyInstance.id){let s=await S.default.tabs.sendMessage(this.chatGPTProxyInstance.id,{id:f,event:e,data:a});return O.info("sendDaemonProcessTask",s),s}return await this.destroy(),{success:!1,data:{},message:"daemon process not exist"}}async updateClientStatus(){this.active&&await U("Client_ChatGPTStatusUpdate",{status:this.status})}async keepAlive(){this.chatGPTProxyInstance&&await Qt(this.chatGPTProxyInstance)&&this.chatGPTProxyInstance.id&&(O.info("keepAliveDaemonProcess"),S.default.tabs.sendMessage(this.chatGPTProxyInstance.id,{id:f,event:"OpenAIDaemonProcess_ping"})),await(a=>new Promise(s=>setTimeout(s,a)))(20*1e3),this.active&&await this.keepAlive()}async tabRemoveListener(e){if(this.chatGPTProxyInstance?.id&&e===this.chatGPTProxyInstance.id){if(O.info("\u5B88\u62A4\u8FDB\u7A0B\u5173\u95ED"),this.questionSender&&this.isAnswering){let{tab:a}=this.questionSender;a&&a.id&&this.currentTaskId&&await S.default.tabs.sendMessage(a.id,{id:f,event:"Client_askChatGPTQuestionResponse",data:{taskId:this.currentTaskId,data:null,done:!0,error:"manual aborted request."}})}this.isAnswering=!1,this.chatGPTProxyInstance=void 0,this.cacheLastTimeChatGPTProxyInstance=void 0,this.status="needAuth",await this.updateClientStatus()}}async tabUpdateListener(e,a){if(e===this.chatGPTProxyInstance?.id){let s=!a.url?.includes("https://chat.openai.com"),n=a.url?.includes("https://chat.openai.com/auth");a.url&&(s||n)&&(O.info("\u5B88\u62A4\u8FDB\u7A0Burl\u53D1\u751F\u53D8\u5316\uFF0C\u5B88\u62A4\u8FDB\u7A0B\u5173\u95ED"),this.cacheLastTimeChatGPTProxyInstance=this.chatGPTProxyInstance,this.chatGPTProxyInstance=void 0,this.status="needAuth",await this.updateClientStatus()),this.active?(a.status==="loading"||a.status==="complete")&&(O.info("\u5B88\u62A4\u8FDB\u7A0Burl\u72B6\u6001\u66F4\u65B0",a.status),this.status=a.status,await this.updateClientStatus(),await this.pingAwaitSuccess()):(this.cacheLastTimeChatGPTProxyInstance=this.chatGPTProxyInstance,this.chatGPTProxyInstance=void 0,this.status="needAuth",await this.updateClientStatus())}}async pingAwaitSuccess(){let e=a=>new Promise(s=>setTimeout(s,a));if(this.chatGPTProxyInstance?.id&&this.active){O.info("start ping await success");let a=!1;for(let s=0;s<20&&!(a||!this.chatGPTProxyInstance?.id);s++)S.default.tabs.sendMessage(this.chatGPTProxyInstance.id,{id:f,event:"OpenAIDaemonProcess_ping"}).then(n=>{n&&n.success&&(O.info("ping await success"),this.status="success",this.updateClientStatus(),a=!0)}),await e(1e3)}}listenDaemonProcessTab(){S.default.tabs.onRemoved.addListener(this.tabRemoveListener.bind(this)),S.default.tabs.onUpdated.addListener(this.tabUpdateListener.bind(this))}removeListener(){S.default.tabs.onRemoved.removeListener(this.tabRemoveListener.bind(this)),S.default.tabs.onUpdated.removeListener(this.tabUpdateListener.bind(this))}async minimizedDaemonProcessWindow(){this.chatGPTProxyInstance?.windowId&&await S.default.windows.update(this.chatGPTProxyInstance.windowId,{state:"minimized"})}async uploadFiles(e){if(this.chatFiles=e,e.filter(a=>a.uploadStatus!=="success").length>0){if(!(await this.sendDaemonProcessTask("OpenAIDaemonProcess_pingFilesUpload",{})).success){this.chatFiles=this.chatFiles.map(n=>(n.uploadStatus="error",n.uploadErrorMessage="Your previous upload didn't go through as the Code Interpreter was initializing. It's now ready for your file. Please try uploading it again.",n));let s=this.chatGPTProxyInstance?.id;s&&((await B("OPENAI"))?.modelOptions?.find(o=>o.slug==="gpt-4-code-interpreter")?L(s).then(o=>{o&&S.default.tabs.update(o.id,{url:"https://chat.openai.com/?model=gpt-4-code-interpreter"})}):L(s).then(o=>{o&&S.default.tabs.update(o.id,{url:"https://chat.openai.com/?model=gpt-4"})}));return}this.chatFiles=this.chatFiles.map(s=>(s.uploadStatus="uploading",s)),await this.sendDaemonProcessTask("OpenAIDaemonProcess_filesUpload",{files:e})}}};var ge=A(_());var Q=new G("Background/Chat/UseChatGPTPlusChat"),X=class extends M{constructor(){super("UseChatGPTPlusChat");this.status="needAuth";this.init()}init(){Q.info("init")}async preAuth(){this.active=!0,await this.checkTokenAndUpdateStatus()}async auth(e){this.active=!0,this.lastActiveTabId=e,await this.checkTokenAndUpdateStatus(),this.status==="needAuth"&&await ge.default.tabs.create({active:!0,url:Lt}),await this.updateClientStatus()}async checkTokenAndUpdateStatus(){let e=this.status;this.token=await this.getToken(),this.status=this.token?"success":"needAuth",e!==this.status&&(Q.info("checkTokenAndUpdateStatus",this.status,this.lastActiveTabId),this.lastActiveTabId=void 0),await this.updateClientStatus()}async askChatGPT(e,a,s){if(await this.checkTokenAndUpdateStatus(),this.status!=="success"){s&&s({type:"error",done:!0,error:"Your session has expired. Please log in.",data:{text:"",conversationId:""}});return}let{taskId:n,doc_id:o,backendAPI:c="get_chatgpt_response",streaming:l=!0,chat_history:i=[],meta:d}=a||{},u=await B("USE_CHAT_GPT_PLUS"),h=Be(u?.temperature)?u.temperature:1;typeof d?.temperature=="number"&&(h=d.temperature),h=Math.min(h,1.2);let p=Object.assign({chat_history:i,streaming:l,message_content:e,chrome_extension_version:z,model_name:this.conversation?.meta.AIModel||u.model||Nt[0].value,prompt_id:d?.contextMenu?.id?d.contextMenu.id:c==="chat_with_document"?"summary_chat":"chat",prompt_name:d?.contextMenu?.text?d.contextMenu.text:c==="chat_with_document"?"summary_chat":"chat",temperature:h},o?{doc_id:o}:{});c==="chat_with_document"&&(p.model_name="gpt-3.5-turbo-16k");let m=new AbortController,I=m.signal;n&&(this.taskList[n]=()=>m.abort()),Q.info("streaming start",p);let b="",C=!1,D=!1,H=0,W=this.conversation?.id||"",yt=(await ge.default.storage.local.get(dt))[dt]||{},Ft=yt.interval||50,vt=yt.rate||.5,Mt=T=>new Promise(F=>setTimeout(F,T)),E=async()=>{if(D)return;if(C&&H===b.length){Q.info("streaming end success"),s&&s({done:!0,type:"message",error:"",data:{text:"",conversationId:W}});return}let T=0,F=Math.floor(b.length-H);if(C){let ue=Math.max(Math.floor(b.length*.1),10);T=b.slice(H,ue+H).length}else{let ue=Math.floor(F*vt);T=b.slice(H,ue+H).length}T>0&&(Q.debug("streaming echo message",C?"\u4E00\u79D2\u53D1\u9001\u5B8C\u5269\u4E0B\u7684\u6587\u672C":`\u6BCF${Ft}\u6BEB\u79D2\u53D1\u9001\u5269\u4F59\u6587\u672C\u7684${(vt*100).toFixed(0)}%`,H,T,b.length),H+=T,s&&s({type:"message",done:!1,error:"",data:{text:b.slice(0,H),conversationId:W}})),await Mt(C?100:Ft),await E()};E();let P=!1;await ut(`${ct}/gpt/${c}`,{provider:N.USE_CHAT_GPT_PLUS,method:"POST",signal:I,headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify(p),onMessage:T=>{try{let F=JSON.parse(T);F?.conversation_id&&(W=F.conversation_id),F?.text&&(b+=F.text),Q.debug("streaming on message",b)}catch(F){Q.error("parse message.data error: 	",F)}}}).then().catch(T=>{if(Q.info("streaming end error",T),C=!0,D=!0,T?.message==="BodyStreamBuffer was aborted"||T?.message==="The user aborted a request."){s&&s({type:"error",error:"manual aborted request.",done:!0,data:{text:"",conversationId:W}});return}try{let F=JSON.parse(T.message||T);if(F.msg&&jt(F.msg)){s&&s({type:"error",error:F.msg,done:!0,data:{text:"",conversationId:W}});return}F?.code===401&&(P=!0),Q.error("sse error",T),s&&s({done:!0,type:"error",error:F.message||F.detail||"Network error.",data:{text:"",conversationId:W}})}catch{s&&s({done:!0,type:"error",error:"Network error.",data:{text:"",conversationId:W}})}}),C||(Q.info("streaming end success"),b===""?(Xt("[API] response empty string.",JSON.stringify({model:p.model_name,promptTextLength:p.message_content.length},null,2),{uuid:"6f02f533-def6-4696-b14e-1b00c2d9a4df"}),s&&s({done:!0,type:"error",error:"Something went wrong, please try again. If this issue persists, contact us via email.",data:{text:"",conversationId:W}})):C=!0),P&&(Q.info("user token expired"),this.status="needAuth",await ht(),await this.updateClientStatus())}async abortTask(e){return this.taskList[e]&&(this.taskList[e](),delete this.taskList[e]),!0}async destroy(){Q.info("destroy"),this.status="needAuth",this.active=!1}async getToken(){return await lt()}async updateClientStatus(){this.active&&await U("Client_ChatGPTStatusUpdate",{status:this.status})}};var ma=/"(?:_|\\u0{2}5[Ff]){2}(?:p|\\u0{2}70)(?:r|\\u0{2}72)(?:o|\\u0{2}6[Ff])(?:t|\\u0{2}74)(?:o|\\u0{2}6[Ff])(?:_|\\u0{2}5[Ff]){2}"\s*:/,ga=/"(?:c|\\u0063)(?:o|\\u006[Ff])(?:n|\\u006[Ee])(?:s|\\u0073)(?:t|\\u0074)(?:r|\\u0072)(?:u|\\u0075)(?:c|\\u0063)(?:t|\\u0074)(?:o|\\u006[Ff])(?:r|\\u0072)"\s*:/,fa=/^\s*["[{]|^\s*-?\d[\d.]{0,14}\s*$/;function Ca(r,t){if(r!=="__proto__"&&!(r==="constructor"&&t&&typeof t=="object"&&"prototype"in t))return t}function os(r,t={}){if(typeof r!="string")return r;let e=r.toLowerCase().trim();if(e==="true")return!0;if(e==="false")return!1;if(e==="null")return null;if(e==="nan")return Number.NaN;if(e==="infinity")return Number.POSITIVE_INFINITY;if(e!=="undefined"){if(!fa.test(r)){if(t.strict)throw new SyntaxError("Invalid JSON");return r}try{return ma.test(r)||ga.test(r)?JSON.parse(r,Ca):JSON.parse(r)}catch(a){if(t.strict)throw a;return r}}}var Yn=String.fromCharCode;var ya=/#/g,va=/&/g;var Ia=/=/g;var ve=/\+/g,ba=/%5e/gi,wa=/%60/gi;var Aa=/%7c/gi;var Pa=/%20/gi;function Ta(r){return encodeURI(""+r).replace(Aa,"|")}function Ce(r){return Ta(typeof r=="string"?r:JSON.stringify(r)).replace(ve,"%2B").replace(Pa,"+").replace(ya,"%23").replace(va,"%26").replace(wa,"`").replace(ba,"^")}function fe(r){return Ce(r).replace(Ia,"%3D")}function cs(r=""){try{return decodeURIComponent(""+r)}catch{return""+r}}function _a(r){return cs(r.replace(ve," "))}function xa(r){return cs(r.replace(ve," "))}function Sa(r=""){let t={};r[0]==="?"&&(r=r.slice(1));for(let e of r.split("&")){let a=e.match(/([^=]+)=?(.*)/)||[];if(a.length<2)continue;let s=_a(a[1]);if(s==="__proto__"||s==="constructor")continue;let n=xa(a[2]||"");t[s]===void 0?t[s]=n:Array.isArray(t[s])?t[s].push(n):t[s]=[t[s],n]}return t}function ka(r,t){return(typeof t=="number"||typeof t=="boolean")&&(t=String(t)),t?Array.isArray(t)?t.map(e=>`${fe(r)}=${Ce(e)}`).join("&"):`${fe(r)}=${Ce(t)}`:fe(r)}function Ea(r){return Object.keys(r).filter(t=>r[t]!==void 0).map(t=>ka(t,r[t])).filter(Boolean).join("&")}var Fa=/^[\s\w\0+.-]{2,}:([/\\]{1,2})/,Ma=/^[\s\w\0+.-]{2,}:([/\\]{2})?/,Oa=/^([/\\]\s*){2,}[^/\\]/;function ds(r,t={}){return typeof t=="boolean"&&(t={acceptRelative:t}),t.strict?Fa.test(r):Ma.test(r)||(t.acceptRelative?Oa.test(r):!1)}var Ra=/\/$|\/\?/;function ye(r="",t=!1){return t?Ra.test(r):r.endsWith("/")}function Ua(r="",t=!1){if(!t)return(ye(r)?r.slice(0,-1):r)||"/";if(!ye(r,!0))return r||"/";let[e,...a]=r.split("?");return(e.slice(0,-1)||"/")+(a.length>0?`?${a.join("?")}`:"")}function La(r="",t=!1){if(!t)return r.endsWith("/")?r:r+"/";if(ye(r,!0))return r||"/";let[e,...a]=r.split("?");return e+"/"+(a.length>0?`?${a.join("?")}`:"")}function us(r,t){if(Ga(t)||ds(r))return r;let e=Ua(t);return r.startsWith(e)?r:Wa(e,r)}function hs(r,t){let e=ls(r),a={...Sa(e.search),...t};return e.search=Ea(a),Na(e)}function Ga(r){return!r||r==="/"}function Ba(r){return r&&r!=="/"}var Da=/^\.?\//;function Wa(r,...t){let e=r||"";for(let a of t.filter(s=>Ba(s)))if(e){let s=a.replace(Da,"");e=La(e)+s}else e=a;return e}function ls(r="",t){let e=r.match(/^[\s\0]*(blob:|data:|javascript:|vbscript:)(.*)/);if(e){let[,u,h=""]=e;return{protocol:u,pathname:h,href:u+h,auth:"",host:"",search:"",hash:""}}if(!ds(r,{acceptRelative:!0}))return t?ls(t+r):is(r);let[,a="",s,n=""]=r.replace(/\\/g,"/").match(/^[\s\0]*([\w+.-]{2,}:)?\/\/([^/@]+@)?(.*)/)||[],[,o="",c=""]=n.match(/([^#/?]*)(.*)?/)||[],{pathname:l,search:i,hash:d}=is(c.replace(/\/(?=[A-Za-z]:)/,""));return{protocol:a,auth:s?s.slice(0,Math.max(0,s.length-1)):"",host:o,pathname:l,search:i,hash:d}}function is(r=""){let[t="",e="",a=""]=(r.match(/([^#?]*)(\?[^#]*)?(#.*)?/)||[]).splice(1);return{pathname:t,search:e,hash:a}}function Na(r){let t=r.pathname||"",e=r.search?(r.search.startsWith("?")?"":"?")+r.search:"",a=r.hash||"",s=r.auth?r.auth+"@":"",n=r.host||"";return(r.protocol?r.protocol+"//":"")+s+n+t+e+a}var Ie=class extends Error{constructor(){super(...arguments),this.name="FetchError"}};function Ha(r,t,e){let a="";t&&(a=t.message),r&&e?a=`${a} (${e.status} ${e.statusText} (${r.toString()}))`:r&&(a=`${a} (${r.toString()})`);let s=new Ie(a);return Object.defineProperty(s,"request",{get(){return r}}),Object.defineProperty(s,"response",{get(){return e}}),Object.defineProperty(s,"data",{get(){return e&&e._data}}),Object.defineProperty(s,"status",{get(){return e&&e.status}}),Object.defineProperty(s,"statusText",{get(){return e&&e.statusText}}),Object.defineProperty(s,"statusCode",{get(){return e&&e.status}}),Object.defineProperty(s,"statusMessage",{get(){return e&&e.statusText}}),s}var qa=new Set(Object.freeze(["PATCH","POST","PUT","DELETE"]));function ps(r="GET"){return qa.has(r.toUpperCase())}function Qa(r){if(r===void 0)return!1;let t=typeof r;return t==="string"||t==="number"||t==="boolean"||t===null?!0:t!=="object"?!1:Array.isArray(r)?!0:r.constructor&&r.constructor.name==="Object"||typeof r.toJSON=="function"}var ja=new Set(["image/svg","application/xml","application/xhtml","application/html"]),$a=/^application\/(?:[\w!#$%&*.^`~-]*\+)?json(;.+)?$/i;function za(r=""){if(!r)return"json";let t=r.split(";").shift()||"";return $a.test(t)?"json":ja.has(t)||t.startsWith("text/")?"text":"blob"}var Va=new Set([408,409,425,429,500,502,503,504]);function be(r){let{fetch:t,Headers:e}=r;function a(o){let c=o.error&&o.error.name==="AbortError"||!1;if(o.options.retry!==!1&&!c){let i;typeof o.options.retry=="number"?i=o.options.retry:i=ps(o.options.method)?0:1;let d=o.response&&o.response.status||500;if(i>0&&Va.has(d))return s(o.request,{...o.options,retry:i-1})}let l=Ha(o.request,o.error,o.response);throw Error.captureStackTrace&&Error.captureStackTrace(l,s),l}let s=async function(c,l={}){let i={request:c,options:{...r.defaults,...l},response:void 0,error:void 0};i.options.onRequest&&await i.options.onRequest(i),typeof i.request=="string"&&(i.options.baseURL&&(i.request=us(i.request,i.options.baseURL)),(i.options.query||i.options.params)&&(i.request=hs(i.request,{...i.options.params,...i.options.query})),i.options.body&&ps(i.options.method)&&Qa(i.options.body)&&(i.options.body=typeof i.options.body=="string"?i.options.body:JSON.stringify(i.options.body),i.options.headers=new e(i.options.headers),i.options.headers.has("content-type")||i.options.headers.set("content-type","application/json"),i.options.headers.has("accept")||i.options.headers.set("accept","application/json"))),i.response=await t(i.request,i.options).catch(async u=>(i.error=u,i.options.onRequestError&&await i.options.onRequestError(i),a(i)));let d=(i.options.parseResponse?"json":i.options.responseType)||za(i.response.headers.get("content-type")||"");if(d==="json"){let u=await i.response.text(),h=i.options.parseResponse||os;i.response._data=h(u)}else d==="stream"?i.response._data=i.response.body:i.response._data=await i.response[d]();return i.options.onResponse&&await i.options.onResponse(i),i.response.status>=400&&i.response.status<600?(i.options.onResponseError&&await i.options.onResponseError(i),a(i)):i.response},n=function(c,l){return s(c,l).then(i=>i._data)};return n.raw=s,n.native=t,n.create=(o={})=>be({...r,defaults:{...r.defaults,...o}}),n}var ms=function(){if(typeof globalThis<"u")return globalThis;if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("unable to locate global object")}(),Ja=ms.fetch||(()=>Promise.reject(new Error("[ofetch] global.fetch is not supported!"))),Ka=ms.Headers,R=be({fetch:Ja,Headers:Ka});function gs(r,t){return new RegExp(`"${r}":"([^"]+)"`).exec(t)?.[1]}var fs=async()=>{try{let r=await R("https://bard.google.com/faq",{cache:"reload"}),t=gs("SNlM0e",r),e=gs("cfb2h",r);return{atValue:t,blValue:e}}catch{return{atValue:"",blValue:""}}},Cs=r=>{let t=JSON.parse(r.split(`
`)[3]),e=JSON.parse(t[0][2]);return e?{text:e[4][0][1][0],error:"",ids:[...e[1],e[4][0][0]]}:{text:"",error:"Please log into [bard.google.com](https://bard.google.com) and try again.",ids:["","",""]}};var ys=A(_());function Xa(){return Math.floor(Math.random()*9e5)+1e5}var Y=class extends M{constructor(){super("BardChat");this.contextIds=["","",""];this.token=void 0,this.init()}async init(){let e=await $();e&&(this.status=e.ON_BOARDING_RECORD_AI_PROVIDER_HAS_AUTH_BARD?"success":"needAuth")}async checkAuth(){this.active=!0,this.token?await this.updateClientStatus("success"):await this.updateClientStatus("needAuth")}async auth(){this.active=!0,await this.syncBardToken()?await this.updateClientStatus("success"):(await this.updateClientStatus("needAuth"),await ys.default.tabs.create({url:"https://bard.google.com/",active:!0}))}async askChatGPT(e,a,s){this.conversation||await super.createConversation({meta:{AIProvider:"BARD",AIModel:It[0].value,maxTokens:It[0].maxTokens}});let{taskId:n}=a||{};if(!this.token){let i=await this.syncBardToken();this.status="needAuth",await this.updateClientStatus(this.status),s?.({type:"error",done:!0,error:"Please log into [bard.google.com](https://bard.google.com) and try again.",data:{text:"",conversationId:""}});return}let o=new AbortController,c=o.signal,l=!1;n&&(this.taskList[n]=()=>o.abort());try{let i=this.chatFiles?.[0],d=[null,JSON.stringify([[JSON.stringify(e),0,null,i?.uploadedUrl?[[[i.uploadedUrl,1],i.fileName]]:[]],null,this.contextIds])],u=await R("https://bard.google.com/_/BardChatUi/data/assistant.lamda.BardFrontendService/StreamGenerate",{method:"POST",signal:c,query:{bl:this.token.blValue,_reqid:Xa(),rt:"c"},body:new URLSearchParams({at:this.token.atValue,"f.req":JSON.stringify(d)}),parseResponse:I=>I}).catch(I=>{if(I?.message.includes("The user aborted a request.")){l=!0,s&&s({type:"error",error:"manual aborted request.",done:!0,data:{text:"",conversationId:""}});return}}).finally(()=>{this.clearFiles()}),{text:h,ids:p,error:m}=Cs(u);if(this.log.debug("result",u,h,p),p){if(l)return;m?s&&s({type:"message",done:!0,error:m,data:{text:"",conversationId:this.conversation?.id||""}}):h&&(s&&s({type:"message",done:!1,error:"",data:{text:h,conversationId:this.conversation?.id||""}}),s&&s({type:"message",done:!0,error:"",data:{text:h,conversationId:this.conversation?.id||""}}),this.contextIds=p)}else s&&s({type:"error",done:!0,error:"BardChat: Unknown Error",data:{text:"",conversationId:this.conversation?.id||""}})}catch(i){this.log.error(i)}}async syncBardToken(){let{atValue:e,blValue:a}=await fs();return!e||!a?(this.token=void 0,!1):(this.token={atValue:e,blValue:a},!0)}reset(){this.contextIds=["","",""]}async uploadFiles(e){this.chatFiles=e,this.chatFiles=await Promise.all(e.map(async a=>{if(a.uploadStatus!=="success"){let[s,n]=Kt(a.file),o=new Blob([s],{type:n}),c={"content-type":"application/x-www-form-urlencoded;charset=UTF-8","push-id":"feeds/mcudyrk2a4khkz","x-goog-upload-header-content-length":a.fileSize.toString(),"x-goog-upload-protocol":"resumable","x-tenant-id":"bard-storage"},i=(await R.raw("https://content-push.googleapis.com/upload/",{method:"POST",headers:{...c,"x-goog-upload-command":"start"},body:new URLSearchParams({[`File name: ${a.fileName}`]:""})})).headers.get("x-goog-upload-url");if(this.log.debug("Bard upload url",i),!i)return a.uploadErrorMessage="Failed to get upload url",a.uploadStatus="error",a;let d=await R.raw(i,{method:"POST",headers:{...c,"x-goog-upload-command":"upload, finalize","x-goog-upload-offset":"0"},body:o});return this.log.debug("Bard upload result",d?._data),d.status===200?(a.uploadedUrl=d._data,a.uploadStatus="success"):(a.uploadErrorMessage="Failed to upload file",a.uploadStatus="error"),a}return a}))}async destroy(){await this.clearFiles(),await this.updateClientStatus("needAuth"),this.active=!1}};function Ya(){return`13.${Gt(104,107)}.${Gt(0,255)}.${Gt(0,255)}`}var vs="https://www.bing.com/turing/conversation/create";async function Is(){let r={"x-ms-client-request-id":g(),"x-ms-useragent":"azsdk-js-api-client-factory/1.0.0-beta.1 core-rest-pipeline/1.10.3 OS/macOS"},t;try{if(t=await R.raw(vs,{headers:r,redirect:"error"}),!t._data?.result)throw new Error("Please sign in to [bing.com](https://bing.com/), complete any required verifications, then try again.")}catch{if(t=await R.raw(vs,{headers:{...r,"x-forwarded-for":Ya()},redirect:"error"}),!t._data)throw new Error("Please sign in to [bing.com](https://bing.com/), complete any required verifications, then try again.")}let e=t._data;if(e.result.value!=="Success"){let n=`${e.result.value}: ${e.result.message}

Please sign in to [bing.com](http://bing.com/), complete any required verifications, then try again.`;throw e.result.value==="UnauthorizedRequest"&&(n+=`
[Log into bing.com to continue.](https://www.bing.com/)`),e.result.value==="Forbidden"&&(n+=`
[Log into bing.com to continue.](https://www.bing.com/)`),new Error(n)}let a=t.headers.get("x-sydney-conversationsignature"),s=t.headers.get("x-sydney-encryptedconversationsignature")||void 0;return e.conversationSignature=e.conversationSignature||a,e.encryptedConversationSignature=s,e}var we=A(_());var te=class{constructor(t,e){this.unpackListeners=[];this.closeListeners=[];this.messageListeners=[];this.id=g(),this.url=t,this.options=e||{}}async init(t){let e=await L(t),a=(await we.default.tabs.query({active:!0}))?.[0];this.clientTabId=e?.id||a?.id,this.clearListener=q(async(s,n,o)=>{if(s==="client"&&n==="Client_ListenProxyWebsocketResponse"){let{taskId:c,listenerType:l,data:i}=o;if(c===this.id){switch(l){case"onUnpackedMessage":for(let d of this.unpackListeners)d(i);break;case"onClose":for(let d of this.closeListeners)d(i);break;case"onMessage":for(let d of this.messageListeners)d(i)}return{success:!0,message:"ok",data:!0}}}})}async open(t){await this.sendMessageToClient("Open",{url:this.url,mode:t})}async close(){this.removeAllListeners(),await this.sendMessageToClient("Close",{url:this.url}),this.clearListener?.()}async sendPacked(t){await this.sendMessageToClient("SendPacked",t)}removeAllListeners(){this.onMessage.removeAllListeners(),this.onUnpackedMessage.removeAllListeners(),this.onClose.removeAllListeners()}get onUnpackedMessage(){return{addListener:t=>{this.unpackListeners.push(t)},removeListener:t=>{this.unpackListeners=this.unpackListeners.filter(e=>e!==t)},removeAllListeners:()=>{this.unpackListeners=[]}}}get onMessage(){return{addListener:t=>{this.messageListeners.push(t)},removeListener:t=>{this.messageListeners=this.messageListeners.filter(e=>e!==t)},removeAllListeners:()=>{this.messageListeners=[]}}}get onClose(){return{addListener:t=>{this.closeListeners.push(t)},removeListener:t=>{this.closeListeners=this.closeListeners.filter(e=>e!==t)},removeAllListeners:()=>{this.closeListeners=[]}}}async sendMessageToClient(t,e){if(this.clientTabId)try{return await we.default.tabs.sendMessage(this.clientTabId,{id:f,data:{taskId:this.id,type:t,data:e},event:"Client_ListenProxyWebsocket"})}catch{return await this.close(),null}}};var Za=["nlu_direct_response_filter","deepleo","disable_emoji_spoken_text","responsible_ai_policy_235","enablemm","dv3sugg","iyxapbing","iycapbing","galileo","saharagenconv5","log2sph","savememfilter","uprofgen","uprofupd","uprofupdasy","vidsumsnip"],tn=["tnaenableux","adssqovr","tnaenable","arankc_1_9_3","rankcf","0731ziv2s0","926buffall","inosanewsmob","wrapnoins","prechr","sydtransl","806log2sph","927uprofasy","919vidsnip","829suggtrims0"],ee=class{buildChatRequest(t,e,a){let s=g(),n=[...Za],o="Balanced";return t.conversationStyle==="precise"?(n.push("h3precise"),o="Precise"):t.conversationStyle==="creative"&&(n.push("h3imaginative"),o="Creative"),{arguments:[{source:"cib",optionsSets:n,allowedMessageTypes:["Chat","InternalSearchQuery","Disengaged","InternalLoaderMessage","SemanticSerp","GenerateContentQuery","SearchQuery"],sliceIds:tn,verbosity:"verbose",scenario:"SERP",plugins:[],isStartOfSession:t.invocationId===0,message:{timestamp:new Date().toISOString(),author:"user",inputMethod:"Keyboard",text:e,imageUrl:a,messageType:"Chat",requestId:s,messageId:s},requestId:s,conversationId:t.conversationId,conversationSignature:t.conversationSignature,participant:{id:t.clientId},tone:o}],invocationId:t.invocationId.toString(),target:"chat",type:4}}async doSendMessage(t){if(!this.conversationContext)try{let s=await Is(),n=await B("BING");this.conversationContext={conversationId:s.conversationId,conversationSignature:s.conversationSignature,encryptedConversationSignature:s.encryptedConversationSignature,clientId:s.clientId,invocationId:0,conversationStyle:n?.conversationStyle||"balanced"}}catch(s){t.onEvent({type:"ERROR",error:s.message||s});return}let e=this.conversationContext,a=new te(e.encryptedConversationSignature?`wss://sydney.bing.com/sydney/ChatHub?sec_access_token=${encodeURIComponent(e.encryptedConversationSignature)}`:"wss://sydney.bing.com/sydney/ChatHub");await a.init(t.clientTabId),a.onUnpackedMessage.addListener(s=>{for(let n of s)if(JSON.stringify(n)==="{}")a.sendPacked({type:6}),a.sendPacked(this.buildChatRequest(e,t.prompt,t.imageUrl)),e.invocationId+=1;else if(n.type===6)a.sendPacked({type:6});else if(n.type===3)t.onEvent({type:"DONE",data:{conversationId:e.conversationId}}),a.removeAllListeners(),a.close();else if(n.type===1){let o=n.arguments[0]?.messages?.[0],c=o?as(o):"";c&&t.onEvent({type:"UPDATE_ANSWER",data:{text:c,conversationId:e.conversationId}})}else if(n.type===2){let o=n?.item?.messages||[],c=n?.item?.result?.error,l=!1;if(o.some(d=>d.contentOrigin==="TurnLimiter")&&(l=!0,t.onEvent({type:"ERROR",error:"Sorry, you have reached chat turns limit in this conversation."})),c==="User needs to solve CAPTCHA to continue."){l=!0;let d=`

Please visit [bing.com/turing/captcha/challenge](https://www.bing.com/turing/captcha/challenge), complete any required verifications, then try again.`;t.onEvent({type:"ERROR",error:c+d})}if(o.length===0&&n?.item?.result?.value==="UnauthorizedRequest"){l=!0,t.onEvent({type:"ERROR",error:c+`

Please sign in to [bing.com](http://bing.com/), complete any required verifications, then try again.`});return}l&&(this.conversationContext=void 0)}}),a.onClose.addListener(()=>{t.onEvent({type:"DONE",data:{conversationId:e.conversationId}})}),t.signal?.addEventListener("abort",()=>{a.removeAllListeners(),a.close(),t.onEvent({type:"ERROR",error:"manual aborted request."})}),await a.open("bing"),await a.sendPacked({protocol:"json",version:1})}resetConversation(){this.conversationContext=void 0}};var Z=class extends M{constructor(){super("BingChat");this.bingLib=new ee,this.status="success",this.init()}async init(){this.log.info("init");let e=await $();e&&(this.status=e.ON_BOARDING_RECORD_AI_PROVIDER_HAS_AUTH_BING?"success":"needAuth")}async auth(){this.active=!0,await this.updateClientStatus("success")}async askChatGPT(e,a,s){let{taskId:n,clientTabId:o}=a||{};this.log.info("askChatGPT");let c=new AbortController,l=c.signal;n&&(this.taskList[n]=()=>c.abort());let i=this.chatFiles?.[0];await Ne("wss://*.bing.com/")||s?.({type:"error",done:!0,error:"Missing bing.com permission",data:{text:"Missing bing.com permission",conversationId:""}}),await this.bingLib.doSendMessage({clientTabId:o,prompt:e,imageUrl:i?.uploadedUrl,signal:l,onEvent:d=>{d.type==="ERROR"?(s?.({type:"error",done:!0,error:d.error,data:{text:"",conversationId:""}}),n&&(this.abortTask(n),this.bingLib.resetConversation())):d.type==="UPDATE_ANSWER"?s?.({type:"message",done:!1,error:"",data:{text:d.data.text,conversationId:d.data.conversationId}}):d.type==="DONE"&&s?.({type:"message",done:!0,error:"",data:{text:"",conversationId:d.data.conversationId}})}}),await this.clearFiles()}async uploadFiles(e){this.chatFiles=e,this.chatFiles=await Promise.all(e.map(async a=>{if(a.uploadStatus!=="success"&&a.base64Data){try{let s=new FormData;s.append("knowledgeRequest",JSON.stringify({imageInfo:{},knowledgeRequest:{invokedSkills:["ImageById"],subscriptionId:"Bing.Chat.Multimodal.Underside",invokedSkillsRequestData:{enableFaceBlur:!0},convoData:{convoid:"",convotone:"Balanced"}}})),s.append("imageBase64",a.base64Data.replace("data:","").replace(/^.+,/,""));let n=await R("https://www.bing.com/images/kblob",{method:"POST",body:s});n?.blobId?(a.uploadedUrl=`https://www.bing.com/images/blob?bcid=${n.blobId}`,a.uploadStatus="success"):(a.uploadStatus="error",a.uploadErrorMessage="Failed to upload image"),this.log.info("uploadFiles",a)}catch(s){a.uploadStatus="error",a.uploadErrorMessage="Failed to upload image",this.log.error("uploadFiles",s,a)}return a}return a}))}async removeConversation(){return this.bingLib.resetConversation(),Promise.resolve(!0)}async destroy(){this.bingLib.resetConversation(),await this.clearFiles()}};var Bs=A(pa()),Ds=A(_());var Us=A(Ss());var ks=`query ChatViewQuery($bot: String!) {
  chatOfBot(bot: $bot) {
    id
    chatId
    defaultBotNickname
    shouldShowDisclaimer
  }
}
`;var Es=`mutation AddMessageBreakMutation($chatId: BigInt!) {
  messageBreakCreate(chatId: $chatId) {
    message {
      id
      __typename
      messageId
      text
      linkifiedText
      authorNickname
      state
      vote
      voteReason
      creationTime
      suggestedReplies
    }
  }
}
`;var Fs=`mutation chatHelpers_sendMessageMutation_Mutation(
  $chatId: BigInt!
  $bot: String!
  $query: String!
  $source: MessageSource
  $withChatBreak: Boolean!
) {
  messageEdgeCreate(chatId: $chatId, bot: $bot, query: $query, source: $source, withChatBreak: $withChatBreak) {
    chatBreak {
      cursor
      node {
        id
        messageId
        text
        author
        suggestedReplies
        creationTime
        state
      }
      id
    }
    message {
      cursor
      node {
        id
        messageId
        text
        author
        suggestedReplies
        creationTime
        state
        chat {
          shouldShowDisclaimer
          id
        }
      }
      id
    }
  }
}
`;var Ms=`mutation subscriptionsMutation($subscriptions: [AutoSubscriptionQuery!]!) {
  autoSubscribe(subscriptions: $subscriptions) {
    viewer {
      id
    }
  }
}
`;var Os=`subscription messageAdded($chatId: BigInt!) {
  messageAdded(chatId: $chatId) {
    id
    messageId
    creationTime
    state
    ...ChatMessage_message
    ...chatHelpers_isBotMessage
  }
}

fragment ChatMessageDownvotedButton_message on Message {
  ...MessageFeedbackReasonModal_message
  ...MessageFeedbackOtherModal_message
}

fragment ChatMessageDropdownMenu_message on Message {
  id
  messageId
  vote
  text
  linkifiedText
  ...chatHelpers_isBotMessage
}

fragment ChatMessageFeedbackButtons_message on Message {
  id
  messageId
  vote
  voteReason
  ...ChatMessageDownvotedButton_message
}

fragment ChatMessageOverflowButton_message on Message {
  text
  ...ChatMessageDropdownMenu_message
  ...chatHelpers_isBotMessage
}

fragment ChatMessageSuggestedReplies_SuggestedReplyButton_message on Message {
  messageId
}

fragment ChatMessageSuggestedReplies_message on Message {
  suggestedReplies
  ...ChatMessageSuggestedReplies_SuggestedReplyButton_message
}

fragment ChatMessage_message on Message {
  id
  messageId
  text
  author
  linkifiedText
  state
  ...ChatMessageSuggestedReplies_message
  ...ChatMessageFeedbackButtons_message
  ...ChatMessageOverflowButton_message
  ...chatHelpers_isHumanMessage
  ...chatHelpers_isBotMessage
  ...chatHelpers_isChatBreak
  ...chatHelpers_useTimeoutLevel
  ...MarkdownLinkInner_message
}

fragment MarkdownLinkInner_message on Message {
  messageId
}

fragment MessageFeedbackOtherModal_message on Message {
  id
  messageId
}

fragment MessageFeedbackReasonModal_message on Message {
  id
  messageId
}

fragment chatHelpers_isBotMessage on Message {
  ...chatHelpers_isHumanMessage
  ...chatHelpers_isChatBreak
}

fragment chatHelpers_isChatBreak on Message {
  author
}

fragment chatHelpers_isHumanMessage on Message {
  author
}

fragment chatHelpers_useTimeoutLevel on Message {
  id
  state
  text
  messageId
}
`;var Rs=`subscription viewerStateUpdated {
  viewerStateUpdated {
    id
    ...ChatPageBotSwitcher_viewer
  }
}

fragment BotHeader_bot on Bot {
  displayName
  messageLimit {
    dailyLimit
  }
  ...BotImage_bot
}

fragment BotImage_bot on Bot {
  image {
    __typename
    ... on LocalBotImage {
      localName
    }
    ... on UrlBotImage {
      url
    }
  }
  displayName
}

fragment BotLink_bot on Bot {
  displayName
}

fragment ChatPageBotSwitcher_viewer on Viewer {
  availableBots {
    id
    messageLimit {
      dailyLimit
    }
    ...BotLink_bot
    ...BotHeader_bot
  }
  allowUserCreatedBots: booleanGate(gateName: "enable_user_created_bots")
}
`;var Te={AddMessageBreakMutation:Es,ChatViewQuery:ks,SendMessageMutation:Fs,SubscriptionsMutation:Ms,MessageAddedSubscription:Os,ViewerStateUpdatedSubscription:Rs};async function dn(){let e=(await R("https://poe.com",{parseResponse:o=>o})).match(/<script>if(.+)throw new Error;(.+),window.+<\/script>/)[2],a=e.match(/var .="(\w+)"/)[1],s=Array.from(e.matchAll(/\[(\d+)\]=.\[(\d+)\]/g)).map(o=>[Number(o[1]),Number(o[2])]),n=Array(s.length);for(let[o,c]of s)n[o]=a[c];return n.join("")}async function Ls(){let[r,t]=await Promise.all([R("https://poe.com/api/settings"),dn().catch(e=>{throw new Error("Failed to get formkey")})]);return r.formkey=t,r}async function Pt(r,t,e){let s={query:Te[r],variables:t},n=(0,Us.default)(JSON.stringify(s)+e.formkey+"WpuLMiXEKKE98j56k");return R("https://poe.com/api/gql_POST",{method:"POST",body:s,headers:{"poe-formkey":e.formkey,"poe-tag-id":n,"poe-tchannel":e.tchannelData.channel}})}async function Gs(r,t){let e=await Pt("ChatViewQuery",{bot:r},t);if(!e.data)throw new Error("[Log into poe.com to continue.](https://www.poe.com)");return e.data.chatOfBot.chatId}async function un(r){return Ds.default.permissions.request({origins:[r]})}var se=class{async doSendMessage(t){if(!await un("https://*.poe.com/")){t.onEvent({type:"ERROR",error:"Missing poe.com permission."});return}if(!this.conversationContext){let s=await qt(),{poeModel:n}={poeModel:s.thirdProviderSettings?.CLAUDE?.model||"a2"};try{let{poeSettings:o,chatId:c}=await this.getChatInfo(n),l=await this.connectWebsocket(o);await this.subscribe(o),this.conversationContext={botId:n,chatId:c,poeSettings:o,wsp:l}}catch(o){t.onEvent({type:"ERROR",error:o.message});return}}let e=this.conversationContext.wsp,a=s=>{let n=s.messages.map(o=>JSON.parse(o));for(let o of n)if(o.message_type==="subscriptionUpdate"&&o.payload.subscription_name==="messageAdded"){let c=o.payload.data.messageAdded;t.onEvent({type:"UPDATE_ANSWER",data:{text:c.text,conversationId:String(this.conversationContext?.chatId||"")}}),c.state==="complete"&&(t.onEvent({type:"DONE",data:{conversationId:String(this.conversationContext?.chatId||"")}}),e.onUnpackedMessage.removeAllListeners())}};e.onUnpackedMessage.addListener(a);try{await e.open()}catch{e.removeAllListeners(),e.close(),t.onEvent({type:"ERROR",error:"Please ensure [you've logged into poe.com](https://www.poe.com) and retry."});return}try{await this.sendMessageRequest(t.prompt)}catch(s){e.removeAllListeners(),e.close(),t.onEvent({type:"ERROR",error:s.message})}}resetConversation(){if(!this.conversationContext)return;let t=this.conversationContext.wsp;t.removeAllListeners(),t.close(),this.sendChatBreak(),this.conversationContext=void 0}async getChatInfo(t){let e=await Ls(),a=await Gs(t,e);return{poeSettings:e,chatId:a}}async sendMessageRequest(t){let{poeSettings:e,botId:a,chatId:s}=this.conversationContext;if(!(await Pt("SendMessageMutation",{bot:a,chatId:s,query:t,source:null,withChatBreak:!1},e)).data.messageEdgeCreate.message)throw new Error("You\u2019ve reached the daily free message limit for this model")}async sendChatBreak(){let{chatId:t,poeSettings:e}=this.conversationContext;await Pt("AddMessageBreakMutation",{chatId:t},e)}async subscribe(t){await Pt("SubscriptionsMutation",{subscriptions:[{subscriptionName:"messageAdded",query:Te.MessageAddedSubscription}]},t)}async getWebsocketUrl(t){let e=`tch${Math.floor(Math.random()*1e6)+1}`,a=t.tchannelData;return`wss://${e}.tch.${a.baseHost}/up/${a.boxName}/updates?min_seq=${a.minSeq}&channel=${a.channel}&hash=${a.channelHash}`}async connectWebsocket(t){let e=await this.getWebsocketUrl(t);return new Bs.default(e,{packMessage:s=>JSON.stringify(s),unpackMessage:s=>JSON.parse(s)})}};var Tt=class extends M{constructor(){super("PoeChat");this.poeLib=new se,this.status="success",this.init()}async init(){this.log.info("init");let e=await $();e&&(this.status=e.ON_BOARDING_RECORD_AI_PROVIDER_HAS_AUTH_POE?"success":"needAuth")}async auth(){this.active=!0,await this.updateClientStatus("success")}async askChatGPT(e,a,s){let{taskId:n}=a||{};this.log.info("askChatGPT");let o=new AbortController,c=o.signal;n&&(this.taskList[n]=()=>o.abort()),await this.poeLib.doSendMessage({prompt:e,signal:c,onEvent(l){l.type==="ERROR"?s?.({type:"error",done:!0,error:l.error,data:{text:"",conversationId:""}}):l.type==="UPDATE_ANSWER"?s?.({type:"message",done:!1,error:"",data:{text:l.data.text,conversationId:l.data.conversationId}}):l.type==="DONE"&&s?.({type:"message",done:!0,error:"",data:{text:"",conversationId:l.data.conversationId}})}})}resetConversation(){this.poeLib.resetConversation()}};var _t=async()=>{try{return(await(await fetch("https://claude.ai/api/organizations",{redirect:"error",cache:"no-cache"})).json())?.[0]?.uuid}catch{return""}},Ws=async(r,t)=>{try{if(!r)return;let e=g(),a=await fetch(`https://claude.ai/api/organizations/${r}/chat_conversations`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t||"",uuid:e})});if(a.status===201||a.status===200){let s=await a.json();return s.uuid?s:void 0}else return}catch{return}},hn=async r=>{try{let t=await fetch(`https://claude.ai/api/organizations/${r}/chat_conversations`,{method:"GET"});if(t.status===200){let e=await t.json();return e.length?e:[]}return[]}catch{return[]}},Ns=async(r,t)=>{let e=await hn(r);e=e.filter(s=>s.name===t);let a=[];for(;e.length;)a=e.splice(0,5).map(s=>s.uuid),await Promise.all(a.map(s=>_e(r,s))),await new Promise(s=>setTimeout(s,5e3))},_e=async(r,t)=>{try{let e=await fetch(`https://claude.ai/api/organizations/${r}/chat_conversations/${t}`,{method:"DELETE"});return e.status===204||e.status===200}catch{return!1}},Hs=async(r,t,e)=>{let a=new FormData;a.append("file",t,e||t?.name||""),a.append("orgUuid",r);let s=await fetch("https://claude.ai/api/convert_document",{method:"POST",body:a});if(s.status===200){let o=await s.json();if(o.extracted_content)return o.file_name=e||t?.name||o.file_name||"",{success:!0,data:o,error:""}}let n="Upload failed.";return s.status===429&&(n="Exceeded file upload rate limit"),{success:!1,data:void 0,error:n}};var ae=class{constructor(t){this.attachments=[];this.organizationId=t}get conversationId(){return this.conversation?.uuid}async createConversation(t){return this.organizationId||(this.organizationId=await _t()),this.organizationId&&(this.conversation=await Ws(this.organizationId,t)),this.conversation?.uuid||""}async sendMessage(t,e){let{regenerate:a=!1,onMessage:s}=e||{},n=this.conversation?.uuid;if((!n||!this.organizationId)&&(n=await this.createConversation(),!n||!this.organizationId)){s?.({completion:"",log_id:"",messageLimit:{type:"within_limit"},model:"",stop:!0,stop_reason:"Please log into [Claude.ai](https://claude.ai/chats) and try again."});return}this.abortController=new AbortController;let o=this.abortController.signal,c=a?"https://claude.ai/api/retry_message":"https://claude.ai/api/append_message";a&&(t="");let l=await B("CLAUDE");await ut(c,{signal:o,method:"POST",provider:"CLAUDE",headers:{"Content-Type":"application/json"},body:JSON.stringify({attachments:this.attachments.map(i=>{let d=Ge(i);return delete d.id,d}),completion:{incremental:!0,model:l?.model||"claude-2",prompt:t,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone},conversation_uuid:n,organization_uuid:this.organizationId,text:t}),onMessage:i=>{try{let d=JSON.parse(i);if(d.log_id)s?.(d);else if(d?.error?.message){let u=d?.error?.message||"Network Error";u==="Overloaded"&&(u="You've sent too many requests to the Claude model. You can continue with the other AI Providers now, or try again later."),s?.({completion:"",log_id:"",messageLimit:{type:"within_limit"},model:"",stop:!0,stop_reason:u})}}catch{}}}).then(()=>{}).catch(i=>{if(i?.message==="BodyStreamBuffer was aborted"||i?.message==="The user aborted a request."){s?.({completion:"",log_id:"",messageLimit:{type:"within_limit"},model:"",stop:!0,stop_reason:"The user aborted a request."});return}try{let d=JSON.parse(i.message),u=d?.error?.message||d?.message||"Network Error";s?.({completion:"",log_id:"",messageLimit:{type:"within_limit"},model:"",stop:!0,stop_reason:u})}catch{s?.({completion:"",log_id:"",messageLimit:{type:"within_limit"},model:"",stop:!0,stop_reason:"Network Error"})}}),this.resetAttachments()}abortSendMessage(){this.abortController?.abort()}async resetConversation(){if(this.conversation?.uuid&&this.organizationId){let t=await _e(this.organizationId,this.conversation.uuid)}return this.conversation=void 0,!0}async uploadAttachment(t,e){if(!this.organizationId&&(this.organizationId=await _t(),!this.organizationId))return{success:!1,error:"organization id not found",data:void 0};if(t.size>10*1024*1024)return{success:!1,error:"file size too large",data:void 0};let a=await Hs(this.organizationId,t,e||t.name);if(a.success&&a.data){let s=a.data;return s.id=g(),this.attachments.push(s),{success:!0,error:void 0,data:s}}else return{success:!1,error:a.error||"Upload failed.",data:void 0}}resetAttachments(){return this.attachments=[],!0}removeAttachment(t){let e=this.attachments.findIndex(a=>a.id===t);return e>-1&&this.attachments.splice(e,1),!0}};var gt=A(_());var mt="CHROME_EXTENSION_LOCAL_STORAGE_CLAUDE_TOKEN_KEY",qs="MaxAI.me",tt=class extends M{constructor(){super("ClaudeChat");this.claude=new ae,this.status="needAuth"}async init(){this.log.info("init")}async preAuth(){this.active=!0;let e=await gt.default.storage.local.get(mt);e[mt]&&(this.claude.organizationId=e[mt]),this.status=this.claude.organizationId?"success":"needAuth",await this.updateClientStatus(this.status)}async auth(){this.active=!0,this.claude.organizationId=await _t(),this.claude.organizationId?(this.status="success",await gt.default.storage.local.set({[mt]:this.claude.organizationId}),await this.updateClientStatus("success")):await gt.default.tabs.create({url:"https://claude.ai/chats",active:!0})}async createConversation(e){if(this.conversation||await super.createConversation(e),this.conversation?.meta.AIConversationId)return this.conversation.id;let a=await this.claude.createConversation(qs);return this.claude.organizationId?await gt.default.storage.local.set({[mt]:this.claude.organizationId}):(await gt.default.storage.local.remove(mt),this.status="needAuth",await this.updateClientStatus("needAuth")),this.conversation&&(this.conversation.meta.AIConversationId=a,await w.conversationDB.addOrUpdateConversation(this.conversation)),this.conversation?.id||""}async askChatGPT(e,a,s){let{regenerate:n}=a||{},o="";this.log.info("ClaudeChat send"),await this.claude.sendMessage(e,{regenerate:n,onMessage:c=>{c.stop?c.stop_reason==="stop_sequence"?s?.({type:"message",done:!0,error:"",data:{text:o,conversationId:this.claude.conversationId}}):c.stop_reason==="The user aborted a request."?s?.({type:"error",error:"manual aborted request.",done:!0,data:{text:"",conversationId:this.claude.conversationId}}):s?.({type:"error",done:!0,error:c.stop_reason||"Network Error",data:{text:o,conversationId:this.claude.conversationId}}):(o+=c.completion||"",s?.({type:"message",done:!1,error:"",data:{text:o,conversationId:this.claude.conversationId}}))}}),await this.clearFiles()}async abortTask(e){return this.claude.abortSendMessage(),!0}async removeConversation(){this.conversation=void 0,await this.claude.resetConversation(),this.claude.organizationId&&Ns(this.claude.organizationId,qs).then().catch()}async getUploadFileToken(){return this.claude.organizationId||await this.auth(),this.claude.organizationId}async uploadFiles(e){this.chatFiles=e,this.chatFiles=await Promise.all(e.map(async a=>{if(a.uploadStatus!=="success"){let[s,n]=Kt(a.file),o=new Blob([s],{type:n});if(n.includes("pdf")){let c=await this.claude.uploadAttachment(o,a.fileName);return c.success&&c.data?{...a,id:c.data.id,file:void 0,uploadStatus:"success",uploadProgress:100}:{...a,file:void 0,uploadStatus:"error",uploadProgress:0,uploadErrorMessage:c.error}}else{let c=await o.text(),l={id:g(),extracted_content:c,file_name:a.fileName,file_size:a.fileSize,file_type:n,totalPages:1};return this.claude.attachments.push(l),{...a,id:l.id,file:void 0,uploadStatus:"success",uploadProgress:100}}}return a}))}async removeFiles(e){return await super.removeFiles(e),e.forEach(a=>{this.claude.removeAttachment(a)}),!0}async destroy(){await this.clearFiles(),this.claude.resetAttachments(),this.status="needAuth",await this.updateClientStatus("needAuth"),this.active=!1}};var Qs=A(_());var ln=new G("Background/Chat/ChatSystem"),xt=class{constructor(){this.adapters={};this.sendQuestion=(t,e,a,s)=>this.currentAdapter?.sendQuestion(t,e,a,s)||Promise.resolve();this.initChatSystem()}get conversation(){return this.currentAdapter?.conversation}get status(){return this.currentAdapter?this.currentAdapter.status:"needAuth"}get currentAdapter(){return this.currentProvider?this.adapters[this.currentProvider]:void 0}get chatFiles(){return this.currentAdapter?.chatFiles||[]}initChatSystem(){q(async(t,e,a,s)=>{if(t==="client")switch(e){case"Client_switchAIProvider":{let{provider:n}=a;return await this.switchAdapter(n),{success:!0,data:{provider:n},message:""}}break;case"Client_authChatGPTProvider":{let{provider:n}=a;return await this.switchAdapter(n),await this.auth(s.tab?.id||0),{success:!0,data:{},message:""}}case"Client_checkChatGPTStatus":return{success:!0,data:{status:this.status},message:""};case"Client_createChatGPTConversation":{let n=a.initConversationData||{};n.meta.AIProvider&&this.currentProvider!==n.meta.AIProvider&&await this.switchAdapter(n.meta.AIProvider);let o=await this.createConversation(n||{});return o?{success:!0,data:{conversationId:o},message:""}:{success:!1,data:{conversationId:o},message:"create conversation failed"}}case"Client_changeConversation":{let{conversationId:n}=a;if(n){let o=await w.conversationDB.getConversationById(n);if(o)return await this.switchAdapterWithConversation(o),{success:!0,data:{conversationId:n}}}return{success:!1,data:{},message:""}}case"Client_askChatGPTQuestion":{let n=a.taskId,o=a.question,c=a.options;if(o.conversationId){let l=await w.conversationDB.getConversationById(o.conversationId);if(l){l?.meta?.AIProvider&&l.meta.AIProvider!==this.currentProvider?await this.switchAdapterWithConversation(l):l.id&&await this.currentAdapter?.createConversation(l);let i=await Ve(l,o,c);o=i.question,c=i.options,await this.updateClientConversationMessages(l.id)}}await this.sendQuestion(n,s,o,c),this.updateClientFiles()}break;case"Client_removeChatGPTConversation":{let{conversationId:n,isForceRemove:o=!1}=a;if(o&&n)return{success:await w.removeConversation(n),data:{},message:""};let c=await this.removeConversation(n||"");return await this.updateClientConversationMessages(n),{success:c,data:{},message:""}}case"Client_abortAskChatGPTQuestion":{let{messageId:n}=a;return await this.abortAskQuestion(n),{success:!0,data:{},message:""}}case"Client_destroyWithLogout":return await this.destroy(),{success:!0,data:{},message:""};case"Client_chatGetFiles":return{success:!0,data:this.chatFiles,message:""};case"Client_chatUploadFiles":{let{files:n}=a;return await this.uploadFiles(n),this.updateClientFiles(),{success:!0,data:this.chatFiles,message:""}}break;case"Client_chatAbortUploadFiles":{let{files:n}=a,o=await this.abortUploadFiles(n.map(c=>c.id));return this.updateClientFiles(),{success:o,data:this.chatFiles,message:""}}break;case"Client_chatRemoveFiles":{let{files:n}=a,o=await this.removeFiles(n.map(c=>c.id));return this.updateClientFiles(),{success:o,data:this.chatFiles,message:""}}break;case"Client_chatClearFiles":{let n=await this.clearFiles();return this.updateClientFiles(),{success:n,data:this.chatFiles,message:""}}break;case"Client_chatUploadFilesChange":{let{files:n}=a;return await this.updateFiles(n),await this.updateClientFiles(),{success:!0,data:{},message:"ok"}}break;case"Client_chatGetUploadFileToken":return{success:!0,data:await this.getUploadFileToken(),message:"ok"};default:break}}),qt().then(async t=>{t.sidebarSettings?.common?.currentAIProvider&&await this.switchAdapter(t.sidebarSettings.common?.currentAIProvider)})}addAdapter(t,e){this.adapters[t]=e}async switchAdapter(t){this.currentProvider=t,await je(e=>(e.sidebarSettings?.common&&(e.sidebarSettings.common.currentAIProvider=t),e)),await this.preAuth();try{Qs.default.runtime.setUninstallURL(`${Ut}/survey/uninstall?version=${z}&provider=${t}`)}catch(e){ln.error("switchAdapter","setUninstallURL",e)}return await U("Client_updateAppSettings",{data:{}}),this.currentAdapter}async auth(t){if(this.currentAdapter){await this.currentAdapter.auth(t);let e=await $(),a=`ON_BOARDING_RECORD_AI_PROVIDER_HAS_AUTH_${this.currentProvider}`;Object.prototype.hasOwnProperty.call(e,a)&&await Bt(a,!0)}}async preAuth(){if(this.currentAdapter){let t=await $(),e=`ON_BOARDING_RECORD_AI_PROVIDER_HAS_AUTH_${this.currentProvider}`;Object.prototype.hasOwnProperty.call(t,e)?t[e]?await this.currentAdapter.preAuth():await U("Client_ChatGPTStatusUpdate",{status:"needAuth"}):await this.currentAdapter.preAuth()}}async abortAskQuestion(t){return this.currentAdapter?await this.currentAdapter.abortAskQuestion(t):!1}async createConversation(t){return this.currentAdapter&&await this.currentAdapter?.createConversation(t)||""}async removeConversation(t){if(!t)return!1;let e=await w.getClientConversation(t),a=e?.meta.AIProvider;if(a){let s=this.adapters[a];await s?.createConversation(e),await s?.removeConversation(t)}else await w.conversationDB.deleteConversation(t);return!0}async destroy(){await this.currentAdapter?.removeConversation(""),await this.currentAdapter?.destroy(),await this.currentAdapter?.clearFiles()}async uploadFiles(t){if(this.currentAdapter)return await this.currentAdapter.uploadFiles(t)}async updateFiles(t){if(this.currentAdapter)return await this.currentAdapter.updateFiles(t)}async abortUploadFiles(t){return this.currentAdapter?await this.currentAdapter.abortUploadFiles(t):!1}async removeFiles(t){return this.currentAdapter?await this.currentAdapter.removeFiles(t):!1}async getFiles(){return this.chatFiles}async getUploadFileToken(){return this.currentAdapter?await this.currentAdapter.getUploadFileToken():null}async clearFiles(){return this.currentAdapter?await this.currentAdapter.clearFiles():!1}async updateClientFiles(){U("Client_listenUploadFilesChange",{files:this.chatFiles})}async updateClientConversationMessages(t){let e=await w.getClientConversation(t);U("Client_listenUpdateConversationMessages",{conversation:e,conversationId:t})}async switchAdapterWithConversation(t,e=!0){let a=t.meta.AIProvider;if(a){let s=await B(a);await ze(a,{...s,model:t.meta.AIModel||s?.model}),await this.switchAdapter(a),await this.currentAdapter?.createConversation(t),e&&await this.updateClientConversationMessages(t.id)}}};var xe=A(_());var j=new G("Background/Chat/MaxAIClaudeChat"),et=class extends M{constructor(){super("MaxAIClaudeChat");this.status="needAuth";this.init()}init(){j.info("init")}async preAuth(){this.active=!0,await this.checkTokenAndUpdateStatus()}async auth(e){this.active=!0,this.lastActiveTabId=e,await this.checkTokenAndUpdateStatus(),this.status==="needAuth"&&await xe.default.tabs.create({active:!0,url:Lt}),await this.updateClientStatus()}async checkTokenAndUpdateStatus(){let e=this.status;this.token=await this.getToken(),this.status=this.token?"success":"needAuth",e!==this.status&&(j.info("checkTokenAndUpdateStatus",this.status,this.lastActiveTabId),this.lastActiveTabId=void 0),await this.updateClientStatus()}async askChatGPT(e,a,s){if(await this.checkTokenAndUpdateStatus(),this.status!=="success"){s&&s({type:"error",done:!0,error:"Your session has expired. Please log in.",data:{text:"",conversationId:""}});return}let{taskId:n,streaming:o=!0,regenerate:c=!1,chat_history:l=[],meta:i}=a||{},d=await B("MAXAI_CLAUDE"),u=Object.assign({chat_history:l,regenerate:c,streaming:o,message_content:e,chrome_extension_version:z,model_name:this.conversation?.meta.AIModel||d.model||Ht[0].value,prompt_id:i?.contextMenu?.id||"chat",prompt_name:i?.contextMenu?.text||"chat"}),h=new AbortController,p=h.signal;n&&(this.taskList[n]=()=>h.abort()),j.info("streaming start",u);let m="",I=!1,b=!1,C=0,D=this.conversation?.id||"",W=(await xe.default.storage.local.get(dt))[dt]||{},Ct=W.interval||50,yt=W.rate||.5,Ft=E=>new Promise(P=>setTimeout(P,E)),vt=async()=>{if(b)return;if(I&&C===m.length){j.info("streaming end success"),s&&s({done:!0,type:"message",error:"",data:{text:"",conversationId:D}});return}let E=0,P=Math.floor(m.length-C);if(I){let T=Math.max(Math.floor(m.length*.1),10);E=m.slice(C,T+C).length}else{let T=Math.floor(P*yt);E=m.slice(C,T+C).length}E>0&&(j.debug("streaming echo message",I?"\u4E00\u79D2\u53D1\u9001\u5B8C\u5269\u4E0B\u7684\u6587\u672C":`\u6BCF${Ct}\u6BEB\u79D2\u53D1\u9001\u5269\u4F59\u6587\u672C\u7684${(yt*100).toFixed(0)}%`,C,E,m.length),C+=E,s&&s({type:"message",done:!1,error:"",data:{text:m.slice(0,C),conversationId:D}})),await Ft(I?100:Ct),await vt()};vt();let Mt=!1;await ut(`${ct}/gpt/get_claude_response`,{provider:N.USE_CHAT_GPT_PLUS,method:"POST",signal:p,headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify(u),onMessage:E=>{try{let P=JSON.parse(E);P?.conversation_id&&(D=P.conversation_id),P?.text&&(m+=P.text),j.debug("streaming on message",m)}catch(P){j.error("parse message.data error: 	",P)}}}).then().catch(E=>{if(j.info("streaming end error",E),I=!0,b=!0,E?.message==="BodyStreamBuffer was aborted"||E?.message==="The user aborted a request."){s&&s({type:"error",error:"manual aborted request.",done:!0,data:{text:"",conversationId:D}});return}try{let P=JSON.parse(E.message||E);if(P.msg&&jt(P.msg)){s&&s({type:"error",error:P.msg,done:!0,data:{text:"",conversationId:D}});return}P?.code===401&&(Mt=!0),j.error("sse error",E),s&&s({done:!0,type:"error",error:P.message||P.detail||"Network error.",data:{text:"",conversationId:D}})}catch{s&&s({done:!0,type:"error",error:"Network error.",data:{text:"",conversationId:D}})}}),I||(j.info("streaming end success"),m===""?(Xt("[API] response empty string.",JSON.stringify({model:u.model_name,promptTextLength:u.message_content.length},null,2),{uuid:"6f02f533-def6-4696-b14e-1b00c2d9a4df"}),s&&s({done:!0,type:"error",error:"Something went wrong, please try again. If this issue persists, contact us via email.",data:{text:"",conversationId:D}})):I=!0),Mt&&(j.info("user token expired"),this.status="needAuth",await ht(),await this.updateClientStatus())}async abortTask(e){return this.taskList[e]&&(this.taskList[e](),delete this.taskList[e]),!0}async destroy(){j.info("destroy"),this.status="needAuth",this.active=!1}async getToken(){return await lt()}async updateClientStatus(){this.active&&await U("Client_ChatGPTStatusUpdate",{status:this.status})}};var St=class{constructor(t){this.sendQuestion=(t,e,a,s)=>this.openAIChat.sendQuestion(t,e,a,s);this.openAIChat=t}async preAuth(){return this.openAIChat.preAuth()}async auth(t){await this.openAIChat.auth(t)}get status(){return this.openAIChat.status}get conversation(){return this.openAIChat.conversation}async abortAskQuestion(t){return await this.openAIChat.abortAskQuestion(t)}async createConversation(t){return t?.id&&this.openAIChat.conversation?.id&&t.id!==this.openAIChat.conversation.id&&await this.openAIChat.removeConversation(this.openAIChat.conversation.id),await this.openAIChat.createConversation(t)}async removeConversation(t){return await this.openAIChat.removeConversation(t)}destroy(){return this.openAIChat.destroy()}get chatFiles(){return this.openAIChat.chatFiles}async uploadFiles(t){return await this.openAIChat.uploadFiles(t)}async updateFiles(t){return await this.openAIChat.updateFiles(t)}async removeFiles(t){return await this.openAIChat.removeFiles(t)}async getFiles(){return await this.openAIChat.getFiles()}async getUploadFileToken(){return await this.openAIChat.getUploadFileToken()}async abortUploadFiles(t){return await this.openAIChat.abortUploadFiles(t)}async clearFiles(){return await this.openAIChat.clearFiles()}};var k=class{constructor(t){this.sendQuestion=(t,e,a,s)=>this.chatAdapter.sendQuestion(t,e,a,s);this.chatAdapter=t}async preAuth(){await this.chatAdapter.preAuth()}async auth(t){await this.chatAdapter.auth(t)}get status(){return this.chatAdapter.status}get conversation(){return this.chatAdapter.conversation}async abortAskQuestion(t){return await this.chatAdapter.abortAskQuestion(t)}async destroy(){await this.chatAdapter.destroy()}async createConversation(t){return await this.chatAdapter.createConversation(t)}async removeConversation(t){return await this.chatAdapter.removeConversation(t)}get chatFiles(){return this.chatAdapter.chatFiles}async getUploadFileToken(){return await this.chatAdapter.getUploadFileToken()}async updateFiles(t){await this.chatAdapter.updateFiles(t)}async uploadFiles(t){return await this.chatAdapter.uploadFiles(t)}async abortUploadFiles(t){return await this.chatAdapter.abortUploadFiles(t)}async removeFiles(t){return await this.chatAdapter.removeFiles(t)}async getFiles(){return await this.chatAdapter.getFiles()}async clearFiles(){return await this.chatAdapter.clearFiles()}};var js=A(_());var st=class{constructor(t){this.sendQuestion=async(t,e,a,s)=>{let n=g(),o=[{role:"system",content:this.openAiApiChat.conversation?.meta.systemPrompt||Qe}];s.historyMessages?.forEach(c=>{o.push({role:c.type==="ai"?"assistant":"user",content:c.text})}),await this.openAiApiChat.askChatGPT(a.question,{taskId:a.messageId,regenerate:s.regenerate,include_history:s.includeHistory,max_history_message_cnt:s.maxHistoryMessageCnt,history:o,meta:s.meta},async({type:c,done:l,error:i,data:d})=>{e.tab?.id&&await this.sendResponseToClient(e.tab.id,{taskId:t,data:{text:d.text,parentMessageId:a.messageId,conversationId:d.conversationId,messageId:n},error:i,done:l})})};this.openAiApiChat=t}async auth(t){await this.openAiApiChat.auth()}async preAuth(){await this.openAiApiChat.preAuth()}get status(){return this.openAiApiChat.checkApiKey(),this.openAiApiChat.status}get conversation(){return this.openAiApiChat.conversation}async createConversation(t){return t?.id&&this.openAiApiChat.conversation?.id&&t.id!==this.openAiApiChat.conversation.id&&await this.openAiApiChat.resetMessagesContext(),await this.openAiApiChat.createConversation(t)}async removeConversation(t){return await this.openAiApiChat.removeConversationWithCache(),await this.openAiApiChat.resetMessagesContext(),Promise.resolve(!0)}async abortAskQuestion(t){return await this.openAiApiChat.abortTask(t)}async destroy(){await this.openAiApiChat.destroy()}async sendResponseToClient(t,e){await js.default.tabs.sendMessage(t,{id:f,event:"Client_askChatGPTQuestionResponse",data:e})}get chatFiles(){return this.openAiApiChat.chatFiles}async uploadFiles(t){return await this.openAiApiChat.uploadFiles(t)}async updateFiles(t){return await this.openAiApiChat.updateFiles(t)}async getUploadFileToken(){return await this.openAiApiChat.getUploadFileToken()}async removeFiles(t){return await this.openAiApiChat.removeFiles(t)}async getFiles(){return await this.openAiApiChat.getFiles()}async abortUploadFiles(t){return await this.openAiApiChat.abortUploadFiles(t)}async clearFiles(){return await this.openAiApiChat.clearFiles()}};var $s=A(_());var at=class{constructor(t){this.sendQuestion=async(t,e,a,s)=>{let n=g(),o=[],l=(await w.conversationDB.getConversationById(a.conversationId))?.meta?.docId;this.useChatGPTPlusChat.conversation&&(!l&&this.useChatGPTPlusChat.conversation.meta.systemPrompt&&o.push({type:"system",data:{content:this.useChatGPTPlusChat.conversation.meta.systemPrompt,additional_kwargs:{}}}),s.historyMessages?.forEach(i=>{o.push({type:i.type==="ai"?"ai":"human",data:{content:i.text,additional_kwargs:{}}})})),l&&o?.[0]?.type==="human"&&o.splice(0,2),await this.useChatGPTPlusChat.askChatGPT(a.question,{doc_id:l,backendAPI:l?"chat_with_document":"get_chatgpt_response",taskId:a.messageId,chat_history:o,meta:s.meta},async({type:i,done:d,error:u,data:h})=>{e.tab?.id&&await this.sendResponseToClient(e.tab.id,{taskId:t,data:{text:h.text,parentMessageId:a.messageId,conversationId:h.conversationId,messageId:n},error:u,done:d})})};this.useChatGPTPlusChat=t}async auth(t){await this.useChatGPTPlusChat.auth(t)}async preAuth(){await this.useChatGPTPlusChat.preAuth()}get status(){return this.useChatGPTPlusChat.status}get conversation(){return this.useChatGPTPlusChat.conversation}async createConversation(t){return await this.useChatGPTPlusChat.createConversation(t)}async removeConversation(t){return await this.useChatGPTPlusChat.removeConversationWithCache(),Promise.resolve(!0)}async abortAskQuestion(t){return await this.useChatGPTPlusChat.abortTask(t)}async destroy(){await this.useChatGPTPlusChat.destroy()}async sendResponseToClient(t,e){await $s.default.tabs.sendMessage(t,{id:f,event:"Client_askChatGPTQuestionResponse",data:e})}get chatFiles(){return this.useChatGPTPlusChat.chatFiles}async uploadFiles(t){return await this.useChatGPTPlusChat.uploadFiles(t)}async updateFiles(t){return await this.useChatGPTPlusChat.updateFiles(t)}async getUploadFileToken(){return await this.useChatGPTPlusChat.getUploadFileToken()}async removeFiles(t){return await this.useChatGPTPlusChat.removeFiles(t)}async getFiles(){return await this.useChatGPTPlusChat.getFiles()}async abortUploadFiles(t){return await this.useChatGPTPlusChat.abortUploadFiles(t)}async clearFiles(){return await this.useChatGPTPlusChat.clearFiles()}};var zs=A(_());var nt=class{constructor(t){this.sendQuestion=async(t,e,a,s)=>{let n=g();await this.bardChat.askChatGPT(a.question,{taskId:a.messageId,regenerate:s.regenerate,include_history:s.includeHistory,max_history_message_cnt:s.maxHistoryMessageCnt},async({type:o,done:c,error:l,data:i})=>{e.tab?.id&&await this.sendResponseToClient(e.tab.id,{taskId:t,data:{text:i.text,parentMessageId:a.messageId,conversationId:i.conversationId,messageId:n},error:l,done:c})})};this.bardChat=t}async auth(t){await this.bardChat.auth()}async preAuth(){await this.bardChat.checkAuth()}get status(){return this.bardChat.status}get conversation(){return this.bardChat.conversation}async createConversation(t){return t.id&&this.bardChat.conversation?.id&&t.id!==this.bardChat.conversation.id&&await this.bardChat.reset(),await this.bardChat.createConversation(t)}async removeConversation(t){return await this.bardChat.removeConversationWithCache(),await this.bardChat.reset(),Promise.resolve(!0)}async abortAskQuestion(t){return await this.bardChat.abortTask(t)}async destroy(){await this.bardChat.destroy()}async sendResponseToClient(t,e){await zs.default.tabs.sendMessage(t,{id:f,event:"Client_askChatGPTQuestionResponse",data:e})}get chatFiles(){return this.bardChat.chatFiles}async updateFiles(t){return await this.bardChat.updateFiles(t)}async uploadFiles(t){return await this.bardChat.uploadFiles(t)}async getUploadFileToken(){return await this.bardChat.getUploadFileToken()}async removeFiles(t){return await this.bardChat.removeFiles(t)}async getFiles(){return await this.bardChat.getFiles()}async abortUploadFiles(t){return await this.bardChat.abortUploadFiles(t)}async clearFiles(){return await this.bardChat.clearFiles()}};var Vs=A(_());var rt=class{constructor(t){this.sendQuestion=async(t,e,a,s)=>{let n=g();await this.bingChat.askChatGPT(a.question,{taskId:a.messageId,regenerate:s.regenerate,include_history:s.includeHistory,max_history_message_cnt:s.maxHistoryMessageCnt,clientTabId:e.tab?.id},async({type:o,done:c,error:l,data:i})=>{e.tab?.id&&await this.sendResponseToClient(e.tab.id,{taskId:t,data:{text:i.text,parentMessageId:a.messageId,conversationId:i.conversationId,messageId:n},error:l,done:c})})};this.bingChat=t}async auth(t){await this.bingChat.auth()}async preAuth(){await this.bingChat.auth()}get status(){return this.bingChat.status}get conversation(){return this.bingChat.conversation}async createConversation(t){return t?.id&&this.bingChat.conversation?.id&&t.id!==this.bingChat.conversation.id&&await this.bingChat.removeConversation(),await this.bingChat.createConversation(t)}async removeConversation(t){return await this.bingChat.removeConversationWithCache(),await this.bingChat.removeConversation(),Promise.resolve(!0)}async abortAskQuestion(t){return await this.bingChat.abortTask(t)}async destroy(){await this.bingChat.destroy()}async sendResponseToClient(t,e){await Vs.default.tabs.sendMessage(t,{id:f,event:"Client_askChatGPTQuestionResponse",data:e})}get chatFiles(){return this.bingChat.chatFiles}async updateFiles(t){return await this.bingChat.updateFiles(t)}async uploadFiles(t){return await this.bingChat.uploadFiles(t)}async getUploadFileToken(){return await this.bingChat.getUploadFileToken()}async removeFiles(t){return await this.bingChat.removeFiles(t)}async getFiles(){return await this.bingChat.getFiles()}async abortUploadFiles(t){return await this.bingChat.abortUploadFiles(t)}async clearFiles(){return await this.bingChat.clearFiles()}};var Js=A(_());var kt=class{constructor(t){this.sendQuestion=async(t,e,a,s)=>{let n=g();await this.poeChat.askChatGPT(a.question,{taskId:a.messageId,regenerate:s.regenerate,include_history:s.includeHistory,max_history_message_cnt:s.maxHistoryMessageCnt},async({type:o,done:c,error:l,data:i})=>{e.tab?.id&&await this.sendResponseToClient(e.tab.id,{taskId:t,data:{text:i.text,parentMessageId:a.messageId,conversationId:i.conversationId,messageId:n},error:l,done:c})})};this.poeChat=t}async auth(t){await this.poeChat.auth()}async preAuth(){await this.poeChat.auth()}get status(){return this.poeChat.status}get conversation(){return this.poeChat.conversation}async createConversation(){return Promise.resolve("")}async removeConversation(t){return this.poeChat.resetConversation(),Promise.resolve(!0)}async abortAskQuestion(t){return await this.poeChat.abortTask(t)}async destroy(){await this.poeChat.destroy()}async sendResponseToClient(t,e){await Js.default.tabs.sendMessage(t,{id:f,event:"Client_askChatGPTQuestionResponse",data:e})}get chatFiles(){return this.poeChat.chatFiles}async uploadFiles(t){return await this.poeChat.uploadFiles(t)}async updateFiles(t){return await this.poeChat.updateFiles(t)}async removeFiles(t){return await this.poeChat.removeFiles(t)}async getFiles(){return await this.poeChat.getFiles()}async getUploadFileToken(){return await this.poeChat.getUploadFileToken()}async abortUploadFiles(t){return await this.poeChat.abortUploadFiles(t)}async clearFiles(){return await this.poeChat.clearFiles()}};var Ks=A(_());var ot=class{constructor(t){this.sendQuestion=async(t,e,a,s)=>{let n=g();await this.claudeWebappChat.askChatGPT(a.question,{taskId:a.messageId,regenerate:s.regenerate,include_history:s.includeHistory,max_history_message_cnt:s.maxHistoryMessageCnt},async({type:o,done:c,error:l,data:i})=>{e.tab?.id&&await this.sendResponseToClient(e.tab.id,{taskId:t,data:{text:i.text,parentMessageId:a.messageId,conversationId:i.conversationId,messageId:n},error:l,done:c})})};this.claudeWebappChat=t}async auth(t){await this.claudeWebappChat.auth()}async preAuth(){await this.claudeWebappChat.preAuth()}get status(){return this.claudeWebappChat.status}get conversation(){return this.claudeWebappChat.conversation}async createConversation(t){return t?.id&&this.claudeWebappChat.conversation?.id&&t.id!==this.claudeWebappChat.conversation.id&&await this.claudeWebappChat.removeConversation(),await this.claudeWebappChat.createConversation(t)}async removeConversation(){return await this.claudeWebappChat.removeConversationWithCache(),await this.claudeWebappChat.removeConversation(),Promise.resolve(!0)}async abortAskQuestion(t){return await this.claudeWebappChat.abortTask(t)}async destroy(){await this.claudeWebappChat.destroy()}async sendResponseToClient(t,e){await Ks.default.tabs.sendMessage(t,{id:f,event:"Client_askChatGPTQuestionResponse",data:e})}get chatFiles(){return this.claudeWebappChat.chatFiles}async updateFiles(t){return await this.claudeWebappChat.updateFiles(t)}async uploadFiles(t){return await this.claudeWebappChat.uploadFiles(t)}async getUploadFileToken(){return await this.claudeWebappChat.getUploadFileToken()}async removeFiles(t){return await this.claudeWebappChat.removeFiles(t)}async getFiles(){return await this.claudeWebappChat.getFiles()}async abortUploadFiles(t){return await this.claudeWebappChat.abortUploadFiles(t)}async clearFiles(){return await this.claudeWebappChat.clearFiles()}};var Xs=A(_());var it=class{constructor(t){this.sendQuestion=async(t,e,a,s)=>{let n=g(),o=[];this.maxAIClaudeChat.conversation&&(this.maxAIClaudeChat.conversation.meta.systemPrompt&&o.push({type:"system",data:{content:this.maxAIClaudeChat.conversation.meta.systemPrompt,additional_kwargs:{}}}),s.historyMessages?.forEach(c=>{o.push({type:c.type==="ai"?"ai":"human",data:{content:c.text,additional_kwargs:{}}})}),s.includeHistory=!1,s.maxHistoryMessageCnt=0),await this.maxAIClaudeChat.askChatGPT(a.question,{taskId:a.messageId,regenerate:s.regenerate,chat_history:o,meta:s.meta},async({type:c,done:l,error:i,data:d})=>{e.tab?.id&&await this.sendResponseToClient(e.tab.id,{taskId:t,data:{text:d.text,parentMessageId:a.messageId,conversationId:d.conversationId,messageId:n},error:i,done:l})})};this.maxAIClaudeChat=t}async auth(t){await this.maxAIClaudeChat.auth(t)}async preAuth(){await this.maxAIClaudeChat.preAuth()}get status(){return this.maxAIClaudeChat.status}get conversation(){return this.maxAIClaudeChat.conversation}async createConversation(t){return await this.maxAIClaudeChat.createConversation(t)}async removeConversation(t){return await this.maxAIClaudeChat.removeConversationWithCache(),Promise.resolve(!0)}async abortAskQuestion(t){return await this.maxAIClaudeChat.abortTask(t)}async destroy(){await this.maxAIClaudeChat.destroy()}async sendResponseToClient(t,e){await Xs.default.tabs.sendMessage(t,{id:f,event:"Client_askChatGPTQuestionResponse",data:e})}get chatFiles(){return this.maxAIClaudeChat.chatFiles}async uploadFiles(t){return await this.maxAIClaudeChat.uploadFiles(t)}async updateFiles(t){return await this.maxAIClaudeChat.updateFiles(t)}async getUploadFileToken(){return await this.maxAIClaudeChat.getUploadFileToken()}async removeFiles(t){return await this.maxAIClaudeChat.removeFiles(t)}async getFiles(){return await this.maxAIClaudeChat.getFiles()}async abortUploadFiles(t){return await this.maxAIClaudeChat.abortUploadFiles(t)}async clearFiles(){return await this.maxAIClaudeChat.clearFiles()}};var y=A(_());var pn=async(r,t)=>{try{let e=await Ke();return e?await(await fetch(`${ct}${r}`,{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`}})).json():new Error("No access token")}catch{}},Ys=async r=>{try{await pn("/user/cardlog",r)}catch{}};var Zs=async(r,t)=>{let e=es.load(t),a=e('script[type="application/ld+json"]').html(),s=a?JSON.parse(a):null,n={};e('meta[property^="og:"]').each((u,h)=>{let p=e(h).attr("property"),m=e(h).attr("content");p&&m&&(n[p.replace("og:","")]=m)});let o=e("title").text(),c=e('meta[name="description"]').attr("content"),l=e('link[rel="logo"]').attr("href"),i=e('link[rel="icon"]').attr("href");return{jsonLD:s,openGraph:Object.keys(n).length>0?n:void 0,title:o,description:c,logo:l,favicon:i}};var Se=class{constructor(t,e,a){this.databaseName=t,this.databaseVersion=e,this.objectStoreName=a}openDatabase(){return new Promise((t,e)=>{let a=indexedDB.open(this.databaseName,this.databaseVersion);a.onerror=s=>{e(s.target?.error||"")},a.onsuccess=s=>{let n=s.target?.result;t(n)},a.onupgradeneeded=s=>{let n=s.target?.result;if(!n.objectStoreNames.contains(this.objectStoreName)){let o=n.createObjectStore(this.objectStoreName,{keyPath:"id"});o.createIndex("id","id",{unique:!0}),o.createIndex("url","url",{unique:!1}),o.createIndex("title","meta.title",{unique:!1}),o.createIndex("summary","summary",{unique:!1})}}})}addOrUpdateWebsite(t){return new Promise(async(e,a)=>{try{let n=(await this.openDatabase()).transaction([this.objectStoreName],"readwrite"),o=n.objectStore(this.objectStoreName);t.updated_at=new Date().toISOString(),o.put(t),n.oncomplete=()=>{e()},n.onerror=c=>{a(c.target?.error||"")}}catch(s){a(s)}})}deleteWebsiteContext(t){return new Promise(async(e,a)=>{try{let n=(await this.openDatabase()).transaction([this.objectStoreName],"readwrite");n.objectStore(this.objectStoreName).delete(t),n.oncomplete=()=>{e()},n.onerror=c=>{a(c.target?.error||"")}}catch(s){a(s)}})}getWebsiteContextById(t){return new Promise(async(e,a)=>{try{let c=(await this.openDatabase()).transaction([this.objectStoreName],"readonly").objectStore(this.objectStoreName).get(t);c.onsuccess=l=>{let i=l.target?.result;e(i)},c.onerror=l=>{a(l.target?.error||"")}}catch(s){a(s)}})}getAllWebsiteContext(){return new Promise(async(t,e)=>{try{let o=(await this.openDatabase()).transaction([this.objectStoreName],"readonly").objectStore(this.objectStoreName).getAll();o.onsuccess=c=>{let l=c.target?.result||[];t(l)},o.onerror=c=>{e(c.target?.error||"")}}catch(a){e(a)}})}async removeUnnecessaryWebsiteContext(){let t=await this.getAllWebsiteContext(),e=[],a=t.filter(s=>{let o=new Date(s.updated_at).getTime();return new Date().getTime()-o<=31536e6?!0:(e.push(s),!1)});a=a.sort((s,n)=>{let o=new Date(s.updated_at).getTime(),c=new Date(n.updated_at).getTime();return o-c});for(let s=0;s<a.length-3e3;s++)e.push(a[s]);await Promise.all(e.map(s=>this.deleteWebsiteContext(s.id)))}async clearAllWebsiteContexts(){let t=await this.getAllWebsiteContext();await Promise.all(t.map(e=>this.deleteWebsiteContext(e.id)))}},mn=r=>{try{return r&&r.startsWith("http")&&new URL(r).host.replace(/^www\./,"").replace(/:\d+$/,"").includes("larksuite.com")?"larksuite.com":""}catch{return""}},V=class r{static{this.websiteContextDB=new Se("websiteContextDB",1,"website_context")}static async createWebsiteContext(t){let e=K([{id:g(),created_at:new Date().toISOString(),updated_at:new Date().toISOString(),host:t.host||mn(t.url),url:"",meta:{},sidebarType:"Chat"},t]);if(t.id){let s=await this.websiteContextDB.getWebsiteContextById(t.id);s&&(e=K([e,s]))}await this.websiteContextDB.addOrUpdateWebsite(K([e,t]));let a=await this.analyzeWebsiteContextMetaData(e.id,t.html);return this.websiteContextDB.removeUnnecessaryWebsiteContext(),a||e}static async updateWebsiteContext(t,e){let a=await this.websiteContextDB.getWebsiteContextById(t);if(!a)return null;let s=K([a,e]);return await this.websiteContextDB.addOrUpdateWebsite(s),s}static async getWebsiteContextById(t){return this.websiteContextDB.getWebsiteContextById(t)}static async getAllWebsiteContext(){return this.websiteContextDB.getAllWebsiteContext()}static async clearAllWebsiteContexts(){return this.websiteContextDB.clearAllWebsiteContexts()}static async deleteWebsiteContext(t){return this.websiteContextDB.deleteWebsiteContext(t)}static async computeWebsiteContextStorageSize(){return(await this.websiteContextDB.getAllWebsiteContext()).length*1}static async analyzeWebsiteContextMetaData(t,e){if(!t)return;let a=await r.websiteContextDB.getWebsiteContextById(t);if(a){if(e&&(a.html=e),a.html){let s=await Zs(a.url,a.html);a.meta=K([a.meta,s]),a.html=""}return await r.websiteContextDB.addOrUpdateWebsite(a),a}}};var ke=A(_()),gn=async(r,t,e)=>new Promise(async a=>{try{let s=t?ke.default?.[r]?.[t]:ke.default?.[r];if(typeof s=="function"){let n=await s(...e);a(n)}else a(s)}catch{a(void 0)}}),ta=gn;var fn=new G("Background/Client"),ea=()=>{q(async(r,t,e,a)=>{if(r==="client")switch(t){case"Client_ping":return{data:!0,success:!0,message:"ok"};case"Client_closeUrl":{let{url:s,tabId:n}=e,o=null;return n?o=await L(n):s&&(o=(await y.default.tabs.query({url:s}))?.[0]||null),o?.id?(await y.default.tabs.remove(o.id),{success:!0,data:!0,message:"ok"}):{success:!0,data:!1,message:"Cannot find close tab."}}break;case"Client_openUrl":{let{url:s,key:n,query:o="",active:c=!0}=e;if(s){if(s.startsWith(y.default.runtime.getURL("/pages/chat/index.html"))){if(a?.url&&a.url.startsWith(y.default.runtime.getURL("/pages/popup/index.html"))){let d=await y.default.tabs.query({currentWindow:!0}),u=await y.default.tabs.query({active:!0});if(d.length>1)for(let h of u)h.id&&(h.pendingUrl==="chrome://newtab/"||h.pendingUrl==="about:blank"||h.url==="chrome://newtab/"||h.url==="about:blank")&&await y.default.tabs.remove(h.id)}let i=await y.default.tabs.query({currentWindow:!0});for(let d=0;d<i.length;d++){let u=i[d];if(u.url&&u.url.startsWith(y.default.runtime.getURL("/pages/chat/index.html")))return await y.default.tabs.update(u.id,{url:s+o,active:c}),{data:{tabId:u.id},success:!0,message:"ok"}}}return{data:{tabId:(await y.default.tabs.create({url:s+o,active:c})).id},success:!0,message:"ok"}}else if(n){let l;return n==="current_page"?a.tab?.id&&(await y.default.tabs.update(a.tab.id,{active:c}),l=a.tab.id):n==="shortcuts"?l=(await y.default.tabs.create({url:"chrome://extensions/shortcuts",active:c})).id:n==="options"?l=await pe(o):n==="chatgpt"?l=(await wt()).id:n==="manage_extension"&&(l=(await y.default.tabs.create({url:`chrome://extensions/?id=${y.default.runtime.id}`,active:c})).id),{data:{tabId:l},success:!0,message:"ok"}}}break;case"Client_emitCMDJ":a.tab?.id&&await y.default.tabs.sendMessage(a.tab.id,{id:f,event:"Client_listenOpenChatMessageBox",data:{}});break;case"Client_updateIcon":{let{mode:s}=e;return J?{data:!1,success:!1,message:"ok"}:(s==="dark"?await y.default.action.setIcon({path:{16:"assets/USE_CHAT_GPT_AI/icons/maxai_16_normal.png",32:"assets/USE_CHAT_GPT_AI/icons/maxai_32_normal.png",48:"assets/USE_CHAT_GPT_AI/icons/maxai_48_normal.png",128:"assets/USE_CHAT_GPT_AI/icons/maxai_128_normal.png"}}):await y.default.action.setIcon({path:{16:"assets/USE_CHAT_GPT_AI/icons/maxai_16_normal.png",32:"assets/USE_CHAT_GPT_AI/icons/maxai_32_normal.png",48:"assets/USE_CHAT_GPT_AI/icons/maxai_48_normal.png",128:"assets/USE_CHAT_GPT_AI/icons/maxai_128_normal.png"}}),{data:!0,success:!0,message:"ok"})}break;case"Client_getChromeExtensionCommands":return{data:await y.default.commands.getAll()||[],success:!0,message:"ok"};case"Client_updateTabVisible":{let{visible:s,windowVisible:n,windowFocus:o}=e||{};if(a.tab?.id){let c=await y.default.tabs.update(a.tab.id,{active:s});if(c.windowId){let l=await y.default.windows.get(c.windowId);if(l.id&&l.id!==y.default.windows.WINDOW_ID_NONE){let d=await $e()!==l.id||n?void 0:"minimized",u=await y.default.tabs.query({windowId:l.id});u=u.filter(h=>h.url&&!/.*:\/\/newtab/.test(h.url)),u.length===1&&await y.default.windows.update(l.id,{focused:o,state:d})}}}return{data:!0,success:!0,message:"ok"}}break;case"Client_updateIframeInput":return a.tab?.id&&await y.default.tabs.sendMessage(a.tab.id,{event:"Client_listenUpdateIframeInput",data:e,id:f}),{data:!0,success:!0,message:"ok"};case"Client_restartApp":return await Wt(),{data:!0,success:!0,message:"ok"};case"Client_logCallApiRequest":return{data:await ns(e),success:!0,message:"ok"};case"Client_updateUseChatGPTAuthInfo":{let s=await lt(),{accessToken:n,refreshToken:o,userInfo:c}=e;if(fn.info("Client_updateUseChatGPTAuthInfo",n,o,c),n&&o){let l=await y.default.storage.local.get(Rt);await y.default.storage.local.set({[Rt]:{accessToken:n,refreshToken:o,userInfo:c,userData:l[Rt]?.userData}})}else await ht();return!s&&n&&(await pe("",!1),await zt()||await Vt(),await $t()),await y.default.tabs.update(a.tab?.id,{active:!0}),{data:!0,success:!0,message:"ok"}}break;case"Client_getUseChatGPTUserInfo":return{success:!0,data:await pt(!1),message:"ok"};case"Client_getUseChatGPTUserSubscriptionInfo":return{success:!0,data:(await pt(!0))?.role,message:"ok"};case"Client_emitPricingHooks":{let{action:s,name:n}=e;return n&&await Ys({action:s,name:n}),{success:!0,data:!0,message:"ok"}}case"Client_getLiteChromeExtensionSettings":{let s=a.tab?.url||a.url;return s||(s=(await y.default.tabs.query({active:!0,currentWindow:!0}))[0]?.url),{success:!0,data:await Jt(s),message:"ok"}}case"Client_getAllConversation":return{success:!0,data:await w.getAllConversation(),message:"ok"};case"Client_getAllPaginationConversation":return{success:!0,data:await w.getAllPaginationConversations(),message:"ok"};case"Client_removeAllConversation":{let s=await w.clearAllConversations();return{success:s,data:s,message:"ok"}}case"Client_getContextMenuActions":{let{contextMenuId:s}=e;return{success:!0,data:await ts(s),message:"ok"}}case"Client_getLiteConversation":{let{conversationId:s}=e,n=await w.getClientConversation(s);return{success:!!n?.id,data:n,message:"ok"}}break;case"Client_updateConversation":{let{conversationId:s,updateConversationData:n}=e,o=await w.conversationDB.getConversationById(s);if(o){await w.conversationDB.addOrUpdateConversation(K([o,n]));let c=await w.getClientConversation(s);return a.tab?.id&&await y.default.tabs.sendMessage(a.tab.id,{event:"Client_listenUpdateConversationMessages",id:f,data:{conversation:c,conversationId:s}}),{success:!0,data:c,message:"ok"}}return{success:!1,data:!1,message:"ok"}}break;case"Client_modifyMessages":{let{conversationId:s,action:n,deleteCount:o,newMessages:c}=e,l=!1;if(n==="add"){if(c.length===0)return{success:!0,data:!0,message:"ok"};l=await w.pushMessages(s,c)}else n==="delete"?l=await w.deleteMessages(s,o):n==="clear"?l=await w.deleteMessages(s,99999999):n==="update"&&(l=await w.updateMessage(s,c[0]));return a.tab?.id&&await y.default.tabs.sendMessage(a.tab.id,{event:"Client_listenUpdateConversationMessages",id:f,data:{conversation:await w.getClientConversation(s),conversationId:s}}),{success:l,data:!0,message:"ok"}}break;case"Client_proxyFetchAPI":try{let{url:s,options:n}=e,{parse:o="json",...c}=n,l=await fetch(s,c);return{success:!0,data:o==="json"?await l.json():await l.text(),message:"ok"}}catch(s){return{success:!1,data:s,message:"ok"}}case"Client_getIframePageContent":{let{taskId:s}=e;return a.tab?.id&&s?(await y.default.tabs.sendMessage(a.tab.id,{event:"Iframe_ListenGetPageContent",id:f,data:{taskId:s,originPageUrl:a.tab.url||a.url}}),{success:!0,data:s,message:"ok"}):{success:!1,data:"",message:"ok"}}break;case"Iframe_sendPageContent":{let{taskId:s,pageContent:n}=e;return s&&a.tab?.id?(await y.default.tabs.sendMessage(a.tab.id,{event:"Client_ListenGetIframePageContentResponse",id:f,data:{taskId:s,pageContent:n}}),{success:!0,data:s,message:"ok"}):{success:!1,data:"",message:"ok"}}case"WebsiteContext_getWebsiteContext":{let{id:s}=e,n;return s&&(n=await V.getWebsiteContextById(s)),{success:!0,data:n,message:"ok"}}case"WebsiteContext_searchWebsiteContext":return{success:!0,data:[],message:"ok"};case"WebsiteContext_deleteWebsiteContext":{let{id:s}=e;return s?(await V.deleteWebsiteContext(s),{success:!0,data:!0,message:"ok"}):{success:!1,data:!1,message:"ok"}}case"WebsiteContext_clearAllWebsiteContext":return await V.clearAllWebsiteContexts(),{success:!0,data:!0,message:"ok"};case"WebsiteContext_updateWebsiteContext":{let{query:s,websiteContext:n}=e;return s.id?(await V.updateWebsiteContext(s.id,n),{success:!0,data:!0,message:"ok"}):{success:!1,data:!1,message:"ok"}}case"WebsiteContext_createWebsiteContext":{let{websiteContext:s}=e;return{success:!0,data:await V.createWebsiteContext(s),message:"ok"}}case"Client_backgroundRunFunction":{let s=await ta(e.command,e.commandFunctionName,e.commandFunctionData);return{success:!!s,data:s,message:"ok"}}default:break}})};var ne=A(_());var Cn=new G("PDF"),sa=async()=>{let r=new Map,t=async(e,a)=>{if((await Jt()).userSettings?.pdf?.enabled){let n=ne.default.runtime.getURL(`/pages/pdf/web/viewer.html?file=${encodeURIComponent(a)}`);Cn.info("pdfSnifferStartListener success",a,n),await ne.default.tabs.update(e,{url:n})}};ne.default.tabs.onUpdated.addListener(async(e,a,s)=>{if(s.active){let n=s.url||s.pendingUrl;(n?.startsWith("file://")||n?.startsWith("ftp://"))&&(n.endsWith(".pdf")||n.endsWith(".PDF"))&&await t(e,n),(n?.endsWith(".pdf")||n?.endsWith(".PDF"))&&(n?.startsWith("http://")||n?.startsWith("https://"))&&(r.has(n)?r.get(n)==="validPDF"&&await t(e,n):(r.set(n,"fetching"),fetch(n,{method:"HEAD"}).then(function(o){o.headers.get("content-type")==="application/pdf"?(r.set(n,"validPDF"),t(e,n)):r.set(n,"invalidPDF")}).catch(function(o){r.delete(n)})))}})};var aa=()=>{q(async(r,t,e,a)=>{if(r==="shortcut")switch(t){case"ShortCuts_getContentOfURL":{let{URL:s,timeout:n}=e,o=await Je(Xe(s),n||60*1e3,{title:"",body:"",url:"",success:!1});return{data:o,success:o.success,message:"ok"}}case"ShortCuts_getContentOfSearchEngine":{let{URL:s}=e,n=await Ye(s);return{data:n,success:n.success,message:"ok"}}case"ShortCuts_OperationPageElement":{let s=e.OperationElementConfig,n=e.OperationElementTabID||a.tab?.id,o=null;if(n&&(o=await L(n)),!o?.id)return{data:null,success:!1,message:"No tabId to execute operation page element."};if(n=o.id,n!==a.tab?.id){let i=h=>new Promise(p=>setTimeout(p,h)),d=!1,u=0;for(;!d&&u<20;){let h=await L(n);if(!h)break;h.status==="complete"&&(d=!0),u++,await i(500)}if(d){let h=await ss(n,s);return{data:h,success:h.success,message:"ok"}}}return{data:null,success:!1,message:"Page not loaded."}}break;default:break}})};var Et="text-davinci-002-render-sha";async function*na(r){let t=r.getReader();try{for(;;){let{done:e,value:a}=await t.read();if(e)return;yield a}}finally{t.releaseLock()}}var ra=async(r,t)=>{let{onMessage:e,...a}=t,s=await fetch(r,a);if(!s.ok){let o=await s.json().catch(()=>({}));throw new Error(JSON.stringify(Ue(o)?{message:`${s.status} ${s.statusText}`,detail:""}:o))}if(a.body&&JSON.parse(a.body).streaming===!1)return await s.json();let n=Re(o=>{o.type==="event"&&e(o.data)});for await(let o of na(s.body)){let c=new TextDecoder().decode(o);n.feed(c)}};var ia="https://chat.openai.com",re="MaxAI.me - Search With AI",ft=(r,t,e,a)=>fetch(`${ia}${e}`,{method:t,headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:a===void 0?void 0:JSON.stringify(a)}),yn=async r=>{try{let{token:t,offset:e=0,limit:a=100,order:s="updated"}=r;return(await(await ft(t,"GET",`/backend-api/conversations?offset=${e}&limit=${a}&order=${s}`)).json())?.items||[]}catch{return[]}},oa=async({token:r,conversationId:t,messageId:e,input:a})=>{try{await ft(r,"POST","/backend-api/moderations",{conversation_id:t,message_id:e,input:a,model:"text-moderation-playground"})}catch{}},Ee=async(r,t,e)=>{await ft(r,"PATCH",`/backend-api/conversation/${t}`,e)},Fe=async(r=!1)=>{let t=await fetch("https://chat.openai.com/api/auth/session");if(t.status===403&&!r)throw new Error("CLOUDFLARE");let e=await t.json().catch(()=>({}));if(!e.accessToken&&!r)throw new Error("UNAUTHORIZED");return e?.accessToken||""},Me=class{constructor(t){this.isCleaningCache=!1;this.token=t.token,this.model=t.model,this.lastChatGPTAnswerMessageId=g(),this.id=g(),this.conversationId=t.conversationId||void 0,this.conversationInfo={title:"",messages:[]}}async updateTitle(t){!this.conversationId||this.conversationInfo.title===t||(await Ee(this.token,this.conversationId,{title:t}),this.conversationInfo.title=t)}async fetchHistoryAndConfig(){if(this.conversationId)try{let e=await(await ft(this.token,"GET",`/backend-api/conversation/${this.conversationId}`)).json();this.conversationInfo={title:e.title,messages:Le(e.current_node,e.mapping),raw:e},e.title!==re&&await this.updateTitle(re),this.lastChatGPTAnswerMessageId=e.current_node}catch{this.lastChatGPTAnswerMessageId=g(),this.conversationId=void 0,this.conversationInfo={title:"",messages:[]}}}async generateAnswer(t,e=!1){let a=t.messageId||g(),s=t.parentMessageId||this.lastChatGPTAnswerMessageId||g(),n=!1,o="",c="",l={action:e?"variant":"next",messages:[{id:a,author:{role:"user"},content:{content_type:"text",parts:[t.prompt]}}],model:this.model,parent_message_id:s,timezone_offset_min:new Date().getTimezoneOffset(),history_and_training_disabled:!1};this.conversationId&&(l.conversation_id=this.conversationId);let i=(await Yt()).arkoseToken;i&&(l.arkose_token=i,await Zt({arkoseToken:""})),t.meta&&(l.messages[0].metadata=t.meta),await ra(`${ia}/backend-api/conversation`,{method:"POST",signal:t.signal,headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify(Object.assign(l)),onMessage:d=>{if(d==="[DONE]"){o&&this.conversationId&&c&&(this.updateTitle(re),oa({token:this.token,conversationId:this.conversationId,messageId:c,input:o})),t.onEvent({type:"done"});return}let u;try{u=JSON.parse(d)}catch{return}let h=u.message?.content?.parts?.[0]||u.message?.content?.text;h?(o=h,c=u.message.id,this.conversationId=u.conversation_id,this.lastChatGPTAnswerMessageId=u.message.id,this.conversationId&&!n&&(n=!0,oa({token:this.token,conversationId:this.conversationId,messageId:a,input:t.prompt})),t.onEvent({type:"answer",data:{text:h,messageId:u.message.id,conversationId:u.conversation_id,parentMessageId:a}})):u.error&&t.onEvent({type:"error",data:{message:u.error,detail:u}})}}).then().catch(d=>{try{if(d?.message==="The user aborted a request."||d?.message==="BodyStreamBuffer was aborted"){t.onEvent({type:"error",data:{message:"manual aborted request.",detail:""}});return}let u=JSON.parse(d.message||d);t.onEvent({type:"error",data:{message:u.message,detail:u.detail}})}catch{t.onEvent({type:"error",data:{message:"Network error.",detail:""}})}})}async close(){this.conversationId&&(await Ee(this.token,this.conversationId,{is_visible:!1}),this.conversationInfo={title:"",messages:[]})}async removeCacheConversation(){if(!this.isCleaningCache&&this.token){let e=(await yn({token:this.token})).filter(s=>s.title===re&&s.id!==this.conversationId);if(e.length===0)return;this.isCleaningCache=!0;let a=s=>new Promise(n=>setTimeout(n,s));for(let s=0;s<e.length;s++)try{await Ee(this.token,e[s].id,{is_visible:!1}),await a(3e3)}catch{}this.isCleaningCache=!1}}},oe=class{constructor(){this.conversations=[],this.abortFunctions={},this.plugins=[],this.token=void 0,this.models=[]}async fetchModels(t){if(this.models.length>0)return this.models;let e=await ft(t,"GET","/backend-api/models").then(a=>a.json());return e?.models&&e.models.length>0&&(this.models=e.models),e.models}async fetchPlugins(t){if(this.plugins.length>0)return this.plugins;let e=await ft(t,"GET","/backend-api/aip/p?offset=0&limit=100&statuses=approved").then(a=>a.json());return e?.items&&e.items.length>0&&(this.plugins=e.items),e.items}async getModelName(t,e){try{let a=await this.fetchModels(t);if(a?.length>0){if(e){let s=a.find(n=>n.slug===e);if(s)return s.slug}return a[0].slug}return Et}catch{return Et}}async getAllModels(){if(this.models.length>0)return this.models;try{let t=this.token||await Fe();return t&&(this.token=t),await this.fetchModels(t)}catch{return[]}}async getAllPlugins(){if(this.plugins.length>0)return this.plugins;try{let t=this.token||await Fe();return t&&(this.token=t),await this.fetchPlugins(t)}catch{return[]}}async createConversation(t,e,a=!0){try{let s=this.token||await Fe();s&&(this.token=s);let n=await this.getModelName(s,e),o=new Me({token:s,model:n,conversationId:t});return this.conversations=[o],a&&o.removeCacheConversation(),await o.fetchHistoryAndConfig(),o}catch{return}}getConversation(t){return this.conversations.find(e=>e.id===t||e.conversationId===t)}getConversations(){return this.conversations}async closeConversation(t){try{let e=this.getConversation(t);return e&&(this.conversations=this.conversations.filter(a=>a.conversationId!==t&&a.id!==t),await e.close()),!0}catch{return!1}}addAbortWithMessageId(t,e){this.abortFunctions[t]=e}removeAbortWithMessageId(t){delete this.abortFunctions[t]}abortWithMessageId(t){try{this.abortFunctions[t]&&(this.abortFunctions[t](),delete this.abortFunctions[t])}catch{}}removeCacheConversation(){return this.conversations?.[0]?.removeCacheConversation()}removeConversationWithId(t){let e=this.conversations.find(a=>a.conversationId===t);e&&e.close()}};var ie=new G("SearchWithAI/OpenAIChat"),ce=class extends M{constructor(){super("OpenAIChat");this.status="success";this.openAILib=new oe,this.conversation=void 0,this.init()}init(){this.log.info("init")}async preAuth(){this.log.info("preAuth")}async auth(e){this.active=!0,this.status="success",await this.updateClientStatus()}async createConversation(){return this.conversation=await this.openAILib.createConversation(),this.conversation?.id||""}async removeConversation(e){return await this.openAILib.closeConversation(e)}async askChatGPT(e,a,s){try{await this.createConversation()}catch(d){s?.({type:"error",done:!0,error:d.message||"conversation is not created",data:{text:"",conversationId:""}})}if(!this.openAILib.token){s?.({type:"error",done:!0,error:"UNAUTHORIZED",data:{text:"",conversationId:""}});return}if(!this.conversation){s?.({type:"error",done:!0,error:"conversation is not created",data:{text:"",conversationId:""}});return}let n=this.openAILib,o=this.conversation,{taskId:c}=a||{};this.log.info("askChatGPT");let l=new AbortController,i=l.signal;c&&(this.taskList[c]=()=>l.abort()),await this.conversation.generateAnswer({prompt:e,signal:i,onEvent(d){if(ie.info("generateAnswer",d,a),d.type==="error"){ie.info("error"),ie.info("abort Controller remove",c),c&&n.removeAbortWithMessageId(c),s?.({type:"error",done:!0,error:d.data.message||d.data.detail||"",data:{text:"",conversationId:""}});return}if(d.type==="done"){ie.info("abort Controller remove",c),c&&n.removeAbortWithMessageId(c),s?.({type:"message",done:!0,error:"",data:{text:"",conversationId:o.conversationId}});return}s?.({type:"message",done:!1,error:"",data:{text:d.data.text,conversationId:o.conversationId}})}},a?.regenerate===!0)}async abortAskQuestion(e){return this.taskList[e]&&(this.taskList[e](),delete this.taskList[e]),this.openAILib.abortWithMessageId(e)}async destroy(){this.openAILib.removeCacheConversation()}async updateClientStatus(){this.active&&await U("Client_ChatGPTStatusUpdate",{status:this.status})}};var ca=A(_()),de=class{constructor(t){this.sendQuestion=async(t,e,a,s)=>{let n=g();await this.openAIChat.askChatGPT(a.question,{taskId:a.messageId,regenerate:s.regenerate,include_history:s.includeHistory,max_history_message_cnt:s.maxHistoryMessageCnt},async({type:o,done:c,error:l,data:i})=>{e.tab?.id&&await this.sendResponseToClient(e.tab.id,{taskId:t,data:{text:i.text,parentMessageId:a.messageId,conversationId:i.conversationId,messageId:n},error:l,done:c})})};this.chatFiles=[],this.openAIChat=t}async preAuth(){return this.openAIChat.preAuth()}async auth(t){await this.openAIChat.auth(t)}get status(){return this.openAIChat.status}async abortAskQuestion(t){try{return await this.openAIChat.abortAskQuestion(t),!0}catch{return!1}}async createConversation(){return Promise.resolve("")}async removeConversation(t){return await this.openAIChat.removeConversation(t)}destroy(){return this.openAIChat.destroy()}async sendResponseToClient(t,e){await ca.default.tabs.sendMessage(t,{id:f,event:"Client_askChatGPTQuestionResponse",data:e})}abortUploadFiles(t){return Promise.resolve(!1)}clearFiles(){return Promise.resolve(!1)}getFiles(){return Promise.resolve([])}getUploadFileToken(){return Promise.resolve(void 0)}removeFiles(t){return Promise.resolve(!1)}updateFiles(t){return Promise.resolve(void 0)}uploadFiles(t){return Promise.resolve(void 0)}};var da=()=>{let r=new k(new de(new ce)),t=new k(new at(new X)),e=new k(new st(new bt)),a=new k(new nt(new Y)),s=new k(new rt(new Z)),n=new k(new ot(new tt)),o=new k(new it(new et));return{[x.OPENAI]:r,[x.USE_CHAT_GPT_PLUS]:t,[x.OPENAI_API]:e,[x.BARD]:a,[x.BING]:s,[x.CLAUDE]:n,[x.MAXAI_CLAUDE]:o}};var Oe=class{constructor(){this.adapters={};this.sendQuestion=(t,e,a,s)=>(this.currentProvider===x.OPENAI_API&&(s.meta={model:me[0].value,temperature:1}),this.currentProvider===x.USE_CHAT_GPT_PLUS&&(s.meta={temperature:1}),this.currentAdapter?.sendQuestion(t,e,a,s)||Promise.resolve());this.adapters=da(),this.initChatSystem(),Yt().then(t=>{this.currentProvider=t.aiProvider})}get currentAdapter(){return this.currentProvider?this.adapters[this.currentProvider]:void 0}initChatSystem(){q(async(t,e,a,s)=>{if(t==="client")switch(e){case"SWAI_switchAIProvider":{let{provider:n}=a;return await this.switchAdapter(n),await this.preAuth(),{success:!0,data:n,message:""};break}case"SWAI_askAIQuestion":{this.currentProvider!==x.BARD&&this.currentProvider!==x.CLAUDE&&await this.auth(s.tab?.id||0);let n=a.taskId,o=a.question,c=a.options;await this.createConversation(o.conversationId),await this.sendQuestion(n,s,o,c);break}case"SWAI_abortAskChatGPTQuestion":{let{taskId:n}=a;return await this.abortAskQuestion(n),{success:!0,data:{},message:""}}default:break}})}async switchAdapter(t){return await this.destroy(),this.currentProvider=t,await Zt({aiProvider:t}),this.currentAdapter}async auth(t){this.currentAdapter&&await this.currentAdapter.auth(t)}async preAuth(){this.currentAdapter&&await this.currentAdapter.preAuth()}async abortAskQuestion(t){return this.currentAdapter?await this.currentAdapter.abortAskQuestion(t):!1}async createConversation(t){if(!this.currentAdapter)return"";let e={AIModel:""};return this.currentProvider===x.USE_CHAT_GPT_PLUS&&(e.AIModel=Nt[0].value),this.currentProvider===x.MAXAI_CLAUDE&&(e.AIModel=Ht[0].value),this.currentProvider===x.OPENAI_API&&(e.AIModel=me[0].value),this.currentProvider===x.OPENAI&&(e.AIModel=Et),this.currentProvider===x.CLAUDE&&(e.AIModel=qe[0].value),this.currentProvider===x.BARD&&(e.AIModel=It[0].value),this.currentProvider===x.BING&&(e.AIModel=He[0].value),await this.currentAdapter?.createConversation({id:t,title:"Chat - Search With AI",type:"Chat",created_at:new Date().toISOString(),updated_at:new Date().toISOString(),messages:[],meta:e})||""}async destroy(){await this.currentAdapter?.removeConversation(""),await this.currentAdapter?.destroy()}},ua=Oe;var ha=()=>{new ua};var la=()=>{try{v.default.management?.getAll?.(),v.default.storage.onChanged.addListener(()=>{}),v.default.scripting.getRegisteredContentScripts(),vn(),bn(),An(),Pn(),_n(),Tn(),wn(),Sn(),sa().then().catch(),xn()}catch{}},vn=()=>{v.default.runtime.onInstalled.addListener(async r=>{r.reason===v.default.runtime.OnInstalledReason.INSTALL?(await We(),await v.default.tabs.create({url:le+"/get-started"})):(await In(),await De(),await zt()||await Vt(),await $t(),await rs("textSelectPopupButton"));try{await v.default.contextMenus.remove("use-chatgpt-ai-context-menu-button")}catch{}await v.default.contextMenus.create({id:"use-chatgpt-ai-context-menu-button",title:"MaxAI.me",contexts:["all"]})})},In=async()=>{z==="2.4.3"&&setTimeout(async()=>{if((await $()).ON_BOARDING_BLACK_FRIDAY_2023_OPEN_LINK)return;let e=await pt(!0);if(await Bt("ON_BOARDING_BLACK_FRIDAY_2023_OPEN_LINK",!0),e?.roles&&e?.subscription_plan_name){let a=(e.roles.find(n=>n.name==="elite")||e.roles.find(n=>n.name==="pro")||{name:"free"}).name,s=e.subscription_plan_name;a==="elite"&&s==="ELITE_YEARLY"||await v.default.tabs.create({url:"https://app.maxai.me/blackfriday2023"})}else await v.default.tabs.create({url:"https://app.maxai.me/blackfriday2023"})},(1+Math.floor(Math.random()*9))*1e3)},bn=()=>{ea(),aa(),v.default.runtime.onMessage.addListener((i,d,u)=>{i?.id&&i.id!==f||i.type==="inboxsdk__injectPageWorld"&&d.tab&&v.default.scripting&&d.tab?.id&&(v.default.scripting.executeScript({target:{tabId:d.tab.id},world:"MAIN",files:["pageWorld.js"]}),u(!0))});let r=new xt,t=new k(new St(new At)),e=new k(new at(new X)),a=new k(new st(new bt)),s=new k(new nt(new Y)),n=new k(new rt(new Z)),o=new k(new kt(new Tt)),c=new k(new ot(new tt)),l=new k(new it(new et));r.addAdapter(N.OPENAI,t),r.addAdapter(N.OPENAI_API,a),r.addAdapter(N.USE_CHAT_GPT_PLUS,e),r.addAdapter(N.BING,n),r.addAdapter(N.BARD,s),r.addAdapter(N.POE,o),r.addAdapter(N.CLAUDE,c),r.addAdapter(N.MAXAI_CLAUDE,l),ha()},wn=()=>{J||v.default.runtime.setUninstallURL(`${Ut}/survey/uninstall?version=${z}`)},An=()=>{J||v.default.commands.onCommand.addListener(async r=>{if(r=="_execute_action"){let e=(await v.default.tabs.query({active:!0,currentWindow:!0}))[0];e&&e.id&&await Dt(e.id,"Client_listenOpenChatMessageBox",{type:"shortcut",command:r})}else if(r==="show-floating-menu"){let e=(await v.default.tabs.query({active:!0,currentWindow:!0}))[0];e&&e.id&&await Dt(e.id,"Client_listenOpenChatMessageBox",{type:"shortcut",command:r})}})},Pn=()=>{if(J)v.default.action.onClicked.addListener(async r=>{r&&r.id&&r.active&&await v.default.tabs.create({url:le})});else{let r=async t=>{try{let e=t,a=e?.url||"",s="";e?.url?.startsWith("chrome")||e?.url?.startsWith("https://chrome.google.com/webstore")||e?.url?.startsWith("https://chat.openai.com")?a.startsWith("chrome://extensions/shortcuts")||(s="pages/popup/index.html"):e&&e.id&&(await v.default.tabs.sendMessage(e.id,{}),s=""),await v.default.action.setPopup({popup:s})}catch{await v.default.action.setPopup({popup:"pages/popup/index.html"})}};v.default.tabs.onActivated.addListener(async({tabId:t})=>{let e=await L(t);e&&await r(e)}),v.default.tabs.onUpdated.addListener(async(t,e,a)=>{e.status==="complete"&&a.active&&await r(a)}),v.default.action.onClicked.addListener(async t=>{if(t&&t.id&&t.active){if(t.url==="chrome://extensions/shortcuts")return;await Dt(t.id,"Client_listenOpenChatMessageBox",{type:"shortcut"})||await v.default.action.setPopup({popup:"pages/popup/index.html"})}})}},Tn=()=>{J||v.default.management?.onDisabled?.addListener(function(r){r.id===v.default.runtime.id&&v.default.action.setPopup({popup:"pages/popup/index.html"})})},_n=()=>{J||v.default.contextMenus.onClicked.addListener(async(r,t)=>{r.menuItemId==="use-chatgpt-ai-context-menu-button"&&t&&t.id&&await v.default.tabs.sendMessage(t.id,{id:f,event:"Client_listenOpenChatMessageBox",data:{}})})},xn=()=>{he||new WebSocket("ws://localhost:8181").addEventListener("message",t=>{t.data==="hot_reload_message"&&Wt().then(()=>{})})},Sn=()=>{let r=["lpfemeioodjbpieminkklglpmhlngfcn","idgpnmonknjnojddfkpgkljpfnnfcklj"];v.default.runtime.onMessageExternal.addListener(async function(t,e){if((!he||r.includes(e.id??""))&&t.event==="GET_MAXAI_USERINFO")return{isLogin:!!await pt(!1),success:!0}})};la();
/*! Bundled license information:

is-buffer/index.js:
  (*!
   * Determine if an object is a Buffer
   *
   * @author   Feross Aboukhadijeh <https://feross.org>
   * @license  MIT
   *)
*/
