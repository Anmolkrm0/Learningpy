const apiUrl="https://www.awesomescreenshot.com";function openLoacalTab(e){dataURL=[],centerOffX=0,centerOffY=0,menuType="upload";var t=new FileReader;t.onload=function(e){var t=document.createElement("IMG");t.src=e.target.result,dataURL.push(t),newTab()},t.readAsDataURL(e)}function handleBase64DataUrl(e,t,i){if(!(currentTemId>0))if(e&&isAutoSaveOnline()&&window.navigator.onLine)fetch(e).then((function(e){return e.blob()})).then((function(e){saveAnnotatedImage(e,!0,t,i)}));else{dataURL=[],centerOffX=0,centerOffY=0;var a=document.createElement("IMG");a.src=e,dataURL.push(a),newTab()}}function saveAnnotatedImage(e,t,i,a){currentTemId>0||getCurrentTab((function(n){sendMessageToTab(n.id,{action:"destroy_selected"}),e&&isAutoSaveOnline()&&window.navigator.onLine?getImageId(tabtitle,taburl,i,a,(function(i,n,o){var r=new UploadItem(e,"1",t,0),u=new UploadQueue(i,n);u.sid=o,u.uploadItems.push(r),u.addCapturesCount(),a&&(u.format=a),uploadQueues[i]=u,u.finishCapture(),u.checkStatus()}),(function(t){openLoacalTab(e),refreshUserInfo()})):e&&openLoacalTab(e)}))}function UploadQueue(e,t){this.imageId=e,this.imageUrl=t,this.haveOpenUrl=!1,this.captureCount=0,this.captureFinish=!1,this.uploadItems=[],this.uploadFinish=!1,this.sid="",this.failedInitImage=!1,this.clientCreateTime=(new Date).toUTCString(),this.offsetInfo={centerOffX,centerOffY,centerW,centerH},this.menuType=menuType,this.type=type,this.errMsg="",this.format="jpg"===localStorage.format?"image/jpeg":"image/png",this.failedMaxTime=!1,this.height=0,this.bgRegions=null,this.contentClip=null,this.bottomClip=null,this.topCapturePostion=null,this.imageScale=0,this.leftClr=null,this.rightClr=null}function UploadItem(e,t,i,a){this.blob=e,this.index=t,this.isLast=i,this.failedTimes=0,this.inTimeoutFun=!1,this.status=a}function reloadUploadQueue(e){var t=uploadQueues[e];if(!t)for(var i in uploadQueues){var a=uploadQueues[i];e==a.imageId&&(t=a)}t&&t.checkStatus()}function removeQueueWithImageId(e){var t=e;if(!uploadQueues[e])for(var i in uploadQueues){e==uploadQueues[i].imageId&&(t=i)}delete uploadQueues[t]}function getQueueByImageId(e){var t=uploadQueues[e];if(!t)for(var i in uploadQueues){var a=uploadQueues[i];if(e==a.imageId){t=a;break}}return t}function initImageId(e,t,i,a,n){isAutoSaveOnline()&&window.navigator.onLine?(isSaveOnLine=!0,getImageId(e,t,i,"jpg"===localStorage.format?"image/jpeg":"image/png",(function(e,t,i){var o=getQueueByImageId(a);o?(i&&(o.sid=i),o.updateInfo(e,t)):(o=new UploadQueue(e,t),uploadQueues[a]=o,i&&(o.sid=i)),n&&uploadLog(e,{contentInfo:n}),o.checkStatus()}),(function(){isSaveOnLine=!1;var e=getQueueByImageId(a);e&&e.failedInitId(),refreshUserInfo()}))):isSaveOnLine=!1}function uploadLog(e,t){$.ajax({type:"POST",contentType:"application/json",url:apiUrl+"/api/v1/image/log",data:JSON.stringify({imageID:e,info:JSON.stringify(t)}),success:function(e){e.code},error:function(e){}})}function getImageId(e,t,i,a,n,o){$.ajax({method:"POST",dataType:"json",contentType:"application/json; charset=utf-8",url:apiUrl+"/api/v1/image/create",data:JSON.stringify({title:e,folderID:"0",sourceURL:t,actionType:i,contentType:a,client:/Edg/.test(navigator.userAgent)?"Edge extension":"chrome extension",version:currentversion,clientCreateTime:(new Date).toUTCString()}),success:function(e){1===e.code?n(e.data.image.id,e.data.image.imageURI,e.data.sid):(o(e.code),uploadLog("-1",{errMsg:e.msg+"image/create; "}))},error:function(e){o(e.status),uploadLog("-1",{errMsg:e.statusText+"image/create; "})}})}function finishUpload(e,t,i,a){$.ajax({method:"POST",contentType:"application/json; charset=utf-8",url:apiUrl+"/api/v1/image/complete_multipart"+(a?"?sid="+a:""),data:JSON.stringify({imageID:e,imageCount:t+"",contentType:i}),success:function(t){1!==t.code&&uploadLog(e,{errMsg:t.msg+" complete_multipart; "}),refreshUserInfo()},error:function(t){uploadLog(e,{errMsg:t.statusText+" complete_multipart; "})}})}function uploadItemOnline(e,t,i){if(1!=e.status||!e.blob){e.status=1;var a=new FormData;a.append("file",e.blob),a.append("imageID",t),a.append("imageIndex",e.index),$.ajax({method:"POST",url:apiUrl+"/api/v1/image/upload_multipart"+(i?"?sid="+i:""),data:a,processData:!1,contentType:!1,success:function(i){1===i.code?(e.status=2,reloadUploadQueue(t)):uploadLog(t,{errMsg:i+"res.code:"+i.code+" upload_multipart; "})},error:function(i){e.status=3,e.failedTimes++,reloadUploadQueue(t),e.failedTimes<2&&uploadLog(t,{errMsg:i.statusText+" status:"+i.status+" "+e.index+" upload_multipart; "})}})}}function handleCurrentCapture(e,t,i,a){if((n=getQueueByImageId(a)).addCapturesCount(),i&&n.finishCapture(),"entire"===n.type&&"entire"===n.menuType)handleEntirePage(e,t,i,n.format,a,(function(e){var n=getQueueByImageId(a);if(!e&&n)n.imageUrl?uploadLog(n.imageId,{clientCreateTime:n.clientCreateTime,errMsg:"cropImage return null"}):n.errMsg=n.errMsg?n.errMsg+"cropImage return null; ":"cropImage return null; ";else{var o=new UploadItem(e,t,i,0);if(n){n.uploadItems.push(o);var r=n.imageUrl?n.imageId:0;r>0&&uploadItemOnline(o,r,n.sid)}}}));else try{cropImage(e.src,n.menuType,n.type,n.offsetInfo.centerOffX,n.offsetInfo.centerOffY,n.offsetInfo.centerW,n.offsetInfo.centerH,i,n.format,a,(function(e){var n=getQueueByImageId(a);if(!e&&n)n.imageUrl?uploadLog(n.imageId,{clientCreateTime:n.clientCreateTime,errMsg:"cropImage return null"}):n.errMsg=n.errMsg?n.errMsg+"cropImage return null; ":"cropImage return null; ";else{var o=new UploadItem(e,t,i,0);if(n){n.uploadItems.push(o);var r=n.imageUrl?n.imageId:0;r>0&&uploadItemOnline(o,r,n.sid)}}}))}catch(e){var n;(n=getQueueByImageId(a))&&(n.imageUrl?uploadLog(n.imageId,{clientCreateTime:n.clientCreateTime,errMsg:e.toString()+"handleCurrentCapture; "}):n.errMsg=n.errMsg?n.errMsg+e.toString()+"handleCurrentCapture; ":e.toString()+"handleCurrentCapture; ")}}function handleEntirePage(e,t,i,a,n,o){var r=getQueueByImageId(n);if(r.contentClip||(r.contentClip=contentClip,r.bgRegions=bgRegions,r.bottomClip=bottomClip,r.topCapturePostion=topCapturePostion,bgRegions&&bgRegions.forEach((function(t){t&&t.fill.width>0&&t.fill.height>0&&(0==t.fill.x?r.leftClr=getColorWithRegion(e,t.sample):t.fill.x>0&&(r.rightClr=getColorWithRegion(e,t.sample)))}))),e){var u,l,s,p,g,d,c,m,h,f=document.createElement("CANVAS"),I=f.getContext("2d"),C=e.width,T=e.height,v=0;if(parseInt(r.topCapturePostion.height)>T+10){r.isMobileMode=!0;var y=r.topCapturePostion.width/C;r.imageScale=Math.round(y),r.topCapturePostion=b(y,r.topCapturePostion),r.topCapturePostion.height>T&&(r.topCapturePostion.height=T,r.topCapturePostion.width=C),r.contentClip&&(r.contentClip=b(y,r.contentClip)),r.contentClip.y+r.contentClip.height>T&&(r.contentClip.height=T-r.contentClip.y),r.bottomClip&&(r.bottomClip=b(y,r.bottomClip))}function b(e,t){return t.x=t.x/e,t.y=Math.ceil(t.y/e),t.height=parseInt(t.height/e),t.width=t.width/e,t}if(1===t)u=g=0,l=d=0,s=c=C,p=m=h=r.topCapturePostion.height-1;else{var U=r.contentClip.height;if(l=r.contentClip.y,u=g=r.contentClip.x,d=0,s=c=r.contentClip.width,p=m=U-1,i){v=Math.ceil(U*ratio.y),p=m=v=v<=0?1:v;var w=r.bottomClip&&r.bottomClip.height?r.bottomClip.height:0;l=T-v-w,h=v+w}else h=m}f.width=r.isMobileMode?C-2:C,f.height=h,I.drawImage(e,u,l,s,p,g,d,c,m),r.contentClip.x>0&&r.leftClr&&(I.beginPath(),I.rect(0,0,u,p),I.fillStyle=r.leftClr,I.fill()),r.contentClip.x+r.contentClip.width<C&&r.rightClr&&(I.beginPath(),I.rect(u+s,0,C-(u+s),p),I.fillStyle=r.rightClr,I.fill()),r.bottomClip&&r.bottomClip.height>0&&i&&I.drawImage(e,0,r.bottomClip.y,C,r.bottomClip.height,0,p,C,r.bottomClip.height),"image/jpeg"===a?f.toBlob((function(e){if(image=null,f=null,!e){var t=getQueueByImageId(n);t&&(t.imageUrl?uploadLog(t.imageId,{clientCreateTime:t.clientCreateTime,errMsg:"cropImage return null size:"+s+" "+p+" "+t.type+t.menuType}):t.errMsg="cropImage return null size:"+s+" "+p+" "+t.type+t.menuType)}o(e)}),"image/jpeg",1):f.toBlob((function(e){if(image=null,f=null,!e){var t=getQueueByImageId(n);t&&(t.imageUrl?uploadLog(t.imageId,{clientCreateTime:t.clientCreateTime+" ",errMsg:"cropImage return null size:"+centerW+" "+centerH+" "+type+menuType}):t.errMsg="cropImage return null size:"+centerW+" "+centerH+" "+type+menuType)}o(e)}))}}function cropImage(e,t,i,a,n,o,r,u,l,s,p){getQueueByImageId(s);if(e){var g=document.createElement("CANVAS"),d=g.getContext("2d"),c=document.createElement("IMG"),m=0;"visible"===i&&"selected"!==t&&"desktop"!==t&&"upload"!==t&&(m=contentCanScroll?getScrollbarWidth():0),c.onload=function(){var e=this.width,h=this.height;if(0==o||"desktop"==t?(r=h,o=e-m,a=n=0):"visible"!==i&&(r=h,n=0),topCapturePostion&&parseInt(topCapturePostion.height)>h+10&&"selected"===t){var f=topCapturePostion.width/e;o/=f,r/=f,a/=f,n/=f}if(u&&"visible"!==i)if(ratio.y>0){(I=Math.ceil(h*ratio.y))<=0&&(I=1),n=h-I,r=I}else{var I=h*ratio.y;n=0,r=h}else"selected"!==t&&(n=0);g.width=o,g.height=r,d.drawImage(this,a,n,o,r,0,0,o,r),"image/jpeg"===l?g.toBlob((function(e){if(c=null,g=null,!e){var a=getQueueByImageId(s);a&&(a.imageUrl?uploadLog(a.imageId,{clientCreateTime:a.clientCreateTime,errMsg:"cropImage return null size:"+o+" "+r+" "+i+t}):a.errMsg="cropImage return null size:"+o+" "+r+" "+i+t)}p(e)}),"image/jpeg",1):g.toBlob((function(e){if(c=null,g=null,!e){var a=getQueueByImageId(s);a&&(a.imageUrl?uploadLog(a.imageId,{clientCreateTime:a.clientCreateTime+" ",errMsg:"cropImage return null size:"+o+" "+r+" "+i+t}):a.errMsg="cropImage return null size:"+o+" "+r+" "+i+t)}p(e)}))},c.src=e}}function getColorWithRegion(e,t){if(t.height>0&&t.width>0){var i=new Map,a=document.createElement("canvas");a.width=t.width,a.height=t.height;var n=a.getContext("2d"),o=null;try{n.drawImage(e,t.x,t.y,t.width,t.height,0,0,t.width,t.height),o=n.getImageData(0,0,t.width,t.height)}catch(e){}if(o){!function(e,t){function i(e,t,i){return(e<<16)+(t<<8)+i}t=t||new Map;for(var a=0,n=e.length;a<n;a+=4)if(255===e[a+3]){var o=i(e[a],e[a+1],e[a+2]);t.set(o,(t.get(o)||0)+1)}}(o.data,i);var r=0,u=0,l=!1;return i.forEach((function(e,t){e>r&&(r=e,u=t,l=!0)})),l?"rgb("+getColor(u).join(", ")+")":"rgb(212,212,212)"}return null}}function getColor(e){var t=255&e,i=255&(e>>=8);return[255&(e>>=8),i,t]}UploadQueue.prototype.updateInfo=function(e,t){this.imageId=e,this.imageUrl=t,this.checkStatus(),this.errMsg&&uploadLog(this.imageId,{errMsg:this.errMsg})},UploadQueue.prototype.failedInitId=function(){this.failedInitImage=!0,this.captureFinish&&(this.uploadItems=[],newTab())},UploadQueue.prototype.addCapturesCount=function(){this.captureCount++},UploadQueue.prototype.finishCapture=function(){if(this.captureFinish=!0,isScrollCapturing=!1,currentTemId=0,this.failedInitImage)return this.uploadItems=[],void newTab();this.checkStatus()},UploadQueue.prototype.checkStatus=function(){if(this.imageUrl){var e=!0,t=this.uploadItems.length;if(t>0){var i=this;this.uploadItems.forEach((function(t){2!==t.status&&(e=!1),0!=t.status&&3!=t.status||(0==t.failedTimes?uploadItemOnline(t,i.imageId,i.sid):t.failedTimes<8&&!t.inTimeoutFun&&!this.failedMaxTime?(t.inTimeoutFun=!0,setTimeout((function(){t.inTimeoutFun=!1,uploadItemOnline(t,i.imageId,i.sid)}),800*t.failedTimes)):t.failedTimes>8&&!t.inTimeoutFun&&(this.failedMaxTime=!0))}))}else e=!1;if(this.captureFinish&&!this.haveOpenUrl&&this.imageUrl){this.haveOpenUrl=!0;var a="entire"===this.menuType||"selected"===this.menuType?this.imageUrl+"?init_open=true":this.imageUrl;openNewTab(a)}e&&this.captureFinish&&!this.uploadFinish&&this.captureCount===t&&(this.uploadFinish=!0,this.uploadItems=[],finishUpload(this.imageId,this.captureCount,this.format,this.sid),removeQueueWithImageId(this.imageId))}};