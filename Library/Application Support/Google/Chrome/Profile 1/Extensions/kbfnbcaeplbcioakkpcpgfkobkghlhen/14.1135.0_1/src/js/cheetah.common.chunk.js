(self.webpackChunk=self.webpackChunk||[]).push([[4382],{65312:(e,t,i)=>{i.r(t),i.d(t,{CheetahFeatureImpl:()=>xt,isAssistantOpened:()=>Rt});var s=i(17771),a=i(17889),n=i(62965),r=i(6294),o=i(85892),l=i(57050),d=i(27378),h=i(54696),c=i(55649),u=i(98805),p=i(14601),g=i(32952),m=i(60797),v=i(66310),_=i(24209),b=i(85985),f=i(23063),S=i(40151),y=i(98403),w=i(2844),A=i(77176),I=i(2834),R=i(76974),x=i(28043),C=i(93508),U=i(16118),E=i(13444),k=i(78674),B=i(12126),P=i(17343),O=i(80544),M=i(79692),T=i(67434),G=i(19751),z=i(44586),H=i(97425),N=i(5114),F=i(8125),j=i(83078),D=i(95195),W=i(22232),q=i(54001),V=i(23239),$=i(34217),L=i(51325);const Z=({width:e,height:t,top:i,left:s,visibility:a})=>d.createElement("div",{"data-grammarly-part":"cheetah-highlight-rect",...(0,q.Sh)(L.highlightRect,"hidden"===a?L.hidden:null,"attention"===a?L.attention:null),style:{width:e,height:t,top:i,left:s}});var Q=i(6726),Y=i(16805);const K=d.forwardRef((function({forceTooltipMessage:e,onClick:t,onMouseEnter:i,onMouseLeave:s},a){return d.createElement(Q.u,{message:"Open GrammarlyGO",forcedMessage:e},d.createElement("button",{onClick:t,"data-grammarly-part":"cheetah-ideate-button",className:Y.ideateButton,ref:a,onMouseEnter:i,onMouseLeave:s},d.createElement("div",{className:Y.ideateButtonIcon})))}));var J=i(88571),X=i(4147),ee=i(89894),te=i(15073),ie=i(42103),se=i(51369),ae=i(85665);const ne=ee.ux.style({fontStyle:"normal",fontWeight:"normal",fontFamily:"Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', sans-serif, Arial",$nest:{"button, input, textarea":{fontFamily:"inherit"}}}),re=({children:e})=>{var t;const i=null===(t=d.useContext(ae.nS.Context))||void 0===t?void 0:t.host;return d.createElement(X.o,null,d.createElement(J.Q,{remSize:R.of(16),setter:e=>te.u.setRootCssVar(i||document.documentElement,e)},d.createElement(ie.G.DefaultProvider,null,d.createElement("div",{className:ne},e,d.createElement(se.X,null)))))};var oe=i(37869),le=i(50783);const de=({referenceElement:e,placement:t,offset:i,disabled:s,onClick:a})=>{const[n,r]=d.useState(null),{styles:o,attributes:l}=(0,oe.D)(e,n,{placement:t,modifiers:i?[{name:"offset",options:{offset:i}}]:[]});return d.createElement("button",{ref:r,style:o.popper,...l.popper,onClick:a,onMouseDown:e=>{e.stopPropagation(),e.preventDefault()},"data-grammarly-part":"cheetah-reply-button",className:le.replyButton,"data-disabled":s},d.createElement("div",{className:le.icon}),d.createElement("span",null,"Reply quickly"))};var he=i(87491);const ce=({referenceElement:e,placement:t,offset:i,disabled:s,onMagicRewriteClick:a,onOpenRewriteClick:n})=>{const[r,o]=d.useState(null),{styles:l,attributes:h}=(0,oe.D)(e,r,{placement:t,modifiers:i?[{name:"offset",options:{offset:i}}]:[]});return a||n?d.createElement("div",{ref:o,style:l.popper,...h.popper,onMouseDown:e=>{e.stopPropagation(),e.preventDefault()},"data-grammarly-part":"cheetah-entry-button",className:he.entryButton,"data-disabled":s},a?d.createElement(Q.u,{message:"Improve it"},d.createElement("button",{onClick:a,onMouseDown:e=>{e.stopPropagation(),e.preventDefault()},className:he.entryButtonItem,"data-disabled":s},d.createElement("i",{className:he.rewriteIcon}))):null,n?d.createElement(Q.u,{message:"Open GrammarlyGO"},d.createElement("button",{onClick:n,onMouseDown:e=>{e.stopPropagation(),e.preventDefault()},className:he.entryButtonItem,"data-disabled":s},d.createElement("i",{className:he.openIcon}))):null):null};var ue=i(90845),pe=i(49708),ge=i(8543),me=i(48033);const ve=()=>d.createElement("svg",{className:me.icon,viewBox:"0 0 16 16",fillRule:"evenodd",clipRule:"evenodd",strokeLinecap:"round"},d.createElement("path",{d:"M8,16C12.418,16 16,12.418 16,8C16,3.582 12.418,0 8,0C3.582,0 0,3.582 0,8C0,12.418 3.582,16 8,16Z",fill:"#0A9A78"}),d.createElement("path",{d:"M4,8L12,8M8,4L8,12",fill:"none",fillRule:"nonzero",stroke:"white",strokeWidth:"1.5px"})),_e=({overflow:e,...t})=>e?d.createElement(fe,{...t}):d.createElement(be,{...t}),be=({left:e,top:t,height:i})=>d.createElement(d.Fragment,null,d.createElement("div",{"data-grammarly-part":"cheetah-quasi-caret",className:me.quasiCaret,style:{left:e,top:t+i,height:i+8}},d.createElement(ve,null))),fe=({left:e,top:t,height:i})=>{const{ref:a,onMount:n}=ue.P.useElWatcher(),r=d.useMemo((()=>V.h.create(N.none)),[]),{rect:o,onMount:h}=ue.P.useRectWatcher(),c=d.useCallback((e=>{e.style.pointerEvents="all",r.set((0,l.zG)(s.Y(N.option)({rect:N.some(e.getBoundingClientRect()),goodParent:(0,l.zG)(e.getBoundingClientRect(),(e=>({x:e.x+e.width/2,y:e.y+e.height/2})),(({x:e,y:t})=>{var i,s;return N.fromNullable(null===(s=null===(i=document.elementFromPoint(e,t))||void 0===i?void 0:i.shadowRoot)||void 0===s?void 0:s.elementFromPoint(e,t))}),N.filter((t=>t===e||e.contains(t||null))))}),N.fold((()=>N.none),(({rect:e})=>N.some({x:e.x,y:e.y}))))),e.style.pointerEvents="none"}),[]),u=d.useMemo((()=>pe.R(document,"scroll",{capture:!0}).pipe(C.O(null))),[]);return ue.P.useSubscriptionTo(w.aj([a.pipe(m.oA),u,o]).pipe(I.b((([e])=>c(e))))),d.createElement(d.Fragment,null,d.createElement("div",{"data-grammarly-part":"cheetah-quasi-caret",className:me.quasiCaret,style:{left:e,top:t+i,height:i+8},ref:e=>{n(e),h(e)}},d.createElement(ge.F.div,{style:r.pipe(A.U((e=>(0,l.zG)(e,N.fold((()=>({opacity:1})),(()=>({opacity:0})))))))},d.createElement(ve,null))),d.createElement(ge.F.Fragment,null,r.pipe(A.U((e=>(0,l.zG)(e,N.fold(l.gn,(e=>d.createElement("div",{"data-grammarly-part":"cheetah-quasi-caret-fixed-bro",className:me.quasiCaret,style:{transform:"none",position:"fixed",left:e.x,top:e.y,height:i+8}},d.createElement(ve,null))))))))))};var Se=i(10389),ye=i(64015),we=i(12422),Ae=i(819),Ie=i(50901),Re=i(51478),xe=i(69693),Ce=i(51216),Ue=i(44120),Ee=i(66768),ke=i(82471),Be=i(70367),Pe=i(84403),Oe=i(42724),Me=i(92627),Te=i(99877),Ge=i(44848),ze=i(72004),He=i(36847),Ne=i(35298),Fe=i(51129),je=i(7534);var De=i(44358),We=i(81873),qe=i(81531),Ve=i(65504),$e=i(9205),Le=i(9629),Ze=i(88355),Qe=i(4068),Ye=i(30857),Ke=i(31528);function Je(e){return"pushAssistantFeed"===e.type}function Xe(e){var t,i;const s="pushRewrite"===e.mode?null:e,a=((null===(t=null==s?void 0:s.source)||void 0===t?void 0:t.type)===Ke.WT.sdui?s.source.action.actions:[]).find((0,F.W9)(Je,(e=>"default-feed"===e.feedId)));return{feedId:"default-feed",cardId:null!==(i=null==a?void 0:a.cardId)&&void 0!==i?i:null}}function et(e,t,i,s){switch(e.mode){case"ideation":return{mode:e.mode,metadata:t,documentUrl:s};case"rewrite":case"quickRewrite":return{mode:e.mode,metadata:t};case"quickReply":return{mode:e.mode,quickReplyContext:(0,l.zG)(i,N.fold((()=>Qe.H.empty),tt)),metadata:t};case"pushRewrite":return{mode:e.mode,writingExpertContext:e.writingExpertContext};default:(0,W.L0)(e)}}function tt(e){var t,i,s,a,n,r,o,d,h,c,u,p,g,m,v,_,b;const f=e=>{var t;return null!==(t=null==e?void 0:e.reduce(((e,t)=>{var i;return t.email&&!e.has(t.email)&&e.set(t.email,{name:null!==(i=t.name)&&void 0!==i?i:"",email:t.email}),e}),new Map))&&void 0!==t?t:new Map},S=f(null===(s=null===(i=null===(t=e.parents)||void 0===t?void 0:t[0])||void 0===i?void 0:i.audience)||void 0===s?void 0:s.indirectRecipients),y=f(null===(r=null===(n=null===(a=e.parents)||void 0===a?void 0:a[0])||void 0===n?void 0:n.audience)||void 0===r?void 0:r.undisclosedRecipients),w=f(null===(c=null===(h=null===(d=null===(o=e.parents)||void 0===o?void 0:o[0])||void 0===d?void 0:d.audience)||void 0===h?void 0:h.recipients)||void 0===c?void 0:c.filter((({email:e})=>(0,Ye.HD)(e)&&!S.has(e)&&!y.has(e)))),A=f(null===(u=e.audience)||void 0===u?void 0:u.indirectRecipients),I=f(null===(p=e.audience)||void 0===p?void 0:p.undisclosedRecipients),R=f(null===(m=null===(g=e.audience)||void 0===g?void 0:g.recipients)||void 0===m?void 0:m.filter((({email:e})=>(0,Ye.HD)(e)&&!A.has(e)&&!I.has(e))));return{previousMessageInfo:(0,l.zG)(ye.YM(null!==(v=e.parents)&&void 0!==v?v:[]),N.fold((()=>Qe.H.PreviousMessageInfo.empty),(e=>{var t;return{author:(0,l.zG)(ye.YM(null!==(t=e.authors)&&void 0!==t?t:[]),N.fold((()=>Qe.H.Person.empty),(e=>{var t,i;return{name:null!==(t=e.name)&&void 0!==t?t:"",email:null!==(i=e.email)&&void 0!==i?i:""}}))),directRecipients:Array.from(w.values()),text:e.delta?(0,Ze.l)(e.delta,""):""}}))),title:null!==(_=e.title)&&void 0!==_?_:"",author:(0,l.zG)(ye.YM(null!==(b=e.authors)&&void 0!==b?b:[]),N.fold((()=>Qe.H.Person.empty),(e=>{var t,i;return{name:null!==(t=e.name)&&void 0!==t?t:"",email:null!==(i=e.email)&&void 0!==i?i:""}}))),directRecipients:Array.from(R.values()),indirectRecipients:Array.from(A.values()),undisclosedRecipients:Array.from(I.values())}}var it=i(41127),st=i(8709),at=i(20236),nt=i(67534);function rt(e,t,i,s){const{left:a,right:n}=(0,l.zG)(e,ye.UI((({alertId:e,alternativeIndex:i})=>function(e,t,i){return(0,l.zG)(D.fromOption((()=>`Alert ${e} not found`))(i(e)),D.filterOrElse(at.S.isCapiAlert,(t=>`Unsupported alert ${e} with type ${t._tag}`)),D.chain((i=>h.$.isWithTransformJson(i)?(0,l.zG)(i.transformJSON.alternatives,N.chain((e=>{var i;return N.fromNullable(null===(i=e.alternatives[t])||void 0===i?void 0:i.delta)})),D.fromOption((()=>`Alternative ${t} not found for WithTransformJson alert ${e}`))):h.$.isWithSubAlerts(i)?(0,l.zG)(i.subalerts.alternatives,N.chain((e=>{var i;return N.fromNullable(null===(i=e.alternatives[t])||void 0===i?void 0:i.delta)})),D.fromOption((()=>`Alternative ${t} or context not found for WithSubAlerts alert ${e}`))):h.$.isWithPosition(i)?D.right((new st.i).retain(i.transformRange.start).delete(i.transformRange.end-i.transformRange.start).insert(i.transformText)):D.left(`Unsupported alert ${e}`))),D.map((i=>({delta:i,alertId:e,alternativeIndex:t}))))}(e,i,t))),ye.oh),r=n.reduce(((e,t)=>e.compose(t.delta)),new st.i),o=(0,nt.g)(r),d=(0,nt.B)(r);return i.performBatchReplacements(o).then((()=>D.right(void 0))).catch((t=>D.left(`Replacement error for [${e.map((e=>`alertId: ${e.alertId} altIdx: ${e.alternativeIndex}`)).join(", ")}]: `+String(t)))).then((e=>(0,l.zG)(s(),N.filter((()=>d.length>0)),N.fold((()=>Promise.resolve(D.right(void 0))),(e=>Promise.all(d.map((({range:t,formatting:i})=>e.apply(t,i).then((()=>D.right(void 0))).catch((e=>D.left(String(e))))))).then((0,l.ls)(ye.oh,(({left:e})=>e.length>0?D.left(`Formatting errors [${e.join(", ")}]`):D.right(void 0))))))).then((t=>{const i=a.concat(D.isLeft(e)?[e.left]:[]).concat(D.isLeft(t)?[t.left]:[]);return i.length>0?D.left(new Error(`AlertApply - ${i.join(" - ")}`)):D.right(void 0)}))))}var ot=i(80358),lt=i(36919),dt=i(19125);var ht=i(71078),ct=i(18625);var ut=i(48015);function pt(e){return i.e(8661).then(i.bind(i,19853)).then((({createRevisionEngine:t})=>{const i=V.h.create(null),s=e.alertStateService.getActiveAlertByClick().pipe(A.U((e=>{var t;return null!==(t=null==e?void 0:e.alertId)&&void 0!==t?t:null}))).subscribe(y.wW(i)),a=c.Y.create("cheetah.revision"),{revisionEngine:n,dispose:r}=t({capiService:e.capiService,sduiService:{sduiItemCollectionChanges:(d=e.sduiBufferService,_.T(d.pipe(U.G(),A.U((([e,t])=>N.isSome(e)?N.some((0,dt.ex)()):N.none)),m.oA),d.pipe(v.w(N.fold((()=>S.E),(e=>e.capiEvents.pipe(b.h((0,F.Kg)(ot.h.is("sdui_add"),ot.h.is("sdui_update"),ot.h.is("sdui_remove"))),A.U((e=>{switch(e.kind){case"sdui_add":return(0,dt.K5)(e.sduiRootId,e.sdui);case"sdui_update":return(0,dt.FE)(e.sduiRootId,e.sdui);case"sdui_remove":return(0,dt.Ul)(e.sduiRootId);default:return(0,l.Rz)(e)}})))))))).pipe((e=>e.pipe(lt.f(e.pipe(k.b(0))))),b.h((e=>e.length>0)))).pipe(I.b((e=>a.trace("sduiService.sduiItemCollectionChanges",e)))),initialFeed:e.initialFeed},alertService:{alertCollectionChanges:(o=e.alertProcessor.alerts,ct.P((()=>o.changes.pipe(A.U((e=>{const t=new Set(e.addedAlerts.filter(at.S.isCapiAlert).map((e=>e.id))),i=new Set(e.removedAlerts.filter((e=>at.S.isCapiAlert(e.alert))).map((e=>e.id)));return[...e.addedAlerts.filter(at.S.isCapiAlert).filter((e=>!i.has(e.id))).map((e=>(0,ht.Tm)(e.id))),...e.removedAlerts.filter((e=>at.S.isCapiAlert(e.alert))).filter((e=>!t.has(e.id))).map((e=>(0,ht.qQ)(e.id,"textChange"===e.reason._tag?"textChange":"other")))]})),C.O(Array.from(o.getAll()).filter(at.S.isCapiAlert).map((e=>(0,ht.Tm)(e.id)))),(e=>e.pipe(lt.f(e.pipe(k.b(0))))),A.U((e=>e.flatMap(l.yR))),b.h((e=>e.length>0)))))).pipe(I.b((e=>a.trace("alertService.alertCollectionChange",e)))),selectedAlertId:i,applyAlerts:t=>{const i=rt(t,(t=>N.fromNullable(e.alertProcessor.alerts.getAlertById(t))),e.replacementService,e.getFormattingService).then(D.fold((e=>{throw a.warn("Error applying alerts",{applyAlertsInfo:t,error:e}),e}),(()=>{})));return e.requestAwaitService.addRequest(i),i},removeAlerts:t=>(0,ut.DV)((()=>Promise.resolve(t.forEach((({alertId:t,removalReason:i})=>{e.alertProcessor.removeAlert(t,{_tag:"alertApplied"===i?it.i.alertAccepted:it.i.ignore})})))),(e=>(a.warn("Error removing alerts",{removedAlertsInfo:t,error:e}),Promise.reject(e)))),setAlertsVisibility:t=>(e.highlightsUpdater.setAlertsVisibility(t),Promise.resolve(void 0)),updateAlertsVisibility:t=>(e.highlightsUpdater.updateAlertsVisibility(t),Promise.resolve(void 0))},monitoringService:{notify:t=>function(e,t,i,s){"error"===t.kind?e.cheetah.error(t,i,s):"warn"===t.kind?e.cheetah.warning(t,i,s):"info"===t.kind?e.cheetah.info(t,i,s):(0,W.L0)(t.kind)}(e.telemetry,t,e.domain,e.getSessionUuid())},logger:a});var o,d;return{revisionEngine:n,dispose:()=>{e.highlightsUpdater.clearAll(),s.unsubscribe(),r()}}}))}var gt=i(48044),mt=i(13853),vt=i(7604),_t=i(73975),bt=i(95300),ft=i(32409);class St{constructor(e){this._params=e,this._subs=new p.w,this._visibleAlertsSubject=new bt.X(new Map),this._emphasizedAlertsSubject=new bt.X(new Map),this._visibleAlerts=this._visibleAlertsSubject.pipe(G.skipBy(gt.Eh(_t.yv,mt.Eh(_t.yv)))),this._emphasizedAlerts=this._emphasizedAlertsSubject.pipe(G.skipBy(gt.Eh(_t.yv,mt.Eh(_t.yv)))),this.hasHighlights=this._visibleAlerts.pipe(A.U((e=>e.size>0)),C.O(!1),x.x(),G.shareReplay({bufferSize:1,refCount:!0})),this._subs.add(this._visibleAlerts.subscribe((e=>{var t;return null===(t=this._params.logger)||void 0===t?void 0:t.debug("visible highlights",e)}))),this._subs.add(this._emphasizedAlerts.subscribe((e=>{var t;return null===(t=this._params.logger)||void 0===t?void 0:t.debug("emphasized highlights",e)})))}setAlertsVisibility(e){this.clearAll();const t=new Map(this._visibleAlertsSubject.value),i=new Map(this._emphasizedAlertsSubject.value);e.filter((e=>"hidden"!==e.visibility)).forEach((({alertId:e,visibility:s})=>{const a=this._params.getAlertById(e);if(a){const n=a.highlightRanges.map((t=>({range:t,highlightId:yt(e,t)})));n.forEach((({range:e,highlightId:t})=>{this._params.highlightCollection.addHighlight(t,e,ft.M.getHighlightMeta(a,t,e,!1))})),t.set(e,new Set(n.map((e=>e.highlightId)))),"emphasized"===s&&i.set(e,new Set(n.map((e=>e.highlightId))))}})),this._visibleAlertsSubject.next(t),this._emphasizedAlertsSubject.next(i)}updateAlertsVisibility(e){const t=new Map(this._visibleAlertsSubject.value),i=new Map(this._emphasizedAlertsSubject.value);e.forEach((({alertId:e,visibility:s})=>{var a;const n=this._params.getAlertById(e);if(n&&"hidden"!==s){const a=n.highlightRanges.map((t=>({range:t,highlightId:yt(e,t)})));a.forEach((({range:e,highlightId:t})=>{this._params.highlightCollection.updateHighlight(t,e,ft.M.getHighlightMeta(n,t,e,!1))})),t.set(e,new Set(a.map((e=>e.highlightId)))),"emphasized"===s?i.set(e,new Set(a.map((e=>e.highlightId)))):i.delete(e)}else{const s=Array.from(null!==(a=this._visibleAlertsSubject.value.get(e))&&void 0!==a?a:new Set);s.length>0&&this._params.highlightCollection.removeHighlights(s),t.delete(e),i.delete(e)}})),this._visibleAlertsSubject.next(t),this._emphasizedAlertsSubject.next(i)}clearAll(){const e=new Set(Array.from(this._visibleAlertsSubject.value.values()).concat(Array.from(this._emphasizedAlertsSubject.value.values())).flatMap((e=>Array.from(e))));e.size>0&&this._params.highlightCollection.removeHighlights(Array.from(e)),this._visibleAlertsSubject.next(new Map),this._emphasizedAlertsSubject.next(new Map)}getHighlightVisualState(e){const t=this._params.alertStateService.getHighlightedAlert().pipe(A.U((t=>{var i;return!0===(null===(i=null==t?void 0:t.highlightIds)||void 0===i?void 0:i.includes(e))})),C.O(!1),x.x()),i=this._params.alertStateService.getActiveAlertByClick().pipe(A.U((t=>{var i;return!0===(null===(i=null==t?void 0:t.highlightIds)||void 0===i?void 0:i.includes(e))})),C.O(!1),x.x()),s=this._emphasizedAlerts.pipe(A.U((t=>Array.from(t.values()).some((t=>t.has(e))))),x.x());return w.aj([t,i,s]).pipe(A.U((([e,t,i])=>({hovered:e,selectedByClick:t,emphasized:i}))),C.O({hovered:!1,selectedByClick:!1,emphasized:!1}),U.G(),A.U((([e,t])=>t.hovered||t.selectedByClick?vt.pc.hovered:t.emphasized?e.hovered||e.selectedByClick?vt.pc.hovered:vt.pc.hoveredNeedsAttention:vt.pc.none)),C.O(vt.pc.none),x.x(),I.b((t=>{var i;return null===(i=this._params.logger)||void 0===i?void 0:i.debug(`[${e}] visual state:`,t)})))}dispose(){this.clearAll(),this._subs.unsubscribe()}}function yt(e,t){return`${e}|${t.start}-${t.end}|cheetah`}const wt=(0,q.xb)(K),At=new Set(["onboarding","gdocsOnboardingPopup","loginSSO","accountMigration","standWithUkraineGrammarlySuspended","claimedUser","dataControl","noPaymentMethodSubscription","grammarlyBusinessSigninPopup","gdocsFeedbackUI"]),It=new Set(["onboarding","gdocsOnboardingPopup","loginSSO","accountMigration","standWithUkraineGrammarlySuspended","claimedUser","dataControl","grammarlyBusinessSigninPopup"]);function Rt(e){return"opened"===e.kind}class xt{constructor(e){this._params=e,this._subs=new p.w,this._log=c.Y.create("CheetahFeatureImpl"),this._inlineButtonUI=V.h.create(null),this._ideateButtonUI=V.h.create(null),this._expandedIdeateButtonUI=V.h.create(null),this._assistantUI=V.h.create(null),this._highlightUI=V.h.create(null),this._quasiCaretUI=V.h.create(null),this._onboardingUI=V.h.create(null),this._nativeCursorHider=V.h.create(N.none),this._lastRestartAttemptTime=V.h.create(0),this._contextHighlight=V.h.create(N.none),this._highlightsUpdater=new St({getAlertById:e=>this._params.alertProcessor.alerts.getAlertById(e),highlightCollection:this._params.highlightCollection,alertStateService:this._params.alertStateService,logger:c.Y.create("cheetah.revision.highlights")}),this._ideateButtonTooltipNotificationState=V.h.create(N.none),this._assistantFocused=V.h.create(!1),this._inlineButtonRecentlyPressed=V.h.create(!1),this._ideateButtonRecentlyHovered=V.h.create(!1),this._selectionRange=V.h.create(N.none),this._highlights=V.h.create([]),this._quasiCaretRect=V.h.create(N.none),this._assistantUIState=V.h.create(N.none),this._onboardingViewModels=V.h.create(N.none),this._ideateButtonRefChange=new g.xQ,this._disposed=new g.xQ,this._initialOnboardingBlockedForSession=V.h.create(!1),this._assistantServices=function(e,t,i,s,a,o,d,h,c,m,_,S,y,x,C,U,E,k,B,P,F,j,q,$,L,Z,Q,Y,K){const J=new g.xQ,X=()=>(0,l.zG)(e.get(),D.fromOption((()=>new Error("checking service not initialized")))),ee={notify(e){null==K||K.info("received monitoring event",{event:e}),(0,l.zG)(X(),D.map((e=>e.sessionUuid)),D.map((t=>{"error"===e.kind?(Q.cheetah.error(e,L,t),"waitForContextTimeout"!==e.name&&"waitForAckTimeout"!==e.name||"getContext"!==e.source||(Date.now()-$.get()>u.LK(5)?($.set(Date.now()),Z()):(0,l.zG)(e.name,(e=>"waitForAckTimeout"===e?"ack":"waitForContextTimeout"===e?"setContext":void(0,W.L0)(e)),(e=>Q.cheetah.sessionRestartTimeout(e,L,t))))):"info"===e.kind?Q.cheetah.info(e,L,t):"warn"===e.kind?Q.cheetah.warning(e,L,t):(0,W.L0)(e.kind)})))}},te=new Be.t({inboundCAPIMessages:t,sendCAPIMessage:({action:e,data:t,shouldInjectRev:i,shouldInjectSessionId:s})=>(0,l.zG)(n.Uo(X()),n.tS((a=>a.sendMessage(e,t,i,s)))),monitoringService:ee}),ie=new Pe.c(te),se={user:V.h.combine(i,s,((e,t)=>({id:Oe.n.Id.create(e.id),isPremium:Fe.n5.isPremium(e),dialect:t}))),setDialect:a},ae=new Me.L(te,h.view((0,l.ls)(N.chain((e=>N.fromNullable(e.cheetahState))),N.fold((()=>({enabled:!1})),(e=>({enabled:!0,userState:e})))))),ne=o.pipe(v.w(N.fold((()=>R.of(N.none)),(e=>e.sessionService.session.view(N.some))))),re=c.pipe(O.QV(M.E),T.R(((e,t)=>{const i=e.filter(Ut);return t&&Ut(t)?[...i,t]:i}),[]),A.U(ye.Z$),G.shareReplay({bufferSize:1,refCount:!0})),oe=w.aj([re,m,_]).pipe(A.U((([e,t,i])=>(0,l.zG)(e,N.filter((()=>t)),N.fold((()=>({})),(e=>({[Te.n.initialPopupAnchor]:i?{reference:e,placement:"top",offset:8,boundaryAreaPadding:10}:void 0,[Te.n.initialBTSPopupAnchor]:i?{reference:e,placement:"top",offset:8,boundaryAreaPadding:10}:void 0,[Te.n.rewriteTooltipAnchor]:{reference:e,placement:"top",offset:8,boundaryAreaPadding:10}}))))))),le=e=>{null==K||K.debug(`Completing step [${e}]`);y.get()[e].extension.completed||x({[e]:{completed:!0,lastSeen:Date.now()}})},de=()=>{const e=new Set;C.get().rewrite&&U||e.add(Ie.T.StepName.rewrite),C.get().compose||e.add(Ie.T.StepName.initial),C.get().onboarding||(e.add(Ie.T.StepName.initial),e.add(Ie.T.StepName.initialBTS),e.add(Ie.T.StepName.rewrite),e.add(Ie.T.StepName.prompts),e.add(Ie.T.StepName.review),e.add(Ie.T.StepName.knowledgeHub),e.add(Ie.T.StepName.references));const t=(0,l.zG)(h.get(),N.map((e=>"ASSIGNMENT_WRITING"===e.defaultDocumentContext.writingIntent)),N.getOrElse(l.jv));return C.get().onboardingBTS&&t||e.add(Ie.T.StepName.initialBTS),C.get().knowledgeHubIntegration||e.add(Ie.T.StepName.knowledgeHub),(0,Ge.Q)({upstreamOnboardingState:y,session:ne,textStats:d,forceDisabledOnboardingSteps:e,assistantUIActions:J,externalElements:oe,hideAssistantOnboardingTooltips:o.pipe(v.w(N.fold((()=>V.h.create(!1)),(e=>e.dragBehavior.pipe(A.U((e=>"draggable"===e.kind&&e.isDragging))))))),promptsAllocated:ae.availability.view(Ae._.getPromptsAllocated),client:"extension",trackingService:ie,disposed:S,logger:qe.C8.Logging.getLogger("OnboardingCompletionEffects"),completeOnboardingStep:le})},he={flush:()=>n.fF((()=>new z.y((t=>{const i=new p.w;return E.empty.get()?t.next(void 0):(E.flush(),(0,l.zG)(e.get(),N.fold((()=>t.next(void 0)),(e=>{i.add(e.messages.pipe(b.h((e=>e._tag===Se.J8.Type.submitOtAck)),H.L(500,R.of(null)),I.b((()=>t.next(void 0)))).subscribe())})))),()=>i.unsubscribe()})).pipe(f.q(1)).toPromise())),getText:e=>n.tD((()=>k(e))),insertText:e=>n.tD((()=>B(e))),setContextHighlight:(e,t)=>{j.set(N.some({range:e,visibility:t}))},selectedRange:P,textUpdated:F},ce={reportUphookShow:e=>n.tD((()=>{e.isPremium||((0,De.n)(q,{placement:"grammarlyGoPrompts",upgradeHookName:"grammarlyGoPrompts",upgradeHookSlot:"grammarlyGo"}),Q.upgradeHooks.showUpgradeHook("grammarlyGoPrompts","grammarlyGo"))})),reportUphookClick:e=>n.tD((()=>{e.isPremium?self.open(r.Rd().appConfig.url.support):((0,De.Q)(q,{placement:"grammarlyGoPrompts",upgradeHookName:"grammarlyGoPrompts",upgradeHookSlot:"grammarlyGo"}),Q.upgradeHooks.clickUpgradeHook("grammarlyGoPrompts","grammarlyGo"),(0,je.wW)("upHook","grammarlyGoPrompts"))}))},ue={domain:R.of(L),submitFeedback:e=>n.Y3((()=>(0,l.zG)(e.source,(e=>e===ze.x.Source.resultCard?"cheetah-card":e===ze.x.Source.quickReplyInitialActions||e===ze.x.Source.intentCard?"cheetah-quick-reply":void(0,W.L0)(e)),(t=>q.feedbackFormSubmit(e.mood,t,e.domain,e.message)))),(e=>new Error(String(e))))},pe=new He.p({capiService:te,monitoringService:ee}),ge=new Ne.j(V.h.create({contextUpdatesClient:Y.isGateEnabled($e.K.CheetahSelectionContextUpdates)&&"test"===Y.getTreatment(Le.p.CheetahSelectionContextUpdates),contextUpdatesServer:Y.isGateEnabled($e.K.CheetahSelectionContextUpdatesServer)&&"test"===Y.getTreatment(Le.p.CheetahSelectionContextUpdates)}));return{capiService:te,userService:se,genAIAvailabilityService:ae,trackingService:ie,textEditorService:he,feedbackService:ue,uphookService:ce,monitoringService:ee,userSurveyService:pe,selectionContextAvailabilityService:ge,createOnboardingViewModels:de,notifyAssistantUIAction:e=>J.next(e),dispose:()=>{te.dispose(),ae.dispose(),pe.dispose(),ge.dispose()}}}(this._params.checkingService,this._params.checkingService.pipe(m.oA,v.w((e=>e.capiMessages))),this._params.user,this._params.dapiSettings.view((e=>{var t,i;return null!==(i=null!==(t=e.dialectStrong)&&void 0!==t?t:e.dialectWeak)&&void 0!==i?i:"american"})),(e=>n.fF((()=>this._params.dapiActions.changeStrongDialect(e)))),this._assistantUIState,this._params.textStats,this._params.capiStartAckMessage,this._ideateButtonRefChange,V.h.combine(this._params.integration.canShowIdeateButtonPopups,this._params.gButtonPopupState.view("type").view((e=>!At.has(e))),F.xD),V.h.combine(this._params.csPageState.view("cheetah").view((e=>(null==e?void 0:e.canShowInitialOnboarding)||(null==e?void 0:e.canShowInitialBTSOnboarding)||!1)),this._initialOnboardingBlockedForSession,((e,t)=>e&&!t)),_.T(this._params.csPageState.view("isActiveTab").pipe(b.h((e=>!e))),this._disposed).pipe(f.q(1)),this._params.dapiSettings.view((e=>function(e){const t=we.Z.State.toClientState(we.Z.decode(e.extension||""),"extension"),i=we.Z.State.toClientState(we.Z.decode(e.editor||""),"editor"),s=we.Z.State.toClientState(we.Z.decode(e.llamaMac||""),"llamaMac"),a=we.Z.State.toClientState(we.Z.decode(e.llamaWindows||""),"llamaWin");return(0,l.zG)(we.Z.State.empty,we.Z.State.patch(t,"extension"),we.Z.State.patch(i,"editor"),we.Z.State.patch(s,"llamaMac"),we.Z.State.patch(a,"llamaWin"))}({extension:e["cheetah:onboardingState"],editor:e["cheetah:onboardingState:editor"],llamaMac:e["cheetah:onboardingState:llamaMac"],llamaWindows:e["cheetah:onboardingState:llamaWindows"]}))),(e=>{this._params.dapiActions.modifyCheetahOnboardingState((0,l.ls)(we.Z.decode,(t=>(0,l.zG)(we.Z.State.toClientState(t,"extension"),(t=>({...t,...e})),(e=>we.Z.State.patch(e,"extension")(t)))),we.Z.encode))}),this._params.featureFlags,this._params.integration.enableInlineRewrites,this._params.textChangeBuffer,(e=>this._params.integration.getText(e)),(e=>this._insertText(e)),this._selectionRange,this._params.integration.textUpdated,this._contextHighlight,this._params.gnar,this._lastRestartAttemptTime,this._params.domain,(()=>this._restartAssistant()),this._params.telemetry,this._params.experimentClient,this._log),this._isOnboardingPopupVisible=V.h.create(!1),this._entryPointsEnabled=V.h.create(!1),this.inlineButtonUI=this._inlineButtonUI.view(),this.ideateButtonUI=this._ideateButtonUI.view(),this.expandedIdeateButtonUI=this._expandedIdeateButtonUI.view(),this.assistantUI=this._assistantUI.view(),this.highlightUI=this._highlightUI.view(),this.quasiCaretUI=this._quasiCaretUI.view(),this.onboardingUI=this._onboardingUI.view(),this.assistantState=this._assistantUI.view((0,l.ls)(N.fromNullable,N.fold((()=>({kind:"closed"})),(()=>({kind:"opened",supportsRevision:this._params.supportsRevision}))))),this.isOnboardingPopupVisible=this._isOnboardingPopupVisible.view(),this.isAvailable=V.h.combine(this._assistantServices.genAIAvailabilityService.availability.view((0,F.ff)(Ae._.isUnavailable)),this._params.csPageState.view("cheetah"),((e,t)=>{var i;return e&&!0===(null===(i=null==t?void 0:t.status)||void 0===i?void 0:i.cheetahEnabled)})),this.userSettings=this._assistantServices.genAIAvailabilityService.availability.view("userSettings"),this._params.dapiActions.reloadPropsRateLimited(),this._subs.add(this._params.checkingService.pipe(m.oA,v.w((e=>e.readyState)),b.h((e=>e===Se.kQ.ready)),f.q(1)).subscribe((()=>this._init()))),this._subs.add(this._setupIdeateTooltipStateObs());const t=this._onboardingViewModels.pipe(v.w(N.fold((()=>S.E),(e=>e.onboarding.uiActions))));this._subs.add(t.pipe(b.h(kt)).subscribe((()=>{this._params.cheetahCSActions.cheetahInitialOnboardingShown()}))),this._subs.add(t.pipe(b.h(Bt)).subscribe((()=>{this._params.cheetahCSActions.cheetahInitialBTSOnboardingShown()}))),this._subs.add(this._getOnboardingVMStepActive([Ie.T.StepName.initial,Ie.T.StepName.initialBTS]).subscribe(y.wW(this._isOnboardingPopupVisible))),this._subs.add(this._params.gButtonPopupState.view("type").view((e=>It.has(e))).subscribe((e=>{e&&this._initialOnboardingBlockedForSession.set(!0)}))),this._subs.add(w.aj([this._params.gButtonDisabledReason,this._params.integration.entryPointsEnabled]).pipe(A.U((([e,t])=>t&&!function(e){const t=new Set([Ve.P.DATA_CONTROL_ACTIVE,Ve.P.OFFLINE,Ve.P.STAND_WITH_UKRAINE,Ve.P.USER_CLAIMED,Ve.P.USER_EDC_BLOCKED,Ve.P.SIGNED_OUT_GB]);return null!==e&&t.has(e)}(e)))).subscribe(y.wW(this._entryPointsEnabled))),this._subs.add(this._params.csPageState.view("cheetah").view((e=>{var t;return!1===(null===(t=null==e?void 0:e.status)||void 0===t?void 0:t.cheetahEnabled)})).subscribe((()=>this._closeAssistant(We.j.disposed)))),this._registerDebugHelpers()}closeAssistant(e){this._closeAssistant(e)}getHoveredStateBehavior(e){return this._highlightsUpdater.getHighlightVisualState(e)}_init(){this._subs.add(this._assistantFocused.subscribe((e=>this._log.debug("Assistant "+(e?"focused":"blurred"))))),this._subs.add(this._params.openAssistant.pipe(v.w((e=>this._openAssistant(e)))).subscribe()),this._subs.add(this._getInlineButtonUI().subscribe(y.wW(this._inlineButtonUI))),this._subs.add(this._getIdeateButtonUI().subscribe(y.wW(this._ideateButtonUI))),this._subs.add(this._getExpandedIdeateButtonUI().subscribe(y.wW(this._expandedIdeateButtonUI))),this._subs.add(this._getHighlightUI().subscribe(y.wW(this._highlightUI))),this._subs.add(this._getQuasiCaretUI().subscribe(y.wW(this._quasiCaretUI))),this._subs.add(this._getOnboardingUI().subscribe(y.wW(this._onboardingUI))),this._subs.add(this._updateSelectionRange().subscribe(y.wW(this._selectionRange))),this._subs.add(this._updateHighlightRects().subscribe(y.wW(this._highlights))),this._subs.add(this._updateQuasiCaretRect().subscribe(y.wW(this._quasiCaretRect))),this._subs.add(this._updateNativeCursor().subscribe()),this._subs.add(this._closeRewriteAssistantWhenUnfocused().subscribe()),this._subs.add(this.assistantState.subscribe((e=>{Rt(e)&&this._params.closeLegacyAssistant()}))),this._subs.add(this._createOnboardingViewModelWhenCheetahAvailable().subscribe()),this._subs.add(this._handleTryItOut().subscribe())}_handleTryItOut(){return this._onboardingViewModels.pipe(v.w(N.fold((()=>S.E),(e=>e.onboarding.uiActions))),b.h(Re.l.is(Re.l.Kind.tryItOut)),I.b((()=>this._params.openAssistant.next({mode:Ct(this._params.integration.quickReplyContext.get())&&this._params.featureFlags.get().quickReply?"quickReply":"ideation"}))))}_getOnboardingVMStepActive(e){return this._onboardingViewModels.pipe(v.w(N.fold((()=>R.of(!1)),(t=>t.onboarding.activeStep.view((0,l.ls)(N.filter((e=>e.show)),N.map((t=>e.includes(t.name))),N.getOrElse(l.jv)))))),x.x())}_setupIdeateTooltipStateObs(){return this._assistantServices.genAIAvailabilityService.availability.pipe(C.O(null),U.G(),A.U((([e,t])=>e&&t&&Ae._.isPassive(e)&&Ae._.isActive(t)?N.some("Youâ€™ve got prompts!"):N.none)),v.w(N.fold((()=>R.of(N.none)),(e=>_.T(R.of(N.some(e)),R.of(N.none).pipe(E.g(3e3))))))).subscribe(y.wW(this._ideateButtonTooltipNotificationState))}_registerDebugHelpers(){!function(e){const t=self;t&&(t.cheetahDebug=t.cheetahDebug||{},Object.assign(t.cheetahDebug,e))}({clearOnboarding:()=>this._params.dapiActions.modifyCheetahOnboardingState((()=>we.Z.encode(we.Z.State.empty)))})}_createOnboardingViewModelWhenCheetahAvailable(){return V.h.combine(this._params.featureFlags,this._assistantServices.genAIAvailabilityService.availability.view(Ae._.isUsable),((e,t)=>e.onboarding&&t)).pipe(I.b((e=>this._onboardingViewModels.modify((t=>((0,l.zG)(t,j.bw((e=>e.onboarding.dispose()))),e?N.some(this._assistantServices.createOnboardingViewModels()):N.none))))))}_closeRewriteAssistantWhenUnfocused(){return this._assistantFocused.pipe(k.b(100),b.h((e=>!e&&(0,l.zG)(this._assistantUIState.view(N.map((({sessionService:e})=>e.session))).get(),N.fold(l.jv,(e=>e.view((e=>"started"===e.kind&&xe.w.isRewriteOrQuickRewrite(e.mode)&&N.isNone(e.inProgressResult)&&0===e.results.length)).get()))))),I.b((()=>this._closeAssistant(We.j.assistantBlurred))))}_onClickIdeateButton(e){Rt(this.assistantState.get())?this._closeAssistant(We.j.closed):this._params.openAssistant.next({mode:e})}_updateSelectionRange(){return w.aj([this._params.integration.selectionRange,this.assistantState.view(Rt)]).pipe(A.U((([e,t])=>({selectionRange:e,assistantIsFocused:this._assistantFocused.get(),inlineButtonRecentlyPressed:this._inlineButtonRecentlyPressed.get(),ideateButtonRecentlyHovered:this._ideateButtonRecentlyHovered.get(),initialPopupOnboardingStepIsActive:this.isOnboardingPopupVisible.get(),assistantOpened:t}))),I.b((({inlineButtonRecentlyPressed:e,ideateButtonRecentlyHovered:t})=>{e&&this._inlineButtonRecentlyPressed.set(!1),t&&this._ideateButtonRecentlyHovered.set(!1)})),b.h((({selectionRange:e,assistantIsFocused:t,inlineButtonRecentlyPressed:i,ideateButtonRecentlyHovered:s,initialPopupOnboardingStepIsActive:a,assistantOpened:n})=>!n||!i&&!s&&(!N.isNone(e)||!t&&!a))),A.U((({selectionRange:e})=>e)))}_updateHighlightRects(){return e=this._selectionRange,t=this._contextHighlight,i=this._params.integration,w.aj([e.pipe(v.w(N.fold((()=>R.of([])),(e=>i.getHighlightRects(e).pipe(A.U((e=>e.map((e=>({rect:e,visibility:"visible"})))))))))),t.pipe(v.w(N.fold((()=>R.of([])),(e=>i.getHighlightRects(e.range).pipe(A.U((t=>t.map((t=>({rect:t,visibility:e.visibility}))))))))))]).pipe(A.U((([e,t])=>t.find((e=>"hidden"!==e.visibility))?t:e)));var e,t,i}_updateQuasiCaretRect(){return w.aj([this._selectionRange,this._highlightsUpdater.hasHighlights]).pipe(v.w((([e,t])=>(0,l.zG)(e,N.filter((()=>!this._params.supportsRevision||!t)),N.filter(h.SV.isCollapsed),N.fold((()=>R.of([])),(e=>this._params.integration.getHighlightRects(e)))))),A.U((e=>(0,l.zG)(e,a.c2,N.map((e=>e[e.length-1]))))))}_updateNativeCursor(){return V.h.combine(this._quasiCaretRect,this.assistantState.view(Rt),((e,t)=>(0,l.zG)(s.Y(N.option)({nativeUIHider:N.fromNullable(this._params.integration.createNativeUIHider),quasiCaretRect:e}),N.filter((()=>t)),j.ew((()=>{this._nativeCursorHider.modify((e=>((0,l.zG)(e,j.bw((e=>e.dispose()))),N.none)))})),j.bw((({nativeUIHider:e})=>{this._nativeCursorHider.modify((t=>((0,l.zG)(t,j.bw((e=>e.dispose()))),N.some(e()))))})))))}_closeAssistant(e){(0,l.zG)(this._assistantUIState.get(),j.bw((({dispose:e})=>e()))),this._assistantUIState.set(N.none),this._assistantUI.set(null),e!==We.j.closed&&e!==We.j.assistantBlurred||this._params.integration.focusTextField()}_restartAssistant(){this._log.info("reconnecting checking service and restarting session"),(0,l.zG)(this._assistantUIState.get(),N.map((({sessionService:e})=>e.session.get().mode)),j.bw((e=>{this._closeAssistant(We.j.disposed),(0,l.zG)(this._params.checkingService.get(),j.bw((e=>{e.reconnect()}))),xe.w.isPushRewrite(e)?this._params.openAssistant.next({mode:"ideation"}):this._params.openAssistant.next({mode:e})})))}async _openAssistant(e){Rt(this.assistantState.get())&&this._closeAssistant(We.j.disposed),this._assistantFocused.set(!0),"pushRewrite"===e.mode&&this._selectionRange.set(N.some(e.transformRange));const t=new Ce.Z({logger:c.Y.create("cheetah.sessionService"),startSessionOptions:et(e,{disableKnowledgeEngine:"disabled"===this._params.dapiSettings.get().serengetiState||void 0},this._params.integration.quickReplyContext.get(),this._params.url),textEditorService:this._assistantServices.textEditorService,capiService:this._assistantServices.capiService,userService:this._assistantServices.userService,trackingService:this._assistantServices.trackingService,monitoringService:this._assistantServices.monitoringService,selectionContextAvailability:this._assistantServices.selectionContextAvailabilityService.availability}),{revisionEngine:i,dispose:s}=this._params.supportsRevision?await pt({capiService:this._assistantServices.capiService,sduiBufferService:this._params.sduiBufferService,alertProcessor:this._params.alertProcessor,initialFeed:Xe(e),highlightsUpdater:this._highlightsUpdater,replacementService:this._params.replacementService,getFormattingService:this._params.getFormattingService,requestAwaitService:this._params.requestAwaitService,alertStateService:this._params.alertStateService,domain:this._params.domain,getSessionUuid:()=>{var e,t;return null!==(t=null===(e=N.toNullable(this._params.checkingService.get()))||void 0===e?void 0:e.sessionUuid)&&void 0!==t?t:null},telemetry:this._params.telemetry}):{revisionEngine:void 0,dispose:l.Q1},a={logger:c.Y.create("cheetah.ui"),textEditorService:this._assistantServices.textEditorService,userService:this._assistantServices.userService,genAIAvailabilityService:this._assistantServices.genAIAvailabilityService,trackingService:this._assistantServices.trackingService,uphookService:this._assistantServices.uphookService,feedbackService:this._assistantServices.feedbackService,monitoringService:this._assistantServices.monitoringService,userSurveyService:this._assistantServices.userSurveyService,selectionContextAvailabilityService:this._assistantServices.selectionContextAvailabilityService,sessionService:t,revisionEngine:i,theme:V.h.create({flatUI:this._params.supportsRevision}),notifyAssistantUIAction:this._assistantServices.notifyAssistantUIAction,settingsOptions:this._params.supportsRevision?{kind:"withView",getView:()=>this._params.settingsService.getView()}:void 0};try{const e=await this._params.integration.renderAssistant((({sizeBehavior:e,dragBehavior:i,readyToDrag:n})=>{const{assistantUI:r,dispose:o}=(0,Ue.e)({...a,lifecycleService:{sizeBehavior:e,dragBehavior:i,readyToDrag:n,focusStateChanged:({isFocused:e})=>(this._assistantFocused.set(e),Promise.resolve()),close:()=>(this._closeAssistant(We.j.closed),Promise.resolve())}});return this._assistantUIState.set(N.some({sessionService:t,dragBehavior:B.D(i),dispose:()=>{s(),o(),t.dispose(),this._assistantFocused.set(!1)}})),r}));this._assistantUI.set(d.createElement(re,null,e))}catch(e){this._log.warn("failed to open assistant, integration failed to render the assistant"),this._assistantUIState.set(N.none),this._assistantUI.set(null)}}_getInlineButtonUI(){return(0,l.zG)(s.Y(o.P)({inlineButtonInfo:this._params.integration.inlineButtonPlacement,selectionRange:this._selectionRange,selectionOngoing:_.T(this._params.integration.selectionRange.pipe(A.U((e=>(0,l.zG)(e,N.isSome)))),this._params.integration.selectionRange.pipe(k.b(100),P.h(!1))),assistantOpened:this.assistantState.view(Rt),textMapIsEmpty:this._params.integration.textMapIsEmpty,quickReplyContext:this._params.integration.quickReplyContext,availability:this._assistantServices.genAIAvailabilityService.availability,entryPointsEnabled:this._entryPointsEnabled,featureFlags:this._params.featureFlags})).pipe(A.U((({inlineButtonInfo:e,selectionRange:t,selectionOngoing:i,assistantOpened:s,textMapIsEmpty:a,quickReplyContext:n,availability:r,entryPointsEnabled:o,featureFlags:h})=>(0,l.zG)(e,N.filter((()=>o)),N.filter((()=>!s)),N.filter((()=>Ae._.isUsable(r))),N.fold(l.gn,(e=>(0,l.zG)(t,N.fold(l.gn,(t=>a&&N.isSome(n)&&h.inlineQuickReply?d.createElement(de,{disabled:!1,referenceElement:e.referenceElement,placement:e.placement,offset:N.toNullable(e.offset),onClick:()=>{this._inlineButtonRecentlyPressed.set(!0),this._params.openAssistant.next({mode:"quickReply"})}}):Et(t)&&(h.inlineRewrite||h.magicRewrite)&&this._params.integration.enableInlineRewrites?d.createElement(ce,{disabled:i,referenceElement:e.referenceElement,placement:e.placement,offset:N.toNullable(e.offset),onOpenRewriteClick:h.inlineRewrite?()=>{this._inlineButtonRecentlyPressed.set(!0),this._params.openAssistant.next({mode:"rewrite"})}:void 0,onMagicRewriteClick:h.magicRewrite?()=>{this._inlineButtonRecentlyPressed.set(!0),this._params.openAssistant.next({mode:"quickRewrite"})}:void 0}):null)))))))))}_getOnboardingUI(){return this._onboardingViewModels.view(N.fold(l.gn,(e=>d.createElement(re,null,$.UI.mount(Ee.T,(0,ke.A)(e))))))}_getHighlightUI(){return V.h.combine(this._highlights,this.assistantState.view(Rt),this._assistantFocused,((e,t,i)=>t&&i?e.map((({rect:e,visibility:t},i)=>d.createElement(Z,{key:`cheetah-highlight-rect-${i}`,top:e.top,left:e.left,width:e.width,height:e.height,visibility:t}))):null))}_getQuasiCaretUI(){return V.h.combine(this._quasiCaretRect,this.assistantState.view(Rt),((e,t)=>(0,l.zG)(e,N.filter((()=>t)),N.fold((()=>null),(e=>d.createElement(_e,{left:e.left,top:e.top,height:e.height,overflow:this._params.integration.allowCustomCaretOverflow}))))))}_getIdeateButtonUI(){return V.h.combine(this._params.featureFlags,this._inlineButtonUI,this._selectionRange,this._params.integration.quickReplyContext,this._assistantServices.genAIAvailabilityService.availability,this._entryPointsEnabled,((e,t,i,s,a,n)=>(0,l.zG)(t,N.fromPredicate((e=>null===e)),N.filter((()=>n&&e.ideateButton)),N.filter((()=>Ae._.isUsable(a))),N.fold(l.gn,(()=>this._getIdeateButtonForSelectionRange(i,s,e))))))}_getExpandedIdeateButtonUI(){return this._params.supportsRevision?V.h.create(null):V.h.combine(this._params.featureFlags,this._selectionRange,this._params.integration.quickReplyContext,this._assistantServices.genAIAvailabilityService.availability,this._entryPointsEnabled,((e,t,i,s,a)=>(0,l.zG)(s,N.fromPredicate((e=>Ae._.isVisible(e))),N.filter((()=>a&&e.ideateButton)),N.fold(l.gn,(()=>this._getIdeateButtonForSelectionRange(t,i,e))))))}_getIdeateButtonForSelectionRange(e,t,i){return this._params.supportsRevision?null:(0,l.zG)(e,N.filter((e=>Et(e)&&i.rewrite)),N.fold((()=>Ct(t)&&i.quickReply?"quickReply":i.compose?"ideation":null),(()=>"rewrite")),N.fromNullable,N.fold(l.gn,(e=>d.createElement(wt,{onMouseEnter:()=>this._ideateButtonRecentlyHovered.set(!0),onMouseLeave:()=>this._ideateButtonRecentlyHovered.set(!1),onClick:()=>this._onClickIdeateButton(e),mount:e=>this._ideateButtonRefChange.next(e),forceTooltipMessage:this._ideateButtonTooltipNotificationState.view(N.toUndefined)}))))}_insertText(e){""!==e?this._params.integration.insertText(e,this._selectionRange.get()):this._log.warn("insert() - attempting to insert empty response, skipping insert.")}dispose(){var e;this._disposed.next(null),this._highlightsUpdater.dispose(),this._closeAssistant(We.j.disposed),null===(e=N.toUndefined((0,l.zG)(this._onboardingViewModels.get(),N.map((e=>e.onboarding)))))||void 0===e||e.dispose(),this._assistantServices.dispose(),this._subs.unsubscribe(),(0,l.zG)(this._nativeCursorHider.get(),j.bw((e=>e.dispose()))),this._params.integration.dispose()}}function Ct(e){return(0,l.zG)(e,N.exists((e=>Object.values(e).filter((e=>void 0!==e)).length>0)))}function Ut(e){return e.isConnected&&null!==e.offsetParent}function Et(e){const t=e.end-e.start;return t>=10&&t<5e3}function kt(e){return(0,F.W9)(Re.l.is(Re.l.Kind.mount),(e=>e.step===Ie.T.StepName.initial))(e)}function Bt(e){return(0,F.W9)(Re.l.is(Re.l.Kind.mount),(e=>e.step===Ie.T.StepName.initialBTS))(e)}},67534:(e,t,i)=>{i.d(t,{B:()=>o,g:()=>r});var s=i(17528),a=i(48015),n=i(36991);const r=e=>e.reduce((({actions:e,index:t},i)=>{const s=e[0];return n.s.isInsertString(i)?(e.unshift({pos:{start:t,end:t},value:i.insert}),{actions:e,index:t}):n.s.isInsertEmbed(i)?{actions:e,index:t+1}:n.s.isRetain(i)?{actions:e,index:t+i.retain}:n.s.isDelete(i)?(s&&s.pos.start===s.pos.end&&s.pos.end===t?s.pos={...s.pos,end:s.pos.end+i.delete}:e.unshift({pos:{start:t,end:t+i.delete},value:""}),{actions:e,index:t+i.delete}):void(0,a.vE)(i)}),{actions:[],index:0}).actions.reduce(((e,t)=>(e.length&&e[e.length-1].value&&e[e.length-1].pos.start===t.pos.start?e[e.length-1].value=`${t.value}${e[e.length-1].value}`:e.push(t),e)),[]),o=e=>e.reduce((({formattings:e,index:t},i)=>s.m.hasFormatting(i)?n.s.isInsertString(i)?(e.push({range:{start:t,end:"\n"===i.insert?t:t+i.insert.length},formatting:i.attributes}),{formattings:e,index:t+i.insert.length}):n.s.isInsertEmbed(i)?{formattings:e,index:t+1}:n.s.isRetain(i)?(e.push({range:{start:t,end:t+i.retain},formatting:i.attributes}),{formattings:e,index:t+i.retain}):{formattings:e,index:t}:n.s.isInsertString(i)?{formattings:e,index:t+i.insert.length}:n.s.isInsertEmbed(i)?{formattings:e,index:t+1}:n.s.isRetain(i)?{formattings:e,index:t+i.retain}:n.s.isDelete(i)?{formattings:e,index:t}:void(0,a.vE)(i)),{formattings:[],index:0}).formattings},88571:(e,t,i)=>{i.d(t,{Q:()=>l});var s=i(27378),a=i(15073),n=i(60797),r=i(95300),o=i(5114);const l=({children:e,remSize:t,setter:i})=>(d+=1,s.useEffect((()=>{const e=t.subscribe((e=>{h.next(o.some(e)),i(o.some(e))}));return()=>{e.unsubscribe(),d-=1,0===d&&(h.next(o.none),i(o.none))}}),[t]),s.createElement(a.u.Context.Provider,{value:h.pipe(n.oA)},e));let d=0;const h=new r.X(o.none)},51325:e=>{e.exports={highlightRect:"XWxTA",hidden:"o979x",attention:"bHjcD",blink:"oy7wj"}},16805:e=>{e.exports={ideateButton:"_ErYR",ideateButtonIcon:"i8HXG",spin:"CSZH1"}},87491:e=>{e.exports={entryButton:"cDocn",entryButtonItem:"dJCJe",rewriteIcon:"wGNWN",openIcon:"vIUqu",spin:"A8MjA"}},50783:e=>{e.exports={replyButton:"ZfD1U",icon:"BdxRh",spin:"MBS28"}},48033:e=>{e.exports={quasiCaret:"WhbAl",icon:"Yd_W5"}}}]);