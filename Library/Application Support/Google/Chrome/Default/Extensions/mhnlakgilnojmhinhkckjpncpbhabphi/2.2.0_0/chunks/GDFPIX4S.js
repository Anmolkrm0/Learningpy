import{b as L}from"./3X42KLOD.js";import{A as _,U as f,c as G,g as k,w as T,x as d,y as l}from"./MT7GI5KY.js";import{c as x}from"./QPPETRF6.js";import{M as C}from"./T463YMPS.js";import{A as g,K as E}from"./LZHALC2F.js";import{a as K}from"./64D36THL.js";import{a as H}from"./3JX3VARJ.js";import{f as p}from"./PQ35KENF.js";var a=p(K());var I=p(H());var O=async()=>{let e=await I.default.storage.local.get(g);return e[g]?e[g]?.refreshToken:""},D=(e,s,o)=>new Promise((t,r)=>{O().then(n=>{if(!n){r(new Error("no accessToken")),f();return}fetch(E+e,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify(s),...o}).then(c=>{c.ok?t(c.json()):(c.status===401&&f(),r(c))}).catch(c=>{})})}),S=(e,s)=>new Promise((o,t)=>{try{O().then(r=>{if(!r){t(new Error("no accessToken")),f();return}fetch(E+e,{headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},...s}).then(n=>{n.ok?o(n.json()):(n.status===401&&f(),t(n))}).catch(n=>{t(n)})})}catch(r){t(r)}});var M=p(G());var m=async()=>{try{let e=await S("/user/get_user_info");if(e?.status==="OK"){let s=e.data?.settings;s&&await l(o=>T([o,s]))}return!0}catch{return!1}},h=async()=>{try{let e=(0,M.default)().utc().valueOf();await l({lastModified:e});let s=C(await d());return(await D("/user/save_user_settings",{settings:{...s,lastModified:e}}))?.status==="OK"}catch{return!1}},v=async()=>{try{await _();let e=await S("/user/get_user_settings_last_modified");if(e?.status==="OK"){let s=await d(),o=String(e.data),t=String(s.lastModified);return o&&t?o===t:!1}return!1}catch{return!1}},A=async()=>{try{let e=await d();await _();let s=await S("/user/get_user_info");if(s?.status==="OK"){let o=s.data?.settings;if(o&&o.lastModified){let t=o.lastModified,r=e.lastModified;if(t){if(!r)return e.buttonSettings?.textSelectPopupButton.contextMenu?.find(n=>n.data.editable)?{success:!1,status:"needSync",cacheLocalSettings:e}:(await m(),{success:!0,status:"ok"});if(r===t)return{success:!0,status:"ok"};if(r<t)return await m(),{success:!0,status:"ok"};if(r>t)return await h(),{success:!0,status:"ok"}}}else return await h(),{success:!0,status:"ok"}}return{success:!1,status:"error"}}catch(e){return e.status===401?{success:!1,status:"needLogin"}:{success:!1,status:"error"}}};var N=()=>{let{t:e}=x(["settings"]),{enqueueSnackbar:s}=L(),[o,t]=(0,a.useState)(!1),[r,n]=(0,a.useState)(!1),[c,y]=(0,a.useState)(!1),[B,P]=(0,a.useState)(!1),w=(0,a.useRef)(void 0),R=(0,a.useCallback)(k((i,u)=>{s(i,{variant:"info",autoHideDuration:1e3,...u})},2e3),[s]),b=(0,a.useCallback)(async()=>{try{return t(!0),await m()}catch{return s(e("settings:sync__sync_failed"),{variant:"error",autoHideDuration:1e3}),!1}finally{t(!1)}},[]),q=(0,a.useCallback)(async i=>{try{t(!0),i&&await l(i);let u=await h();return u&&R(e("settings:sync__save_success"),{variant:"success",autoHideDuration:1e3}),u}catch{return s(e("settings:sync__sync_failed"),{variant:"error",autoHideDuration:1e3}),!1}finally{t(!1)}},[]);return{isSyncing:o,isChecking:r,showCheckAlert:B,showErrorAlert:c,checkSync:async()=>{try{if(y(!1),P(!1),w.current=void 0,await v())return{success:!0,status:"ok"};n(!0);let i=await A();return i.status==="error"?(y(!0),{success:!1,status:"error"}):i}catch{return y(!0),{success:!1,status:"error"}}finally{n(!1)}},syncLocalToServer:q,syncServerToLocal:b,localSettingsCacheRef:w}},oe=N;export{O as a,h as b,v as c,A as d,oe as e};
